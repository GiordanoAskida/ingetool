<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingetool - Askida Broadcast</title>
    
    <!-- üîê MSAL.js for Microsoft Authentication - unpkg CDN (pi√π affidabile) -->
    <script src="https://unpkg.com/@azure/msal-browser@2.38.0/lib/msal-browser.min.js"></script>
    
    <!-- üé® Google Fonts - Montserrat (similar to Glance) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- üì± PWA Meta Tags -->
    <meta name="theme-color" content="#e61252">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ingetool">
    <meta name="description" content="Gestion des √©quipes et ressources - Askida Broadcast">
    
    <!-- üì± PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <!-- üì± Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            // Create minimal service worker inline
            const swCode = `
              self.addEventListener('install', (event) => {
                console.log('Service Worker install√©');
                self.skipWaiting();
              });
              
              self.addEventListener('activate', (event) => {
                console.log('Service Worker activ√©');
                event.waitUntil(self.clients.claim());
              });
              
              self.addEventListener('fetch', (event) => {
                // Pass-through: no caching for now
                event.respondWith(fetch(event.request));
              });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            const registration = await navigator.serviceWorker.register(swUrl);
            console.log('‚úÖ PWA Service Worker enregistr√©:', registration.scope);
            
            // V√©rifier si installable
            window.addEventListener('beforeinstallprompt', (e) => {
              console.log('‚úÖ PWA installable d√©tect√©!');
              // Sauvegarder l'event pour plus tard si n√©cessaire
              window.deferredPrompt = e;
            });
            
          } catch (error) {
            console.error('‚ùå Erreur Service Worker:', error);
          }
        });
      }
    </script>
    
    <!-- 
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    VERSION ONEDRIVE - Synchronisation Cloud Microsoft
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    üìã CONFIGURATION REQUISE (voir ligne ~415):
       - ONEDRIVE_CLIENT_ID (Azure AD Application ID)
       - ONEDRIVE_TENANT_ID (Azure AD Directory ID)
    
    üìö Documentation compl√®te: GUIDE-ONEDRIVE-FR.md
    ‚ö° Quick Start: QUICKSTART-ONEDRIVE-FR.md
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -->
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- OneDrive/Microsoft Graph API - Utilise OAuth 2.0 Implicit Flow -->
</head>
<body>
    <!-- üîê SISTEMA LOGIN MULTI-UTENTE -->
    <script>
        (function() {
            // ========================================
            // CONFIGURAZIONE UTENTI
            // ========================================
            const USERS = {
                'admin': {
                    password: 'Askida2025',
                    role: 'admin',
                    displayName: 'Administrateur'
                },
                'read': {
                    password: 'Read2025',
                    role: 'reader',
                    displayName: 'Lecteur'
                },
                // INGEGNERI - Password individuali
                'Alexandre BOUTON': {
                    password: 'alexandre47',
                    role: 'engineer',
                    displayName: 'Alexandre BOUTON'
                },
                'Victor DRIEU': {
                    password: 'victor23',
                    role: 'engineer',
                    displayName: 'Victor DRIEU'
                },
                'Manuel IRNIGER': {
                    password: 'manuel85',
                    role: 'engineer',
                    displayName: 'Manuel IRNIGER'
                },
                'Malek MIZOURI': {
                    password: 'malek61',
                    role: 'engineer',
                    displayName: 'Malek MIZOURI'
                },
                'Maher NACHEB': {
                    password: 'maher92',
                    role: 'engineer',
                    displayName: 'Maher NACHEB'
                },
                'Denis PEREZ': {
                    password: 'denis34',
                    role: 'engineer',
                    displayName: 'Denis PEREZ'
                },
                'Farid RADI': {
                    password: 'farid78',
                    role: 'engineer',
                    displayName: 'Farid RADI'
                },
                'Raphael RECAMIER': {
                    password: 'raphael56',
                    role: 'engineer',
                    displayName: 'Raphael RECAMIER'
                },
                'Marc ROUILLET': {
                    password: 'marc41',
                    role: 'engineer',
                    displayName: 'Marc ROUILLET'
                },
                'Bastien DOUBLET': {
                    password: 'bastien29',
                    role: 'engineer',
                    displayName: 'Bastien DOUBLET'
                },
                'Jean-Paul CARDO': {
                    password: 'jeanpaul67',
                    role: 'engineer',
                    displayName: 'Jean-Paul CARDO'
                },
                'Etienne JULIEN': {
                    password: 'etienne15',
                    role: 'engineer',
                    displayName: 'Etienne JULIEN'
                },
                'Kyllian CHESNEL': {
                    password: 'kyllian83',
                    role: 'engineer',
                    displayName: 'Kyllian CHESNEL'
                },
                'Giordano MORELLI': {
                    password: 'giordano74',
                    role: 'engineer',
                    displayName: 'Giordano MORELLI'
                }
            };
            
            // üîê MICROSOFT AUTHENTICATION CONFIGURATION (v3.0)
            const MSAL_CONFIG = {
                auth: {
                    clientId: '0ded32a8-75de-48dc-b866-11cce4a18c99', // M√™me app que OneDrive
                    authority: 'https://login.microsoftonline.com/51b9c03e-2025-4f37-8526-8d499718a398',
                    redirectUri: window.location.origin + window.location.pathname
                },
                cache: {
                    cacheLocation: 'sessionStorage',
                    storeAuthStateInCookie: false
                }
            };
            
            // Scopes Microsoft Graph
            const LOGIN_SCOPES = ['User.Read', 'Calendars.ReadWrite'];
            
            // üìß EMAIL TO ROLE MAPPING
            const EMAIL_ROLE_MAP = {
                // Admins
                'admin@askida.fr': { role: 'admin', name: 'Administrateur' },
                'aleksey@askida.fr': { role: 'admin', name: 'Aleksey' },
                'giordano.morelli@askida.fr': { role: 'admin', name: 'Giordano MORELLI' },
                
                // Engineers (mapping email ‚Üí engineerId dans la base)
                'alexandre.bouton@askida.fr': { role: 'engineer', name: 'Alexandre BOUTON' },
                'victor.drieu@askida.fr': { role: 'engineer', name: 'Victor DRIEU' },
                'manuel.irniger@askida.fr': { role: 'engineer', name: 'Manuel IRNIGER' },
                'malek.mizouri@askida.fr': { role: 'engineer', name: 'Malek MIZOURI' },
                'maher.nacheb@askida.fr': { role: 'engineer', name: 'Maher NACHEB' },
                'denis.perez@askida.fr': { role: 'engineer', name: 'Denis PEREZ' },
                'farid.radi@askida.fr': { role: 'engineer', name: 'Farid RADI' },
                'raphael.recamier@askida.fr': { role: 'engineer', name: 'Raphael RECAMIER' },
                'marc.rouillet@askida.fr': { role: 'engineer', name: 'Marc ROUILLET' },
                'pierre-etienne.bauduin@askida.fr': { role: 'engineer', name: 'Pierre-Etienne BAUDUIN' },
                'bastien.doublet@askida.fr': { role: 'engineer', name: 'Bastien DOUBLET' },
                'jeanpaul.cardo@askida.fr': { role: 'engineer', name: 'Jean-Paul CARDO' },
                'etienne.julien@askida.fr': { role: 'engineer', name: 'Etienne JULIEN' },
                'kyllian.chesnel@askida.fr': { role: 'engineer', name: 'Kyllian CHESNEL' },
                
                // Readers (default per email @askida.fr non mappate)
            };
            
            // Inizializza MSAL
            let msalInstance = null;
            let msalAccessToken = null;
            
            try {
                msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);
            } catch (error) {
                console.warn('‚ö†Ô∏è MSAL non disponibile, fallback a login classique');
            }
            
            // Chiavi per salvare lo stato di autenticazione
            const AUTH_KEY = 'askida_authenticated';
            const USER_KEY = 'askida_current_user';
            const ROLE_KEY = 'askida_user_role';
            
            // Verifica se l'utente √® gi√† autenticato
            const isAuthenticated = sessionStorage.getItem(AUTH_KEY);
            
            if (!isAuthenticated) {
                // Mostra schermata di login DUAL-MODE (v3.0)
                document.body.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(135deg, #000000 0%, #2d0a1a 50%, #000000 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
                        z-index: 99999;
                    ">
                        <div style="
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(230, 18, 82, 0.3);
                            text-align: center;
                            max-width: 420px;
                            width: 90%;
                            border-top: 4px solid #e61252;
                        ">
                            <!-- Logo Askida Broadcast -->
                            <div style="
                                display: flex; 
                                justify-content: center; 
                                margin-bottom: 30px;
                            ">
                                <img 
                                    src="https://raw.githubusercontent.com/GiordanoAskida/ingetool/main/logo-broadcast.png" 
                                    alt="Askida Broadcast" 
                                    style="max-width: 280px; width: 90%;"
                                    onerror="this.style.display='none'; document.getElementById('fallbackLogo').style.display='flex';"
                                />
                                <div id="fallbackLogo" style="
                                    display: none;
                                    background: #e61252;
                                    padding: 20px 40px;
                                    border-radius: 10px;
                                    box-shadow: 0 4px 15px rgba(230, 18, 82, 0.3);
                                ">
                                    <div style="
                                        color: white;
                                        font-size: 2.5em;
                                        font-weight: 800;
                                        letter-spacing: 2px;
                                        line-height: 1;
                                    ">ASKIDA</div>
                                    <div style="
                                        color: white;
                                        font-size: 1.1em;
                                        font-weight: 600;
                                        letter-spacing: 3px;
                                        text-align: center;
                                        margin-top: 5px;
                                    ">BROADCAST</div>
                                </div>
                            </div>
                            <h2 style="
                                color: #e61252;
                                font-size: 1.8em;
                                margin-bottom: 10px;
                                font-weight: 700;
                            ">Connexion</h2>
                            <p style="
                                color: #6B7280;
                                margin-bottom: 30px;
                                font-size: 0.9em;
                            ">Ingetool - Gestion des √âquipes</p>
                            
                            <!-- ‚ú® NEW: Microsoft Login Button -->
                            ${msalInstance ? `
                                <button 
                                    onclick="loginWithMicrosoft()" 
                                    id="microsoftLoginBtn"
                                    style="
                                        width: 100%;
                                        padding: 15px;
                                        background: #e61252;
                                        color: white;
                                        border: none;
                                        border-radius: 10px;
                                        font-size: 1em;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 10px;
                                        margin-bottom: 20px;
                                    "
                                    onmouseover="this.style.background='#c10f47'"
                                    onmouseout="this.style.background='#e61252'"
                                >
                                    <svg width="20" height="20" viewBox="0 0 21 21" fill="white">
                                        <rect x="1" y="1" width="9" height="9" />
                                        <rect x="1" y="11" width="9" height="9" />
                                        <rect x="11" y="1" width="9" height="9" />
                                        <rect x="11" y="11" width="9" height="9" />
                                    </svg>
                                    <span>üîê Se connecter avec Microsoft</span>
                                </button>
                                
                                <!-- Separatore -->
                                <div style="
                                    position: relative;
                                    text-align: center;
                                    margin: 25px 0;
                                ">
                                    <div style="
                                        position: absolute;
                                        top: 50%;
                                        left: 0;
                                        right: 0;
                                        height: 1px;
                                        background: #E5E7EB;
                                    "></div>
                                    <span style="
                                        position: relative;
                                        background: white;
                                        padding: 0 15px;
                                        color: #6B7280;
                                        font-size: 0.85em;
                                        font-weight: 600;
                                    ">ou connexion classique</span>
                                </div>
                            ` : ''}
                            
                            <!-- Classic Login Form -->
                            <div id="classicLoginForm" style="${msalInstance ? '' : 'display: block;'}">
                                <div style="text-align: left; margin-bottom: 20px;">
                                    <label style="
                                        display: block;
                                        color: #374151;
                                        font-weight: 600;
                                        margin-bottom: 8px;
                                        font-size: 0.9em;
                                    ">Nom d'utilisateur</label>
                                    <input 
                                        type="text" 
                                        id="usernameInput" 
                                        placeholder="admin, read, ou nom ing√©nieur"
                                        style="
                                            width: 100%;
                                            padding: 12px 15px;
                                            border: 2px solid #D1D5DB;
                                            border-radius: 10px;
                                            font-size: 1em;
                                            transition: all 0.3s;
                                        "
                                        onfocus="this.style.borderColor='#e61252'"
                                        onblur="this.style.borderColor='#D1D5DB'"
                                    />
                                    <small style="
                                        display: block;
                                        color: #6B7280;
                                        margin-top: 5px;
                                        font-size: 0.75em;
                                    ">üë∑ Ing√©nieurs: utilisez votre nom exact</small>
                                </div>
                                
                                <div style="text-align: left; margin-bottom: 25px;">
                                    <label style="
                                        display: block;
                                        color: #374151;
                                        font-weight: 600;
                                        margin-bottom: 8px;
                                        font-size: 0.9em;
                                    ">Mot de passe</label>
                                    <input 
                                        type="password" 
                                        id="passwordInput" 
                                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                        style="
                                            width: 100%;
                                            padding: 12px 15px;
                                            border: 2px solid #D1D5DB;
                                            border-radius: 10px;
                                            font-size: 1em;
                                            transition: all 0.3s;
                                        "
                                        onfocus="this.style.borderColor='#e61252'"
                                        onblur="this.style.borderColor='#D1D5DB'"
                                        onkeypress="if(event.key==='Enter') checkLogin()"
                                    />
                                </div>
                                
                                <button 
                                    onclick="checkLogin()" 
                                    style="
                                        width: 100%;
                                        padding: 15px;
                                        background: #e61252;
                                        color: white;
                                        border: none;
                                        border-radius: 10px;
                                        font-size: 1em;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s;
                                    "
                                    onmouseover="this.style.background='#c10f47'"
                                    onmouseout="this.style.background='#e61252'"
                                >
                                    üîì Se connecter
                                </button>
                            </div>
                            
                            <div id="errorMessage" style="
                                color: #DC2626;
                                margin-top: 15px;
                                font-size: 0.9em;
                                font-weight: 600;
                                display: none;
                            ">
                                ‚ùå Identifiants incorrects
                            </div>
                            
                            <div id="loadingMessage" style="
                                color: #0078D4;
                                margin-top: 15px;
                                font-size: 0.9em;
                                font-weight: 600;
                                display: none;
                            ">
                                <div style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</div>
                                Connexion en cours...
                            </div>
                            
                            <div style="
                                margin-top: 30px;
                                padding-top: 20px;
                                border-top: 1px solid #E5E7EB;
                            ">
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 10px;
                                    font-size: 0.75em;
                                    color: #6B7280;
                                    text-align: left;
                                ">
                                    <div style="
                                        background: #F9FAFB;
                                        padding: 8px;
                                        border-radius: 5px;
                                        border-left: 3px solid #8B5CF6;
                                    ">
                                        <div style="font-weight: 700; color: #8B5CF6; margin-bottom: 3px;">üëë Admin</div>
                                        <div>Toutes permissions</div>
                                    </div>
                                    <div style="
                                        background: #F9FAFB;
                                        padding: 8px;
                                        border-radius: 5px;
                                        border-left: 3px solid #3B82F6;
                                    ">
                                        <div style="font-weight: 700; color: #3B82F6; margin-bottom: 3px;">üëÅÔ∏è Read</div>
                                        <div>Lecture seule</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${msalInstance ? `
                                <div style="
                                    margin-top: 20px;
                                    font-size: 0.7em;
                                    color: #9CA3AF;
                                    padding: 10px;
                                    background: #F3F4F6;
                                    border-radius: 8px;
                                ">
                                    üí° <strong>Nouveau:</strong> Connexion Microsoft avec votre compte @askida.fr<br>
                                    üîí Plus s√©curis√© ‚Ä¢ ‚ö° Plus rapide (SSO)
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <style>
                        @keyframes spin {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                        }
                    </style>
                `;
                
                // Funzione per verificare il login
                window.checkLogin = function() {
                    const usernameInput = document.getElementById('usernameInput');
                    const passwordInput = document.getElementById('passwordInput');
                    const errorMsg = document.getElementById('errorMessage');
                    
                    const username = usernameInput.value.trim();
                    const password = passwordInput.value;
                    
                    // Verifica credenziali in USERS (case-sensitive per ingegneri, lowercase per admin/read)
                    let user = USERS[username]; // Prova match esatto
                    if (!user) {
                        user = USERS[username.toLowerCase()]; // Fallback per admin/read
                    }
                    
                    if (user && user.password === password) {
                        // Login corretto - Admin, Reader o Ingegnere
                        sessionStorage.setItem(AUTH_KEY, 'true');
                        sessionStorage.setItem(USER_KEY, username); // Salva nome esatto
                        sessionStorage.setItem(ROLE_KEY, user.role);
                        
                        // Per ingegneri, cerca l'ID nel database (verr√† caricato da React)
                        if (user.role === 'engineer') {
                            // Salva il nome per matching successivo con database
                            sessionStorage.setItem('ENGINEER_NAME', username);
                        }
                        
                        // Mostra messaggio di successo
                        const roleIcon = user.role === 'admin' ? 'üëë' : (user.role === 'reader' ? 'üëÅÔ∏è' : 'üë∑');
                        
                        document.body.innerHTML = `
                            <div style="
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: linear-gradient(135deg, #e61252 0%, #c10f47 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
                            ">
                                <div style="text-align: center; color: white;">
                                    <div style="font-size: 80px; margin-bottom: 20px;">‚úÖ</div>
                                    <h1 style="font-size: 2em; font-weight: 700; margin-bottom: 10px;">Connexion r√©ussie!</h1>
                                    <p style="font-size: 1.2em; opacity: 0.9; margin-bottom: 10px;">Bienvenue ${roleIcon} ${user.displayName}</p>
                                    <p style="font-size: 1em; opacity: 0.8;">Chargement de ${user.role === 'engineer' ? 'vos projets' : 'l\'application'}...</p>
                                </div>
                            </div>
                        `;
                        
                        // Ricarica la pagina
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // Login errato
                        errorMsg.style.display = 'block';
                        errorMsg.textContent = 'Nom d\'utilisateur ou mot de passe incorrect';
                        passwordInput.value = '';
                        usernameInput.focus();
                        
                        // Shake animation
                        usernameInput.style.animation = 'shake 0.5s';
                        passwordInput.style.animation = 'shake 0.5s';
                        setTimeout(() => {
                            usernameInput.style.animation = '';
                            passwordInput.style.animation = '';
                        }, 500);
                    }
                };
                
                // Permetti invio con tasto Enter
                setTimeout(() => {
                    const usernameInput = document.getElementById('usernameInput');
                    const passwordInput = document.getElementById('passwordInput');
                    
                    if (usernameInput) {
                        usernameInput.focus();
                        usernameInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                passwordInput.focus();
                            }
                        });
                    }
                    
                    if (passwordInput) {
                        passwordInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                checkLogin();
                            }
                        });
                    }
                }, 100);
                
                // Aggiungi animazione shake
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                        20%, 40%, 60%, 80% { transform: translateX(5px); }
                    }
                `;
                document.head.appendChild(style);
                
                // üîê MICROSOFT AUTHENTICATION FUNCTIONS (v3.0)
                
                window.loginWithMicrosoft = async function() {
                    const loadingMsg = document.getElementById('loadingMessage');
                    const errorMsg = document.getElementById('errorMessage');
                    const microsoftBtn = document.getElementById('microsoftLoginBtn');
                    
                    if (microsoftBtn) microsoftBtn.disabled = true;
                    if (loadingMsg) loadingMsg.style.display = 'block';
                    if (errorMsg) errorMsg.style.display = 'none';
                    
                    try {
                        // Login popup
                        const loginResponse = await msalInstance.loginPopup({
                            scopes: LOGIN_SCOPES,
                            prompt: 'select_account'
                        });
                        
                        const account = loginResponse.account;
                        const userEmail = account.username.toLowerCase();
                        const userName = account.name;
                        
                        console.log('‚úÖ Microsoft login r√©ussi:', userEmail);
                        
                        // Map email to role
                        const userMapping = EMAIL_ROLE_MAP[userEmail];
                        let role, displayName;
                        
                        if (userMapping) {
                            role = userMapping.role;
                            displayName = userMapping.name;
                        } else {
                            // Default: reader pour email @askida.fr non mapp√©s
                            if (userEmail.endsWith('@askida.fr')) {
                                role = 'reader';
                                displayName = userName;
                            } else {
                                throw new Error('Email non autoris√©: ' + userEmail);
                            }
                        }
                        
                        // Save authentication
                        sessionStorage.setItem(AUTH_KEY, 'true');
                        sessionStorage.setItem(USER_KEY, displayName);
                        sessionStorage.setItem(ROLE_KEY, role);
                        sessionStorage.setItem('MS_EMAIL', userEmail);
                        sessionStorage.setItem('MS_AUTH', 'true'); // Flag per Microsoft auth
                        sessionStorage.setItem('auth_method', 'microsoft'); // ‚úÖ v3.0: For calendar sync
                        sessionStorage.setItem('auth_email', userEmail); // ‚úÖ v3.0: For calendar sync
                        
                        // Save account info for token refresh
                        sessionStorage.setItem('MS_ACCOUNT', JSON.stringify({
                            homeAccountId: account.homeAccountId,
                            environment: account.environment,
                            tenantId: account.tenantId,
                            username: account.username
                        }));
                        
                        // Per ingegneri, salva nome per matching con DB
                        if (role === 'engineer') {
                            sessionStorage.setItem('ENGINEER_NAME', displayName);
                        }
                        
                        // Get initial access token for Calendar
                        try {
                            const tokenResponse = await msalInstance.acquireTokenSilent({
                                scopes: LOGIN_SCOPES,
                                account: account
                            });
                            msalAccessToken = tokenResponse.accessToken;
                            sessionStorage.setItem('MS_ACCESS_TOKEN', msalAccessToken);
                            console.log('‚úÖ Access token acquis');
                        } catch (tokenError) {
                            console.warn('‚ö†Ô∏è Token acquisition √©chou√©e:', tokenError);
                        }
                        
                        // Success screen
                        const roleIcon = role === 'admin' ? 'üëë' : (role === 'reader' ? 'üëÅÔ∏è' : 'üë∑');
                        
                        document.body.innerHTML = `
                            <div style="
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: linear-gradient(135deg, #e61252 0%, #c10f47 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, sans-serif;
                            ">
                                <div style="text-align: center; color: white;">
                                    <div style="font-size: 80px; margin-bottom: 20px;">‚úÖ</div>
                                    <h1 style="font-size: 2em; font-weight: 700; margin-bottom: 10px;">Connexion r√©ussie!</h1>
                                    <p style="font-size: 1.2em; opacity: 0.9; margin-bottom: 10px;">Bienvenue ${roleIcon} ${displayName}</p>
                                    <p style="font-size: 0.9em; opacity: 0.7; margin-bottom: 10px;">${userEmail}</p>
                                    <p style="font-size: 1em; opacity: 0.8;">Chargement de ${role === 'engineer' ? 'vos projets' : 'l\'application'}...</p>
                                </div>
                            </div>
                        `;
                        
                        // Reload
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                        
                    } catch (error) {
                        console.error('‚ùå Microsoft login √©chou√©:', error);
                        
                        if (errorMsg) {
                            errorMsg.style.display = 'block';
                            if (error.message.includes('non autoris√©')) {
                                errorMsg.innerHTML = '‚ùå Email non autoris√©<br><small style="font-size: 0.8em;">Utilisez un compte @askida.fr</small>';
                            } else if (error.errorCode === 'user_cancelled') {
                                errorMsg.textContent = '‚ùå Connexion annul√©e';
                            } else {
                                errorMsg.innerHTML = '‚ùå Erreur de connexion Microsoft<br><small style="font-size: 0.8em;">Utilisez la connexion classique ci-dessous</small>';
                            }
                        }
                        if (loadingMsg) loadingMsg.style.display = 'none';
                        if (microsoftBtn) microsoftBtn.disabled = false;
                    }
                };
                
                // Get or refresh Microsoft Graph access token
                window.getMicrosoftAccessToken = async function() {
                    // Check if already have valid token
                    const savedToken = sessionStorage.getItem('MS_ACCESS_TOKEN');
                    if (savedToken && msalAccessToken) {
                        return msalAccessToken;
                    }
                    
                    // Try to get new token silently
                    try {
                        const accountInfo = JSON.parse(sessionStorage.getItem('MS_ACCOUNT') || '{}');
                        const accounts = msalInstance.getAllAccounts();
                        const account = accounts.find(acc => acc.homeAccountId === accountInfo.homeAccountId) || accounts[0];
                        
                        if (!account) {
                            throw new Error('No account found');
                        }
                        
                        const tokenResponse = await msalInstance.acquireTokenSilent({
                            scopes: LOGIN_SCOPES,
                            account: account
                        });
                        
                        msalAccessToken = tokenResponse.accessToken;
                        sessionStorage.setItem('MS_ACCESS_TOKEN', msalAccessToken);
                        return msalAccessToken;
                        
                    } catch (error) {
                        console.error('‚ùå Token refresh failed:', error);
                        // Fallback: try interactive
                        try {
                            const tokenResponse = await msalInstance.acquireTokenPopup({
                                scopes: LOGIN_SCOPES
                            });
                            msalAccessToken = tokenResponse.accessToken;
                            sessionStorage.setItem('MS_ACCESS_TOKEN', msalAccessToken);
                            return msalAccessToken;
                        } catch (popupError) {
                            console.error('‚ùå Token popup failed:', popupError);
                            return null;
                        }
                    }
                };
                
                // üìÖ CALENDAR SYNC FUNCTIONS (v3.0)
                
                // Create Teams calendar event for engineer
                window.createTeamsCalendarEvent = async function(engineerEmail, project, allocation) {
                    try {
                        const token = await getMicrosoftAccessToken();
                        if (!token) {
                            console.warn('‚ö†Ô∏è No access token, calendar sync skipped');
                            return null;
                        }
                        
                        const event = {
                            subject: `üìÅ [Ingetool] ${project.name}`,
                            body: {
                                contentType: "HTML",
                                content: `
                                    <h3>Projet: ${project.name}</h3>
                                    <p><strong>Jours allou√©s:</strong> ${allocation}j</p>
                                    <p><strong>Description:</strong> ${project.description || 'N/A'}</p>
                                    <p><strong>Statut:</strong> ${project.status}</p>
                                    <hr>
                                    <p><a href="${window.location.href}">Ouvrir dans Ingetool</a></p>
                                `
                            },
                            start: {
                                dateTime: project.startDate + "T09:00:00",
                                timeZone: "Europe/Paris"
                            },
                            end: {
                                dateTime: project.endDate + "T18:00:00",
                                timeZone: "Europe/Paris"
                            },
                            isAllDay: false,
                            showAs: "tentative",
                            categories: ["Ingetool", "Projet"],
                            reminderMinutesBeforeStart: 1440 // 1 day
                        };
                        
                        const response = await fetch(
                            `https://graph.microsoft.com/v1.0/users/${engineerEmail}/events`,
                            {
                                method: "POST",
                                headers: {
                                    "Authorization": `Bearer ${token}`,
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(event)
                            }
                        );
                        
                        if (!response.ok) {
                            const error = await response.json();
                            console.error('‚ùå Calendar event creation failed:', error);
                            return null;
                        }
                        
                        const createdEvent = await response.json();
                        console.log('‚úÖ Calendar event created:', createdEvent.id);
                        return createdEvent.id;
                        
                    } catch (error) {
                        console.error('‚ùå createTeamsCalendarEvent error:', error);
                        return null;
                    }
                };
                
                // Update Teams calendar event
                window.updateTeamsCalendarEvent = async function(engineerEmail, eventId, project, allocation) {
                    try {
                        const token = await getMicrosoftAccessToken();
                        if (!token || !eventId) {
                            return false;
                        }
                        
                        const updateData = {
                            subject: `üìÅ [Ingetool] ${project.name}`,
                            body: {
                                contentType: "HTML",
                                content: `
                                    <h3>Projet: ${project.name}</h3>
                                    <p><strong>Jours allou√©s:</strong> ${allocation}j</p>
                                    <p><strong>Description:</strong> ${project.description || 'N/A'}</p>
                                    <p><strong>Statut:</strong> ${project.status}</p>
                                    <hr>
                                    <p><a href="${window.location.href}">Ouvrir dans Ingetool</a></p>
                                `
                            },
                            start: {
                                dateTime: project.startDate + "T09:00:00",
                                timeZone: "Europe/Paris"
                            },
                            end: {
                                dateTime: project.endDate + "T18:00:00",
                                timeZone: "Europe/Paris"
                            }
                        };
                        
                        const response = await fetch(
                            `https://graph.microsoft.com/v1.0/users/${engineerEmail}/events/${eventId}`,
                            {
                                method: "PATCH",
                                headers: {
                                    "Authorization": `Bearer ${token}`,
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify(updateData)
                            }
                        );
                        
                        if (!response.ok) {
                            console.error('‚ùå Calendar event update failed');
                            return false;
                        }
                        
                        console.log('‚úÖ Calendar event updated:', eventId);
                        return true;
                        
                    } catch (error) {
                        console.error('‚ùå updateTeamsCalendarEvent error:', error);
                        return false;
                    }
                };
                
                // Delete Teams calendar event
                window.deleteTeamsCalendarEvent = async function(engineerEmail, eventId) {
                    try {
                        const token = await getMicrosoftAccessToken();
                        if (!token || !eventId) {
                            return false;
                        }
                        
                        const response = await fetch(
                            `https://graph.microsoft.com/v1.0/users/${engineerEmail}/events/${eventId}`,
                            {
                                method: "DELETE",
                                headers: {
                                    "Authorization": `Bearer ${token}`
                                }
                            }
                        );
                        
                        if (!response.ok && response.status !== 404) {
                            console.error('‚ùå Calendar event deletion failed');
                            return false;
                        }
                        
                        console.log('‚úÖ Calendar event deleted:', eventId);
                        return true;
                        
                    } catch (error) {
                        console.error('‚ùå deleteTeamsCalendarEvent error:', error);
                        return false;
                    }
                };
                
                // Blocca l'esecuzione del resto della pagina
                throw new Error('Authentication required');
            }
        })();
    </script>
    
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Icone
        const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Trash2 = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Edit2 = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const Check = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;
        const X = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Calendar = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Users = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const Briefcase = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const UserCog = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/></svg>;
        const Package = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>;
        const Download = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Bell = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>;
        const Search = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Filter = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const TrendingUp = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const BarChart = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>;
        const Menu = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
        const FileText = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const Database = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
        const Upload = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const User = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const AlertTriangle = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const Settings = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.2-13.2L15 8m-6 3-2.2-2.2M1 12h6m6 0h6M4.8 19.2L7 17m10 0 2.2 2.2M4.8 4.8L7 7m10 0 2.2-2.2"/></svg>;

        window.storage = {
            async get(key) {
                const value = localStorage.getItem(key);
                return value ? { key, value } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value };
            }
        };

        function ProjectManager() {
          const [projects, setProjects] = useState([]);
          const [engineers, setEngineers] = useState([]);
          const [resources, setResources] = useState([]);
          const [genericResources, setGenericResources] = useState([]);
          const [projectManagers, setProjectManagers] = useState([]);
          const [activeTab, setActiveTab] = useState('projects');
          const [showProjectForm, setShowProjectForm] = useState(false);
          const [showEngineerForm, setShowEngineerForm] = useState(false);
          const [showResourceForm, setShowResourceForm] = useState(false);
          const [showGenericResourceForm, setShowGenericResourceForm] = useState(false);
          const [showPMForm, setShowPMForm] = useState(false);
          const [editingProject, setEditingProject] = useState(null);
          const [editingEngineer, setEditingEngineer] = useState(null);
          const [editingResource, setEditingResource] = useState(null);
          const [editingGenericResource, setEditingGenericResource] = useState(null);
          const [editingPM, setEditingPM] = useState(null);
          const [formData, setFormData] = useState({
            name: '', status: 'probable', description: '',
            selectedEngineers: [], selectedResources: [], selectedGenericResources: [],
            engineerDays: {}, resourceDays: {}, genericResourceDays: {},
            engineerMonthlyAllocation: {}, resourceMonthlyAllocation: {}, genericResourceMonthlyAllocation: {},
            engineerActualAllocation: {}, // üìä CRA: Allocation r√©elle saisie par engineers
            projectManager: '', startDate: '', endDate: '',
            tags: { client: [], type: [], priority: [] }
          });
          const [engineerForm, setEngineerForm] = useState({ 
            name: '', 
            email: '',
            specialty: '', specialty2: '', specialty3: '', specialty4: '',
            maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: [],
            syncToTeamsCalendar: true // v3.0: Sync calendrier par d√©faut
          });
          const [expandedUnavailability, setExpandedUnavailability] = useState(new Set());
          const [resourceForm, setResourceForm] = useState({ 
            name: '', type: '',
            maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
          });
          const [genericResourceForm, setGenericResourceForm] = useState({ 
            name: '', type: '',
            maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
          });
          const [pmForm, setPMForm] = useState({ name: '', department: '' });
          const [filterStatus, setFilterStatus] = useState('all');
          const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
          const [filterCalendarStatus, setFilterCalendarStatus] = useState('all');
          const [selectedDayProjects, setSelectedDayProjects] = useState(null);
          const [showDayModal, setShowDayModal] = useState(false);
          const [timelineQuarter, setTimelineQuarter] = useState(Math.floor(new Date().getMonth() / 3));
          const [timelineYear, setTimelineYear] = useState(new Date().getFullYear());
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
          const [showBackupModal, setShowBackupModal] = useState(false);
          const [swipeStart, setSwipeStart] = useState(null);
          const [swipedProject, setSwipedProject] = useState(null);
          const [selectedResourceId, setSelectedResourceId] = useState('');
          const [resourceViewQuarter, setResourceViewQuarter] = useState(Math.floor(new Date().getMonth() / 3));
          const [resourceViewYear, setResourceViewYear] = useState(new Date().getFullYear());
          
          // üìà Gantt Interattivo Stati
          const [ganttZoom, setGanttZoom] = useState(1); // 0.5 = 6 mesi, 1 = 3 mesi, 2 = 1.5 mesi
          
          // üïê Auto-logout Stati
          const [showInactivityWarning, setShowInactivityWarning] = useState(false);
          const [inactivityTimeLeft, setInactivityTimeLeft] = useState(5); // Minuti rimasti
          const [ganttViewMonths, setGanttViewMonths] = useState(3);
          const [ganttStartMonth, setGanttStartMonth] = useState(new Date().getMonth());
          const [ganttStartYear, setGanttStartYear] = useState(new Date().getFullYear());
          const [draggedProject, setDraggedProject] = useState(null);
          const [dragStartX, setDragStartX] = useState(0);
          const [dragStartDate, setDragStartDate] = useState(null);
          const [resizingProject, setResizingProject] = useState(null);
          const [resizingSide, setResizingSide] = useState(null); // 'start' o 'end'
          const [hoveredProject, setHoveredProject] = useState(null);
          const [resourceViewMode, setResourceViewMode] = useState('quarter');
          const [showConflictModal, setShowConflictModal] = useState(false);
          const [conflictToResolve, setConflictToResolve] = useState(null);
          
          // üìÖ NUOVI STATI - CALENDARIO AVANZATO
          const [calendarView, setCalendarView] = useState('month'); // 'day', 'week', 'month', 'quarter', 'year'
          const [selectedDate, setSelectedDate] = useState(new Date());
          const [holidays, setHolidays] = useState([]); // Festivit√† configurabili
          const [showHolidayModal, setShowHolidayModal] = useState(false);
          const [holidayForm, setHolidayForm] = useState({ date: '', name: '' });
          
          // üë• NUOVI STATI - DISPONIBILIT√Ä RISORSE
          const [showUnavailabilityModal, setShowUnavailabilityModal] = useState(false);
          const [unavailabilityForm, setUnavailabilityForm] = useState({
            resourceId: null, resourceType: '', // 'engineer', 'resource', 'genericResource'
            startDate: '', endDate: '', type: 'vacation', reason: '', // type: 'vacation', 'sick', 'training', 'other'
            recurring: false, // true se ricorrente
            recurrencePattern: 'weekly', // 'weekly', 'monthly', 'yearly'
            weekday: 1, // 0=Dim, 1=Lun, 2=Mar, 3=Mer, 4=Jeu, 5=Ven, 6=Sam
            dayOfMonth: 1 // Per monthly: 1-31
          });
          const [selectedResourceForConfig, setSelectedResourceForConfig] = useState(null);
          const [showResourceConfigModal, setShowResourceConfigModal] = useState(false);
          
          // üìä NUOVI STATI - MULTI-CALENDARIO COMPARATIVO
          const [multiCalendarResources, setMultiCalendarResources] = useState([]); // Array di {id, type}
          const [showMultiCalendar, setShowMultiCalendar] = useState(false);
          
          // Stati per calendario interattivo risoluzione conflitti (sistema allocazione giorni)
          const [conflictCalendarMode, setConflictCalendarMode] = useState(null); // 'project1' | 'project2' | null
          const [conflictSelectedDays, setConflictSelectedDays] = useState({
            project1: {}, // { '2025-11-28': 1.0, '2025-11-29': 0.5, ... }
            project2: {}
          });
          const [conflictRangeStart, setConflictRangeStart] = useState('');
          const [conflictRangeEnd, setConflictRangeEnd] = useState('');
          const [conflictRangeWorkdaysOnly, setConflictRangeWorkdaysOnly] = useState(true);
          const [conflictCalendarMonth, setConflictCalendarMonth] = useState(new Date());
          
          // Stato per r√©solution par priorit√©
          const [priorityProject, setPriorityProject] = useState(null); // 'project1' | 'project2' | null
          
          // üìä NUOVI STATI - CRA (Compte Rendu d'Activit√©)
          const [craSelectedMonth, setCraSelectedMonth] = useState(new Date().getMonth());
          const [craSelectedYear, setCraSelectedYear] = useState(new Date().getFullYear());
          const [craSelectedProject, setCraSelectedProject] = useState('all');
          const [showCRAPDFModal, setShowCRAPDFModal] = useState(false);
          const [craPDFData, setCraPDFData] = useState([]);
          const [craPDFComments, setCraPDFComments] = useState({});
          const [craExportType, setCraExportType] = useState('pdf'); // 'pdf' ou 'excel'
          
          // üìä STATI - STATISTICHE (Admin only)
          const [statsSelectedEngineer, setStatsSelectedEngineer] = useState('all');
          const [statsSelectedMonth, setStatsSelectedMonth] = useState(new Date().getMonth());
          const [statsSelectedYear, setStatsSelectedYear] = useState(new Date().getFullYear());
          const [dashboardView, setDashboardView] = useState('dashboard'); // 'dashboard', 'individuel', 'clients', 'heatmap'
          const [editingActualHours, setEditingActualHours] = useState(null); // {projectId, date}
          const [showCRACalendar, setShowCRACalendar] = useState(false);
          const [craCalendarMonth, setCraCalendarMonth] = useState(new Date().getMonth());
          const [craCalendarYear, setCraCalendarYear] = useState(new Date().getFullYear());
          const [craEditingDate, setCraEditingDate] = useState(null); // {projectId, date, planned, actual}
          
          // Stati per sistema intelligente gestione conflitti
          const [showConflictWarningModal, setShowConflictWarningModal] = useState(false);
          const [conflictWarningData, setConflictWarningData] = useState(null); // { days: {}, affectedProjects: [], currentProject: null }
          const [pendingAllocationAction, setPendingAllocationAction] = useState(null); // funzione da eseguire dopo conferma
          
          const [showDeleteWarning, setShowDeleteWarning] = useState(false);
          const [resourceToDelete, setResourceToDelete] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [advancedFilters, setAdvancedFilters] = useState({ dateStart: '', dateEnd: '', resourceId: '', pmId: '', tags: [] });
          const [showAlerts, setShowAlerts] = useState(false);
          const [availableTags, setAvailableTags] = useState({
            client: [],
            type: ['POC', 'Upgrade', 'Deploy', 'Workflow', 'Consultancy', 'Day2Day'],
            priority: ['P0', 'P1', 'P2']
          });
          
          // Stati per utente e ruolo
          const [currentUser, setCurrentUser] = useState(sessionStorage.getItem('askida_current_user') || 'admin');
          const [userRole, setUserRole] = useState(sessionStorage.getItem('askida_user_role') || 'admin');
          const [currentEngineerId, setCurrentEngineerId] = useState(
            sessionStorage.getItem('ENGINEER_ID') ? parseInt(sessionStorage.getItem('ENGINEER_ID')) : null
          );
          
          // üîß Effetto per matchare nome ingegnere con ID dal database
          useEffect(() => {
            if (!currentEngineerId && engineers.length > 0) {
              // Per Engineer: usa ENGINEER_NAME
              // Per Admin: usa currentUser (se corrisponde a un engineer)
              const nameToMatch = isEngineer 
                ? sessionStorage.getItem('ENGINEER_NAME')
                : currentUser; // Admin name
              
              console.log('üîç CRA Access Debug:', {
                isEngineer,
                isAdmin,
                currentUser,
                nameToMatch,
                engineersCount: engineers.length,
                engineerNames: engineers.map(e => e.name)
              });
              
              if (nameToMatch) {
                const matchedEngineer = engineers.find(e => e.name === nameToMatch);
                if (matchedEngineer) {
                  console.log('‚úÖ Matched engineer:', nameToMatch, '‚Üí ID:', matchedEngineer.id);
                  setCurrentEngineerId(matchedEngineer.id);
                  sessionStorage.setItem('ENGINEER_ID', matchedEngineer.id.toString());
                } else {
                  if (isEngineer) {
                    console.warn('‚ö†Ô∏è Engineer not found in database:', nameToMatch);
                  } else {
                    console.log('‚ÑπÔ∏è Admin name does not match any engineer:', nameToMatch);
                  }
                }
              }
            }
          }, [engineers, isEngineer, currentEngineerId, currentUser, isAdmin]);
          
          const isReadOnly = userRole === 'reader';
          const isEngineer = userRole === 'engineer';
          const isAdmin = userRole === 'admin';
          
          // CRA Access: Engineers OU Admin avec engineerId associ√©
          const hasCRAAccess = isEngineer || (isAdmin && currentEngineerId);
          
          // Filtra progetti visibili per ingegneri (solo i loro progetti)
          const getVisibleProjects = () => {
            let filtered = projects;
            
            // Engineer vede solo i suoi progetti
            if (isEngineer && currentEngineerId) {
              filtered = projects.filter(p => 
                p.selectedEngineers && p.selectedEngineers.includes(currentEngineerId)
              );
            }
            
            // Non-admin non vedono Place Holder
            if (!isAdmin) {
              filtered = filtered.filter(p => p.status !== 'presente');
            }
            
            return filtered;
          };
          
          const visibleProjects = getVisibleProjects();
          
          // Stati per OneDrive/SharePoint
          const [isOneDriveConnected, setIsOneDriveConnected] = useState(false);
          const [isOneDriveReady, setIsOneDriveReady] = useState(true); // Usato per mostrare/nascondere banner connessione
          const [isSyncing, setIsSyncing] = useState(false);
          const [lastSyncTime, setLastSyncTime] = useState(null);
          const [syncStatus, setSyncStatus] = useState(''); // 'saving', 'saved', 'error'
          const [oneDriveError, setOneDriveError] = useState(null);
          const [oneDriveAccessToken, setOneDriveAccessToken] = useState(null);
          const [oneDriveFolderPath, setOneDriveFolderPath] = useState(null); // Path dynamique du dossier Ingetool-Data
          const [sharePointSiteId, setSharePointSiteId] = useState(null); // ID du site SharePoint
          
          // Configuration SharePoint/Microsoft Graph
          // ‚úÖ CONFIGUR√â avec vos valeurs Azure AD + SharePoint + GitHub Pages
          const ONEDRIVE_CLIENT_ID = '0ded32a8-75de-48dc-b866-11cce4a18c99';
          const ONEDRIVE_TENANT_ID = '51b9c03e-2025-4f37-8526-8d499718a398';
          
          // üîê MSAL Configuration for Microsoft Authentication (v3.0)
          const MSAL_CONFIG = {
            auth: {
              clientId: ONEDRIVE_CLIENT_ID, // R√©utilise la m√™me app Azure AD
              authority: `https://login.microsoftonline.com/${ONEDRIVE_TENANT_ID}`,
              redirectUri: 'https://giordanoaskida.github.io/ingetool/' // ‚úÖ URI EXACT
            },
            cache: {
              cacheLocation: 'sessionStorage',
              storeAuthStateInCookie: false
            }
          };
          
          // üìß Email to Role Mapping (v3.0)
          const EMAIL_ROLE_MAP = {
            // Admins
            'admin@askida.fr': 'admin',
            'giordano.morelli@askida.fr': 'admin',
            
            // Engineers (ajuster avec vrais emails Askida)
            'alexandre.bouton@askida.fr': 'engineer',
            'victor.drieu@askida.fr': 'engineer',
            'manuel.irniger@askida.fr': 'engineer',
            'malek.mizouri@askida.fr': 'engineer',
            'maher.nacheb@askida.fr': 'engineer',
            'denis.perez@askida.fr': 'engineer',
            'farid.radi@askida.fr': 'engineer',
            'raphael.recamier@askida.fr': 'engineer',
            'marc.rouillet@askida.fr': 'engineer',
            'bastien.doublet@askida.fr': 'engineer',
            'jeanpaul.cardo@askida.fr': 'engineer',
            'etienne.julien@askida.fr': 'engineer',
            'kyllian.chesnel@askida.fr': 'engineer',
            
            // Readers
            'read@askida.fr': 'reader'
          };
          
          // üîê Helper function: check if email is valid Askida email
          function isValidAskidaEmail(email) {
            return email && email.toLowerCase().endsWith('@askida.fr');
          }
          
          // üîê Helper function: get role from email (with fallback)
          function getRoleFromEmail(email) {
            const normalizedEmail = email.toLowerCase();
            
            // Check exact match first
            if (EMAIL_ROLE_MAP[normalizedEmail]) {
              return EMAIL_ROLE_MAP[normalizedEmail];
            }
            
            // If @askida.fr but not in map ‚Üí default to 'engineer'
            if (isValidAskidaEmail(normalizedEmail)) {
              console.log(`üìß Email ${normalizedEmail} not in map, defaulting to engineer role`);
              return 'engineer';
            }
            
            // Not @askida.fr ‚Üí reader role (restricted access)
            return 'reader';
          }
          
          // Initialize MSAL instance
          let msalInstance = null;
          try {
            msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);
          } catch (error) {
            console.warn('‚ö†Ô∏è MSAL not available, fallback to classic login');
          }
          
          // üîê Microsoft Authentication Functions (v3.0)
          async function loginWithMicrosoft() {
            if (!msalInstance) {
              alert('‚ùå Authentification Microsoft non disponible.\n\nUtilisez le login classique.');
              return false;
            }
            
            // Show loading
            const loadingMsg = document.getElementById('loadingMessage');
            const errorMsg = document.getElementById('errorMessage');
            const microsoftBtn = document.getElementById('microsoftLoginBtn');
            
            if (loadingMsg) loadingMsg.style.display = 'block';
            if (errorMsg) errorMsg.style.display = 'none';
            if (microsoftBtn) microsoftBtn.disabled = true;
            
            try {
              const loginRequest = {
                scopes: [
                  'User.Read',
                  'Calendars.ReadWrite'
                ]
              };
              
              const loginResponse = await msalInstance.loginPopup(loginRequest);
              
              if (loginResponse && loginResponse.account) {
                const userEmail = loginResponse.account.username.toLowerCase();
                const userName = loginResponse.account.name;
                
                // Validate email domain
                if (!isValidAskidaEmail(userEmail)) {
                  if (loadingMsg) loadingMsg.style.display = 'none';
                  if (microsoftBtn) microsoftBtn.disabled = false;
                  if (errorMsg) {
                    errorMsg.textContent = `‚ùå Email non autoris√©: ${userEmail}\n\nUtilisez un compte @askida.fr`;
                    errorMsg.style.display = 'block';
                  }
                  console.error('‚ùå Microsoft login √©chou√©: Email non autoris√©:', userEmail);
                  return false;
                }
                
                // Determine role from email
                const userRole = getRoleFromEmail(userEmail);
                
                // Save auth state
                sessionStorage.setItem(AUTH_KEY, 'true');
                sessionStorage.setItem(USER_KEY, userName);
                sessionStorage.setItem(ROLE_KEY, userRole);
                sessionStorage.setItem('auth_email', userEmail);
                sessionStorage.setItem('auth_method', 'microsoft');
                sessionStorage.setItem('msal_account_id', loginResponse.account.homeAccountId);
                
                console.log('‚úÖ Microsoft Auth successful:', userName, userRole, userEmail);
                
                // Reload page to load main app
                window.location.reload();
                
                return true;
              }
              
              if (loadingMsg) loadingMsg.style.display = 'none';
              if (microsoftBtn) microsoftBtn.disabled = false;
              return false;
              
            } catch (error) {
              console.error('‚ùå Microsoft login error:', error);
              
              if (loadingMsg) loadingMsg.style.display = 'none';
              if (microsoftBtn) microsoftBtn.disabled = false;
              
              if (error.errorCode === 'user_cancelled') {
                // User closed popup, no alert needed
                return false;
              }
              
              if (errorMsg) {
                errorMsg.textContent = '‚ùå Erreur connexion Microsoft. Essayez le login classique.';
                errorMsg.style.display = 'block';
              }
              
              return false;
            }
          }
          
          async function getMicrosoftAccessToken() {
            if (!msalInstance) return null;
            
            try {
              const accounts = msalInstance.getAllAccounts();
              if (accounts.length === 0) return null;
              
              const silentRequest = {
                scopes: ['User.Read', 'Calendars.ReadWrite'],
                account: accounts[0]
              };
              
              const response = await msalInstance.acquireTokenSilent(silentRequest);
              return response.accessToken;
              
            } catch (error) {
              console.warn('‚ö†Ô∏è Silent token acquisition failed:', error);
              
              try {
                const interactiveRequest = {
                  scopes: ['User.Read', 'Calendars.ReadWrite']
                };
                const response = await msalInstance.acquireTokenPopup(interactiveRequest);
                return response.accessToken;
              } catch (interactiveError) {
                console.error('‚ùå Token acquisition failed:', interactiveError);
                return null;
              }
            }
          }
          
          function logoutMicrosoft() {
            if (!msalInstance) return;
            
            try {
              const accounts = msalInstance.getAllAccounts();
              if (accounts.length > 0) {
                msalInstance.logoutPopup({
                  account: accounts[0]
                });
              }
            } catch (error) {
              console.warn('‚ö†Ô∏è Logout error:', error);
            }
          }
          
          // üìÖ Teams Calendar Sync Functions (v3.0)
          async function createTeamsCalendarEvent(engineer, project) {
            // Check if sync enabled for this engineer
            if (!engineer.syncToTeamsCalendar) {
              console.log(`‚è≠Ô∏è Calendar sync disabled for ${engineer.name}`);
              return null;
            }
            
            // Get access token
            const accessToken = await getMicrosoftAccessToken();
            if (!accessToken) {
              console.warn('‚ö†Ô∏è No access token for calendar sync');
              return null;
            }
            
            // Get engineer email
            const engineerEmail = engineer.email;
            if (!engineerEmail) {
              console.warn(`‚ö†Ô∏è No email for ${engineer.name}`);
              return null;
            }
            
            try {
              const days = project.engineerDays?.[engineer.id] || 0;
              const pmName = getProjectManager(project)?.name || 'N/A';
              
              const event = {
                subject: `üìÅ [Ingetool] ${project.name}`,
                body: {
                  contentType: "HTML",
                  content: `
                    <h3>Projet: ${project.name}</h3>
                    <p><strong>Chef de projet:</strong> ${pmName}</p>
                    <p><strong>Jours allou√©s:</strong> ${days}j</p>
                    <p><strong>Description:</strong> ${project.description || 'N/A'}</p>
                    <p><strong>Statut:</strong> Programm√©</p>
                    <hr>
                    <p><a href="${window.location.href}">üì± Ouvrir dans Ingetool</a></p>
                  `
                },
                start: {
                  dateTime: project.startDate + "T09:00:00",
                  timeZone: "Europe/Paris"
                },
                end: {
                  dateTime: project.endDate + "T18:00:00",
                  timeZone: "Europe/Paris"
                },
                isAllDay: false,
                showAs: "tentative",
                categories: ["Ingetool", "Projet"],
                reminderMinutesBeforeStart: 1440
              };
              
              const response = await fetch(
                `https://graph.microsoft.com/v1.0/users/${engineerEmail}/events`,
                {
                  method: "POST",
                  headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify(event)
                }
              );
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå Calendar event creation failed for ${engineer.name}:`, errorText);
                return null;
              }
              
              const createdEvent = await response.json();
              console.log(`‚úÖ Calendar event created for ${engineer.name}:`, createdEvent.id);
              
              return createdEvent.id;
              
            } catch (error) {
              console.error(`‚ùå Error creating calendar event for ${engineer.name}:`, error);
              return null;
            }
          }
          
          async function updateTeamsCalendarEvent(engineer, project, eventId) {
            if (!engineer.syncToTeamsCalendar || !eventId) return false;
            
            const accessToken = await getMicrosoftAccessToken();
            if (!accessToken || !engineer.email) return false;
            
            try {
              const days = project.engineerDays?.[engineer.id] || 0;
              const pmName = getProjectManager(project)?.name || 'N/A';
              
              const updateData = {
                subject: `üìÅ [Ingetool] ${project.name}`,
                body: {
                  contentType: "HTML",
                  content: `
                    <h3>Projet: ${project.name}</h3>
                    <p><strong>Chef de projet:</strong> ${pmName}</p>
                    <p><strong>Jours allou√©s:</strong> ${days}j</p>
                    <p><strong>Description:</strong> ${project.description || 'N/A'}</p>
                    <p><strong>Statut:</strong> Programm√©</p>
                    <hr>
                    <p><a href="${window.location.href}">üì± Ouvrir dans Ingetool</a></p>
                  `
                },
                start: {
                  dateTime: project.startDate + "T09:00:00",
                  timeZone: "Europe/Paris"
                },
                end: {
                  dateTime: project.endDate + "T18:00:00",
                  timeZone: "Europe/Paris"
                }
              };
              
              const response = await fetch(
                `https://graph.microsoft.com/v1.0/users/${engineer.email}/events/${eventId}`,
                {
                  method: "PATCH",
                  headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify(updateData)
                }
              );
              
              if (!response.ok) {
                console.error(`‚ùå Calendar event update failed for ${engineer.name}`);
                return false;
              }
              
              console.log(`‚úÖ Calendar event updated for ${engineer.name}`);
              return true;
              
            } catch (error) {
              console.error(`‚ùå Error updating calendar event for ${engineer.name}:`, error);
              return false;
            }
          }
          
          async function deleteTeamsCalendarEvent(engineer, eventId) {
            if (!eventId || !engineer.email) return false;
            
            const accessToken = await getMicrosoftAccessToken();
            if (!accessToken) return false;
            
            try {
              const response = await fetch(
                `https://graph.microsoft.com/v1.0/users/${engineer.email}/events/${eventId}`,
                {
                  method: "DELETE",
                  headers: {
                    "Authorization": `Bearer ${accessToken}`
                  }
                }
              );
              
              if (!response.ok && response.status !== 404) {
                console.error(`‚ùå Calendar event deletion failed for ${engineer.name}`);
                return false;
              }
              
              console.log(`‚úÖ Calendar event deleted for ${engineer.name}`);
              return true;
              
            } catch (error) {
              console.error(`‚ùå Error deleting calendar event for ${engineer.name}:`, error);
              return false;
            }
          }
          
          // üìÖ Project Calendar Sync Manager (v3.0)
          async function syncProjectToCalendars(project, oldProject = null) {
            // Only sync if status is "Programm√©"
            if (project.status !== 'programme') {
              // If was Programm√© before, delete events
              if (oldProject && oldProject.status === 'programme') {
                await deleteProjectCalendarEvents(oldProject);
              }
              return;
            }
            
            // Check if auth method is Microsoft
            const authMethod = sessionStorage.getItem('auth_method');
            if (authMethod !== 'microsoft') {
              console.log('‚è≠Ô∏è Calendar sync requires Microsoft login');
              return;
            }
            
            // Initialize calendarEvents if not exists
            if (!project.calendarEvents) {
              project.calendarEvents = {};
            }
            
            const selectedEngineers = project.selectedEngineers || [];
            let createdCount = 0;
            let updatedCount = 0;
            
            for (const engId of selectedEngineers) {
              const engineer = engineers.find(e => e.id === engId);
              if (!engineer) continue;
              
              const existingEventId = project.calendarEvents[engId];
              
              if (existingEventId && oldProject) {
                // Update existing event
                const success = await updateTeamsCalendarEvent(engineer, project, existingEventId);
                if (success) updatedCount++;
              } else {
                // Create new event
                const eventId = await createTeamsCalendarEvent(engineer, project);
                if (eventId) {
                  project.calendarEvents[engId] = eventId;
                  createdCount++;
                }
              }
            }
            
            // Delete events for engineers removed from project
            if (oldProject && oldProject.calendarEvents) {
              const removedEngineers = (oldProject.selectedEngineers || []).filter(
                id => !selectedEngineers.includes(id)
              );
              
              for (const engId of removedEngineers) {
                const eventId = oldProject.calendarEvents[engId];
                if (eventId) {
                  const engineer = engineers.find(e => e.id === engId);
                  if (engineer) {
                    await deleteTeamsCalendarEvent(engineer, eventId);
                  }
                  delete project.calendarEvents[engId];
                }
              }
            }
            
            if (createdCount > 0 || updatedCount > 0) {
              console.log(`‚úÖ Calendar sync: ${createdCount} cr√©√©s, ${updatedCount} mis √† jour`);
            }
          }
          
          async function deleteProjectCalendarEvents(project) {
            if (!project.calendarEvents) return;
            
            for (const [engId, eventId] of Object.entries(project.calendarEvents)) {
              const engineer = engineers.find(e => e.id === parseInt(engId));
              if (engineer && eventId) {
                await deleteTeamsCalendarEvent(engineer, eventId);
              }
            }
            
            project.calendarEvents = {};
          }
          const ONEDRIVE_REDIRECT_URI = 'https://giordanoaskida.github.io/ingetool/';
          const ONEDRIVE_SCOPES = 'https://graph.microsoft.com/Files.ReadWrite https://graph.microsoft.com/Sites.ReadWrite.All https://graph.microsoft.com/User.Read';
          const ONEDRIVE_FILE_NAME = 'askida-ingetool-data.json';
          
          // Configuration SharePoint Site
          const SHAREPOINT_SITE_URL = 'https://askida.sharepoint.com/sites/Engineering2';
          const SHAREPOINT_HOSTNAME = 'askida.sharepoint.com';
          const SHAREPOINT_SITE_PATH = '/sites/Engineering2';
          const SHAREPOINT_FOLDER_NAME = 'Ingetool-Data';
          
          // √âtats pour allocation mensuelle d√©taill√©e
          const [showMonthlyAllocationModal, setShowMonthlyAllocationModal] = useState(false);
          const [monthlyAllocationData, setMonthlyAllocationData] = useState({
            resourceId: null,
            resourceName: '',
            resourceType: null,
            totalDays: 0,
            selectedDates: {} // Oggetto: { '2026-01-05': 1.0, '2026-01-12': 0.5, ... } (0.5 = mezza giornata, 1.0 = giornata intera)
          });
          
          // Stati per selezione range date
          const [rangeStartDate, setRangeStartDate] = useState('');
          const [rangeEndDate, setRangeEndDate] = useState('');
          const [rangeWorkdaysOnly, setRangeWorkdaysOnly] = useState(true);
          const [rangeAllocationType, setRangeAllocationType] = useState(1.0); // 0.5 o 1.0


          const statusConfig = {
            'probable': { label: 'Probable', color: 'bg-yellow-100 text-yellow-800', calendarColor: 'bg-yellow-100 text-yellow-800' },
            'presente': { label: 'Place Holder', color: 'bg-blue-100 text-blue-800', calendarColor: 'bg-blue-100 text-blue-800' },
            'programme': { label: 'Programm√©', color: 'bg-green-100 text-green-800', calendarColor: 'bg-green-100 text-green-800' }
          };

          useEffect(() => { loadData(); }, []);
          useEffect(() => {
            if (projects.length > 0 || engineers.length > 0 || resources.length > 0 || genericResources.length > 0 || projectManagers.length > 0 || holidays.length > 0) {
              saveData();
            }
          }, [projects, engineers, resources, genericResources, projectManagers, holidays]);
          
          // üïê Auto-logout per inattivit√† (30 min con warning a 25 min)
          useEffect(() => {
            let inactivityTimer;
            let warningTimer;
            let countdownInterval;
            
            const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minuti
            const WARNING_TIME = 25 * 60 * 1000; // 25 minuti (5 min prima)
            
            const logout = () => {
              // v3.0: Logout Microsoft if logged in with Microsoft
              const authMethod = sessionStorage.getItem('auth_method');
              if (authMethod === 'microsoft') {
                logoutMicrosoft();
              }
              
              sessionStorage.clear();
              window.location.reload();
            };
            
            const resetTimers = () => {
              // Clear existing timers
              clearTimeout(inactivityTimer);
              clearTimeout(warningTimer);
              clearInterval(countdownInterval);
              setShowInactivityWarning(false);
              
              // Set warning timer (25 min)
              warningTimer = setTimeout(() => {
                setShowInactivityWarning(true);
                setInactivityTimeLeft(5);
                
                // Countdown ogni minuto
                countdownInterval = setInterval(() => {
                  setInactivityTimeLeft(prev => {
                    if (prev <= 1) {
                      clearInterval(countdownInterval);
                      return 0;
                    }
                    return prev - 1;
                  });
                }, 60 * 1000); // Ogni minuto
              }, WARNING_TIME);
              
              // Set logout timer (30 min)
              inactivityTimer = setTimeout(logout, INACTIVITY_TIMEOUT);
            };
            
            // Eventi che indicano attivit√†
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            
            activityEvents.forEach(event => {
              document.addEventListener(event, resetTimers);
            });
            
            // Start timers
            resetTimers();
            
            // Cleanup
            return () => {
              clearTimeout(inactivityTimer);
              clearTimeout(warningTimer);
              clearInterval(countdownInterval);
              activityEvents.forEach(event => {
                document.removeEventListener(event, resetTimers);
              });
            };
          }, []);

          const saveData = async () => {
            try {
              const data = { projects, engineers, resources, genericResources, projectManagers, availableTags, holidays };
              await window.storage.set('project-manager-data', JSON.stringify(data));
            } catch (error) { console.log('Erreur'); }
          };

          const loadData = async () => {
            try {
              const result = await window.storage.get('project-manager-data');
              if (result) {
                const data = JSON.parse(result.value);
                
                // Inizializza engineerActualAllocation per progetti vecchi
                const projectsWithCRA = (data.projects || []).map(p => ({
                  ...p,
                  engineerActualAllocation: p.engineerActualAllocation || {}
                }));
                
                setProjects(projectsWithCRA);
                setEngineers(data.engineers || []);
                setResources(data.resources || []);
                setGenericResources(data.genericResources || []);
                setProjectManagers(data.projectManagers || []);
                setHolidays(data.holidays || []);
                if (data.availableTags) {
                  setAvailableTags(data.availableTags);
                }
              }
            } catch (error) { console.log('Pas de donn√©es'); }
          };

          // =====================================================
          // ONEDRIVE FUNCTIONS
          // =====================================================
          
          // Inizializza OneDrive - Gestione token OAuth 2.0
          useEffect(() => {
            console.log('üîµ V√©rification authentification OneDrive...');
            
            // V√©rifie si on a un token dans l'URL (retour de Microsoft login)
            const checkTokenInUrl = () => {
              const hash = window.location.hash;
              
              if (hash && hash.includes('access_token')) {
                console.log('‚úÖ Token trouv√© dans l\'URL!');
                
                // Parse le hash pour extraire le token
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                const expiresIn = params.get('expires_in');
                
                if (accessToken) {
                  console.log('‚úÖ Token OneDrive r√©cup√©r√©!');
                  setOneDriveAccessToken(accessToken);
                  setIsOneDriveConnected(true);
                  setSyncStatus('');
                  
                  // Nettoie l'URL (enl√®ve le hash)
                  window.history.replaceState(null, null, window.location.pathname);
                  
                  // Sauvegarde le token et l'expiration dans sessionStorage
                  sessionStorage.setItem('onedrive_token', accessToken);
                  const expirationTime = Date.now() + (parseInt(expiresIn || '3600') * 1000);
                  sessionStorage.setItem('onedrive_token_expiry', expirationTime.toString());
                  
                  // Charge les donn√©es depuis OneDrive (token explicite = fix timing React)
                  setTimeout(() => loadFromOneDrive(accessToken), 500);
                }
              } else {
                // V√©rifie si on a un token stock√© dans sessionStorage
                const storedToken = sessionStorage.getItem('onedrive_token');
                const tokenExpiry = sessionStorage.getItem('onedrive_token_expiry');
                
                if (storedToken && tokenExpiry) {
                  const expiryTime = parseInt(tokenExpiry);
                  
                  if (Date.now() < expiryTime) {
                    console.log('‚úÖ Token OneDrive valide trouv√© dans sessionStorage');
                    setOneDriveAccessToken(storedToken);
                    setIsOneDriveConnected(true);
                    
                    // Charge les donn√©es depuis OneDrive (token explicite = fix timing React)
                    setTimeout(() => loadFromOneDrive(storedToken), 500);
                  } else {
                    console.log('‚ö†Ô∏è Token OneDrive expir√©');
                    sessionStorage.removeItem('onedrive_token');
                    sessionStorage.removeItem('onedrive_token_expiry');
                  }
                }
              }
            };
            
            checkTokenInUrl();
          }, []);
          
          // Login OneDrive - Redirect vers Microsoft
          const signInOneDrive = async () => {
            try {
              console.log('üîµ Redirection vers Microsoft login...');
              
              // V√©rifie que les config sont d√©finies
              if (ONEDRIVE_CLIENT_ID === 'VOTRE_CLIENT_ID_AZURE' || ONEDRIVE_TENANT_ID === 'VOTRE_TENANT_ID_AZURE') {
                alert('‚ùå Erreur: Configuration OneDrive manquante!\n\nVeuillez configurer CLIENT_ID et TENANT_ID dans le code.');
                setOneDriveError('Configuration OneDrive non d√©finie. Consultez la documentation.');
                return;
              }
              
              // Construction de l'URL d'autorisation Microsoft
              const authUrl = `https://login.microsoftonline.com/${ONEDRIVE_TENANT_ID}/oauth2/v2.0/authorize?` +
                `client_id=${encodeURIComponent(ONEDRIVE_CLIENT_ID)}` +
                `&response_type=token` +
                `&redirect_uri=${encodeURIComponent(ONEDRIVE_REDIRECT_URI)}` +
                `&scope=${encodeURIComponent(ONEDRIVE_SCOPES)}` +
                `&response_mode=fragment`;
              
              // Redirection vers Microsoft
              window.location.href = authUrl;
              
            } catch (error) {
              console.error('‚ùå Erreur login OneDrive:', error);
              alert('‚ùå Erreur de connexion √† OneDrive');
              setOneDriveError('Erreur de connexion: ' + (error.message || 'unknown'));
            }
          };
          
          // Logout OneDrive
          const signOutOneDrive = async () => {
            try {
              // Reset stati
              setIsOneDriveConnected(false);
              setOneDriveAccessToken(null);
              setSyncStatus('');
              setLastSyncTime(null);
              
              // Rimuovi token da sessionStorage
              sessionStorage.removeItem('onedrive_token');
              sessionStorage.removeItem('onedrive_token_expiry');
              
              console.log('‚úÖ D√©connexion OneDrive r√©ussie');
            } catch (error) {
              console.error('‚ùå Erreur d√©connexion OneDrive:', error);
            }
          };
          
          // üè¢ Obtenir ID du site SharePoint
          const getSharePointSiteId = async (explicitToken) => {
            const token = explicitToken || oneDriveAccessToken || sessionStorage.getItem('onedrive_token');
            if (!token) return null;
            
            // Si d√©j√† en cache, retourne
            if (sharePointSiteId) return sharePointSiteId;
            
            try {
              console.log('üè¢ R√©cup√©ration ID du site SharePoint...');
              
              // API pour obtenir site par hostname et path
              const siteUrl = `https://graph.microsoft.com/v1.0/sites/${SHAREPOINT_HOSTNAME}:${SHAREPOINT_SITE_PATH}`;
              console.log('üè¢ URL:', siteUrl);
              
              const response = await fetch(siteUrl, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erreur r√©cup√©ration site:', response.status, errorText);
                throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
              }
              
              const site = await response.json();
              console.log('‚úÖ Site trouv√©:', site.displayName, 'ID:', site.id);
              
              setSharePointSiteId(site.id);
              return site.id;
              
            } catch (error) {
              console.error('‚ùå Erreur getSharePointSiteId:', error);
              return null;
            }
          };
          
          // üîç Recherche dynamique du dossier Ingetool-Data
          const findIngetoolDataFolder = async () => {
            if (!oneDriveAccessToken) return null;
            
            try {
              console.log('üîç Recherche du dossier Ingetool-Data...');
              
              // üêõ SUPER DEBUG: Lista TUTTI i folder nel root
              
              // Strat√©gie 1: Chercher dans root direct
              try {
                const directUrl = 'https://graph.microsoft.com/v1.0/me/drive/root:/Ingetool-Data';
                const directResponse = await fetch(directUrl, {
                  method: 'GET',
                  headers: { 'Authorization': `Bearer ${oneDriveAccessToken}` }
                });
                
                if (directResponse.ok) {
                  const folder = await directResponse.json();
                  const path = folder.parentReference.path.replace('/drive/root:', '') + '/' + folder.name;
                  console.log('‚úÖ Dossier trouv√© dans root:', path);
                  return path;
                }
              } catch (e) {
                console.log('‚ö†Ô∏è Pas trouv√© dans root, recherche dans sharedWithMe...');
              }
              
              // Strat√©gie 2: Chercher dans sharedWithMe
              const sharedUrl = 'https://graph.microsoft.com/v1.0/me/drive/sharedWithMe';
              const sharedResponse = await fetch(sharedUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${oneDriveAccessToken}` }
              });
              
              if (sharedResponse.ok) {
                const data = await sharedResponse.json();
                
                // üêõ SUPER DEBUG: Lista items in sharedWithMe
                
                const folder = data.value.find(item => 
                  item.name === 'Ingetool-Data' || 
                  item.name.includes('Ingetool-Data')
                );
                
                if (folder && folder.parentReference) {
                  const path = folder.parentReference.path.replace('/drive/root:', '') + '/' + folder.name;
                  console.log('‚úÖ Dossier trouv√© dans sharedWithMe:', path);
                  return path;
                }
              }
              
              // Strat√©gie 3: Recherche globale
              const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='Ingetool-Data')`;
              const searchResponse = await fetch(searchUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${oneDriveAccessToken}` }
              });
              
              if (searchResponse.ok) {
                const data = await searchResponse.json();
                const folder = data.value.find(item => 
                  item.folder && 
                  (item.name === 'Ingetool-Data' || item.name.includes('Ingetool-Data'))
                );
                
                if (folder && folder.parentReference) {
                  const path = folder.parentReference.path.replace('/drive/root:', '') + '/' + folder.name;
                  console.log('‚úÖ Dossier trouv√© via recherche:', path);
                  return path;
                }
              }
              
              console.log('‚ùå Dossier Ingetool-Data non trouv√©');
              return null;
              
            } catch (error) {
              console.error('‚ùå Erreur recherche dossier:', error);
              return null;
            }
          };
          
          // Salva dati su OneDrive
          const saveToOneDrive = async (data) => {
            const token = oneDriveAccessToken || sessionStorage.getItem('onedrive_token');
            if (!token) return;
            
            try {
              setIsSyncing(true);
              setSyncStatus('saving');
              
              const jsonData = JSON.stringify(data);
              
              // üè¢ Obtenir ID du site SharePoint
              const siteId = await getSharePointSiteId(token);
              
              if (!siteId) {
                throw new Error('Impossible de r√©cup√©rer l\'ID du site SharePoint');
              }
              
              // üè¢ Microsoft Graph API endpoint pour SharePoint Site
              const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${SHAREPOINT_FOLDER_NAME}/${ONEDRIVE_FILE_NAME}:/content`;
              console.log('üíæ Sauvegarde vers SharePoint:', url);
              
              const response = await fetch(url, {
                method: 'PUT',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: jsonData
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erreur sauvegarde:', response.status, errorText);
                throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
              }
              
              console.log('‚úÖ Donn√©es sauvegard√©es sur SharePoint');
              setSyncStatus('saved');
              setLastSyncTime(new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
              
              // Reset status apr√®s 3 secondes
              setTimeout(() => setSyncStatus(''), 3000);
              
            } catch (error) {
              console.error('‚ùå Erreur sauvegarde OneDrive:', error);
              setSyncStatus('error');
              setTimeout(() => setSyncStatus(''), 3000);
              
              // Si token expir√©, d√©connecte
              if (error.message?.includes('401')) {
                console.log('‚ö†Ô∏è Token expir√©, d√©connexion...');
                signOutOneDrive();
              }
            } finally {
              setIsSyncing(false);
            }
          };
          
          // Carica dati da OneDrive
          const loadFromOneDrive = async (explicitToken) => {
            // Priorit√©: token explicite > state React > sessionStorage (fix timing React d√©finitif)
            const token = explicitToken || oneDriveAccessToken || sessionStorage.getItem('onedrive_token');
            if (!token) {
              console.log('‚ö†Ô∏è loadFromOneDrive: Pas de token disponible');
              return;
            }
            
            try {
              setIsSyncing(true);
              
              // üè¢ Obtenir ID du site SharePoint (avec token explicite)
              const siteId = await getSharePointSiteId(token);
              
              if (!siteId) {
                throw new Error('Impossible de r√©cup√©rer l\'ID du site SharePoint');
              }
              
              // üè¢ Microsoft Graph API endpoint pour SharePoint Site
              const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${SHAREPOINT_FOLDER_NAME}/${ONEDRIVE_FILE_NAME}:/content`;
              console.log('üì• Chargement depuis SharePoint:', url);
              
              const response = await fetch(url, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (response.status === 404) {
                console.log('‚ÑπÔ∏è Fichier non trouv√© sur SharePoint (premier acc√®s)');
                setIsSyncing(false);
                return;
              }
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erreur chargement:', response.status, errorText);
                throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
              }
              
              const text = await response.text();
              
              if (text) {
                const data = JSON.parse(text);
                
                // Carica i dati nell'app
                if (data.projects) setProjects(data.projects);
                if (data.engineers) setEngineers(data.engineers);
                if (data.resources) setResources(data.resources);
                if (data.genericResources) setGenericResources(data.genericResources);
                if (data.projectManagers) setProjectManagers(data.projectManagers);
                if (data.availableTags) setAvailableTags(data.availableTags);
                
                console.log('‚úÖ Donn√©es charg√©es depuis SharePoint');
                setLastSyncTime(new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
              }
              
            } catch (error) {
              console.error('‚ùå Erreur chargement OneDrive:', error);
              
              // Si token expir√©, d√©connecte
              if (error.message?.includes('401')) {
                console.log('‚ö†Ô∏è Token expir√©, d√©connexion...');
                signOutOneDrive();
              }
            } finally {
              setIsSyncing(false);
            }
          };
          
          // üßπ Cleanup risorse fantasma - rimuove ID risorse che non esistono pi√π
          useEffect(() => {
            if (projects.length > 0 && (engineers.length > 0 || resources.length > 0 || genericResources.length > 0)) {
              const engineerIds = engineers.map(e => e.id);
              const resourceIds = resources.map(r => r.id);
              const genericIds = genericResources.map(g => g.id);
              
              const cleanedProjects = projects.map(p => {
                const cleanedEngineers = (p.selectedEngineers || []).filter(id => engineerIds.includes(id));
                const cleanedResources = (p.selectedResources || []).filter(id => resourceIds.includes(id));
                const cleanedGeneric = (p.selectedGenericResources || []).filter(id => genericIds.includes(id));
                
                // Se c'√® differenza, aggiorna
                if (
                  cleanedEngineers.length !== (p.selectedEngineers || []).length ||
                  cleanedResources.length !== (p.selectedResources || []).length ||
                  cleanedGeneric.length !== (p.selectedGenericResources || []).length
                ) {
                  return {
                    ...p,
                    selectedEngineers: cleanedEngineers,
                    selectedResources: cleanedResources,
                    selectedGenericResources: cleanedGeneric
                  };
                }
                return p;
              });
              
              // Aggiorna solo se c'√® differenza
              const hasChanges = cleanedProjects.some((p, i) => p !== projects[i]);
              if (hasChanges) {
                console.log('üßπ Cleanup risorse fantasma effectu√©');
                setProjects(cleanedProjects);
              }
            }
          }, [engineers, resources, genericResources]); // NON projects per evitare loop infinito
          
          // Auto-save su OneDrive quando cambiano i dati
          useEffect(() => {
            if (isOneDriveConnected && (projects.length > 0 || engineers.length > 0 || resources.length > 0)) {
              const timer = setTimeout(() => {
                const data = { projects, engineers, resources, genericResources, projectManagers, availableTags };
                saveToOneDrive(data);
              }, 2000); // Attente de 2 secondes d'inactivit√© avant de sauvegarder
              
              return () => clearTimeout(timer);
            }
          }, [projects, engineers, resources, genericResources, projectManagers, isOneDriveConnected]);
          
          // Force sync manuelle
          const forceSyncFromOneDrive = async () => {
            if (!isOneDriveConnected) {
              alert('‚ö†Ô∏è Connectez d\'abord OneDrive');
              return;
            }
            await loadFromOneDrive();
            alert('‚úÖ Donn√©es synchronis√©es depuis OneDrive!');
          };
          
          // =====================================================
          // END ONEDRIVE FUNCTIONS
          // =====================================================


          const addProject = () => {
            if (!formData.name.trim()) return;
            
            // Raccogli tutti i giorni allocati nel progetto (da tutte le risorse)
            const allSelectedDays = {};
            
            // Engineer allocations
            if (formData.engineerMonthlyAllocation) {
              Object.values(formData.engineerMonthlyAllocation).forEach(dateMap => {
                Object.entries(dateMap).forEach(([date, allocation]) => {
                  allSelectedDays[date] = Math.max(allSelectedDays[date] || 0, allocation);
                });
              });
            }
            
            // Resource allocations
            if (formData.resourceMonthlyAllocation) {
              Object.values(formData.resourceMonthlyAllocation).forEach(dateMap => {
                Object.entries(dateMap).forEach(([date, allocation]) => {
                  allSelectedDays[date] = Math.max(allSelectedDays[date] || 0, allocation);
                });
              });
            }
            
            // Generic resource allocations
            if (formData.genericResourceMonthlyAllocation) {
              Object.values(formData.genericResourceMonthlyAllocation).forEach(dateMap => {
                Object.entries(dateMap).forEach(([date, allocation]) => {
                  allSelectedDays[date] = Math.max(allSelectedDays[date] || 0, allocation);
                });
              });
            }
            
            // V√©rifier conflits (syst√®me intelligent) - PER RISORSA per evitare falsi positivi
            let conflicts = {};
            
            // Controlla conflitti per ogni Engineer allocato
            if (formData.engineerMonthlyAllocation) {
              Object.entries(formData.engineerMonthlyAllocation).forEach(([engineerId, dateMap]) => {
                const engineer = engineers.find(e => e.id == engineerId || e.id === engineerId);
                if (engineer && dateMap) {
                  const engineerConflicts = getConflictingProjects(dateMap, editingProject?.id, engineer.name, 'Engineer');
                  // Merge conflicts
                  Object.entries(engineerConflicts).forEach(([date, allocs]) => {
                    if (!conflicts[date]) conflicts[date] = [];
                    conflicts[date].push(...allocs);
                  });
                }
              });
            }
            
            // Controlla conflitti per ogni Resource allocato
            if (formData.resourceMonthlyAllocation) {
              Object.entries(formData.resourceMonthlyAllocation).forEach(([resourceId, dateMap]) => {
                const resource = resources.find(r => r.id == resourceId || r.id === resourceId);
                if (resource && dateMap) {
                  const resourceConflicts = getConflictingProjects(dateMap, editingProject?.id, resource.name, 'Resource');
                  // Merge conflicts
                  Object.entries(resourceConflicts).forEach(([date, allocs]) => {
                    if (!conflicts[date]) conflicts[date] = [];
                    conflicts[date].push(...allocs);
                  });
                }
              });
            }
            
            // Controlla conflitti per ogni Generic Resource allocato
            if (formData.genericResourceMonthlyAllocation) {
              Object.entries(formData.genericResourceMonthlyAllocation).forEach(([genericId, dateMap]) => {
                const generic = genericResources.find(g => g.id == genericId || g.id === genericId);
                if (generic && dateMap) {
                  const genericConflicts = getConflictingProjects(dateMap, editingProject?.id, generic.name, 'Generic');
                  // Merge conflicts
                  Object.entries(genericConflicts).forEach(([date, allocs]) => {
                    if (!conflicts[date]) conflicts[date] = [];
                    conflicts[date].push(...allocs);
                  });
                }
              });
            }
            
            if (Object.keys(conflicts).length > 0) {
              // Conflits d√©tect√©s - montrer modal de confirmation
              setConflictWarningData({
                days: conflicts,
                affectedProjects: [...new Set(Object.values(conflicts).flatMap(arr => arr.map(a => a.projectName)))],
                currentProject: formData.name
              });
              
              // Sauvegarder l'action √† ex√©cuter apr√®s confirmation
              setPendingAllocationAction(() => () => {
                // Appliquer les modifications avec gestion des conflits
                const updatedProjects = handleConflictConfirmation(conflicts, allSelectedDays, { 
                  id: editingProject?.id || Date.now(),
                  ...formData
                });
                
                // Finaliser la sauvegarde
                if (editingProject) {
                  setEditingProject(null);
                } else {
                  // Nouveau projet d√©j√† ajout√© par handleConflictConfirmation si n√©cessaire
                  // On doit juste s'assurer qu'il est bien dans la liste
                  const projectExists = updatedProjects.some(p => p.name === formData.name);
                  if (!projectExists) {
                    setProjects([...updatedProjects, { id: Date.now(), ...formData, selectedDates: allSelectedDays }]);
                  }
                }
                resetProjectForm();
              });
              
              setShowConflictWarningModal(true);
            } else {
              // Pas de conflits - sauvegarder directement
              if (editingProject) {
                const updatedProject = { 
                  ...editingProject,
                  ...formData,
                  selectedDates: allSelectedDays,
                  calendarEvents: editingProject.calendarEvents || {} // v3.0: Preserve calendar events
                };
                
                setProjects(projects.map(p => p.id === editingProject.id ? updatedProject : p));
                
                // v3.0: Sync to Teams Calendar if status is "Programm√©"
                syncProjectToCalendars(updatedProject, editingProject).catch(err => {
                  console.error('‚ùå Calendar sync error:', err);
                });
                
                setEditingProject(null);
              } else {
                const newProject = { 
                  id: Date.now(), 
                  ...formData,
                  selectedDates: allSelectedDays,
                  calendarEvents: {} // v3.0: Init calendar events
                };
                
                setProjects([...projects, newProject]);
                
                // v3.0: Sync to Teams Calendar if status is "Programm√©"
                if (formData.status === 'programme') {
                  syncProjectToCalendars(newProject).catch(err => {
                    console.error('‚ùå Calendar sync error:', err);
                  });
                }
              }
              resetProjectForm();
            }
          };

          const addEngineer = () => {
            if (!engineerForm.name.trim()) return;
            setEngineers([...engineers, { 
              id: Date.now(), 
              ...engineerForm,
              name: engineerForm.name.trim(),
              email: engineerForm.email.trim(),
              maxMonthlyHours: engineerForm.maxMonthlyHours || 160,
              defaultDailyHours: engineerForm.defaultDailyHours || 8,
              unavailability: [],
              syncToTeamsCalendar: engineerForm.syncToTeamsCalendar !== false // v3.0: Default true
            }]);
            setEngineerForm({ 
              name: '', 
              email: '',
              specialty: '', specialty2: '', specialty3: '', specialty4: '',
              maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: [],
              syncToTeamsCalendar: true
            });
            setShowEngineerForm(false);
          };

          const addResource = () => {
            if (!resourceForm.name.trim()) return;
            setResources([...resources, { 
              id: Date.now(), 
              ...resourceForm,
              maxMonthlyHours: resourceForm.maxMonthlyHours || 160,
              defaultDailyHours: resourceForm.defaultDailyHours || 8,
              unavailability: []
            }]);
            setResourceForm({ 
              name: '', type: '',
              maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
            });
            setShowResourceForm(false);
          };

          const addGenericResource = () => {
            if (!genericResourceForm.name.trim()) return;
            setGenericResources([...genericResources, { 
              id: Date.now(), 
              ...genericResourceForm,
              maxMonthlyHours: genericResourceForm.maxMonthlyHours || 160,
              defaultDailyHours: genericResourceForm.defaultDailyHours || 8,
              unavailability: []
            }]);
            setGenericResourceForm({ 
              name: '', type: '',
              maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
            });
            setShowGenericResourceForm(false);
          };

          const addPM = () => {
            if (!pmForm.name.trim()) return;
            setProjectManagers([...projectManagers, { id: Date.now(), ...pmForm }]);
            setPMForm({ name: '', department: '' });
            setShowPMForm(false);
          };

          const deleteProject = (id) => setProjects(projects.filter(p => p.id !== id));
          const deleteEngineer = (id) => {
            setProjects(projects.map(p => ({...p, selectedEngineers: (p.selectedEngineers || []).filter(eId => eId !== id)})));
            setEngineers(engineers.filter(e => e.id !== id));
          };
          const deleteResource = (id) => {
            setProjects(projects.map(p => ({...p, selectedResources: (p.selectedResources || []).filter(rId => rId !== id)})));
            setResources(resources.filter(r => r.id !== id));
          };
          const deleteGenericResource = (id) => {
            setProjects(projects.map(p => ({...p, selectedGenericResources: (p.selectedGenericResources || []).filter(rId => rId !== id)})));
            setGenericResources(genericResources.filter(r => r.id !== id));
          };
          const deletePM = (id) => {
            setProjects(projects.map(p => ({...p, projectManager: p.projectManager === id ? '' : p.projectManager})));
            setProjectManagers(projectManagers.filter(pm => pm.id !== id));
          };

          const checkResourceUsage = (id, type) => {
            return projects.filter(p => {
              if (type === 'engineer') return (p.selectedEngineers || []).includes(id);
              if (type === 'resource') return (p.selectedResources || []).includes(id);
              if (type === 'generic') return (p.selectedGenericResources || []).includes(id);
              if (type === 'pm') return p.projectManager === id;
              return false;
            });
          };

          const initiateDelete = (id, name, type) => {
            const usedIn = checkResourceUsage(id, type);
            if (usedIn.length > 0) {
              setResourceToDelete({ id, name, type, usedIn });
              setShowDeleteWarning(true);
            } else {
              confirmDelete(id, type);
            }
          };

          const confirmDelete = (id, type) => {
            if (type === 'engineer') deleteEngineer(id);
            else if (type === 'resource') deleteResource(id);
            else if (type === 'generic') deleteGenericResource(id);
            else if (type === 'pm') deletePM(id);
            setShowDeleteWarning(false);
            setResourceToDelete(null);
          };

          const cancelDelete = () => {
            setShowDeleteWarning(false);
            setResourceToDelete(null);
          };

          // =====================================================
          // NUOVE FUNZIONI - GESTIONE AVANZATA RISORSE
          // =====================================================
          
          // Calcola il carico mensile totale di una risorsa
          const calculateMonthlyLoad = (resourceId, resourceType, year, month) => {
            let totalHours = 0;
            
            projects.forEach(project => {
              if (!project.startDate || !project.endDate) return;
              
              const projectStart = new Date(project.startDate);
              const projectEnd = new Date(project.endDate);
              const monthStart = new Date(year, month, 1);
              const monthEnd = new Date(year, month + 1, 0);
              
              // Verifica se il progetto si sovrappone al mese
              if (projectStart <= monthEnd && projectEnd >= monthStart) {
                let hours = 0;
                
                if (resourceType === 'engineer' && project.selectedEngineers?.includes(resourceId)) {
                  hours = project.engineerDays?.[resourceId] || 0;
                } else if (resourceType === 'resource' && project.selectedResources?.includes(resourceId)) {
                  hours = project.resourceDays?.[resourceId] || 0;
                } else if (resourceType === 'genericResource' && project.selectedGenericResources?.includes(resourceId)) {
                  hours = project.genericResourceDays?.[resourceId] || 0;
                }
                
                // Converti giorni in ore (assumendo defaultDailyHours)
                const resource = getResourceById(resourceId, resourceType);
                const dailyHours = resource?.defaultDailyHours || 8;
                totalHours += hours * dailyHours;
              }
            });
            
            return totalHours;
          };
          
          // Ottiene una risorsa per ID e tipo
          const getResourceById = (id, type) => {
            if (type === 'engineer') return engineers.find(e => e.id === id);
            if (type === 'resource') return resources.find(r => r.id === id);
            if (type === 'genericResource') return genericResources.find(r => r.id === id);
            return null;
          };
          
          // Verifica se una risorsa √® disponibile in un periodo
          const isResourceAvailable = (resourceId, resourceType, startDate, endDate) => {
            const resource = getResourceById(resourceId, resourceType);
            if (!resource || !resource.unavailability) return true;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            return !resource.unavailability.some(unavail => {
              const unavailStart = new Date(unavail.startDate);
              const unavailEnd = new Date(unavail.endDate);
              return (start <= unavailEnd && end >= unavailStart);
            });
          };
          
          // Aggiunge un periodo di indisponibilit√† a una risorsa
          // Genera date ricorrenti
          const generateRecurringDates = (pattern, startDate, endDate, weekday, dayOfMonth) => {
            const dates = [];
            let current = new Date(startDate);
            const end = new Date(endDate);
            
            while (current <= end) {
              if (pattern === 'weekly' && current.getDay() === weekday) {
                const dateStr = current.toISOString().split('T')[0];
                dates.push({ startDate: dateStr, endDate: dateStr });
              } else if (pattern === 'monthly' && current.getDate() === dayOfMonth) {
                const dateStr = current.toISOString().split('T')[0];
                dates.push({ startDate: dateStr, endDate: dateStr });
              } else if (pattern === 'yearly') {
                const start = new Date(startDate);
                const yearStart = new Date(current.getFullYear(), start.getMonth(), start.getDate());
                const yearEnd = new Date(current.getFullYear(), new Date(endDate).getMonth(), new Date(endDate).getDate());
                
                if (current >= yearStart && current <= yearEnd && current.getTime() === yearStart.getTime()) {
                  const startStr = yearStart.toISOString().split('T')[0];
                  const endStr = yearEnd.toISOString().split('T')[0];
                  dates.push({ startDate: startStr, endDate: endStr });
                }
              }
              current.setDate(current.getDate() + 1);
            }
            
            return dates;
          };
          
          const addUnavailability = () => {
            const { resourceId, resourceType, startDate, endDate, type, reason, recurring, recurrencePattern, weekday, dayOfMonth } = unavailabilityForm;
            if (!resourceId || !startDate || !endDate) return;
            
            let unavailabilityEntries = [];
            
            if (recurring) {
              // Genera multiple date ricorrenti
              const generatedDates = generateRecurringDates(recurrencePattern, startDate, endDate, weekday, dayOfMonth);
              unavailabilityEntries = generatedDates.map(dates => ({
                ...dates,
                type,
                reason,
                recurring: true,
                recurrencePattern
              }));
            } else {
              // Singola indisponibilit√†
              unavailabilityEntries = [{ startDate, endDate, type, reason, recurring: false }];
            }
            
            if (resourceType === 'engineer') {
              setEngineers(engineers.map(e => 
                e.id === resourceId 
                  ? { ...e, unavailability: [...(e.unavailability || []), ...unavailabilityEntries] }
                  : e
              ));
            } else if (resourceType === 'resource') {
              setResources(resources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: [...(r.unavailability || []), ...unavailabilityEntries] }
                  : r
              ));
            } else if (resourceType === 'genericResource') {
              setGenericResources(genericResources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: [...(r.unavailability || []), ...unavailabilityEntries] }
                  : r
              ));
            }
            
            setShowUnavailabilityModal(false);
            setUnavailabilityForm({
              resourceId: null, resourceType: '',
              startDate: '', endDate: '', type: 'vacation', reason: '',
              recurring: false, recurrencePattern: 'weekly', weekday: 1, dayOfMonth: 1
            });
          };
          
          // Rimuove un periodo di indisponibilit√†
          
          // Raggruppa indisponibilit√† ricorrenti
          const groupUnavailability = (unavailabilityList) => {
            if (!unavailabilityList || unavailabilityList.length === 0) return [];
            
            const groups = [];
            const processed = new Set();
            
            unavailabilityList.forEach((unavail, idx) => {
              if (processed.has(idx)) return;
              
              if (unavail.recurring) {
                // Trova tutte le occorrenze con stesso pattern e reason
                const relatedIndices = [];
                unavailabilityList.forEach((u, i) => {
                  if (u.recurring && 
                      u.recurrencePattern === unavail.recurrencePattern && 
                      u.reason === unavail.reason &&
                      u.type === unavail.type) {
                    relatedIndices.push(i);
                    processed.add(i);
                  }
                });
                
                // Trova date min e max
                const dates = relatedIndices.map(i => new Date(unavailabilityList[i].startDate));
                const minDate = new Date(Math.min(...dates));
                const maxDate = new Date(Math.max(...dates));
                
                groups.push({
                  type: 'recurring',
                  recurring: true,
                  recurrencePattern: unavail.recurrencePattern,
                  startDate: minDate.toISOString().split('T')[0],
                  endDate: maxDate.toISOString().split('T')[0],
                  reason: unavail.reason,
                  unavailType: unavail.type,
                  count: relatedIndices.length,
                  indices: relatedIndices
                });
              } else {
                // Indisponibilit√† singola
                groups.push({
                  type: 'single',
                  recurring: false,
                  startDate: unavail.startDate,
                  endDate: unavail.endDate,
                  reason: unavail.reason,
                  unavailType: unavail.type,
                  index: idx
                });
                processed.add(idx);
              }
            });
            
            return groups;
          };
          
          // Rimuove gruppo di indisponibilit√† ricorrenti
          const removeRecurringGroup = (resourceId, resourceType, indices) => {
            if (resourceType === 'engineer') {
              setEngineers(engineers.map(e => 
                e.id === resourceId 
                  ? { ...e, unavailability: e.unavailability.filter((_, idx) => !indices.includes(idx)) }
                  : e
              ));
            } else if (resourceType === 'resource') {
              setResources(resources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: r.unavailability.filter((_, idx) => !indices.includes(idx)) }
                  : r
              ));
            } else if (resourceType === 'genericResource') {
              setGenericResources(genericResources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: r.unavailability.filter((_, idx) => !indices.includes(idx)) }
                  : r
              ));
            }
          };
          
          const removeUnavailability = (resourceId, resourceType, index) => {
            if (resourceType === 'engineer') {
              setEngineers(engineers.map(e => 
                e.id === resourceId 
                  ? { ...e, unavailability: e.unavailability.filter((_, i) => i !== index) }
                  : e
              ));
            } else if (resourceType === 'resource') {
              setResources(resources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: r.unavailability.filter((_, i) => i !== index) }
                  : r
              ));
            } else if (resourceType === 'genericResource') {
              setGenericResources(genericResources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: r.unavailability.filter((_, i) => i !== index) }
                  : r
              ));
            }
          };
          
          // Calcola la percentuale di allocazione di una risorsa
          const calculateAllocationPercentage = (resourceId, resourceType, year, month) => {
            const resource = getResourceById(resourceId, resourceType);
            if (!resource) return 0;
            
            const totalHours = calculateMonthlyLoad(resourceId, resourceType, year, month);
            const maxHours = resource.maxMonthlyHours || 160;
            
            return Math.round((totalHours / maxHours) * 100);
          };
          
          // Aggiorna configurazione risorsa (max ore, ore giornaliere)
          const updateResourceConfig = (resourceId, resourceType, maxMonthlyHours, defaultDailyHours) => {
            if (resourceType === 'engineer') {
              setEngineers(engineers.map(e => 
                e.id === resourceId 
                  ? { ...e, maxMonthlyHours, defaultDailyHours }
                  : e
              ));
            } else if (resourceType === 'resource') {
              setResources(resources.map(r => 
                r.id === resourceId 
                  ? { ...r, maxMonthlyHours, defaultDailyHours }
                  : r
              ));
            } else if (resourceType === 'genericResource') {
              setGenericResources(genericResources.map(r => 
                r.id === resourceId 
                  ? { ...r, maxMonthlyHours, defaultDailyHours }
                  : r
              ));
            }
          };
          
          // üìÖ Helper: Converte Date a stringa YYYY-MM-DD locale (NO UTC!)
          const toLocalDateString = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          };
          
          // Calcola P√¢ques con algoritmo di Gauss
          const calculateEaster = (year) => {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const month = Math.floor((h + l - 7 * m + 114) / 31);
            const day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month - 1, day);
          };
          
          // Genera tutte le festivit√† francesi per un anno
          const generateFrenchHolidays = (year) => {
            const easter = calculateEaster(year);
            const easterMonday = new Date(easter);
            easterMonday.setDate(easter.getDate() + 1);
            
            const ascension = new Date(easter);
            ascension.setDate(easter.getDate() + 39);
            
            const pentecoteMonday = new Date(easter);
            pentecoteMonday.setDate(easter.getDate() + 50);
            
            return [
              { date: `${year}-01-01`, name: 'Jour de l\'An' },
              { date: toLocalDateString(easterMonday), name: 'Lundi de P√¢ques' },
              { date: `${year}-05-01`, name: 'F√™te du Travail' },
              { date: `${year}-05-08`, name: 'Victoire 1945' },
              { date: toLocalDateString(ascension), name: 'Ascension' },
              { date: toLocalDateString(pentecoteMonday), name: 'Lundi de Pentec√¥te' },
              { date: `${year}-07-14`, name: 'F√™te Nationale' },
              { date: `${year}-08-15`, name: 'Assomption' },
              { date: `${year}-11-01`, name: 'Toussaint' },
              { date: `${year}-11-11`, name: 'Armistice 1918' },
              { date: `${year}-12-25`, name: 'No√´l' }
            ];
          };
          
          // Aggiungi tutte le festivit√† di un anno
          const addAllHolidaysForYear = (year) => {
            const yearHolidays = generateFrenchHolidays(year);
            const newHolidays = yearHolidays.filter(holiday => 
              !holidays.some(h => h.date === holiday.date)
            ).map(h => ({ ...h, id: Date.now() + Math.random() }));
            
            setHolidays([...holidays, ...newHolidays]);
          };
          
          // Gestione festivit√†
          const addHoliday = () => {
            if (!holidayForm.date || !holidayForm.name) return;
            setHolidays([...holidays, { ...holidayForm, id: Date.now() }]);
            setHolidayForm({ date: '', name: '' });
            setShowHolidayModal(false);
          };
          
          const removeHoliday = (id) => {
            setHolidays(holidays.filter(h => h.id !== id));
          };
          
          const isHoliday = (date) => {
            const dateStr = toLocalDateString(date);
            return holidays.some(h => h.date === dateStr);
          };

          // =====================================================
          // FUNZIONI CRA (Compte Rendu d'Activit√©)
          // =====================================================
          
          // Copia pianificato ‚Üí effettivo per un progetto
          const copyPlannedToActual = (projectId) => {
            const project = projects.find(p => p.id === projectId);
            if (!project || !currentEngineerId) return;
            
            const planned = project.engineerMonthlyAllocation?.[currentEngineerId] || {};
            
            setProjects(projects.map(p => {
              if (p.id === projectId) {
                return {
                  ...p,
                  engineerActualAllocation: {
                    ...p.engineerActualAllocation,
                    [currentEngineerId]: { ...planned }
                  }
                };
              }
              return p;
            }));
            
            saveData();
          };
          
          // Aggiorna ore effettive per una data specifica
          const updateActualHours = (projectId, date, hours) => {
            if (!currentEngineerId) return;
            
            setProjects(projects.map(p => {
              if (p.id === projectId) {
                const actualAlloc = p.engineerActualAllocation || {};
                const engineerAlloc = actualAlloc[currentEngineerId] || {};
                
                return {
                  ...p,
                  engineerActualAllocation: {
                    ...actualAlloc,
                    [currentEngineerId]: {
                      ...engineerAlloc,
                      [date]: parseFloat(hours) || 0
                    }
                  }
                };
              }
              return p;
            }));
            
            saveData();
          };
          
          // Aggiorna planned con controllo budget
          const updatePlannedHours = (projectId, date, hours) => {
            if (!currentEngineerId) return { success: false, message: 'Ing√©nieur non identifi√©' };
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return { success: false, message: 'Projet non trouv√©' };
            
            const budget = project.engineerDays?.[currentEngineerId] || 0;
            const currentPlanned = project.engineerMonthlyAllocation?.[currentEngineerId] || {};
            
            // Calcola nuovo totale senza la data corrente
            const otherDatesTotal = Object.entries(currentPlanned)
              .filter(([d]) => d !== date)
              .reduce((sum, [, val]) => sum + val, 0);
            
            const newTotal = otherDatesTotal + (parseFloat(hours) || 0);
            
            // Controllo budget (se budget > 0)
            if (budget > 0 && newTotal > budget) {
              return { 
                success: false, 
                message: `Jours command√©s d√©pass√©s! Maximum ${budget}j autoris√©s (actuellement: ${otherDatesTotal.toFixed(1)}j sur autres dates)` 
              };
            }
            
            // Aggiorna
            setProjects(projects.map(p => {
              if (p.id === projectId) {
                const plannedAlloc = p.engineerMonthlyAllocation || {};
                const engineerAlloc = plannedAlloc[currentEngineerId] || {};
                
                return {
                  ...p,
                  engineerMonthlyAllocation: {
                    ...plannedAlloc,
                    [currentEngineerId]: {
                      ...engineerAlloc,
                      [date]: parseFloat(hours) || 0
                    }
                  }
                };
              }
              return p;
            }));
            
            saveData();
            return { success: true, message: 'Planification mise √† jour' };
          };
          
          // Calcola giorni pianificati
          const calculatePlannedDays = (project, engineerId) => {
            if (!project || !engineerId) return 0;
            const allocation = project.engineerMonthlyAllocation?.[engineerId] || {};
            // Valori gi√† en jours (1 = 1j, 0.5 = 0.5j)
            return Object.values(allocation).reduce((sum, days) => sum + days, 0);
          };
          
          // Calcola giorni effettivi
          const calculateActualDays = (project, engineerId) => {
            if (!project || !engineerId) return 0;
            const allocation = project.engineerActualAllocation?.[engineerId] || {};
            // Valeurs d√©j√† en jours (1 = 1j, 0.5 = 0.5j)
            return Object.values(allocation).reduce((sum, days) => sum + days, 0);
          };
          
          // Calcola giorni restanti
          const calculateRemainingDays = (project, engineerId) => {
            if (!project || !engineerId) return 0;
            const actual = calculateActualDays(project, engineerId);
            const soldDays = project.engineerDays?.[engineerId] || 0;
            return soldDays - actual;
          };
          
          // Calcola tasso completamento
          const calculateCompletionRate = (project, engineerId) => {
            if (!project || !engineerId) return 0;
            const soldDays = project.engineerDays?.[engineerId] || 0;
            if (soldDays === 0) return 0;
            const actual = calculateActualDays(project, engineerId);
            return Math.round((actual / soldDays) * 100);
          };
          
          // Get all dates with allocation for a project/engineer in a month
          const getCRADatesForMonth = (project, engineerId, year, month) => {
            if (!project || !engineerId) return [];
            
            const planned = project.engineerMonthlyAllocation?.[engineerId] || {};
            const actual = project.engineerActualAllocation?.[engineerId] || {};
            
            const allDates = new Set([...Object.keys(planned), ...Object.keys(actual)]);
            
            return Array.from(allDates)
              .filter(dateStr => {
                const date = new Date(dateStr);
                return date.getFullYear() === year && date.getMonth() === month;
              })
              .sort()
              .map(dateStr => ({
                date: dateStr,
                planned: planned[dateStr] || 0,
                actual: actual[dateStr] || 0
              }));
          };
          
          // =====================================================
          // FUNZIONI STATISTICHE (Admin only)
          // =====================================================
          
          // Calcola statistiche ingegnere per periodo
          const calculateEngineerStats = (engineerId, year, month) => {
            // CRITICAL: Converti engineerId in numero (dropdown restituisce string)
            const engineerIdNum = typeof engineerId === 'string' ? parseInt(engineerId) : engineerId;
            
            const engineerProjects = projects.filter(p => 
              p.selectedEngineers && p.selectedEngineers.includes(engineerIdNum)
            );
            
            let totalPlanned = 0;
            let totalActual = 0;
            const projectsBreakdown = [];
            
            // Costruisci prefisso data per match (es: "2026-01" per gennaio 2026)
            const monthStr = String(month + 1).padStart(2, '0');
            const datePrefix = `${year}-${monthStr}`;
            
            engineerProjects.forEach(project => {
              const plannedAlloc = project.engineerMonthlyAllocation?.[engineerIdNum] || {};
              const actualAlloc = project.engineerActualAllocation?.[engineerIdNum] || {};
              
              let projectPlanned = 0;
              let projectActual = 0;
              
              // Confronto diretto stringhe invece di Date parsing
              Object.entries(plannedAlloc).forEach(([dateStr, days]) => {
                if (dateStr.startsWith(datePrefix)) {
                  projectPlanned += days;
                  totalPlanned += days;
                }
              });
              
              Object.entries(actualAlloc).forEach(([dateStr, days]) => {
                if (dateStr.startsWith(datePrefix)) {
                  projectActual += days;
                  totalActual += days;
                }
              });
              
              if (projectPlanned > 0 || projectActual > 0) {
                projectsBreakdown.push({
                  projectName: project.name,
                  projectId: project.id,
                  client: project.tags?.client?.[0] || 'N/A',
                  type: project.tags?.type?.[0] || 'N/A',
                  priority: project.tags?.priority?.[0] || 'N/A',
                  status: project.status || 'N/A',
                  startDate: project.startDate || 'N/A',
                  endDate: project.endDate || 'N/A',
                  budget: project.engineerDays?.[engineerIdNum] || 0,
                  planned: projectPlanned,
                  actual: projectActual,
                  delta: projectActual - projectPlanned
                });
              }
            });
            
            return {
              totalPlanned,
              totalActual,
              delta: totalActual - totalPlanned,
              tauxUtilisation: totalPlanned > 0 ? Math.round((totalActual / totalPlanned) * 100) : 0,
              projectsBreakdown
            };
          };
          
          // Funzione per formattare i giorni secondo le specifiche
          const formatDays = (days) => {
            if (days === 0) return '0j';
            if (days === 0.125) return '1h';
            if (days === 0.25) return '2h';
            if (days === 0.375) return '3h';
            if (days === 0.5) return '0.5j';
            if (days === 0.625) return '5h';
            if (days === 0.75) return '6h';
            if (days === 0.875) return '7h';
            if (days === 1) return '1j';
            // Per valori non standard, usa il formato originale
            return `${days.toFixed(2)}j`;
          };
          
          // Funzione per formattare percentuali in sicurezza (evita NaN)
          const safePercent = (value) => {
            if (value === null || value === undefined || isNaN(value)) return 0;
            if (value < 0) return 0;
            if (value > 999) return 999; // Cap massimo ragionevole
            return Math.round(value);
          };
          
          // Export CSV Timesheet d√©taill√©
          const exportTimesheetCSV = () => {
            // CRITICAL: Converti engineerId in numero
            const engineerIdNum = statsSelectedEngineer === 'all' ? null : parseInt(statsSelectedEngineer);
            const engineer = engineerIdNum ? engineers.find(e => e.id === engineerIdNum) : null;
            const engineerName = engineer ? engineer.name : 'Tous';
            const monthName = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                               'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'][statsSelectedMonth];
            
            // BOM UTF-8 per Excel
            let csvContent = "\uFEFF";
            
            // Se singolo ingegnere, aggiungi SYNTH√àSE in alto
            if (statsSelectedEngineer !== 'all') {
              const stats = calculateEngineerStats(engineerIdNum, statsSelectedYear, statsSelectedMonth);
              const nbProjects = stats.projectsBreakdown.length;
              
              csvContent += "SYNTH√àSE MENSUELLE\n";
              csvContent += "Ing√©nieur;Mois;Jours Planifi√©s;Jours R√©alis√©s;√âcart;Taux Utilisation;Projets Actifs\n";
              csvContent += `${engineerName};${monthName} ${statsSelectedYear};${formatDays(stats.totalPlanned)};${formatDays(stats.totalActual)};${formatDays(stats.delta)};${stats.tauxUtilisation}%;${nbProjects}\n`;
              csvContent += "\n"; // Riga vuota
              csvContent += "D√âTAIL PAR DATE\n";
            }
            
            // Header dettaglio
            csvContent += "Date;Ing√©nieur;Projet;Client;Type;Priorit√©;Statut;P√©riode;Budget;Planifi√©;R√©alis√©;√âcart;Statut Temps\n";
            
            const engineersToExport = statsSelectedEngineer === 'all' ? engineers : [engineer];
            
            // Costruisci prefisso data
            const monthStr = String(statsSelectedMonth + 1).padStart(2, '0');
            const datePrefix = `${statsSelectedYear}-${monthStr}`;
            
            engineersToExport.forEach(eng => {
              const engineerProjects = projects.filter(p => 
                p.selectedEngineers && p.selectedEngineers.includes(eng.id)
              );
              
              engineerProjects.forEach(project => {
                const plannedAlloc = project.engineerMonthlyAllocation?.[eng.id] || {};
                const actualAlloc = project.engineerActualAllocation?.[eng.id] || {};
                
                const allDates = new Set([...Object.keys(plannedAlloc), ...Object.keys(actualAlloc)]);
                
                // Info progetto
                const client = project.tags?.client?.[0] || 'N/A';
                const type = project.tags?.type?.[0] || 'N/A';
                const priority = project.tags?.priority?.[0] || 'N/A';
                const status = project.status || 'N/A';
                const periode = `${project.startDate || 'N/A'} ‚Üí ${project.endDate || 'N/A'}`;
                const budget = project.engineerDays?.[eng.id] || 0;
                
                allDates.forEach(dateStr => {
                  // Confronto diretto stringhe
                  if (dateStr.startsWith(datePrefix)) {
                    const planned = plannedAlloc[dateStr] || 0;
                    const actual = actualAlloc[dateStr] || 0;
                    const delta = actual - planned;
                    const statutTemps = planned === actual ? 'Conforme' : (actual > planned ? 'D√©passement' : 'Diff√©rent');
                    
                    // Formatta data senza parsing problematico
                    const [year, month, day] = dateStr.split('-');
                    const dateFormatted = `${day}/${month}/${year}`;
                    
                    // Punto e virgola come separatore con formato giorni
                    csvContent += `${dateFormatted};${eng.name};${project.name};${client};${type};${priority};${status};${periode};${formatDays(budget)};${formatDays(planned)};${formatDays(actual)};${formatDays(delta)};${statutTemps}\n`;
                  }
                });
              });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Timesheet_${engineerName}_${monthName}_${statsSelectedYear}.csv`;
            link.click();
          };
          
          // Export CSV Synth√®se mensuelle
          const exportSyntheseCSV = () => {
            const monthName = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                               'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'][statsSelectedMonth];
            
            // BOM UTF-8 + Header con punto e virgola per Excel
            let csvContent = "\uFEFF"; // BOM UTF-8 per Excel
            csvContent += "Ing√©nieur;Mois;Jours Planifi√©s;Jours R√©alis√©s;√âcart;Taux Utilisation;Projets Actifs\n";
            
            // CRITICAL: Converti engineerId in numero
            const engineerIdNum = statsSelectedEngineer === 'all' ? null : parseInt(statsSelectedEngineer);
            const engineersToExport = statsSelectedEngineer === 'all' ? engineers : [engineers.find(e => e.id === engineerIdNum)];
            
            engineersToExport.forEach(eng => {
              const stats = calculateEngineerStats(eng.id, statsSelectedYear, statsSelectedMonth);
              const nbProjects = stats.projectsBreakdown.length;
              
              // Punto e virgola come separatore con formatDays
              csvContent += `${eng.name};${monthName} ${statsSelectedYear};${formatDays(stats.totalPlanned)};${formatDays(stats.totalActual)};${formatDays(stats.delta)};${stats.tauxUtilisation}%;${nbProjects}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Synthese_${monthName}_${statsSelectedYear}.csv`;
            link.click();
          };
          
          // Export Dashboard PDF
          const exportDashboardPDF = () => {
            const monthName = ['Janvier', 'Fevrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                               'Juillet', 'Aout', 'Septembre', 'Octobre', 'Novembre', 'Decembre'][statsSelectedMonth];
            
            // Importa jsPDF e autoTable
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('DASHBOARD EXECUTIF', 14, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Periode: ${monthName} ${statsSelectedYear}`, 14, 28);
            doc.text(`Genere le: ${new Date().toLocaleDateString('fr-FR')}`, 14, 34);
            
            let yPos = 45;
            
            // KPI Globali
            const kpis = calculateGlobalKPIs(statsSelectedYear, statsSelectedMonth);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('KPIs Globaux', 14, yPos);
            yPos += 8;
            
            doc.autoTable({
              startY: yPos,
              head: [['Metrique', 'Valeur']],
              body: [
                ['Utilisation Rate', `${safePercent(kpis.utilisationRate)}%`],
                ['Projets Actifs', `${kpis.projetsActifs || 0}`],
                ['Respect des Commandes', `${safePercent(kpis.budgetRespect)}%`],
                ['Planning Accuracy', `${safePercent(kpis.planningAccuracy)}%`]
              ],
              theme: 'grid',
              headStyles: { fillColor: [230, 18, 82], fontStyle: 'bold', font: 'helvetica' },
              styles: { fontSize: 10, font: 'helvetica' }
            });
            
            yPos = doc.lastAutoTable.finalY + 10;
            
            // Capacite Residuelle
            const capacity = calculateTeamCapacity(statsSelectedYear, statsSelectedMonth);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('Capacite Disponible', 14, yPos);
            yPos += 8;
            
            doc.autoTable({
              startY: yPos,
              head: [['Metrique', 'Valeur']],
              body: [
                ['Capacite Disponible', `${capacity.capaciteDisponible.toFixed(1)}j`],
                ['Nouveaux Projets Acceptables', `${capacity.nbProjetsAcceptables} (8j chacun)`],
                ['Utilisation', `${Math.round((capacity.capaciteUtilisee / capacity.capaciteTheorique) * 100)}%`]
              ],
              theme: 'grid',
              headStyles: { fillColor: [230, 18, 82], fontStyle: 'bold', font: 'helvetica' },
              styles: { fontSize: 10, font: 'helvetica' }
            });
            
            yPos = doc.lastAutoTable.finalY + 10;
            
            // Ing√©nieurs Disponibles (d√©tail)
            if (capacity.engineersCapacity.length > 0) {
              doc.setFontSize(12);
              doc.setFont('helvetica', 'bold');
              doc.text('Ingenieurs Disponibles', 14, yPos);
              yPos += 6;
              
              const engCapacityData = capacity.engineersCapacity.map(eng => [
                eng.name,
                `${eng.disponible.toFixed(1)}j libres`
              ]);
              
              doc.autoTable({
                startY: yPos,
                head: [['Ingenieur', 'Disponibilite']],
                body: engCapacityData,
                theme: 'grid',
                headStyles: { fillColor: [230, 18, 82], fontStyle: 'bold', font: 'helvetica' },
                styles: { fontSize: 9, font: 'helvetica' }
              });
              
              yPos = doc.lastAutoTable.finalY + 10;
            }
            
            // Alerts
            const alerts = generateAlerts(statsSelectedYear, statsSelectedMonth);
            if (alerts.urgent.length > 0 || alerts.attention.length > 0 || alerts.deadlines.length > 0) {
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text('Alertes', 14, yPos);
              yPos += 8;
              
              const alertsData = [
                ...alerts.urgent.map(a => ['[!] URGENT', a.message]),
                ...alerts.attention.map(a => ['[!] ATTENTION', a.message]),
                ...alerts.deadlines.map(a => ['[!] DEADLINE', a.message])
              ];
              
              doc.autoTable({
                startY: yPos,
                head: [['Type', 'Message']],
                body: alertsData,
                theme: 'grid',
                headStyles: { fillColor: [230, 18, 82], fontStyle: 'bold', font: 'helvetica' },
                styles: { fontSize: 9, font: 'helvetica' },
                columnStyles: {
                  0: { cellWidth: 40 },
                  1: { cellWidth: 145 }
                }
              });
              
              yPos = doc.lastAutoTable.finalY + 10;
            }
            
            // Top Performers (nouvelle page si n√©cessaire)
            if (yPos > 250 && kpis.topPerformers.length > 0) {
              doc.addPage();
              yPos = 20;
            }
            
            if (kpis.topPerformers.length > 0) {
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text('Top Performers (Accuracy)', 14, yPos);
              yPos += 8;
              
              const performersData = kpis.topPerformers.map((p, idx) => [
                `#${idx + 1}`,
                p.name,
                `${safePercent(p.accuracy)}%`
              ]);
              
              doc.autoTable({
                startY: yPos,
                head: [['Rang', 'Ingenieur', 'Accuracy']],
                body: performersData,
                theme: 'grid',
                headStyles: { fillColor: [230, 18, 82], fontStyle: 'bold', font: 'helvetica' },
                styles: { fontSize: 10, font: 'helvetica' }
              });
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
              doc.setPage(i);
              doc.setFontSize(8);
              doc.setFont('helvetica', 'normal');
              doc.setTextColor(100, 100, 100);
              doc.text(`Dashboard Askida Broadcast - Page ${i}/${pageCount}`, 14, 285);
            }
            
            // Salva PDF
            doc.save(`Dashboard_${monthName}_${statsSelectedYear}.pdf`);
          };
          
          // =====================================================
          // FUNZIONI DASHBOARD AVANZATO
          // =====================================================
          
          // Tableau de Bord Ex√©cutif - KPI Globali
          const calculateGlobalKPIs = (year, month) => {
            const monthStr = String(month + 1).padStart(2, '0');
            const datePrefix = `${year}-${monthStr}`;
            
            let totalPlanned = 0;
            let totalActual = 0;
            let projectsWithData = [];
            let engineersStats = {};
            
            // Calcola per tutti gli ingegneri
            engineers.forEach(eng => {
              const stats = calculateEngineerStats(eng.id, year, month);
              totalPlanned += stats.totalPlanned;
              totalActual += stats.totalActual;
              
              if (stats.totalPlanned > 0 || stats.totalActual > 0) {
                let accuracy = 0;
                if (stats.totalPlanned > 0 && !isNaN(stats.totalActual) && !isNaN(stats.totalPlanned)) {
                  const actual = stats.totalActual || 0;
                  const planned = stats.totalPlanned || 0;
                  accuracy = Math.abs(1 - Math.abs(actual - planned) / planned) * 100;
                  if (isNaN(accuracy)) accuracy = 0;
                  if (accuracy < 0) accuracy = 0;
                  if (accuracy > 100) accuracy = 100;
                }
                
                engineersStats[eng.id] = {
                  name: eng.name,
                  planned: stats.totalPlanned || 0,
                  actual: stats.totalActual || 0,
                  accuracy: accuracy
                };
              }
              
              stats.projectsBreakdown.forEach(proj => {
                const existing = projectsWithData.find(p => p.projectId === proj.projectId);
                if (!existing) {
                  projectsWithData.push({
                    projectId: proj.projectId,
                    projectName: proj.projectName,
                    budget: proj.budget,
                    totalPlanned: proj.planned,
                    totalActual: proj.actual
                  });
                } else {
                  existing.totalPlanned += proj.planned;
                  existing.totalActual += proj.actual;
                }
              });
            });
            
            // Calcola metriche con controlli anti-NaN
            let utilisationRate = 0;
            if (totalPlanned > 0 && !isNaN(totalActual) && !isNaN(totalPlanned)) {
              utilisationRate = Math.round((totalActual / totalPlanned) * 100);
              if (isNaN(utilisationRate)) utilisationRate = 0;
            }
            
            const projetsActifs = projectsWithData.length;
            
            // Budget Respect: % progetti con actual <= budget * 1.1
            const projetsOnBudget = projectsWithData.filter(p => {
              const budget = p.budget || 0;
              const actual = p.totalActual || 0;
              return budget > 0 && actual <= budget * 1.1;
            }).length;
            let budgetRespect = 0;
            if (projetsActifs > 0) {
              budgetRespect = Math.round((projetsOnBudget / projetsActifs) * 100);
              if (isNaN(budgetRespect)) budgetRespect = 0;
            }
            
            // Planning Accuracy: % progetti con |actual - planned| < 10%
            const projetsAccurate = projectsWithData.filter(p => {
              const planned = p.totalPlanned || 0;
              const actual = p.totalActual || 0;
              if (planned === 0) return false;
              const diff = Math.abs(actual - planned);
              const ratio = diff / planned;
              return !isNaN(ratio) && ratio < 0.1;
            }).length;
            let planningAccuracy = 0;
            if (projetsActifs > 0) {
              planningAccuracy = Math.round((projetsAccurate / projetsActifs) * 100);
              if (isNaN(planningAccuracy)) planningAccuracy = 0;
            }
            
            // Top Performers (migliore accuracy) - filtra NaN
            const topPerformers = Object.values(engineersStats)
              .filter(e => !isNaN(e.accuracy) && e.accuracy >= 0)
              .sort((a, b) => b.accuracy - a.accuracy)
              .slice(0, 3);
            
            // Progetti in overrun (>110% budget)
            const projetsOverrun = projectsWithData.filter(p => {
              const budget = p.budget || 0;
              const actual = p.totalActual || 0;
              return budget > 0 && actual > budget * 1.1;
            });
            
            // Ingegneri sotto-utilizzati (<10j nel mese)
            const sousUtilises = Object.values(engineersStats).filter(e => {
              const actual = e.actual || 0;
              return actual > 0 && actual < 10;
            });
            
            // Bottlenecks (progetti con >100% allocation)
            const bottlenecks = projectsWithData.filter(p => {
              const budget = p.budget || 0;
              const actual = p.totalActual || 0;
              return budget > 0 && actual > budget;
            });
            
            return {
              utilisationRate,
              projetsActifs,
              budgetRespect,
              planningAccuracy,
              topPerformers,
              alerts: {
                projetsOverrun,
                sousUtilises,
                bottlenecks
              },
              totalPlanned,
              totalActual
            };
          };
          
          // Calcolo Capacit√† Residua Team
          const calculateTeamCapacity = (year, month) => {
            const monthStr = String(month + 1).padStart(2, '0');
            const datePrefix = `${year}-${monthStr}`;
            
            // Capacit√† teorica: 20 giorni/mese per ingegnere
            const workingDaysPerMonth = 20;
            const engineersCount = engineers.filter(e => e.role !== 'admin' && e.role !== 'reader').length;
            const capaciteTheorique = engineersCount * workingDaysPerMonth;
            
            // Calcola capacit√† utilizzata (planned)
            let capaciteUtilisee = 0;
            const engineersCapacity = [];
            
            engineers.forEach(eng => {
              if (eng.role === 'admin' || eng.role === 'reader') return;
              
              const stats = calculateEngineerStats(eng.id, year, month);
              const planned = stats.totalPlanned || 0;
              const disponible = workingDaysPerMonth - planned;
              
              capaciteUtilisee += planned;
              
              if (disponible > 0) {
                engineersCapacity.push({
                  name: eng.name,
                  disponible: disponible
                });
              }
            });
            
            const capaciteDisponible = capaciteTheorique - capaciteUtilisee;
            
            // Stima progetti accettabili (progetto medio = 8j)
            const projetMoyenJours = 8;
            const nbProjetsAcceptables = Math.floor(capaciteDisponible / projetMoyenJours);
            
            // Sort ingegneri per disponibilit√† d√©croissant
            engineersCapacity.sort((a, b) => b.disponible - a.disponible);
            
            return {
              capaciteTheorique,
              capaciteUtilisee,
              capaciteDisponible,
              nbProjetsAcceptables,
              engineersCapacity: engineersCapacity.slice(0, 5) // Top 5
            };
          };
          
          // Analisi per Cliente
          const calculateClientAnalysis = (year, month, allTime = false) => {
            const clientsData = {};
            
            projects.forEach(project => {
              const client = project.tags?.client?.[0] || 'Sans Client';
              
              if (!clientsData[client]) {
                clientsData[client] = {
                  client,
                  projets: [],
                  totalBudget: 0,
                  totalPlanned: 0,
                  totalActual: 0
                };
              }
              
              // Calcola budget e actual per questo progetto
              let projectBudget = 0;
              let projectPlanned = 0;
              let projectActual = 0;
              
              if (project.engineerDays) {
                Object.values(project.engineerDays).forEach(days => {
                  projectBudget += days || 0;
                });
              }
              
              if (project.engineerMonthlyAllocation) {
                Object.entries(project.engineerMonthlyAllocation).forEach(([engId, dates]) => {
                  Object.entries(dates).forEach(([dateStr, days]) => {
                    // Se allTime=true, somma TUTTE le date, altrimenti filtra per mese
                    if (allTime) {
                      projectPlanned += days;
                    } else {
                      const monthStr = String(month + 1).padStart(2, '0');
                      const datePrefix = `${year}-${monthStr}`;
                      if (dateStr.startsWith(datePrefix)) {
                        projectPlanned += days;
                      }
                    }
                  });
                });
              }
              
              if (project.engineerActualAllocation) {
                Object.entries(project.engineerActualAllocation).forEach(([engId, dates]) => {
                  Object.entries(dates).forEach(([dateStr, days]) => {
                    // Se allTime=true, somma TUTTE le date, altrimenti filtra per mese
                    if (allTime) {
                      projectActual += days;
                    } else {
                      const monthStr = String(month + 1).padStart(2, '0');
                      const datePrefix = `${year}-${monthStr}`;
                      if (dateStr.startsWith(datePrefix)) {
                        projectActual += days;
                      }
                    }
                  });
                });
              }
              
              if (projectBudget > 0 || projectPlanned > 0 || projectActual > 0) {
                clientsData[client].projets.push({
                  name: project.name,
                  budget: projectBudget,
                  planned: projectPlanned,
                  actual: projectActual
                });
                clientsData[client].totalBudget += projectBudget;
                clientsData[client].totalPlanned += projectPlanned;
                clientsData[client].totalActual += projectActual;
              }
            });
            
            // Calcola √©cart e status per ogni cliente
            const clientsList = Object.values(clientsData).map(client => {
              const actual = client.totalActual || 0;
              const planned = client.totalPlanned || 0;
              const ecart = actual - planned;
              
              let ecartPercent = 0;
              if (planned > 0 && !isNaN(ecart) && !isNaN(planned)) {
                ecartPercent = (ecart / planned) * 100;
                if (isNaN(ecartPercent)) ecartPercent = 0;
              } else if (planned === 0 && actual > 0) {
                // Caso speciale: pianificato nulla ma actual > 0 ‚Üí overrun infinito
                ecartPercent = 999; // Valore simbolico per overrun critico
              }
              
              // Status basato SOLO su overrun positivo (actual > planned)
              let status = 'üü¢'; // Verde (default: on budget o sotto budget)
              
              if (ecartPercent > 20) {
                status = 'üî¥'; // Rosso: overrun >20% (critico)
              } else if (ecartPercent > 10) {
                status = 'üü°'; // Giallo: overrun >10% (attenzione)
              }
              // Se ecartPercent <= 10 (o negativo) ‚Üí Verde (tutto ok)
              
              return {
                ...client,
                ecart,
                ecartPercent,
                status,
                nbProjets: client.projets.length
              };
            }).filter(c => c.nbProjets > 0)
              .sort((a, b) => b.totalActual - a.totalActual);
            
            return clientsList;
          };
          
          // Heatmap Allocazione Settimanale
          const calculateWeeklyHeatmap = (year, month) => {
            const monthStr = String(month + 1).padStart(2, '0');
            const datePrefix = `${year}-${monthStr}`;
            
            // Determina settimane del mese
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const weeks = [];
            let currentDate = new Date(firstDay);
            
            while (currentDate <= lastDay) {
              const weekStart = new Date(currentDate);
              const weekEnd = new Date(currentDate);
              weekEnd.setDate(weekEnd.getDate() + 6);
              
              if (weekEnd > lastDay) weekEnd.setTime(lastDay.getTime());
              
              // Formatta date per label (es: "S1 (01-05)")
              const startDay = String(weekStart.getDate()).padStart(2, '0');
              const endDay = String(weekEnd.getDate()).padStart(2, '0');
              
              weeks.push({
                start: weekStart.toISOString().split('T')[0],
                end: weekEnd.toISOString().split('T')[0],
                label: `S${weeks.length + 1} (${startDay}-${endDay})`
              });
              
              currentDate.setDate(currentDate.getDate() + 7);
            }
            
            // Calcola allocation per ingegnere per settimana
            const heatmapData = engineers.map(eng => {
              const weeklyData = weeks.map(week => {
                let totalDays = 0;
                
                projects.forEach(project => {
                  const plannedAlloc = project.engineerMonthlyAllocation?.[eng.id] || {};
                  
                  Object.entries(plannedAlloc).forEach(([dateStr, days]) => {
                    if (dateStr >= week.start && dateStr <= week.end) {
                      totalDays += days;
                    }
                  });
                });
                
                // Calcola % (assumo 5 giorni lavorativi per settimana)
                const workingDays = 5;
                let percent = Math.round((totalDays / workingDays) * 100);
                if (isNaN(percent)) percent = 0;
                
                let color = 'üü¢'; // Verde (<90%)
                if (percent < 50) color = 'üü°'; // Giallo (sotto-utilizzato)
                else if (percent > 100) color = 'üî¥'; // Rosso (sovraccarico)
                
                return {
                  week: week.label,
                  days: totalDays || 0,
                  percent,
                  color
                };
              });
              
              return {
                engineerId: eng.id,
                engineerName: eng.name,
                weeks: weeklyData
              };
            }).filter(e => e.weeks.some(w => w.days > 0));
            
            return { weeks, heatmapData };
          };
          
          // Alert Automatici
          const generateAlerts = (year, month) => {
            const monthStr = String(month + 1).padStart(2, '0');
            const datePrefix = `${year}-${monthStr}`;
            const today = new Date().toISOString().split('T')[0];
            
            const urgent = [];
            const attention = [];
            const deadlines = [];
            
            // Analizza progetti
            projects.forEach(project => {
              let projectBudget = 0;
              let projectActual = 0;
              
              // Calcola budget totale
              if (project.engineerDays) {
                Object.values(project.engineerDays).forEach(days => {
                  projectBudget += days || 0;
                });
              }
              
              // Calcola actual totale per questo mese
              if (project.engineerActualAllocation) {
                Object.entries(project.engineerActualAllocation).forEach(([engId, dates]) => {
                  Object.entries(dates).forEach(([dateStr, days]) => {
                    if (dateStr.startsWith(datePrefix)) {
                      projectActual += days;
                    }
                  });
                });
              }
              
              // Alert budget >95%
              if (projectBudget > 0 && projectActual > projectBudget * 0.95) {
                const percentUsed = Math.round((projectActual / projectBudget) * 100);
                urgent.push({
                  type: 'budget',
                  message: `${project.name}: ${percentUsed}% jours command√©s utilis√©s`,
                  project: project.name
                });
              }
              
              // Alert deadline proche (7 giorni)
              if (project.endDate) {
                const endDate = new Date(project.endDate);
                const daysUntilEnd = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                
                if (daysUntilEnd > 0 && daysUntilEnd <= 7) {
                  deadlines.push({
                    type: 'deadline',
                    message: `${project.name}: se termine dans ${daysUntilEnd} jours`,
                    project: project.name,
                    daysLeft: daysUntilEnd
                  });
                }
              }
            });
            
            // Analizza ingegneri sotto-utilizzati
            engineers.forEach(eng => {
              const stats = calculateEngineerStats(eng.id, year, month);
              
              if (stats.totalPlanned < 10 && stats.totalPlanned > 0) {
                attention.push({
                  type: 'sous-utilise',
                  message: `${eng.name}: seulement ${stats.totalPlanned.toFixed(1)}j planifi√©s`,
                  engineer: eng.name
                });
              }
            });
            
            return {
              urgent: urgent.slice(0, 5), // Max 5
              attention: attention.slice(0, 5),
              deadlines: deadlines.slice(0, 5)
            };
          };
          
          // =====================================================
          // FUNZIONI CALENDARIO CRA INTERATTIVO
          // =====================================================
          
          // üîß NOUVELLE FONCTION: Calcul de la disponibilit√© d'un ing√©nieur pour une date
          const calculateEngineerAvailability = (engineerId, dateStr, excludeProjectId = null) => {
            let totalAllocated = 0;
            const allocatedProjects = [];
            
            projects.forEach(p => {
              if ((!excludeProjectId || p.id !== excludeProjectId) &&
                  p.selectedEngineers?.includes(engineerId) &&
                  p.engineerMonthlyAllocation?.[engineerId]?.[dateStr]) {
                const allocation = p.engineerMonthlyAllocation[engineerId][dateStr];
                totalAllocated += allocation;
                allocatedProjects.push({
                  id: p.id,
                  name: p.name,
                  allocation: allocation
                });
              }
            });
            
            const availableCapacity = Math.max(0, 1.0 - totalAllocated);
            
            return {
              totalAllocated,
              availableCapacity,
              allocatedProjects,
              isFullyBlocked: availableCapacity <= 0,
              hasOtherAllocations: allocatedProjects.length > 0
            };
          };
          
          // üîß NOUVELLE FONCTION: Sugg√®re la prochaine allocation possible
          const getNextAvailableAllocation = (currentAllocation, availableCapacity) => {
            // Cycle: 0 ‚Üí minimum(0.25, available) ‚Üí minimum(0.5, available) ‚Üí minimum(1.0, available) ‚Üí 0
            const possibleValues = [0, 0.25, 0.5, 1.0];
            const currentIndex = possibleValues.indexOf(currentAllocation);
            
            // Trouve la prochaine valeur qui ne d√©passe pas la capacit√© disponible
            for (let i = currentIndex + 1; i < possibleValues.length; i++) {
              if (possibleValues[i] <= availableCapacity + 0.001) { // tol√©rance
                return possibleValues[i];
              }
            }
            
            // Retour √† 0 si aucune valeur possible ou cycle complet
            return 0;
          };
          
          // Genera giorni calendario per CRA
          const generateCRACalendarDays = (year, month, projectId, engineerId) => {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            const adjustedStart = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
            
            const days = [];
            
            // Empty cells prima del primo giorno
            for (let i = 0; i < adjustedStart; i++) {
              days.push(null);
            }
            
            const project = projects.find(p => p.id === projectId);
            if (!project) return days;
            
            const planned = project.engineerMonthlyAllocation?.[engineerId] || {};
            const actual = project.engineerActualAllocation?.[engineerId] || {};
            
            // Giorni del mese
            for (let day = 1; day <= daysInMonth; day++) {
              const date = new Date(year, month, day);
              const dateStr = toLocalDateString(date);
              
              // üîß Utilise la fonction utilitaire pour calculer la disponibilit√©
              const availability = calculateEngineerAvailability(engineerId, dateStr, projectId);
              
              // Check indisponibilit√†
              const engineer = engineers.find(e => e.id === engineerId);
              const isUnavailable = engineer?.unavailability?.some(u => {
                const start = new Date(u.startDate);
                const end = new Date(u.endDate);
                return date >= start && date <= end;
              });
              
              // Check festivit√†
              const isFestivity = isHoliday(date);
              
              days.push({
                day,
                date: dateStr,
                dateObj: date,
                planned: planned[dateStr] || 0,
                actual: actual[dateStr] || 0,
                hasOtherProjects: availability.hasOtherAllocations,
                isFullyBlocked: availability.isFullyBlocked,
                availableCapacity: availability.availableCapacity,
                totalAllocated: availability.totalAllocated,
                otherProjects: availability.allocatedProjects,
                isUnavailable,
                isFestivity,
                isToday: dateStr === toLocalDateString(new Date())
              });
            }
            
            return days;
          };
          
          // Click su giorno calendario CRA
          const handleCRADayClick = (projectId, dayData) => {
            if (!dayData) return;
            
            // Calcola budget disponibile in tempo reale
            const project = projects.find(p => p.id === projectId);
            const budget = project?.engineerDays?.[currentEngineerId] || 0;
            const currentPlanned = project?.engineerMonthlyAllocation?.[currentEngineerId] || {};
            
            // Somma planned su ALTRE date (esclusa quella corrente)
            const otherDatesTotal = Object.entries(currentPlanned)
              .filter(([d]) => d !== dayData.date)
              .reduce((sum, [, val]) => sum + val, 0);
            
            const budgetDisponible = budget - otherDatesTotal;
            
            setCraEditingDate({
              projectId,
              date: dayData.date,
              planned: dayData.planned,
              actual: dayData.actual,
              dateObj: dayData.dateObj,
              hasOtherProjects: dayData.hasOtherProjects,
              isFullyBlocked: dayData.isFullyBlocked,
              availableCapacity: dayData.availableCapacity,
              totalAllocated: dayData.totalAllocated,
              otherProjects: dayData.otherProjects,
              isUnavailable: dayData.isUnavailable,
              isFestivity: dayData.isFestivity,
              budgetTotal: budget,
              budgetDisponible: budgetDisponible,
              otherDatesPlanned: otherDatesTotal
            });
          };
          
          // Salva modifica CRA da calendario
          const saveCRAEdit = () => {
            if (!craEditingDate) return;
            
            // Calcola il massimo che pu√≤ pianificare su questa data
            const maxAllowed = craEditingDate.budgetDisponible;
            
            if (craEditingDate.planned > maxAllowed) {
              alert(`‚ùå Jours command√©s d√©pass√©s! Maximum ${maxAllowed.toFixed(2)}j disponibles sur cette date (${craEditingDate.otherDatesPlanned.toFixed(1)}j d√©j√† planifi√©s sur autres dates)`);
              return;
            }
            
            // Aggiorna progetti con ENTRAMBI planned e actual in un'unica operazione
            const updatedProjects = projects.map(p => {
              if (p.id === craEditingDate.projectId) {
                const plannedAlloc = p.engineerMonthlyAllocation || {};
                const actualAlloc = p.engineerActualAllocation || {};
                
                return {
                  ...p,
                  engineerMonthlyAllocation: {
                    ...plannedAlloc,
                    [currentEngineerId]: {
                      ...(plannedAlloc[currentEngineerId] || {}),
                      [craEditingDate.date]: parseFloat(craEditingDate.planned) || 0
                    }
                  },
                  engineerActualAllocation: {
                    ...actualAlloc,
                    [currentEngineerId]: {
                      ...(actualAlloc[currentEngineerId] || {}),
                      [craEditingDate.date]: parseFloat(craEditingDate.actual) || 0
                    }
                  }
                };
              }
              return p;
            });
            
            // Salva in state E localStorage INSIEME
            setProjects(updatedProjects);
            localStorage.setItem('ingetool_projects', JSON.stringify(updatedProjects));
            
            setCraEditingDate(null);
          };

          // =====================================================
          // FUNZIONI EXPORT PDF CRA CON COMMENTI
          // =====================================================
          
          // Prepara dati per export PDF/Excel CRA di un singolo progetto e mostra modal commenti
          const prepareCRAPDFExport = (projectId, exportType = 'pdf') => {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const engineerName = engineers.find(e => e.id === currentEngineerId)?.name || 'Ing√©nieur';
            
            // Raccogli tutte le righe CRA del progetto
            const craLines = [];
            const actualAlloc = project.engineerActualAllocation?.[currentEngineerId] || {};
            
            Object.entries(actualAlloc).forEach(([dateStr, hours]) => {
              if (hours > 0) {
                const date = new Date(dateStr);
                craLines.push({
                  date: dateStr,
                  dateFormatted: date.toLocaleDateString('fr-FR', { 
                    weekday: 'short', 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                  }),
                  hours: hours,
                  projectName: project.name,
                  projectId: project.id
                });
              }
            });
            
            // Ordina per data
            craLines.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (craLines.length === 0) {
              alert('‚ùå Aucune activit√© √† exporter pour ce projet');
              return;
            }
            
            // Inizializza commenti vuoti
            const initialComments = {};
            craLines.forEach(line => {
              const key = `${line.date}-${line.projectId}`;
              initialComments[key] = '';
            });
            
            setCraPDFData(craLines);
            setCraPDFComments(initialComments);
            setCraExportType(exportType);
            setShowCRAPDFModal(true);
          };
          
          // Genera PDF CRA con commenti per un singolo progetto
          const generateCRAPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const engineerName = engineers.find(e => e.id === currentEngineerId)?.name || 'Ing√©nieur';
            const projectName = craPDFData[0]?.projectName || 'Projet';
            
            // Calcola il mese dalla prima data
            const firstDate = craPDFData[0]?.date ? new Date(craPDFData[0].date) : new Date();
            const moisAnnee = firstDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            
            // Logo Askida Broadcast in alto a SINISTRA
            const logoImg = new Image();
            logoImg.src = 'https://raw.githubusercontent.com/GiordanoAskida/ingetool/main/logo-broadcast.png';
            logoImg.onload = function() {
              doc.addImage(logoImg, 'PNG', 14, 10, 50, 15);
              generatePDFContent();
            };
            
            // Se il logo non carica, genera comunque il PDF
            logoImg.onerror = function() {
              console.warn('Logo non caricato, PDF senza logo');
              generatePDFContent();
            };
            
            const generatePDFContent = () => {
              // Titolo sotto il logo
              doc.setFontSize(16);
              doc.setFont(undefined, 'bold');
              doc.text(`Compte Rendu d'Activit√© - ${engineerName}`, 14, 32);
              
              // Informazioni progetto
              doc.setFontSize(11);
              doc.setFont(undefined, 'normal');
              doc.text(`Projet: ${projectName}`, 14, 40);
              doc.text(`Mois: ${moisAnnee}`, 14, 46);
              doc.text(`G√©n√©r√© le: ${new Date().toLocaleDateString('fr-FR')}`, 14, 52);
            
              // Tableau
              const tableData = craPDFData.map(line => {
                const key = `${line.date}-${line.projectId}`;
                const comment = craPDFComments[key] || '';
                return [
                  line.dateFormatted,
                  formatDays(line.hours),
                  comment
                ];
              });
              
              doc.autoTable({
                startY: 58,
                head: [['Date', 'Temps pass√©', 'Commentaire']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [230, 18, 82], fontStyle: 'bold' },
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                  0: { cellWidth: 40 },
                  1: { cellWidth: 30 },
                  2: { cellWidth: 115 }
                }
              });
              
              // Calcola totale ore
              const totalHours = craPDFData.reduce((sum, line) => sum + line.hours, 0);
              
              const finalY = doc.lastAutoTable.finalY || 35;
              doc.setFontSize(11);
              doc.setFont(undefined, 'bold');
              doc.text(`Total temps pass√©: ${formatDays(totalHours)}`, 14, finalY + 10);
              
              // Footer aziendale
              const pageHeight = doc.internal.pageSize.height;
              doc.setFontSize(8);
              doc.setFont(undefined, 'normal');
              doc.setTextColor(100, 100, 100);
              doc.text('Askida Broadcast - Gestion des √©quipes Ing√©', 105, pageHeight - 10, { align: 'center' });
              doc.text(`Document confidentiel - ${new Date().getFullYear()}`, 105, pageHeight - 6, { align: 'center' });
              doc.setTextColor(0, 0, 0);
              
              // Salva
              const safeProjectName = projectName.replace(/[^a-z0-9]/gi, '_');
              doc.save(`CRA_${engineerName}_${safeProjectName}.pdf`);
              
              // Chiudi modal
              setShowCRAPDFModal(false);
              setCraPDFData([]);
              setCraPDFComments({});
            };
          };

          // =====================================================
          // FUNZIONI EXPORT EXCEL CRA CON COMMENTI
          // =====================================================
          
          const generateCRAExcel = () => {
            const XLSX = window.XLSX;
            if (!XLSX) {
              alert('‚ùå Biblioth√®que Excel non charg√©e. Veuillez recharger la page.');
              return;
            }

            // ‚îÄ‚îÄ Donn√©es de base ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const project = projects.find(p => p.id === craPDFData[0]?.projectId);
            const engineerName = engineers.find(e => e.id === currentEngineerId)?.name || 'Ing√©nieur';
            const projectName  = craPDFData[0]?.projectName || 'Projet';
            const projectCode  = project?.id ? `PRJ-${String(project.id).padStart(4, '0')}` : '';
            const clientName   = project?.tags?.client?.[0] || 'Askida Broadcast';
            const firstDate    = craPDFData[0]?.date ? new Date(craPDFData[0].date) : new Date();
            const year  = firstDate.getFullYear();
            const month = firstDate.getMonth(); // 0-indexed
            const moisAnnee = firstDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

            // Nombre de jours dans le mois
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Map date -> {hours, comment} depuis craPDFData
            const activityMap = {};
            craPDFData.forEach(line => {
              const d = new Date(line.date);
              const dayNum = d.getDate();
              // S'assurer qu'on est bien sur le bon mois
              if (d.getFullYear() === year && d.getMonth() === month) {
                const key = `${line.date}-${line.projectId}`;
                activityMap[dayNum] = {
                  hours:   line.hours,
                  comment: craPDFComments[key] || ''
                };
              }
            });

            // ‚îÄ‚îÄ Helpers styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const BLUE        = '4472C4';
            const BLUE_LIGHT  = 'EBF2FB';
            const WHITE       = 'FFFFFF';
            const GREY_WE     = 'D9D9D9';
            const GREY_TEXT   = '595959';

            const styleHeader = (bold, color, bg, sz, hAlign) => ({
              font: { name: 'Arial', bold: bold || false, color: { rgb: color || '000000' }, sz: sz || 10 },
              fill: { fgColor: { rgb: bg || 'FFFFFF' } },
              alignment: { horizontal: hAlign || 'left', vertical: 'center', wrapText: true },
              border: {
                top:    { style: 'thin', color: { rgb: 'BFBFBF' } },
                bottom: { style: 'thin', color: { rgb: 'BFBFBF' } },
                left:   { style: 'thin', color: { rgb: 'BFBFBF' } },
                right:  { style: 'thin', color: { rgb: 'BFBFBF' } }
              }
            });

            const styleCell = (bold, color, bg, hAlign) => ({
              font: { name: 'Arial', bold: bold || false, color: { rgb: color || '000000' }, sz: 10 },
              fill: { fgColor: { rgb: bg || 'FFFFFF' } },
              alignment: { horizontal: hAlign || 'left', vertical: 'center', wrapText: true },
              border: {
                top:    { style: 'thin', color: { rgb: 'BFBFBF' } },
                bottom: { style: 'thin', color: { rgb: 'BFBFBF' } },
                left:   { style: 'thin', color: { rgb: 'BFBFBF' } },
                right:  { style: 'thin', color: { rgb: 'BFBFBF' } }
              }
            });

            // ‚îÄ‚îÄ Construction ws_data (array of arrays) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const ws_data = [];
            const merges  = [];

            // R1 : vide spacer
            ws_data.push(['', '', '', '', '', '', '', '']);

            // R2 : Titre principal (fusionn√© B-H ‚Üí col 1 √† 7)
            ws_data.push(['', "COMPTE RENDU D'ACTIVIT√â", '', '', '', '', '', '']);
            merges.push({ s: { r: 1, c: 1 }, e: { r: 1, c: 7 } });

            // R3 : Ing√©nieur
            ws_data.push(['', 'Ing√©nieur :', engineerName, '', '', '', '', '']);
            merges.push({ s: { r: 2, c: 2 }, e: { r: 2, c: 7 } });

            // R4 : Soci√©t√© / Client
            ws_data.push(['', 'Soci√©t√© / Client :', clientName, '', '', '', '', '']);
            merges.push({ s: { r: 3, c: 2 }, e: { r: 3, c: 7 } });

            // R5 : Projet + Code
            ws_data.push(['', 'Projet :', projectName, '', '', projectCode, '', '']);
            merges.push({ s: { r: 4, c: 2 }, e: { r: 4, c: 4 } });
            merges.push({ s: { r: 4, c: 5 }, e: { r: 4, c: 7 } });

            // R6 : Mois / Ann√©e
            ws_data.push(['', 'Mois / Ann√©e :', moisAnnee, '', '', '', '', '']);
            merges.push({ s: { r: 5, c: 2 }, e: { r: 5, c: 7 } });

            // R7 : spacer
            ws_data.push(['', '', '', '', '', '', '', '']);

            // R8 : spacer
            ws_data.push(['', '', '', '', '', '', '', '']);

            // R9 : spacer
            ws_data.push(['', '', '', '', '', '', '', '']);

            // R10 : En-t√™tes tableau (row index 9)
            ws_data.push(['', 'Date', 'Jour', 'Actions / Description', 'Sur place ?', "Nb d'heures", 'Jours', 'Base 8h']);
            const TABLE_HEADER_ROW = 10; // 1-indexed

            // R11 √† R11+daysInMonth-1 : un jour par ligne
            const JOUR_FR = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            const DATA_START_ROW = TABLE_HEADER_ROW + 1; // 1-indexed
            const DATA_END_ROW   = DATA_START_ROW + daysInMonth - 1;

            for (let day = 1; day <= daysInMonth; day++) {
              const d         = new Date(year, month, day);
              const dow       = d.getDay(); // 0=Sun,6=Sat
              const isWeekend = dow === 0 || dow === 6;
              const jourLabel = JOUR_FR[dow === 0 ? 6 : dow - 1]; // Mon=0‚Ä¶Sun=6
              const dateLabel = d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
              const act       = activityMap[day] || {};
              const nbHeures  = act.hours != null ? act.hours * 8 : ''; // convert jours‚Üíheures (1j=8h)
              const joursStr  = act.hours != null ? formatDays(act.hours) : '';
              const comment   = act.comment || '';
              const surPlace  = act.hours ? 'Non' : '';

              ws_data.push(['', dateLabel, jourLabel, comment, surPlace, nbHeures !== '' ? nbHeures : '', joursStr, '']);
            }

            // Ligne vide apr√®s donn√©es
            ws_data.push(['', '', '', '', '', '', '', '']);

            // Totaux
            const TOTAL_ROW1 = DATA_END_ROW + 2; // 1-indexed
            const TOTAL_ROW2 = TOTAL_ROW1 + 1;
            ws_data.push(['', 'TOTAL heures :', '', '', '',
              { f: `SUM(F${DATA_START_ROW}:F${DATA_END_ROW})`, t: 'n' }, '', '']);
            merges.push({ s: { r: TOTAL_ROW1 - 1, c: 1 }, e: { r: TOTAL_ROW1 - 1, c: 4 } });

            ws_data.push(['', 'TOTAL jours (base 8h) :', '', '', '', '',
              '', { f: `SUM(H${DATA_START_ROW}:H${DATA_END_ROW})`, t: 'n' }]);
            merges.push({ s: { r: TOTAL_ROW2 - 1, c: 1 }, e: { r: TOTAL_ROW2 - 1, c: 4 } });

            // Spacer + signature
            const SIG_ROW = TOTAL_ROW2 + 3;
            ws_data.push(['', '', '', '', '', '', '', '']);
            ws_data.push(['', '', '', '', '', '', '', '']);
            ws_data.push(['', '', '', '', '', '', '', '']);
            ws_data.push(['', 'Accord :', '', '', '', '', '', '']);
            ws_data.push(['', 'Valid√© par :', '', '', '', '', '', '']);
            ws_data.push(['', 'Le :', '', '', '', '', '', '']);
            merges.push({ s: { r: SIG_ROW - 1,     c: 2 }, e: { r: SIG_ROW - 1,     c: 7 } });
            merges.push({ s: { r: SIG_ROW,     c: 2 }, e: { r: SIG_ROW,     c: 7 } });
            merges.push({ s: { r: SIG_ROW + 1, c: 2 }, e: { r: SIG_ROW + 1, c: 7 } });

            // Footer
            const FOOTER_ROW = SIG_ROW + 3;
            ws_data.push(['', '', '', '', '', '', '', '']);
            ws_data.push(['', '', '', '', '', '', '', '']);
            ws_data.push(['', "Document g√©n√©r√© automatiquement par Ingetool ‚Äî Askida Broadcast", '', '', '', '', '', '']);
            merges.push({ s: { r: FOOTER_ROW - 1, c: 1 }, e: { r: FOOTER_ROW - 1, c: 7 } });

            // ‚îÄ‚îÄ Cr√©ation workbook ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!merges'] = merges;

            // Largeurs colonnes
            ws['!cols'] = [
              { wch: 4  }, // A : marge
              { wch: 13 }, // B : Date
              { wch: 6  }, // C : Jour
              { wch: 52 }, // D : Actions
              { wch: 11 }, // E : Sur place
              { wch: 11 }, // F : Nb heures
              { wch: 9  }, // G : Jours
              { wch: 11 }, // H : Base 8h
            ];

            // Hauteurs lignes
            ws['!rows'] = [];
            ws['!rows'][0]  = { hpt: 10 };
            ws['!rows'][1]  = { hpt: 26 }; // titre
            ws['!rows'][2]  = { hpt: 18 };
            ws['!rows'][3]  = { hpt: 18 };
            ws['!rows'][4]  = { hpt: 18 };
            ws['!rows'][5]  = { hpt: 18 };
            ws['!rows'][9]  = { hpt: 28 }; // en-t√™te tableau

            // ‚îÄ‚îÄ Application des styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const setStyle = (cellRef, style) => {
              if (!ws[cellRef]) ws[cellRef] = { v: '', t: 's' };
              ws[cellRef].s = style;
            };

            // Titre R2
            setStyle('B2', { font: { name: 'Arial', bold: true, sz: 16, color: { rgb: WHITE } }, fill: { fgColor: { rgb: BLUE } }, alignment: { horizontal: 'center', vertical: 'center' } });

            // Labels header info
            ['B3','B4','B5','B6'].forEach(ref => {
              setStyle(ref, { font: { name: 'Arial', bold: true, sz: 10, color: { rgb: WHITE } }, fill: { fgColor: { rgb: BLUE } }, alignment: { horizontal: 'right', vertical: 'center' } });
            });

            // Valeurs header info
            ['C3','C4','C5','F5','C6'].forEach(ref => {
              setStyle(ref, styleCell(false, '000000', BLUE_LIGHT, 'left'));
            });

            // En-t√™tes colonnes tableau (row 10)
            ['B10','C10','D10','E10','F10','G10','H10'].forEach(ref => {
              setStyle(ref, styleHeader(true, WHITE, BLUE, 10, 'center'));
            });

            // Lignes de donn√©es
            for (let day = 1; day <= daysInMonth; day++) {
              const rowNum  = DATA_START_ROW + day - 1;
              const d       = new Date(year, month, day);
              const dow     = d.getDay();
              const isWE    = dow === 0 || dow === 6;
              const bg      = isWE ? GREY_WE : WHITE;
              const txtCol  = isWE ? GREY_TEXT : '000000';
              const bold    = isWE;

              ['B','C','D','E','F','G','H'].forEach(col => {
                const hAlign = (col === 'D') ? 'left' : 'center';
                setStyle(`${col}${rowNum}`, {
                  font:      { name: 'Arial', bold: bold, italic: isWE, sz: col === 'D' ? 9 : 10, color: { rgb: txtCol } },
                  fill:      { fgColor: { rgb: bg } },
                  alignment: { horizontal: hAlign, vertical: 'center', wrapText: col === 'D' },
                  border: {
                    top:    { style: 'thin', color: { rgb: 'BFBFBF' } },
                    bottom: { style: 'thin', color: { rgb: 'BFBFBF' } },
                    left:   { style: 'thin', color: { rgb: 'BFBFBF' } },
                    right:  { style: 'thin', color: { rgb: 'BFBFBF' } }
                  }
                });
              });

              // Formule Base 8h
              const hCell = ws[`H${rowNum}`];
              if (hCell) {
                hCell.f = `IF(F${rowNum}<>"",F${rowNum}/8,"")`;
                hCell.v = '';
                hCell.t = 'n';
                hCell.z = '0.000';
              }
            }

            // Totaux styles
            setStyle(`B${TOTAL_ROW1}`, { font: { name: 'Arial', bold: true, sz: 10, color: { rgb: WHITE } }, fill: { fgColor: { rgb: BLUE } }, alignment: { horizontal: 'right', vertical: 'center' } });
            setStyle(`F${TOTAL_ROW1}`, styleCell(true, '000000', BLUE_LIGHT, 'center'));
            setStyle(`B${TOTAL_ROW2}`, { font: { name: 'Arial', bold: true, sz: 10, color: { rgb: WHITE } }, fill: { fgColor: { rgb: BLUE } }, alignment: { horizontal: 'right', vertical: 'center' } });
            setStyle(`H${TOTAL_ROW2}`, styleCell(true, '000000', BLUE_LIGHT, 'center'));

            // Formules totaux
            if (ws[`F${TOTAL_ROW1}`]) { ws[`F${TOTAL_ROW1}`].f = `SUM(F${DATA_START_ROW}:F${DATA_END_ROW})`; ws[`F${TOTAL_ROW1}`].v = 0; ws[`F${TOTAL_ROW1}`].t = 'n'; }
            if (ws[`H${TOTAL_ROW2}`]) { ws[`H${TOTAL_ROW2}`].f = `SUM(H${DATA_START_ROW}:H${DATA_END_ROW})`; ws[`H${TOTAL_ROW2}`].v = 0; ws[`H${TOTAL_ROW2}`].t = 'n'; ws[`H${TOTAL_ROW2}`].z = '0.000'; }

            // Signature labels
            [`B${SIG_ROW}`,`B${SIG_ROW+1}`,`B${SIG_ROW+2}`].forEach(ref => {
              setStyle(ref, { font: { name: 'Arial', bold: true, sz: 10 }, fill: { fgColor: { rgb: WHITE } }, alignment: { horizontal: 'left', vertical: 'center' } });
            });

            // Footer
            setStyle(`B${FOOTER_ROW}`, { font: { name: 'Arial', sz: 8, italic: true, color: { rgb: '808080' } }, fill: { fgColor: { rgb: WHITE } }, alignment: { horizontal: 'center', vertical: 'center' } });

            // Mise en page impression
            ws['!pageSetup'] = { orientation: 'portrait', paperSize: 9, fitToPage: true, fitToWidth: 1, fitToHeight: 0 };

            XLSX.utils.book_append_sheet(wb, ws, 'CRA');

            // Sauvegarde
            const safe = s => s.replace(/[^a-z0-9]/gi, '_');
            const monthStr = (month + 1).toString().padStart(2, '0');
            XLSX.writeFile(wb, `CRA_${safe(engineerName)}_${safe(projectName)}_${year}_${monthStr}.xlsx`);

            // Ferma modal
            setShowCRAPDFModal(false);
            setCraPDFData([]);
            setCraPDFComments({});
          };

          // =====================================================
          // FUNZIONI CALENDARIO INTERATTIVO RISOLUZIONE CONFLITTI
          // =====================================================
          
          // Genera giorni del mese per il calendario
          const generateConflictCalendarDays = (year, month) => {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay(); // 0 = Dimanche, 1 = Lundi, ...
            
            // Adjust per far iniziare da Luned√¨ (standard europeo)
            const adjustedStart = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
            
            const days = [];
            
            // Giorni vuoti prima del primo giorno del mese
            for (let i = 0; i < adjustedStart; i++) {
              days.push(null);
            }
            
            // Giorni del mese
            for (let day = 1; day <= daysInMonth; day++) {
              days.push(day);
            }
            
            return days;
          };
          
          // =====================================================
          // FUNZIONI CALENDARIO CONFLITTI - SISTEMA ALLOCAZIONE GIORNI
          // =====================================================
          
          // Genera chiave data da giorno
          const getConflictDateKey = (day) => {
            const year = conflictCalendarMonth.getFullYear();
            const month = conflictCalendarMonth.getMonth();
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          };
          
          // Handler click su giorno - Cicla tra stati: vuoto ‚Üí 0.5j ‚Üí 1.0j ‚Üí vuoto
          const handleConflictDayClick = (day, projectKey) => {
            if (!day) return;
            
            const dateKey = getConflictDateKey(day);
            
            setConflictSelectedDays(prev => {
              const projectDays = prev[projectKey] || {};
              const currentValue = projectDays[dateKey] || 0;
              // Ciclo: 0 ‚Üí 0.5 ‚Üí 1.0 ‚Üí 0
              const newValue = currentValue === 0 ? 0.5 : currentValue === 0.5 ? 1.0 : 0;
              
              const newProjectDays = { ...projectDays };
              
              if (newValue === 0) {
                delete newProjectDays[dateKey];
              } else {
                newProjectDays[dateKey] = newValue;
              }
              
              return {
                ...prev,
                [projectKey]: newProjectDays
              };
            });
          };
          
          // Ottieni allocazione giorno (0.5, 1.0 o null)
          const getConflictDayAllocation = (day, projectKey) => {
            if (!day) return null;
            const dateKey = getConflictDateKey(day);
            return conflictSelectedDays[projectKey]?.[dateKey] || null;
          };
          
          // Calcola date d√©but/fin da giorni selezionati
          const calculateConflictProjectDates = (projectKey) => {
            const projectDays = conflictSelectedDays[projectKey] || {};
            const dates = Object.keys(projectDays).sort();
            
            if (dates.length === 0) return { start: '', end: '' };
            
            return {
              start: dates[0],
              end: dates[dates.length - 1]
            };
          };
          
          // Applica selezione range (da date pickers)
          const applyConflictRangeSelection = (projectKey, value) => {
            if (!conflictRangeStart || !conflictRangeEnd) {
              alert('‚ö†Ô∏è S√©lectionnez d\'abord les dates d√©but et fin');
              return;
            }
            
            const start = new Date(conflictRangeStart);
            const end = new Date(conflictRangeEnd);
            
            if (start > end) {
              alert('‚ö†Ô∏è La date d√©but doit √™tre avant la date fin');
              return;
            }
            
            setConflictSelectedDays(prev => {
              const newProjectDays = { ...prev[projectKey] };
              
              // Itera su tutti i giorni nel range
              let currentDate = new Date(start);
              while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay(); // 0 = Dimanche, 6 = Samedi
                
                // Se conflictRangeWorkdaysOnly √® true, salta weekend
                if (conflictRangeWorkdaysOnly && (dayOfWeek === 0 || dayOfWeek === 6)) {
                  currentDate.setDate(currentDate.getDate() + 1);
                  continue;
                }
                
                const dateKey = currentDate.toISOString().split('T')[0];
                newProjectDays[dateKey] = value; // 0.5 o 1.0
                
                currentDate.setDate(currentDate.getDate() + 1);
              }
              
              return {
                ...prev,
                [projectKey]: newProjectDays
              };
            });
          };
          
          // Conta totale giorni allocati
          const getConflictTotalDays = (projectKey) => {
            const projectDays = conflictSelectedDays[projectKey] || {};
            return Object.values(projectDays).reduce((sum, val) => sum + val, 0);
          };

          // =====================================================
          // SYST√àME INTELLIGENT GESTION CONFLITS
          // =====================================================
          
          // Ottieni mappa globale allocazioni per una risorsa specifica: { '2025-12-12': [{ project, allocation }] }
          const getAllocatedDays = (resourceName = null, resourceType = null) => {
            const allocationMap = {};
            
            projects.forEach(project => {
              // Se nessun filtro risorsa, usa selectedDates globale (vecchio comportamento)
              if (!resourceName || !resourceType) {
                if (!project.selectedDates) return;
                
                Object.entries(project.selectedDates).forEach(([date, allocation]) => {
                  if (!allocationMap[date]) {
                    allocationMap[date] = [];
                  }
                  allocationMap[date].push({
                    projectId: project.id,
                    projectName: project.name,
                    allocation: allocation
                  });
                });
                return;
              }
              
              // Filtra per risorsa specifica
              let resourceAllocation = null;
              
              if (resourceType === 'Engineer') {
                resourceAllocation = project.engineerMonthlyAllocation?.[resourceName];
              } else if (resourceType === 'Resource') {
                resourceAllocation = project.resourceMonthlyAllocation?.[resourceName];
              } else if (resourceType === 'Generic') {
                resourceAllocation = project.genericResourceMonthlyAllocation?.[resourceName];
              }
              
              if (!resourceAllocation) return;
              
              Object.entries(resourceAllocation).forEach(([date, allocation]) => {
                if (!allocationMap[date]) {
                  allocationMap[date] = [];
                }
                allocationMap[date].push({
                  projectId: project.id,
                  projectName: project.name,
                  allocation: allocation
                });
              });
            });
            
            return allocationMap;
          };
          
          // Trova progetti che usano giorni specifici (escluso progetto corrente) per una risorsa specifica
          const getConflictingProjects = (selectedDays, currentProjectId = null, resourceName = null, resourceType = null) => {
            const allocationMap = getAllocatedDays(resourceName, resourceType);
            const conflicts = {};
            
            Object.entries(selectedDays).forEach(([date, allocation]) => {
              if (allocation > 0 && allocationMap[date]) {
                const conflictingAllocs = allocationMap[date].filter(
                  alloc => alloc.projectId !== currentProjectId
                );
                
                // üîß CORRECTION: V√©rifie si l'allocation totale d√©passe 1j
                if (conflictingAllocs.length > 0) {
                  const totalExisting = conflictingAllocs.reduce((sum, alloc) => sum + alloc.allocation, 0);
                  const newTotal = totalExisting + allocation;
                  
                  // Conflit seulement si le total d√©passe 1j (avec tol√©rance pour erreurs d'arrondi)
                  if (newTotal > 1.001) {
                    conflicts[date] = conflictingAllocs;
                  }
                }
              }
            });
            
            return conflicts;
          };
          
          // Verifica se un giorno √® allocato in altri progetti per una risorsa specifica
          const isDayAllocatedElsewhere = (date, currentProjectId = null, resourceName = null, resourceType = null) => {
            const allocationMap = getAllocatedDays(resourceName, resourceType);
            if (!allocationMap[date]) return false;
            
            return allocationMap[date].some(alloc => alloc.projectId !== currentProjectId);
          };
          
          // Ottieni dettagli allocazione per tooltip per una risorsa specifica
          const getAllocationDetails = (date, currentProjectId = null, resourceName = null, resourceType = null) => {
            const allocationMap = getAllocatedDays(resourceName, resourceType);
            if (!allocationMap[date]) return null;
            
            const allocations = allocationMap[date].filter(
              alloc => alloc.projectId !== currentProjectId
            );
            
            if (allocations.length === 0) return null;
            
            return allocations;
          };
          
          // Gestisci conferma conflitto e applica modifiche (rimozione/split)
          const handleConflictConfirmation = (conflicts, newSelectedDays, targetProject) => {
            // Update progetti coinvolti
            const updatedProjects = projects.map(project => {
              // Per ogni giorno in conflitto
              Object.keys(conflicts).forEach(date => {
                const conflictingAllocs = conflicts[date];
                const hasConflict = conflictingAllocs.some(alloc => alloc.projectId === project.id);
                
                if (hasConflict && project.selectedDates && project.selectedDates[date]) {
                  const oldAllocation = project.selectedDates[date];
                  const newAllocation = newSelectedDays[date] || 0;
                  
                  // Logica split (Q2: opzione B)
                  if (oldAllocation === 1.0 && newAllocation === 0.5) {
                    // Riduci vecchio progetto a 0.5j
                    project.selectedDates[date] = 0.5;
                  } else if (oldAllocation === 1.0 && newAllocation === 1.0) {
                    // Rimuovi completamente da vecchio progetto
                    delete project.selectedDates[date];
                  } else if (oldAllocation === 0.5 && newAllocation === 0.5) {
                    // Rimuovi da vecchio (split equo non possibile)
                    delete project.selectedDates[date];
                  } else if (oldAllocation === 0.5 && newAllocation === 1.0) {
                    // Rimuovi da vecchio
                    delete project.selectedDates[date];
                  } else {
                    // Default: rimuovi da vecchio progetto
                    delete project.selectedDates[date];
                  }
                }
              });
              
              return project;
            });
            
            // Update progetto target con nuova allocazione
            const finalProjects = updatedProjects.map(project => {
              if (project.id === targetProject.id) {
                return {
                  ...project,
                  selectedDates: {
                    ...project.selectedDates,
                    ...newSelectedDays
                  }
                };
              }
              return project;
            });
            
            setProjects(finalProjects);
            return finalProjects;
          };

          // Funzioni per Alert
          const checkDateOverlap = (date1Start, date1End, date2Start, date2End) => {
            if (!date1Start || !date1End || !date2Start || !date2End) return false;
            return date1Start <= date2End && date2Start <= date1End;
          };
          
          // Nuova funzione: controlla overlap giorni REALI (selectedDates)
          const checkActualDaysOverlap = (project1, project2) => {
            // Se non ci sono selectedDates, usa vecchio metodo date range
            if (!project1.selectedDates || Object.keys(project1.selectedDates).length === 0 ||
                !project2.selectedDates || Object.keys(project2.selectedDates).length === 0) {
              return checkDateOverlap(project1.startDate, project1.endDate, project2.startDate, project2.endDate);
            }
            
            // Controlla se ci sono giorni in comune con allocazione > 0
            const days1 = Object.keys(project1.selectedDates).filter(date => project1.selectedDates[date] > 0);
            const days2 = Object.keys(project2.selectedDates).filter(date => project2.selectedDates[date] > 0);
            
            // Cerca intersezione
            const overlap = days1.some(day => days2.includes(day));
            return overlap;
          };

          const getOverlapAlerts = () => {
            const alerts = [];
            const allResources = [
              ...engineers.map(e => ({ ...e, type: 'engineer' })),
              ...resources.map(r => ({ ...r, type: 'resource' })),
              ...genericResources.map(g => ({ ...g, type: 'generic' }))
            ];

            allResources.forEach(resource => {
              const assignedProjects = projects.filter(p => {
                if (resource.type === 'engineer') return (p.selectedEngineers || []).includes(resource.id);
                if (resource.type === 'resource') return (p.selectedResources || []).includes(resource.id);
                if (resource.type === 'generic') return (p.selectedGenericResources || []).includes(resource.id);
                return false;
              }).filter(p => p.startDate && p.endDate);

              for (let i = 0; i < assignedProjects.length; i++) {
                for (let j = i + 1; j < assignedProjects.length; j++) {
                  // Usa nuova funzione che controlla giorni reali (selectedDates)
                  if (checkActualDaysOverlap(assignedProjects[i], assignedProjects[j])) {
                    alerts.push({
                      type: 'overlap',
                      resource: resource.name,
                      resourceType: resource.type,
                      projects: [assignedProjects[i].name, assignedProjects[j].name]
                    });
                  }
                }
              }
            });
            return alerts;
          };

          const getProjectsWithoutDates = () => {
            return projects.filter(p => !p.startDate || !p.endDate).map(p => ({
              type: 'no-dates',
              project: p.name,
              projectId: p.id
            }));
          };

          const getAllAlerts = () => {
            const baseAlerts = [
              ...getOverlapAlerts(),
              ...getProjectsWithoutDates()
            ];
            
            // Aggiungi alert stats SOLO per admin
            if (userRole === 'admin' && activeTab === 'stats') {
              const statsAlerts = generateAlerts(statsSelectedYear, statsSelectedMonth);
              
              // Converti alert stats in formato compatibile
              const formattedStatsAlerts = [
                ...statsAlerts.urgent.map(a => ({ ...a, category: 'stats-urgent' })),
                ...statsAlerts.attention.map(a => ({ ...a, category: 'stats-attention' })),
                ...statsAlerts.deadlines.map(a => ({ ...a, category: 'stats-deadline' }))
              ];
              
              return [...baseAlerts, ...formattedStatsAlerts];
            }
            
            return baseAlerts;
          };

          // Funzioni per Ricerca e Filtri
          const applySearchAndFilters = (projectsList) => {
            let filtered = projectsList;

            // Ricerca globale
            if (searchQuery) {
              const query = searchQuery.toLowerCase();
              filtered = filtered.filter(p => {
                const projectMatch = p.name.toLowerCase().includes(query) || 
                                    (p.description && p.description.toLowerCase().includes(query));
                const pmMatch = getProjectManager(p) && getProjectManager(p).name.toLowerCase().includes(query);
                const engMatch = getAssignedEngineers(p).some(e => e.name.toLowerCase().includes(query));
                const resMatch = getAssignedResources(p).some(r => r.name.toLowerCase().includes(query));
                const genMatch = getAssignedGenericResources(p).some(g => g.name.toLowerCase().includes(query));
                return projectMatch || pmMatch || engMatch || resMatch || genMatch;
              });
            }

            // Filtro date (esclude progetti senza date)
            if (advancedFilters.dateStart) {
              filtered = filtered.filter(p => p.endDate && p.endDate >= advancedFilters.dateStart);
            }
            if (advancedFilters.dateEnd) {
              filtered = filtered.filter(p => p.startDate && p.startDate <= advancedFilters.dateEnd);
            }

            // Filtro risorsa
            if (advancedFilters.resourceId) {
              const resourceIdNum = parseInt(advancedFilters.resourceId, 10);
              filtered = filtered.filter(p => 
                (p.selectedEngineers || []).includes(resourceIdNum) ||
                (p.selectedResources || []).includes(resourceIdNum) ||
                (p.selectedGenericResources || []).includes(resourceIdNum)
              );
            }

            // Filtro PM
            if (advancedFilters.pmId) {
              const pmIdNum = parseInt(advancedFilters.pmId, 10);
              filtered = filtered.filter(p => p.projectManager === pmIdNum);
            }

            // Filtro Tags
            if (advancedFilters.tags && advancedFilters.tags.length > 0) {
              filtered = filtered.filter(p => {
                if (!p.tags) return false;
                const projectTags = [...(p.tags.client || []), ...(p.tags.type || []), ...(p.tags.priority || [])];
                return advancedFilters.tags.some(tag => projectTags.includes(tag));
              });
            }

            return filtered;
          };

          const resetFilters = () => {
            setSearchQuery('');
            setAdvancedFilters({ dateStart: '', dateEnd: '', resourceId: '', pmId: '', tags: [] });
          };

          const addClientTag = (clientName) => {
            if (clientName && !availableTags.client.includes(clientName)) {
              setAvailableTags({ ...availableTags, client: [...availableTags.client, clientName] });
            }
          };

          const deleteTag = (category, tagToDelete) => {
            // Rimuove il tag da availableTags
            const updatedCategoryTags = availableTags[category].filter(t => t !== tagToDelete);
            setAvailableTags({ ...availableTags, [category]: updatedCategoryTags });
            
            // Rimuove il tag da tutti i progetti che lo usano
            const updatedProjects = projects.map(project => {
              if (project.tags && project.tags[category]) {
                return {
                  ...project,
                  tags: {
                    ...project.tags,
                    [category]: project.tags[category].filter(t => t !== tagToDelete)
                  }
                };
              }
              return project;
            });
            setProjects(updatedProjects);
            
            // Salva in localStorage
            localStorage.setItem('ingetool_projects', JSON.stringify(updatedProjects));
          };

          const toggleTag = (category, tag) => {
            const currentTags = formData.tags[category] || [];
            const newTags = currentTags.includes(tag) 
              ? currentTags.filter(t => t !== tag)
              : [...currentTags, tag];
            setFormData({ ...formData, tags: { ...formData.tags, [category]: newTags } });
          };

          const toggleFilterTag = (tag) => {
            const currentTags = advancedFilters.tags || [];
            const newTags = currentTags.includes(tag)
              ? currentTags.filter(t => t !== tag)
              : [...currentTags, tag];
            setAdvancedFilters({ ...advancedFilters, tags: newTags });
          };

          const getTagColor = (category) => {
            if (category === 'client') return 'bg-blue-100 text-blue-800 border-blue-300';
            if (category === 'type') return 'bg-purple-100 text-purple-800 border-purple-300';
            if (category === 'priority') return 'bg-red-100 text-red-800 border-red-300';
            return 'bg-gray-100 text-gray-800 border-gray-300';
          };

          // Export PDF
          const exportToPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Gestion des √âquipes Ing√© - Askida Broadcast', 14, 20);
            doc.setFontSize(11);
            doc.text(`Rapport g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 14, 28);
            
            let yPos = 40;
            
            // Statistiques
            doc.setFontSize(14);
            doc.text('Statistiques', 14, yPos);
            yPos += 8;
            doc.setFontSize(10);
            doc.text(`Total projets: ${projects.length}`, 20, yPos);
            yPos += 6;
            doc.text(`Probables: ${projects.filter(p => p.status === 'probable').length}`, 20, yPos);
            yPos += 6;
            doc.text(`Place Holder: ${projects.filter(p => p.status === 'presente').length}`, 20, yPos);
            yPos += 6;
            doc.text(`Programm√©s: ${projects.filter(p => p.status === 'programme').length}`, 20, yPos);
            yPos += 10;
            
            // Table projets
            doc.setFontSize(14);
            doc.text('Liste des Projets', 14, yPos);
            yPos += 8;
            
            const tableData = projects.map(p => [
              p.name,
              statusConfig[p.status]?.label || p.status,
              p.startDate ? new Date(p.startDate).toLocaleDateString('fr-FR') : '-',
              p.endDate ? new Date(p.endDate).toLocaleDateString('fr-FR') : '-',
              getAssignedEngineers(p).length + getAssignedResources(p).length + getAssignedGenericResources(p).length
            ]);
            
            doc.autoTable({
              startY: yPos,
              head: [['Projet', 'Statut', 'D√©but', 'Fin', 'Ressources']],
              body: tableData,
              theme: 'striped',
              headStyles: { fillColor: [79, 70, 229] },
              margin: { left: 14, right: 14 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
            
            doc.save('askida-broadcast-rapport.pdf');
          };

          // Backup JSON
          const exportBackup = () => {
            const data = {
              projects,
              engineers,
              resources,
              genericResources,
              projectManagers,
              availableTags,
              exportDate: new Date().toISOString(),
              version: '1.0'
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `askida-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
          };

          // Restore from backup
          const importBackup = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                
                if (data.version && data.projects) {
                  setProjects(data.projects || []);
                  setEngineers(data.engineers || []);
                  setResources(data.resources || []);
                  setGenericResources(data.genericResources || []);
                  setProjectManagers(data.projectManagers || []);
                  if (data.availableTags) {
                    setAvailableTags(data.availableTags);
                  }
                  alert(`‚úÖ Backup restaur√© avec succ√®s!\n${data.projects.length} projets import√©s`);
                  setShowBackupModal(false);
                } else {
                  alert('‚ùå Format de backup invalide');
                }
              } catch (error) {
                alert('‚ùå Erreur lors de la lecture du backup');
              }
            };
            reader.readAsText(file);
          };

          // Vue Ressource functions
          const getAllResources = () => {
            return [
              ...engineers.map(e => ({ ...e, type: 'Ing√©nieur', resourceType: 'engineer' })),
              ...resources.map(r => ({ ...r, type: r.type || 'Ressource', resourceType: 'resource' })),
              ...genericResources.map(g => ({ ...g, type: g.type || 'G√©n√©rique', resourceType: 'generic' }))
            ];
          };

          const getSelectedResource = () => {
            return getAllResources().find(r => r.id == selectedResourceId || r.id === selectedResourceId);
          };

          const getResourceProjects = (resourceId) => {
            if (!resourceId) return [];
            return projects.filter(p => {
              const resource = getAllResources().find(r => r.id == resourceId || r.id === resourceId);
              if (!resource) return false;
              
              if (resource.resourceType === 'engineer') {
                return (p.selectedEngineers || []).some(id => id == resourceId || id === resourceId);
              } else if (resource.resourceType === 'resource') {
                return (p.selectedResources || []).some(id => id == resourceId || id === resourceId);
              } else {
                return (p.selectedGenericResources || []).some(id => id == resourceId || id === resourceId);
              }
            }).filter(p => p.startDate && p.endDate);
          };

          const getResourceConflicts = (resourceId) => {
            const resourceProjects = getResourceProjects(resourceId);
            const conflicts = [];
            
            for (let i = 0; i < resourceProjects.length; i++) {
              for (let j = i + 1; j < resourceProjects.length; j++) {
                // Usa nuova funzione che controlla giorni reali (selectedDates)
                if (checkActualDaysOverlap(resourceProjects[i], resourceProjects[j])) {
                  // Calcola overlap start/end basato su selectedDates se disponibili
                  let overlapStart, overlapEnd;
                  
                  if (resourceProjects[i].selectedDates && resourceProjects[j].selectedDates) {
                    const days1 = Object.keys(resourceProjects[i].selectedDates).filter(d => resourceProjects[i].selectedDates[d] > 0).sort();
                    const days2 = Object.keys(resourceProjects[j].selectedDates).filter(d => resourceProjects[j].selectedDates[d] > 0).sort();
                    const commonDays = days1.filter(d => days2.includes(d)).sort();
                    
                    if (commonDays.length > 0) {
                      overlapStart = new Date(commonDays[0]);
                      overlapEnd = new Date(commonDays[commonDays.length - 1]);
                    } else {
                      // Fallback (non dovrebbe succedere)
                      overlapStart = new Date(Math.max(new Date(resourceProjects[i].startDate), new Date(resourceProjects[j].startDate)));
                      overlapEnd = new Date(Math.min(new Date(resourceProjects[i].endDate), new Date(resourceProjects[j].endDate)));
                    }
                  } else {
                    // Se non ci sono selectedDates, usa date range
                    overlapStart = new Date(Math.max(new Date(resourceProjects[i].startDate), new Date(resourceProjects[j].startDate)));
                    overlapEnd = new Date(Math.min(new Date(resourceProjects[i].endDate), new Date(resourceProjects[j].endDate)));
                  }
                  
                  conflicts.push({
                    project1: resourceProjects[i],
                    project2: resourceProjects[j],
                    overlapStart,
                    overlapEnd
                  });
                }
              }
            }
            return conflicts;
          };

          const getMonthDays = (year, month) => {
            return new Date(year, month + 1, 0).getDate();
          };

          const getResourceDaysInMonth = (resourceId, year, month) => {
            const resource = getAllResources().find(r => r.id == resourceId || r.id === resourceId);
            if (!resource) return { total: 0, byProject: {} };
            
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            const monthStartStr = monthStart.toISOString().split('T')[0];
            const monthEndStr = monthEnd.toISOString().split('T')[0];
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            const resourceProjects = getResourceProjects(resourceId);
            const byProject = {};
            let total = 0;
            
            resourceProjects.forEach(p => {
              if (p.startDate <= monthEndStr && p.endDate >= monthStartStr) {
                let days = 0;
                
                // Cherche si une allocation mensuelle d√©taill√©e existe (avec dates sp√©cifiques)
                let dateAllocation = null;
                if (resource.resourceType === 'engineer') {
                  dateAllocation = p.engineerMonthlyAllocation?.[resourceId];
                } else if (resource.resourceType === 'resource') {
                  dateAllocation = p.resourceMonthlyAllocation?.[resourceId];
                } else {
                  dateAllocation = p.genericResourceMonthlyAllocation?.[resourceId];
                }
                
                // Si allocation d√©taill√©e existe, compte les dates du mois
                if (dateAllocation) {
                  if (Array.isArray(dateAllocation)) {
                    // Vecchio formato: array di stringhe di date
                    days = dateAllocation.filter(d => d.startsWith(monthKey)).length;
                  } else if (typeof dateAllocation === 'object') {
                    // Nuovo formato: oggetto { '2026-01-05': 1.0, '2026-01-12': 0.5 }
                    days = Object.entries(dateAllocation)
                      .filter(([date]) => date.startsWith(monthKey))
                      .reduce((sum, [, value]) => sum + value, 0);
                  }
                } else {
                  // Sinon, distribution uniforme comme avant
                  let totalDays = 0;
                  if (resource.resourceType === 'engineer') {
                    totalDays = p.engineerDays?.[resourceId] || 0;
                    if (!totalDays) {
                      const matchingKey = Object.keys(p.engineerDays || {}).find(k => k == resourceId);
                      if (matchingKey) totalDays = p.engineerDays[matchingKey];
                    }
                  } else if (resource.resourceType === 'resource') {
                    totalDays = p.resourceDays?.[resourceId] || 0;
                    if (!totalDays) {
                      const matchingKey = Object.keys(p.resourceDays || {}).find(k => k == resourceId);
                      if (matchingKey) totalDays = p.resourceDays[matchingKey];
                    }
                  } else {
                    totalDays = p.genericResourceDays?.[resourceId] || 0;
                    if (!totalDays) {
                      const matchingKey = Object.keys(p.genericResourceDays || {}).find(k => k == resourceId);
                      if (matchingKey) totalDays = p.genericResourceDays[matchingKey];
                    }
                  }
                  
                  const projectStart = new Date(Math.max(new Date(p.startDate), monthStart));
                  const projectEnd = new Date(Math.min(new Date(p.endDate), monthEnd));
                  const daysInMonth = Math.ceil((projectEnd - projectStart) / (1000 * 60 * 60 * 24)) + 1;
                  const totalProjectDays = Math.ceil((new Date(p.endDate) - new Date(p.startDate)) / (1000 * 60 * 60 * 24)) + 1;
                  days = Math.round((totalDays * daysInMonth) / totalProjectDays);
                }
                
                byProject[p.id] = { name: p.name, days: days, status: p.status };
                total += days;
              }
            });
            
            return { total, byProject };
          };
          
          // R√©solution automatique par priorit√©
          const resolveByPriority = (conflictData, priorityProjectKey) => {
            // Determina progetti
            const priorityProj = priorityProjectKey === 'project1' ? conflictData.project1 : conflictData.project2;
            const secondaryProj = priorityProjectKey === 'project1' ? conflictData.project2 : conflictData.project1;
            
            // Ottieni info risorsa dal conflictData
            const resourceId = conflictData.resourceId;
            const resourceType = conflictData.resourceType;
            
            // Il progetto prioritario mantiene le sue allocazioni esistenti
            const priorityDays = priorityProj.selectedDates || {};
            
            // Trova giorni disponibili per progetto secondario
            const secondaryStart = new Date(secondaryProj.startDate);
            const secondaryEnd = new Date(secondaryProj.endDate);
            
            // üîß FIX CRITICO: Estendi ricerca a ¬±3 mesi per trovare giorni disponibili
            const extendedStart = new Date(secondaryStart);
            extendedStart.setMonth(extendedStart.getMonth() - 3);
            const extendedEnd = new Date(secondaryEnd);
            extendedEnd.setMonth(extendedEnd.getMonth() + 3);
            
            // üîß FIX: Usa jours vendus per questa risorsa specifica invece di contare tutti i giorni
            let totalDaysNeeded = 0;
            
            if (resourceId && resourceType) {
              // Leggi i jours vendus per la risorsa specifica
              if (resourceType === 'engineer') {
                totalDaysNeeded = secondaryProj.engineerDays?.[resourceId] || 0;
                // Fallback per match con conversione tipo
                if (!totalDaysNeeded) {
                  const matchingKey = Object.keys(secondaryProj.engineerDays || {}).find(k => k == resourceId);
                  if (matchingKey) totalDaysNeeded = secondaryProj.engineerDays[matchingKey];
                }
              } else if (resourceType === 'resource') {
                totalDaysNeeded = secondaryProj.resourceDays?.[resourceId] || 0;
                if (!totalDaysNeeded) {
                  const matchingKey = Object.keys(secondaryProj.resourceDays || {}).find(k => k == resourceId);
                  if (matchingKey) totalDaysNeeded = secondaryProj.resourceDays[matchingKey];
                }
              } else if (resourceType === 'generic') {
                totalDaysNeeded = secondaryProj.genericResourceDays?.[resourceId] || 0;
                if (!totalDaysNeeded) {
                  const matchingKey = Object.keys(secondaryProj.genericResourceDays || {}).find(k => k == resourceId);
                  if (matchingKey) totalDaysNeeded = secondaryProj.genericResourceDays[matchingKey];
                }
              }
            }
            
            // Se non trovato jours vendus, fallback a selectedDates o conteggio giorni
            if (!totalDaysNeeded) {
              if (secondaryProj.selectedDates) {
                totalDaysNeeded = Object.values(secondaryProj.selectedDates).reduce((sum, val) => sum + val, 0);
              } else {
                // Ultimo fallback: conta tutti i giorni lavorativi nel range
                let current = new Date(secondaryStart);
                while (current <= secondaryEnd) {
                  const dayOfWeek = current.getDay();
                  if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    totalDaysNeeded += 1;
                  }
                  current.setDate(current.getDate() + 1);
                }
              }
            }
            
            // Trova giorni disponibili (non occupati dal progetto prioritario)
            const availableDays = [];
            let current = new Date(extendedStart);
            
            while (current <= extendedEnd) {
              const dateStr = current.toISOString().split('T')[0];
              const dayOfWeek = current.getDay();
              
              // Solo giorni lavorativi
              if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                const priorityAllocation = priorityDays[dateStr] || 0;
                const availableCapacity = 1.0 - priorityAllocation;
                
                if (availableCapacity > 0) {
                  availableDays.push({
                    date: dateStr,
                    capacity: availableCapacity
                  });
                }
              }
              
              current.setDate(current.getDate() + 1);
            }
            
            // Alloca progetto secondario nei giorni disponibili
            const secondaryAllocations = {};
            let daysAllocated = 0;
            let warningMessage = null;
            
            for (const day of availableDays) {
              if (daysAllocated >= totalDaysNeeded) break;
              
              const allocationNeeded = Math.min(day.capacity, totalDaysNeeded - daysAllocated);
              secondaryAllocations[day.date] = allocationNeeded;
              daysAllocated += allocationNeeded;
            }
            
            // Verifica se giorni sufficienti
            if (daysAllocated < totalDaysNeeded) {
              const shortage = totalDaysNeeded - daysAllocated;
              warningMessage = `‚ö†Ô∏è Seulement ${daysAllocated}j disponibles sur ${totalDaysNeeded}j demand√©s. Manque: ${shortage.toFixed(1)}j`;
            }
            
            // Calcola nuove date range per progetto secondario
            const allocatedDates = Object.keys(secondaryAllocations).sort();
            const newStartDate = allocatedDates.length > 0 ? allocatedDates[0] : secondaryProj.startDate;
            const newEndDate = allocatedDates.length > 0 ? allocatedDates[allocatedDates.length - 1] : secondaryProj.endDate;
            
            return {
              priorityProject: {
                id: priorityProj.id,
                name: priorityProj.name,
                allocations: priorityDays,
                modified: false
              },
              secondaryProject: {
                id: secondaryProj.id,
                name: secondaryProj.name,
                allocations: secondaryAllocations,
                newStartDate: newStartDate,
                newEndDate: newEndDate,
                modified: true
              },
              warning: warningMessage,
              daysAllocated: daysAllocated,
              daysNeeded: totalDaysNeeded
            };
          };

          const resolveConflict = (conflictData, action, newDates, newSelectedDays = null) => {
            // Determina quale progetto stiamo modificando
            const targetProjectId = action === 'modify1' ? conflictData.project1.id : conflictData.project2.id;
            const targetProjectName = action === 'modify1' ? conflictData.project1.name : conflictData.project2.name;
            
            // Se newSelectedDays non √® fornito, usa solo le date
            const daysToAllocate = newSelectedDays || {};
            
            // V√©rifier conflits avec autres projets (syst√®me intelligent)
            const conflicts = getConflictingProjects(daysToAllocate, targetProjectId);
            
            if (Object.keys(conflicts).length > 0) {
              // Conflits d√©tect√©s - montrer modal de confirmation
              setConflictWarningData({
                days: conflicts,
                affectedProjects: [...new Set(Object.values(conflicts).flatMap(arr => arr.map(a => a.projectName)))],
                currentProject: targetProjectName
              });
              
              // Sauvegarder l'action √† ex√©cuter apr√®s confirmation
              setPendingAllocationAction(() => () => {
                // Appliquer les modifications avec gestion des conflits
                handleConflictConfirmation(conflicts, daysToAllocate, { id: targetProjectId });
                
                // Finaliser la modification du projet
                const updatedProjects = projects.map(p => {
                  if (p.id === targetProjectId) {
                    return { 
                      ...p, 
                      startDate: newDates.startDate, 
                      endDate: newDates.endDate,
                      selectedDates: daysToAllocate
                    };
                  }
                  return p;
                });
                
                setProjects(updatedProjects);
                setShowConflictModal(false);
                setConflictToResolve(null);
              });
              
              setShowConflictWarningModal(true);
            } else {
              // Pas de conflits - appliquer directement
              if (action === 'modify1') {
                const updatedProjects = projects.map(p => 
                  p.id === conflictData.project1.id 
                    ? { ...p, startDate: newDates.startDate, endDate: newDates.endDate, selectedDates: daysToAllocate }
                    : p
                );
                setProjects(updatedProjects);
              } else if (action === 'modify2') {
                const updatedProjects = projects.map(p => 
                  p.id === conflictData.project2.id 
                    ? { ...p, startDate: newDates.startDate, endDate: newDates.endDate, selectedDates: daysToAllocate }
                    : p
                );
                setProjects(updatedProjects);
              }
              setShowConflictModal(false);
              setConflictToResolve(null);
            }
          };
          
          // Fonctions pour allocation mensuelle d√©taill√©e
          const getProjectMonths = () => {
            if (!formData.startDate || !formData.endDate) return [];
            const start = new Date(formData.startDate);
            const end = new Date(formData.endDate);
            const months = [];
            let current = new Date(start.getFullYear(), start.getMonth(), 1);
            
            while (current <= end) {
              months.push({
                key: `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`,
                label: current.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }),
                year: current.getFullYear(),
                month: current.getMonth()
              });
              current.setMonth(current.getMonth() + 1);
            }
            return months;
          };
          
          const formatDateKey = (year, month, day) => {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          };
          
          const toggleDateSelection = (dateKey) => {
            setMonthlyAllocationData(prev => {
              const currentValue = prev.selectedDates[dateKey] || 0;
              const newValue = currentValue === 0 ? 0.5 : currentValue === 0.5 ? 1.0 : 0;
              const newDates = { ...prev.selectedDates };
              
              if (newValue === 0) {
                delete newDates[dateKey];
              } else {
                newDates[dateKey] = newValue;
              }
              
              return { ...prev, selectedDates: newDates };
            });
          };
          
          const getSelectedDatesCount = () => {
            return Object.values(monthlyAllocationData.selectedDates).reduce((sum, val) => sum + val, 0);
          };
          
          const getDatesInMonth = (year, month) => {
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            return Object.entries(monthlyAllocationData.selectedDates)
              .filter(([date]) => date.startsWith(monthKey))
              .reduce((sum, [, value]) => sum + value, 0);
          };
          
          // Funzione per applicare selezione range date
          const applyDateRange = () => {
            if (!rangeStartDate || !rangeEndDate) {
              alert('‚ö†Ô∏è Veuillez s√©lectionner une date de d√©but et une date de fin');
              return;
            }
            
            const start = new Date(rangeStartDate);
            const end = new Date(rangeEndDate);
            
            if (start > end) {
              alert('‚ö†Ô∏è La date de d√©but doit √™tre ant√©rieure √† la date de fin');
              return;
            }
            
            const newDates = { ...monthlyAllocationData.selectedDates };
            const currentDate = new Date(start);
            let skippedDays = 0; // ‚úÖ NUOVO: Counter giorni saltati
            
            while (currentDate <= end) {
              const dayOfWeek = currentDate.getDay(); // 0 = Dimanche, 6 = Samedi
              
              // Se rangeWorkdaysOnly √® true, salta weekend
              if (rangeWorkdaysOnly && (dayOfWeek === 0 || dayOfWeek === 6)) {
                currentDate.setDate(currentDate.getDate() + 1);
                continue;
              }
              
              // Formatta data come 'YYYY-MM-DD'
              const dateKey = currentDate.toISOString().split('T')[0];
              
              // ‚úÖ NUOVO: Verifica se il giorno √® disponibile
              const isAvailable = isResourceAvailable(
                monthlyAllocationData.resourceId,
                monthlyAllocationData.resourceType,
                dateKey,
                dateKey
              );
              
              // ‚úÖ NUOVO: Salta giorni indisponibili
              if (!isAvailable) {
                skippedDays++;
                currentDate.setDate(currentDate.getDate() + 1);
                continue;
              }
              
              // Aggiungi o aggiorna la data con il tipo di allocazione selezionato
              newDates[dateKey] = rangeAllocationType;
              
              currentDate.setDate(currentDate.getDate() + 1);
            }
            
            setMonthlyAllocationData(prev => ({
              ...prev,
              selectedDates: newDates
            }));
            
            // Calcola quanti giorni sono stati selezionati
            const totalSelected = Object.values(newDates).reduce((sum, val) => sum + val, 0);
            
            // ‚úÖ NUOVO: Messaggio con giorni saltati se presenti
            if (skippedDays > 0) {
              alert(`‚úÖ Range appliqu√©! ${totalSelected} jour${totalSelected !== 1 ? 's' : ''} s√©lectionn√©${totalSelected !== 1 ? 's' : ''}\n‚ö†Ô∏è ${skippedDays} jour${skippedDays !== 1 ? 's' : ''} indisponible${skippedDays !== 1 ? 's' : ''} ignor√©${skippedDays !== 1 ? 's' : ''}`);
            } else {
              alert(`‚úÖ Range appliqu√©! ${totalSelected} jour${totalSelected !== 1 ? 's' : ''} s√©lectionn√©${totalSelected !== 1 ? 's' : ''}`);
            }
          };
          
          const openMonthlyAllocationModal = (resourceId, resourceName, resourceType) => {
            const totalDays = resourceType === 'engineer' 
              ? (formData.engineerDays[resourceId] || 0)
              : resourceType === 'resource'
              ? (formData.resourceDays[resourceId] || 0)
              : (formData.genericResourceDays[resourceId] || 0);
            
            const existingAllocation = resourceType === 'engineer'
              ? (formData.engineerMonthlyAllocation[resourceId])
              : resourceType === 'resource'
              ? (formData.resourceMonthlyAllocation[resourceId])
              : (formData.genericResourceMonthlyAllocation[resourceId]);
            
            // Converti vecchio formato (array) in nuovo formato (oggetto) se necessario
            let selectedDates = {};
            if (existingAllocation) {
              if (Array.isArray(existingAllocation)) {
                // Vecchio formato: array di date, converti in oggetto con valore 1.0
                existingAllocation.forEach(date => {
                  selectedDates[date] = 1.0;
                });
              } else {
                // Nuovo formato: gi√† un oggetto
                selectedDates = { ...existingAllocation };
              }
            }
            
            setMonthlyAllocationData({
              resourceId,
              resourceName,
              resourceType,
              totalDays,
              selectedDates
            });
            
            // Inizializza date range con date del progetto
            setRangeStartDate(formData.startDate || '');
            setRangeEndDate(formData.endDate || '');
            setRangeWorkdaysOnly(true);
            setRangeAllocationType(1.0);
            
            setShowMonthlyAllocationModal(true);
          };
          
          const saveMonthlyAllocation = () => {
            const total = getSelectedDatesCount();
            if (total !== monthlyAllocationData.totalDays) {
              alert(`‚ùå Erreur: Le nombre de jours s√©lectionn√©s (${total}j) ne correspond pas au total (${monthlyAllocationData.totalDays}j)`);
              return;
            }
            
            const { resourceId, resourceType, selectedDates } = monthlyAllocationData;
            
            if (resourceType === 'engineer') {
              setFormData(prev => ({
                ...prev,
                engineerMonthlyAllocation: {
                  ...prev.engineerMonthlyAllocation,
                  [resourceId]: selectedDates
                }
              }));
            } else if (resourceType === 'resource') {
              setFormData(prev => ({
                ...prev,
                resourceMonthlyAllocation: {
                  ...prev.resourceMonthlyAllocation,
                  [resourceId]: selectedDates
                }
              }));
            } else {
              setFormData(prev => ({
                ...prev,
                genericResourceMonthlyAllocation: {
                  ...prev.genericResourceMonthlyAllocation,
                  [resourceId]: selectedDates
                }
              }));
            }
            
            setShowMonthlyAllocationModal(false);
          };
          
          const clearMonthlyAllocation = (resourceId, resourceType) => {
            if (resourceType === 'engineer') {
              setFormData(prev => {
                const newAllocation = { ...prev.engineerMonthlyAllocation };
                delete newAllocation[resourceId];
                return { ...prev, engineerMonthlyAllocation: newAllocation };
              });
            } else if (resourceType === 'resource') {
              setFormData(prev => {
                const newAllocation = { ...prev.resourceMonthlyAllocation };
                delete newAllocation[resourceId];
                return { ...prev, resourceMonthlyAllocation: newAllocation };
              });
            } else {
              setFormData(prev => {
                const newAllocation = { ...prev.genericResourceMonthlyAllocation };
                delete newAllocation[resourceId];
                return { ...prev, genericResourceMonthlyAllocation: newAllocation };
              });
            }
          };

          // Swipe functions for mobile
          const handleTouchStart = (e, projectId) => {
            setSwipeStart(e.touches[0].clientX);
          };

          const handleTouchMove = (e, projectId) => {
            if (!swipeStart) return;
            const currentX = e.touches[0].clientX;
            const diff = swipeStart - currentX;
            
            if (Math.abs(diff) > 50) {
              if (diff > 0) {
                setSwipedProject(projectId);
              } else {
                setSwipedProject(null);
              }
            }
          };

          const handleTouchEnd = () => {
            setSwipeStart(null);
          };

          // Funzioni per Vista Carico di Lavoro
          const getResourceWorkload = () => {
            const workload = [];

            engineers.forEach(eng => {
              const assignedProjects = projects.filter(p => (p.selectedEngineers || []).includes(eng.id));
              const totalDays = assignedProjects.reduce((sum, p) => sum + (p.engineerDays?.[eng.id] || 0), 0);
              workload.push({
                id: eng.id,
                name: eng.name,
                type: 'Ing√©nieur',
                specialty: eng.specialty,
                projects: assignedProjects.map(p => ({
                  name: p.name,
                  days: p.engineerDays?.[eng.id] || 0,
                  startDate: p.startDate,
                  endDate: p.endDate,
                  status: p.status
                })),
                totalDays
              });
            });

            resources.forEach(res => {
              const assignedProjects = projects.filter(p => (p.selectedResources || []).includes(res.id));
              const totalDays = assignedProjects.reduce((sum, p) => sum + (p.resourceDays?.[res.id] || 0), 0);
              workload.push({
                id: res.id,
                name: res.name,
                type: 'Ressource',
                specialty: res.type,
                projects: assignedProjects.map(p => ({
                  name: p.name,
                  days: p.resourceDays?.[res.id] || 0,
                  startDate: p.startDate,
                  endDate: p.endDate,
                  status: p.status
                })),
                totalDays
              });
            });

            genericResources.forEach(gen => {
              const assignedProjects = projects.filter(p => (p.selectedGenericResources || []).includes(gen.id));
              const totalDays = assignedProjects.reduce((sum, p) => sum + (p.genericResourceDays?.[gen.id] || 0), 0);
              workload.push({
                id: gen.id,
                name: gen.name,
                type: 'Ressource G√©n√©rique',
                specialty: gen.type,
                projects: assignedProjects.map(p => ({
                  name: p.name,
                  days: p.genericResourceDays?.[gen.id] || 0,
                  startDate: p.startDate,
                  endDate: p.endDate,
                  status: p.status
                })),
                totalDays
              });
            });

            return workload;
          };

          const resetProjectForm = () => {
            setFormData({ 
              name: '', status: 'probable', description: '', 
              selectedEngineers: [], selectedResources: [], selectedGenericResources: [], 
              engineerDays: {}, resourceDays: {}, genericResourceDays: {},
              engineerMonthlyAllocation: {}, resourceMonthlyAllocation: {}, genericResourceMonthlyAllocation: {},
              engineerActualAllocation: {},
              projectManager: '', startDate: '', endDate: '', 
              tags: { client: [], type: [], priority: [] } 
            });
            setShowProjectForm(false);
            setEditingProject(null);
          };

          const startEdit = (project) => {
            setEditingProject(project);
            setFormData({
              ...project,
              engineerDays: project.engineerDays || {},
              resourceDays: project.resourceDays || {},
              genericResourceDays: project.genericResourceDays || {},
              engineerMonthlyAllocation: project.engineerMonthlyAllocation || {},
              resourceMonthlyAllocation: project.resourceMonthlyAllocation || {},
              genericResourceMonthlyAllocation: project.genericResourceMonthlyAllocation || {},
              engineerActualAllocation: project.engineerActualAllocation || {}
            });
            setShowProjectForm(true);
          };

          const calculateWorkDays = (startDate, endDate) => {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            return Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
          };

          const checkResourceConflict = (resourceId, resourceType, startDate, endDate, currentProjectId = null) => {
            if (!startDate || !endDate) return [];
            
            // Crea oggetto temporaneo per il progetto corrente (per usare checkActualDaysOverlap)
            const currentProject = {
              startDate,
              endDate,
              selectedDates: {} // Non ha selectedDates perch√© √® in fase di creazione/modifica
            };
            
            return projects.filter(p => {
              if (p.id === currentProjectId || !p.startDate || !p.endDate) return false;
              const hasResource = resourceType === 'engineer' ? (p.selectedEngineers || []).includes(resourceId)
                : resourceType === 'resource' ? (p.selectedResources || []).includes(resourceId)
                : (p.selectedGenericResources || []).includes(resourceId);
              
              if (!hasResource) return false;
              
              // Usa checkActualDaysOverlap per controllo intelligente
              return checkActualDaysOverlap(currentProject, p);
            });
          };

          const toggleEngineer = (engineerId) => {
            setFormData(prev => {
              const isSelected = (prev.selectedEngineers || []).includes(engineerId);
              const newEngineers = isSelected ? prev.selectedEngineers.filter(id => id !== engineerId) : [...(prev.selectedEngineers || []), engineerId];
              const newEngineerDays = {...prev.engineerDays};
              if (!isSelected && !newEngineerDays[engineerId]) {
                newEngineerDays[engineerId] = calculateWorkDays(prev.startDate, prev.endDate);
              } else if (isSelected) {
                delete newEngineerDays[engineerId];
              }
              return { ...prev, selectedEngineers: newEngineers, engineerDays: newEngineerDays };
            });
          };

          const toggleResource = (resourceId) => {
            setFormData(prev => {
              const isSelected = (prev.selectedResources || []).includes(resourceId);
              const newResources = isSelected ? prev.selectedResources.filter(id => id !== resourceId) : [...(prev.selectedResources || []), resourceId];
              const newResourceDays = {...prev.resourceDays};
              if (!isSelected && !newResourceDays[resourceId]) {
                newResourceDays[resourceId] = calculateWorkDays(prev.startDate, prev.endDate);
              } else if (isSelected) {
                delete newResourceDays[resourceId];
              }
              return { ...prev, selectedResources: newResources, resourceDays: newResourceDays };
            });
          };

          const toggleGenericResource = (resourceId) => {
            setFormData(prev => {
              const isSelected = (prev.selectedGenericResources || []).includes(resourceId);
              const newResources = isSelected ? prev.selectedGenericResources.filter(id => id !== resourceId) : [...(prev.selectedGenericResources || []), resourceId];
              const newGenericResourceDays = {...prev.genericResourceDays};
              if (!isSelected && !newGenericResourceDays[resourceId]) {
                newGenericResourceDays[resourceId] = calculateWorkDays(prev.startDate, prev.endDate);
              } else if (isSelected) {
                delete newGenericResourceDays[resourceId];
              }
              return { ...prev, selectedGenericResources: newResources, genericResourceDays: newGenericResourceDays };
            });
          };

          const getAssignedEngineers = (project) => engineers.filter(e => (project.selectedEngineers || []).includes(e.id));
          const getAssignedResources = (project) => resources.filter(r => (project.selectedResources || []).includes(r.id));
          const getAssignedGenericResources = (project) => genericResources.filter(r => (project.selectedGenericResources || []).includes(r.id));
          const getProjectManager = (project) => projectManagers.find(pm => pm.id === project.projectManager);

          // Calcola percentuale occupazione settimanale per una risorsa
          const calculateWeeklyOccupation = (resourceId, resourceType) => {
            let totalDays = 0;
            
            projects.forEach(project => {
              if (!project.startDate || !project.endDate) return;
              
              let days = 0;
              if (resourceType === 'engineer' && (project.selectedEngineers || []).includes(resourceId)) {
                days = project.engineerDays && project.engineerDays[resourceId] ? project.engineerDays[resourceId] : 0;
              } else if (resourceType === 'resource' && (project.selectedResources || []).includes(resourceId)) {
                days = project.resourceDays && project.resourceDays[resourceId] ? project.resourceDays[resourceId] : 0;
              } else if (resourceType === 'generic' && (project.selectedGenericResources || []).includes(resourceId)) {
                days = project.genericResourceDays && project.genericResourceDays[resourceId] ? project.genericResourceDays[resourceId] : 0;
              }
              
              if (days > 0) {
                const projectDuration = calculateWorkDays(project.startDate, project.endDate);
                const weeks = projectDuration / 5; // semaines
                const daysPerWeek = days / weeks;
                totalDays += daysPerWeek;
              }
            });
            
            const percentage = (totalDays / 5) * 100;
            return Math.round(percentage);
          };

          const exportToExcel = () => {
            let csv = '\uFEFF';
            csv += 'Projet;Statut;Date D√©but;Date Fin;Chef de Projet;Type Ressource;Nom Ressource;Sp√©cialit√©s;Jours Vendus\n';
            
            projects.forEach(project => {
              const pm = getProjectManager(project);
              const pmName = pm ? pm.name : '';
              const startDate = project.startDate ? new Date(project.startDate).toLocaleDateString('fr-FR') : '';
              const endDate = project.endDate ? new Date(project.endDate).toLocaleDateString('fr-FR') : '';
              const status = statusConfig[project.status]?.label || project.status;
              
              getAssignedEngineers(project).forEach(eng => {
                const specialties = [eng.specialty, eng.specialty2, eng.specialty3, eng.specialty4].filter(s => s).join(' / ');
                const days = project.engineerDays && project.engineerDays[eng.id] ? project.engineerDays[eng.id] : 0;
                csv += `${project.name};${status};${startDate};${endDate};${pmName};Ing√©nieur;${eng.name};${specialties};${days}\n`;
              });
              
              getAssignedResources(project).forEach(res => {
                const type = res.type || '';
                const days = project.resourceDays && project.resourceDays[res.id] ? project.resourceDays[res.id] : 0;
                csv += `${project.name};${status};${startDate};${endDate};${pmName};Ressource;${res.name};${type};${days}\n`;
              });
              
              getAssignedGenericResources(project).forEach(res => {
                const type = res.type || '';
                const days = project.genericResourceDays && project.genericResourceDays[res.id] ? project.genericResourceDays[res.id] : 0;
                csv += `${project.name};${status};${startDate};${endDate};${pmName};Ressource G√©n√©rique;${res.name};${type};${days}\n`;
              });
              
              if (getAssignedEngineers(project).length === 0 && getAssignedResources(project).length === 0 && getAssignedGenericResources(project).length === 0) {
                csv += `${project.name};${status};${startDate};${endDate};${pmName};;;;\n`;
              }
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `projets_export_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
          };

          const baseFiltered = filterStatus === 'all' ? visibleProjects : visibleProjects.filter(p => p.status === filterStatus);
          const filteredProjects = applySearchAndFilters(baseFiltered);
          const allAlerts = getAllAlerts();
          const projectsProbables = visibleProjects.filter(p => p.status === 'probable').length;
          const projectsPresente = visibleProjects.filter(p => p.status === 'presente').length;
          const projectsProgramme = visibleProjects.filter(p => p.status === 'programme').length;

          const getDaysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
          const getFirstDayOfMonth = (month, year) => new Date(year, month, 1).getDay();
          const getProjectsForDate = (day) => {
            const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const dateProjects = visibleProjects.filter(p => {
              if (!p.startDate || !p.endDate) return false;
              if (dateStr < p.startDate || dateStr > p.endDate) return false;
              
              // V√©rifie si une ressource a une allocation d√©taill√©e pour ce jour
              let hasDetailedAllocation = false;
              let isDateIncluded = false;
              
              // V√©rifie toutes les ressources du projet
              const allResourceIds = [
                ...(p.selectedEngineers || []),
                ...(p.selectedResources || []),
                ...(p.selectedGenericResources || [])
              ];
              
              for (const resourceId of allResourceIds) {
                // Cherche allocation d√©taill√©e pour cette ressource
                let allocation = null;
                if ((p.selectedEngineers || []).includes(resourceId)) {
                  allocation = p.engineerMonthlyAllocation?.[resourceId];
                } else if ((p.selectedResources || []).includes(resourceId)) {
                  allocation = p.resourceMonthlyAllocation?.[resourceId];
                } else if ((p.selectedGenericResources || []).includes(resourceId)) {
                  allocation = p.genericResourceMonthlyAllocation?.[resourceId];
                }
                
                // Si allocation d√©taill√©e existe
                if (allocation) {
                  hasDetailedAllocation = true;
                  
                  // Gestisce sia vecchio formato (array) che nuovo formato (oggetto)
                  if (Array.isArray(allocation)) {
                    // Vecchio formato: array di stringhe di date
                    if (allocation.includes(dateStr)) {
                      isDateIncluded = true;
                      break;
                    }
                  } else if (typeof allocation === 'object') {
                    // Nuovo formato: oggetto { '2026-01-05': 1.0, '2026-01-12': 0.5 }
                    if (allocation[dateStr] && allocation[dateStr] > 0) {
                      isDateIncluded = true;
                      break;
                    }
                  }
                }
              }
              
              // Si pas d'allocation d√©taill√©e, afficher comme avant
              // Si allocation d√©taill√©e, afficher seulement si date incluse
              return hasDetailedAllocation ? isDateIncluded : true;
            });
            
            return filterCalendarStatus === 'all' ? dateProjects : dateProjects.filter(p => p.status === filterCalendarStatus);
          };

          // Timeline functions
          const getQuarterMonths = (quarter, year) => {
            const startMonth = quarter * 3;
            return [0, 1, 2].map(i => new Date(year, startMonth + i, 1));
          };

          const getQuarterProjects = () => {
            const months = getQuarterMonths(timelineQuarter, timelineYear);
            const quarterStart = months[0].toISOString().split('T')[0];
            const quarterEnd = new Date(months[2].getFullYear(), months[2].getMonth() + 1, 0).toISOString().split('T')[0];
            
            const filteredProjects = visibleProjects.filter(p => {
              if (!p.startDate || !p.endDate) return false;
              return p.startDate <= quarterEnd && p.endDate >= quarterStart;
            });
            
            return filterCalendarStatus === 'all' ? filteredProjects : filteredProjects.filter(p => p.status === filterCalendarStatus);
          };

          const getProjectPosition = (project, quarterStart, quarterEnd) => {
            const start = new Date(Math.max(new Date(project.startDate), new Date(quarterStart)));
            const end = new Date(Math.min(new Date(project.endDate), new Date(quarterEnd)));
            const quarterStartDate = new Date(quarterStart);
            const quarterEndDate = new Date(quarterEnd);
            
            const totalDays = (quarterEndDate - quarterStartDate) / (1000 * 60 * 60 * 24);
            const startOffset = (start - quarterStartDate) / (1000 * 60 * 60 * 24);
            const duration = (end - start) / (1000 * 60 * 60 * 24) + 1;
            
            return {
              left: (startOffset / totalDays) * 100,
              width: (duration / totalDays) * 100
            };
          };

          // =====================================================
          // RENDER CALENDARIO - VISTA SETTIMANA
          // =====================================================
          const renderWeekView = () => {
            const weekDays = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const startOfWeek = new Date(selectedDate);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            startOfWeek.setDate(diff);
            
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
              const date = new Date(startOfWeek);
              date.setDate(startOfWeek.getDate() + i);
              weekDates.push(date);
            }
            
            return (
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex justify-between items-center mb-4">
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setDate(newDate.getDate() - 7);
                      setSelectedDate(newDate);
                    }} 
                    className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded font-semibold"
                  >
                    ‚Üê Semaine pr√©c√©dente
                  </button>
                  <h2 className="text-xl font-bold text-gray-800">
                    Semaine du {weekDates[0].toLocaleDateString('fr-FR')} au {weekDates[6].toLocaleDateString('fr-FR')}
                  </h2>
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setDate(newDate.getDate() + 7);
                      setSelectedDate(newDate);
                    }} 
                    className="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded font-semibold"
                  >
                    Semaine suivante ‚Üí
                  </button>
                </div>
                
                <div className="grid grid-cols-7 gap-2">
                  {weekDates.map((date, idx) => {
                    const projectsOnDay = visibleProjects.filter(p => {
                      if (!p.startDate || !p.endDate) return false;
                      if (filterCalendarStatus !== 'all' && p.status !== filterCalendarStatus) return false;
                      const projectStart = new Date(p.startDate);
                      const projectEnd = new Date(p.endDate);
                      const dayStart = new Date(date);
                      dayStart.setHours(0, 0, 0, 0);
                      const dayEnd = new Date(date);
                      dayEnd.setHours(23, 59, 59, 999);
                      return projectStart <= dayEnd && projectEnd >= dayStart;
                    });
                    
                    const isHolidayDay = isHoliday(date);
                    const isToday = new Date().toDateString() === date.toDateString();
                    
                    return (
                      <div 
                        key={idx} 
                        className={`border-2 rounded-lg p-3 min-h-96 ${isToday ? 'border-blue-500 bg-blue-50' : isHolidayDay ? 'border-red-300 bg-red-50' : 'border-gray-200 bg-white'}`}
                      >
                        <div className="font-bold text-gray-800 mb-2 text-center">
                          <div className="text-sm">{weekDays[idx]}</div>
                          <div className={`text-2xl ${isToday ? 'text-blue-600' : ''}`}>{date.getDate()}</div>
                          {isHolidayDay && (
                            <div className="text-xs text-red-600 mt-1">
                              {holidays.find(h => h.date === toLocalDateString(date))?.name}
                            </div>
                          )}
                        </div>
                        
                        <div className="space-y-2 max-h-80 overflow-y-auto">
                          {projectsOnDay.map(project => {
                            const totalResources = (project.selectedEngineers?.length || 0) + 
                                                 (project.selectedResources?.length || 0) + 
                                                 (project.selectedGenericResources?.length || 0);
                            
                            return (
                              <div 
                                key={project.id} 
                                className={`text-xs px-2 py-2 rounded cursor-pointer hover:opacity-80 ${statusConfig[project.status]?.calendarColor || 'bg-gray-100 text-gray-800'}`}
                                onClick={() => {
                                  setSelectedDayProjects({ 
                                    day: date.getDate(), 
                                    month: date.getMonth(), 
                                    year: date.getFullYear(), 
                                    projects: [project] 
                                  });
                                  setShowDayModal(true);
                                }}
                              >
                                <div className="font-semibold truncate">{project.name}</div>
                                {totalResources > 0 && (
                                  <div className="text-xs opacity-75 mt-1">
                                    üë• {totalResources} ressource(s)
                                  </div>
                                )}
                              </div>
                            );
                          })}
                          {projectsOnDay.length === 0 && (
                            <div className="text-center text-gray-400 text-xs mt-8">
                              Aucun projet
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          };
          
          // =====================================================
          // RENDER CALENDARIO - VISTA ANNO
          // =====================================================
          const renderYearView = () => {
            const year = selectedDate.getFullYear();
            const months = [];
            
            for (let m = 0; m < 12; m++) {
              const monthProjects = visibleProjects.filter(p => {
                if (!p.startDate || !p.endDate) return false;
                if (filterCalendarStatus !== 'all' && p.status !== filterCalendarStatus) return false;
                const projectStart = new Date(p.startDate);
                const projectEnd = new Date(p.endDate);
                const monthStart = new Date(year, m, 1);
                const monthEnd = new Date(year, m + 1, 0);
                return projectStart <= monthEnd && projectEnd >= monthStart;
              });
              
              months.push({
                month: m,
                name: new Date(year, m).toLocaleDateString('fr-FR', { month: 'long' }),
                projects: monthProjects,
                totalProjects: monthProjects.length
              });
            }
            
            return (
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex justify-between items-center mb-6">
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setFullYear(newDate.getFullYear() - 1);
                      setSelectedDate(newDate);
                    }} 
                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded font-semibold"
                  >
                    ‚Üê {year - 1}
                  </button>
                  <h2 className="text-2xl font-bold text-gray-800">Ann√©e {year}</h2>
                  <button 
                    onClick={() => {
                      const newDate = new Date(selectedDate);
                      newDate.setFullYear(newDate.getFullYear() + 1);
                      setSelectedDate(newDate);
                    }} 
                    className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded font-semibold"
                  >
                    {year + 1} ‚Üí
                  </button>
                </div>
                
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                  {months.map(({ month, name, projects, totalProjects }) => (
                    <div 
                      key={month}
                      onClick={() => {
                        setSelectedMonth(month);
                        setSelectedYear(year);
                        setCalendarView('month');
                      }}
                      className="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 hover:shadow-lg cursor-pointer transition-all bg-white"
                    >
                      <div className="font-bold text-gray-800 mb-2 text-center capitalize">
                        {name}
                      </div>
                      <div className="text-center">
                        <div className="text-3xl font-bold text-[#e61252] mb-2">
                          {totalProjects}
                        </div>
                        <div className="text-xs text-gray-600">
                          {totalProjects === 0 ? 'Aucun projet' : totalProjects === 1 ? 'projet' : 'projets'}
                        </div>
                      </div>
                      
                      {totalProjects > 0 && (
                        <div className="mt-3 space-y-1">
                          {Object.entries(
                            projects.reduce((acc, p) => {
                              acc[p.status] = (acc[p.status] || 0) + 1;
                              return acc;
                            }, {})
                          ).map(([status, count]) => (
                            <div key={status} className="flex justify-between text-xs">
                              <span className="text-gray-600">{statusConfig[status]?.label || status}:</span>
                              <span className="font-semibold">{count}</span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            );
          };
          
          // =====================================================
          // RENDER CALENDARIO - VISTA MESE (originale migliorato)
          // =====================================================
          const renderMonthView = () => {
            const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
            const firstDay = getFirstDayOfMonth(selectedMonth, selectedYear);
            const days = [];
            const weekDays = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="p-2"></div>);

            for (let day = 1; day <= daysInMonth; day++) {
              const projectsOnDay = getProjectsForDate(day);
              const currentDate = new Date(selectedYear, selectedMonth, day);
              const isHolidayDay = isHoliday(currentDate);
              
              // Count resources by type for sub-badges
              const resourceCounts = { engineers: 0, resources: 0, generic: 0, pm: 0 };
              projectsOnDay.forEach(p => {
                if (p.selectedEngineers) resourceCounts.engineers += p.selectedEngineers.length;
                if (p.selectedResources) resourceCounts.resources += p.selectedResources.length;
                if (p.selectedGenericResources) resourceCounts.generic += p.selectedGenericResources.length;
                if (p.projectManager) resourceCounts.pm += 1;
              });
              
              days.push(
                <div 
                  key={day} 
                  onClick={() => { 
                    setSelectedDayProjects({ day, month: selectedMonth, year: selectedYear, projects: projectsOnDay }); 
                    setShowDayModal(true); 
                  }} 
                  className={`border border-gray-200 p-2 min-h-32 hover:bg-blue-50 cursor-pointer transition-colors ${
                    isHolidayDay ? 'bg-red-50' : 'bg-white'
                  }`}
                  title={projectsOnDay.length > 0 ? `${projectsOnDay.length} projet(s) - Cliquer pour d√©tails` : ''}
                >
                  <div className="font-semibold text-gray-700 mb-1 flex justify-between items-center">
                    <span className={isHolidayDay ? 'text-red-600' : ''}>{day}</span>
                    {projectsOnDay.length > 0 && (
                      <span className="text-xs bg-[#e61252] text-white rounded-full px-2 py-0.5">{projectsOnDay.length}</span>
                    )}
                  </div>
                  {isHolidayDay && (
                    <div className="text-xs text-red-600 mb-1">
                      üéÑ {holidays.find(h => h.date === toLocalDateString(currentDate))?.name}
                    </div>
                  )}
                  <div className="space-y-1 max-h-16 overflow-y-auto">
                    {projectsOnDay.slice(0, 3).map(project => (
                      <div key={project.id} className={`text-xs px-2 py-1 rounded truncate ${statusConfig[project.status]?.calendarColor || 'bg-gray-100 text-gray-800'}`} title={`${project.name} - ${statusConfig[project.status]?.label || project.status}`}>
                        {project.name}
                      </div>
                    ))}
                    {projectsOnDay.length > 3 && (
                      <div className="text-xs text-gray-500 text-center">+{projectsOnDay.length - 3} autre(s)</div>
                    )}
                  </div>
                  {projectsOnDay.length > 0 && (
                    <div className="mt-2 pt-1 border-t border-gray-200 flex gap-1 flex-wrap">
                      {resourceCounts.pm > 0 && <span className="text-xs bg-orange-100 text-orange-700 px-1 rounded" title="Chefs de projet">üë§{resourceCounts.pm}</span>}
                      {resourceCounts.engineers > 0 && <span className="text-xs bg-pink-50 text-[#c10f47] px-1 rounded" title="Ing√©nieurs">üîß{resourceCounts.engineers}</span>}
                      {resourceCounts.resources > 0 && <span className="text-xs bg-purple-100 text-purple-700 px-1 rounded" title="Ressources">üì¶{resourceCounts.resources}</span>}
                      {resourceCounts.generic > 0 && <span className="text-xs bg-teal-100 text-teal-700 px-1 rounded" title="G√©n√©riques">‚öôÔ∏è{resourceCounts.generic}</span>}
                    </div>
                  )}
                </div>
              );
            }

            return (
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex justify-between items-center mb-4">
                  <button onClick={() => { if (selectedMonth === 0) { setSelectedMonth(11); setSelectedYear(selectedYear - 1); } else { setSelectedMonth(selectedMonth - 1); } }} className="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">‚Üê</button>
                  <h2 className="text-xl font-bold text-gray-800">{new Date(selectedYear, selectedMonth).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h2>
                  <button onClick={() => { if (selectedMonth === 11) { setSelectedMonth(0); setSelectedYear(selectedYear + 1); } else { setSelectedMonth(selectedMonth + 1); } }} className="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">‚Üí</button>
                </div>
                <div className="grid grid-cols-7 gap-1">
                  {weekDays.map(day => <div key={day} className="text-center font-semibold text-gray-700 p-2">{day}</div>)}
                  {days}
                </div>
              </div>
            );
          };

          const renderCalendar = () => {
            return (
              <div className="space-y-4">
                {/* Selector Vista + Gestione Festivit√† */}
                <div className="bg-white rounded-lg shadow p-4 flex flex-wrap gap-3 items-center justify-between">
                  <div className="flex gap-2">
                    <button
                      onClick={() => setCalendarView('week')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                        calendarView === 'week' 
                          ? 'bg-[#e61252] text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üìÖ Semaine
                    </button>
                    <button
                      onClick={() => setCalendarView('month')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                        calendarView === 'month' 
                          ? 'bg-[#e61252] text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üìÜ Mois
                    </button>
                    <button
                      onClick={() => setCalendarView('year')}
                      className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                        calendarView === 'year' 
                          ? 'bg-[#e61252] text-white' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      üìä Ann√©e
                    </button>
                  </div>
                  
                  <div className="flex gap-2">
                    {!isReadOnly && (
                      <button
                        onClick={() => setShowHolidayModal(true)}
                        className="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-800 rounded-lg font-semibold flex items-center gap-2"
                      >
                        üéÑ Jours f√©ri√©s ({holidays.length})
                      </button>
                    )}
                    {!isEngineer && (
                      <button
                        onClick={() => setShowMultiCalendar(!showMultiCalendar)}
                        className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${
                          showMultiCalendar 
                            ? 'bg-purple-600 text-white' 
                            : 'bg-purple-100 hover:bg-purple-200 text-purple-800'
                        }`}
                      >
                        üë• Comparer ressources
                      </button>
                    )}
                  </div>
                </div>
                
                {/* Render vista selezionata */}
                {calendarView === 'week' && renderWeekView()}
                {calendarView === 'month' && renderMonthView()}
                {calendarView === 'year' && renderYearView()}
                
                {/* Multi-Calendario Comparativo */}
                {showMultiCalendar && (
                  <div className="mt-4 bg-white rounded-lg shadow p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <Users size={20} />
                      Comparaison de ressources
                    </h3>
                    
                    {/* Selector Ressources */}
                    <div className="mb-4 bg-gray-50 p-4 rounded-lg">
                      <p className="text-sm font-semibold text-gray-700 mb-3">
                        S√©lectionnez 2-3 ressources √† comparer:
                      </p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {/* Engineers */}
                        <div>
                          <label className="block text-xs font-semibold text-gray-600 mb-2">Ing√©nieurs</label>
                          <select
                            onChange={(e) => {
                              if (e.target.value && multiCalendarResources.length < 3) {
                                const [type, id] = e.target.value.split('-');
                                if (!multiCalendarResources.find(r => r.id === parseInt(id) && r.type === type)) {
                                  setMultiCalendarResources([...multiCalendarResources, { 
                                    id: parseInt(id), 
                                    type,
                                    name: engineers.find(e => e.id === parseInt(id))?.name 
                                  }]);
                                }
                              }
                              e.target.value = '';
                            }}
                            className="w-full border rounded-lg px-3 py-2 text-sm"
                            value=""
                          >
                            <option value="">-- S√©lectionner --</option>
                            {engineers.map(eng => (
                              <option key={eng.id} value={`engineer-${eng.id}`}>{eng.name}</option>
                            ))}
                          </select>
                        </div>
                        
                        {/* Ressources Askida */}
                        <div>
                          <label className="block text-xs font-semibold text-gray-600 mb-2">Ressources Askida</label>
                          <select
                            onChange={(e) => {
                              if (e.target.value && multiCalendarResources.length < 3) {
                                const [type, id] = e.target.value.split('-');
                                if (!multiCalendarResources.find(r => r.id === parseInt(id) && r.type === type)) {
                                  setMultiCalendarResources([...multiCalendarResources, { 
                                    id: parseInt(id), 
                                    type,
                                    name: resources.find(r => r.id === parseInt(id))?.name 
                                  }]);
                                }
                              }
                              e.target.value = '';
                            }}
                            className="w-full border rounded-lg px-3 py-2 text-sm"
                            value=""
                          >
                            <option value="">-- S√©lectionner --</option>
                            {resources.map(res => (
                              <option key={res.id} value={`resource-${res.id}`}>{res.name}</option>
                            ))}
                          </select>
                        </div>
                        
                        {/* Ressources G√©n√©riques */}
                        <div>
                          <label className="block text-xs font-semibold text-gray-600 mb-2">Ressources G√©n√©riques</label>
                          <select
                            onChange={(e) => {
                              if (e.target.value && multiCalendarResources.length < 3) {
                                const [type, id] = e.target.value.split('-');
                                if (!multiCalendarResources.find(r => r.id === parseInt(id) && r.type === type)) {
                                  setMultiCalendarResources([...multiCalendarResources, { 
                                    id: parseInt(id), 
                                    type,
                                    name: genericResources.find(r => r.id === parseInt(id))?.name 
                                  }]);
                                }
                              }
                              e.target.value = '';
                            }}
                            className="w-full border rounded-lg px-3 py-2 text-sm"
                            value=""
                          >
                            <option value="">-- S√©lectionner --</option>
                            {genericResources.map(res => (
                              <option key={res.id} value={`genericResource-${res.id}`}>{res.name}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>
                    
                    {/* Ressources S√©lectionn√©es */}
                    {multiCalendarResources.length > 0 && (
                      <div className="mb-4 flex flex-wrap gap-2">
                        {multiCalendarResources.map((res, idx) => {
                          const resource = getResourceById(res.id, res.type);
                          const allocationPct = calculateAllocationPercentage(res.id, res.type, selectedMonth, selectedYear);
                          
                          return (
                            <div key={idx} className="bg-pink-50 text-[#c10f47] px-3 py-2 rounded-lg flex items-center gap-2">
                              <span className="font-semibold">{res.name}</span>
                              <span className={`text-xs px-2 py-0.5 rounded-full ${
                                allocationPct > 100 ? 'bg-red-200 text-red-800' : 
                                allocationPct > 80 ? 'bg-orange-200 text-orange-800' : 
                                'bg-green-200 text-green-800'
                              }`}>
                                {allocationPct}%
                              </span>
                              <button
                                onClick={() => setMultiCalendarResources(multiCalendarResources.filter((_, i) => i !== idx))}
                                className="text-[#e61252] hover:text-[#c10f47]"
                              >
                                <X size={14} />
                              </button>
                            </div>
                          );
                        })}
                      </div>
                    )}
                    
                    {/* Comparaison Calendrier */}
                    {multiCalendarResources.length >= 2 ? (
                      <div className="grid grid-cols-1 gap-4">
                        {multiCalendarResources.map((selectedRes, idx) => {
                          const resource = getResourceById(selectedRes.id, selectedRes.type);
                          const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
                          const firstDay = getFirstDayOfMonth(selectedMonth, selectedYear);
                          const days = [];
                          const weekDays = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
                          
                          for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="p-1"></div>);
                          
                          for (let day = 1; day <= daysInMonth; day++) {
                            const projectsOnDay = visibleProjects.filter(p => {
                              if (!p.startDate || !p.endDate) return false;
                              const projectStart = new Date(p.startDate);
                              const projectEnd = new Date(p.endDate);
                              const currentDate = new Date(selectedYear, selectedMonth, day);
                              
                              if (projectStart <= currentDate && projectEnd >= currentDate) {
                                if (selectedRes.type === 'engineer' && p.selectedEngineers?.includes(selectedRes.id)) return true;
                                if (selectedRes.type === 'resource' && p.selectedResources?.includes(selectedRes.id)) return true;
                                if (selectedRes.type === 'genericResource' && p.selectedGenericResources?.includes(selectedRes.id)) return true;
                              }
                              return false;
                            });
                            
                            const currentDate = new Date(selectedYear, selectedMonth, day);
                            const isUnavailable = !isResourceAvailable(selectedRes.id, selectedRes.type, currentDate, currentDate);
                            const isHolidayDay = isHoliday(currentDate);
                            
                            days.push(
                              <div 
                                key={day} 
                                className={`border p-1 min-h-16 text-xs ${
                                  isUnavailable ? 'bg-red-100 border-red-300' : 
                                  isHolidayDay ? 'bg-yellow-50 border-yellow-300' :
                                  projectsOnDay.length > 0 ? 'bg-green-50 border-green-300' : 
                                  'bg-white border-gray-200'
                                }`}
                                title={projectsOnDay.length > 0 ? projectsOnDay.map(p => p.name).join(', ') : ''}
                              >
                                <div className="font-semibold text-gray-700">{day}</div>
                                {projectsOnDay.length > 0 && (
                                  <div className="text-xs text-green-700 font-bold">{projectsOnDay.length}</div>
                                )}
                                {isUnavailable && <div className="text-xs text-red-600">üö´</div>}
                              </div>
                            );
                          }
                          
                          return (
                            <div key={idx} className="border-2 border-gray-200 rounded-lg p-4">
                              <h4 className="font-bold text-gray-800 mb-3 flex items-center justify-between">
                                <span>{resource?.name || selectedRes.name}</span>
                                <span className="text-sm text-gray-600">
                                  {calculateMonthlyLoad(selectedRes.id, selectedRes.type, selectedYear, selectedMonth)}h / {resource?.maxMonthlyHours || 160}h
                                </span>
                              </h4>
                              <div className="grid grid-cols-7 gap-0.5">
                                {weekDays.map(d => <div key={d} className="text-center font-semibold text-gray-600 text-xs p-1">{d}</div>)}
                                {days}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <p className="text-center text-gray-500 py-8">
                        S√©lectionnez au moins 2 ressources pour comparer leurs calendriers
                      </p>
                    )}
                  </div>
                )}
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-white p-6" style={{fontFamily: "'Montserrat', sans-serif"}}>
              <div className="max-w-7xl mx-auto">
                {/* üé® ASKIDA BROADCAST HEADER */}
                <div className="mb-8 pb-6 border-b-2 border-gray-100">
                  <div className="flex justify-between items-center mb-4">
                    <div className="flex items-center gap-4">
                      {/* Logo Broadcast */}
                      <div className="flex items-center">
                        <img src="./logo-broadcast.png" alt="Askida Broadcast" style={{maxHeight: '60px', width: 'auto'}} />
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      {/* Badge Utente */}
                      <div className={`px-4 py-2 rounded-lg shadow-md font-semibold text-sm flex items-center gap-2 ${
                        userRole === 'admin' 
                          ? 'text-white' 
                          : 'bg-gray-800 text-white'
                      }`} style={userRole === 'admin' ? {backgroundColor: '#e61252'} : {}}>
                        <span className="text-xl">{userRole === 'admin' ? 'üëë' : 'üëÅÔ∏è'}</span>
                        <div>
                          <div className="text-xs opacity-90">
                            {userRole === 'admin' ? 'Administrateur' : 'Lecteur'}
                          </div>
                          <div className="font-bold">{currentUser}</div>
                        </div>
                      </div>
                      
                      {/* OneDrive Status/Connection */}
                      {oneDriveError && (
                        <div className="bg-red-100 text-red-800 px-3 py-2 rounded-lg shadow-md font-semibold text-xs flex items-center gap-2">
                          <span>‚ö†Ô∏è</span>
                          <span className="hidden md:inline">Erreur Drive</span>
                        </div>
                      )}
                      
                      {isOneDriveReady && !isOneDriveConnected && (
                        <button 
                          onClick={signInOneDrive}
                          className="bg-white hover:bg-blue-50 text-blue-600 px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all font-semibold text-sm flex items-center gap-2"
                          title="Connecter OneDrive"
                        >
                          <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                          </svg>
                          <span className="hidden md:inline">Connecter OneDrive</span>
                        </button>
                      )}
                      
                      {isOneDriveConnected && (
                        <div className="flex items-center gap-2">
                          <div className="bg-green-500 text-white px-3 py-2 rounded-lg shadow-md font-semibold text-xs flex items-center gap-2">
                            <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            <span>Drive</span>
                          </div>
                          <button 
                            onClick={signOutOneDrive}
                            className="bg-white hover:bg-gray-100 text-gray-600 px-2 py-2 rounded-lg shadow-md hover:shadow-lg transition-all text-xs"
                            title="D√©connecter Drive"
                          >
                            ‚úï
                          </button>
                        </div>
                      )}
                      
                      {/* Badge Ruolo Utente */}
                      {isEngineer && (
                        <div className="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg shadow-md font-semibold text-sm flex items-center gap-2">
                          <span>üë∑</span>
                          <span>{currentUser}</span>
                        </div>
                      )}
                      {isAdmin && (
                        <div className="bg-purple-100 text-purple-800 px-4 py-2 rounded-lg shadow-md font-semibold text-sm flex items-center gap-2">
                          <span>üëë</span>
                          <span>Admin</span>
                        </div>
                      )}
                      
                      {/* Bottone Logout */}
                      <button 
                        onClick={() => {
                          sessionStorage.clear();
                          location.reload();
                        }}
                        className="bg-white hover:bg-red-50 text-red-600 px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all font-semibold text-sm flex items-center gap-2"
                        title="D√©connexion"
                      >
                        <span>üö™</span>
                        <span className="hidden md:inline">D√©connexion</span>
                      </button>
                      
                      {/* Alerts - Solo Admin */}
                      {userRole === 'admin' && (
                        <button onClick={() => setShowAlerts(!showAlerts)} className="relative bg-white p-3 rounded-lg shadow hover:shadow-lg transition-all">
                          <Bell size={24} className={allAlerts.length > 0 ? 'text-red-600' : 'text-gray-600'} />
                          {allAlerts.length > 0 && (
                            <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">
                              {allAlerts.length}
                            </span>
                          )}
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Banner Mode Lecture Seule */}
                  {isReadOnly && (
                    <div className="bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-400 rounded-lg p-3 mb-4 flex items-center gap-3 shadow-md">
                      <span className="text-2xl">‚ö†Ô∏è</span>
                      <div>
                        <div className="font-bold text-yellow-900">Mode Lecture Seule</div>
                        <div className="text-sm text-yellow-800">Vous pouvez consulter tous les projets mais vous ne pouvez pas les modifier</div>
                      </div>
                    </div>
                  )}

                  {/* Banner Errore OneDrive */}
                  {oneDriveError && (
                    <div className="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-400 rounded-lg p-4 mb-4 shadow-md">
                      <div className="flex items-start gap-3">
                        <span className="text-3xl">‚ö†Ô∏è</span>
                        <div className="flex-1">
                          <div className="font-bold text-red-900 mb-2">Erreur de chargement OneDrive</div>
                          <div className="text-sm text-red-800 mb-3">{oneDriveError}</div>
                          <div className="bg-red-100 border border-red-300 rounded-lg p-3 mb-3 text-sm">
                            <div className="font-semibold text-red-900 mb-2">üí° Solutions possibles:</div>
                            <ul className="text-red-800 space-y-1 list-disc list-inside">
                              <li>V√©rifier votre connexion internet</li>
                              <li>D√©sactiver les bloqueurs de publicit√©s/extensions</li>
                              <li>Ouvrir la <strong>Console</strong> (F12) et chercher erreurs rouges</li>
                              <li>Essayer un autre navigateur (Chrome, Firefox)</li>
                              <li>Vider le cache du navigateur (Ctrl+Shift+Delete)</li>
                            </ul>
                          </div>
                          <div className="text-sm text-red-700 mb-3">
                            <strong>Note:</strong> L'application fonctionne sans OneDrive, mais les donn√©es ne seront pas synchronis√©es entre appareils.
                          </div>
                          <button 
                            onClick={() => {
                              setOneDriveError(null);
                              location.reload();
                            }}
                            className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm"
                          >
                            üîÑ R√©essayer
                          </button>
                        </div>
                        <button 
                          onClick={() => setOneDriveError(null)}
                          className="text-red-400 hover:text-red-600"
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Barra di ricerca e filtri */}
                  <div className="bg-white rounded-lg shadow p-3 md:p-4 mb-3 md:mb-4">
                    <div className="flex gap-2 md:gap-3 flex-wrap items-end">
                      {!isEngineer && (
                        <div className="flex-1 min-w-full md:min-w-64">
                          <label className="block text-xs md:text-sm font-semibold text-gray-700 mb-1">
                            üîç Recherche
                          </label>
                          <input 
                            type="text" 
                            placeholder="Rechercher..." 
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full border rounded px-2 md:px-3 py-1.5 md:py-2 text-sm"
                          />
                        </div>
                      )}
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date d√©but</label>
                        <input 
                          type="date" 
                          value={advancedFilters.dateStart}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, dateStart: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        />
                      </div>
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date fin</label>
                        <input 
                          type="date" 
                          value={advancedFilters.dateEnd}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, dateEnd: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        />
                      </div>
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Ressource</label>
                        <select 
                          value={advancedFilters.resourceId}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, resourceId: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        >
                          <option value="">Toutes</option>
                          <optgroup label="Ing√©nieurs">
                            {engineers.filter(e => projects.some(p => (p.selectedEngineers || []).includes(e.id))).map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                          </optgroup>
                          <optgroup label="Ressources">
                            {resources.filter(r => projects.some(p => (p.selectedResources || []).includes(r.id))).map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                          </optgroup>
                          <optgroup label="G√©n√©riques">
                            {genericResources.filter(g => projects.some(p => (p.selectedGenericResources || []).includes(g.id))).map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                          </optgroup>
                        </select>
                      </div>
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Chef de projet</label>
                        <select 
                          value={advancedFilters.pmId}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, pmId: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        >
                          <option value="">Tous</option>
                          {projectManagers.map(pm => <option key={pm.id} value={pm.id}>{pm.name}</option>)}
                        </select>
                      </div>
                      <div className="w-full md:col-span-5">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Filtrer par tags</label>
                        <div className="flex flex-wrap gap-2 p-2 border rounded bg-gray-50 min-h-10">
                          {[...availableTags.client.map(t => ({t, c:'client'})), ...availableTags.type.map(t => ({t, c:'type'})), ...availableTags.priority.map(t => ({t, c:'priority'}))].map(({t, c}) => (
                            <button key={t} onClick={() => toggleFilterTag(t)} className={`px-3 py-1 rounded-full text-sm border ${(advancedFilters.tags || []).includes(t) ? getTagColor(c) + ' border-current font-semibold' : 'bg-white text-gray-600 border-gray-300'}`}>
                              {t}
                            </button>
                          ))}
                        </div>
                      </div>
                      <button onClick={resetFilters} className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold whitespace-nowrap">
                        R√©initialiser
                      </button>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                  <div onClick={() => setFilterCalendarStatus('probable')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'probable' ? 'ring-4 ring-yellow-400' : ''}`}><p className="text-sm text-gray-600">Probables</p><p className="text-3xl font-bold text-yellow-600">{projectsProbables}</p></div>
                  <div onClick={() => setFilterCalendarStatus('presente')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'presente' ? 'ring-4 ring-blue-400' : ''}`}><p className="text-sm text-gray-600">Place Holder</p><p className="text-3xl font-bold text-blue-600">{projectsPresente}</p></div>
                  <div onClick={() => setFilterCalendarStatus('programme')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'programme' ? 'ring-4 ring-green-400' : ''}`}><p className="text-sm text-gray-600">Programm√©s</p><p className="text-3xl font-bold text-green-600">{projectsProgramme}</p></div>
                  <div onClick={() => setFilterCalendarStatus('all')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'all' ? 'ring-4 ring-[#e61252]' : ''}`}><p className="text-sm text-gray-600">All Projets</p><p className="text-3xl font-bold text-[#e61252]">{projects.length}</p></div>
                </div>

                {/* Navigation Tabs - Sempre visibili con scroll orizzontale su mobile */}
                <div className="mb-4 md:mb-6 overflow-x-auto">
                  <div className="flex gap-2 min-w-max pb-2">
                    <button onClick={() => setActiveTab('projects')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'projects' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><Briefcase /> Projets</button>
                    <button onClick={() => setActiveTab('calendar')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'calendar' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><Calendar /> Calendrier</button>
                    <button onClick={() => setActiveTab('timeline')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'timeline' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><BarChart /> Timeline</button>
                    {hasCRAAccess && (
                      <button onClick={() => setActiveTab('cra')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'cra' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><User /> Mes Activit√©s</button>
                    )}
                    {!isEngineer && !isReadOnly && (
                      <>
                        <button onClick={() => setActiveTab('resource')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'resource' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><User /> Vue Ressource</button>
                        <button onClick={() => setActiveTab('team')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'team' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><Users /> √âquipe</button>
                        <button onClick={() => setActiveTab('stats')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'stats' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><BarChart /> Statistiques</button>
                        <button onClick={() => setActiveTab('export')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 whitespace-nowrap ${activeTab === 'export' ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}><Download /> Export</button>
                      </>
                    )}
                  </div>
                </div>

                {mobileMenuOpen && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 z-50 md:hidden" onClick={() => setMobileMenuOpen(false)}>
                    <div className="bg-white w-64 h-full shadow-xl p-4" onClick={(e) => e.stopPropagation()}>
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Menu</h2>
                        <button onClick={() => setMobileMenuOpen(false)} className="text-gray-500">
                          <X size={24} />
                        </button>
                      </div>
                      <div className="space-y-2">
                        <button onClick={() => { setActiveTab('projects'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'projects' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><Briefcase /> Projets</button>
                        <button onClick={() => { setActiveTab('calendar'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'calendar' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><Calendar /> Calendrier</button>
                        <button onClick={() => { setActiveTab('timeline'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'timeline' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><BarChart /> Timeline</button>
                        {hasCRAAccess && (
                          <button onClick={() => { setActiveTab('cra'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'cra' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><User /> Mes Activit√©s</button>
                        )}
                        {!isEngineer && !isReadOnly && (
                          <>
                            <button onClick={() => { setActiveTab('resource'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'resource' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><User /> Vue Ressource</button>
                            <button onClick={() => { setActiveTab('team'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'team' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><Users /> √âquipe</button>
                            <button onClick={() => { setActiveTab('stats'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'stats' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><BarChart /> Statistiques</button>
                            <button onClick={() => { setActiveTab('export'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'export' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}><Download /> Export</button>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'projects' && (
                  <div>
                    <div className="flex gap-3 mb-6 flex-wrap">
                      {!isReadOnly && !isEngineer && (
                        <button onClick={() => setShowProjectForm(true)} className="bg-[#e61252] hover:bg-[#c10f47] text-white px-4 py-2 rounded-lg flex items-center gap-2 font-semibold"><Plus /> Nouveau Projet</button>
                      )}
                      {['all', 'probable', 'presente', 'programme'].map(status => (
                        <button key={status} onClick={() => setFilterStatus(status)} className={`px-4 py-2 rounded-lg font-medium ${filterStatus === status ? 'bg-[#e61252] text-white' : 'bg-white text-gray-700 border'}`}>
                          {status === 'all' ? 'Tous' : statusConfig[status]?.label || status}
                        </button>
                      ))}
                    </div>
                    <div className="space-y-4">
                      {filteredProjects.length === 0 ? (
                        <div className="bg-white rounded-lg shadow p-8 text-center"><p className="text-gray-500">Aucun projet trouv√©</p></div>
                      ) : (
                        filteredProjects.map(project => (
                          <div 
                            key={project.id} 
                            className="bg-white rounded-lg shadow-md p-3 md:p-6 relative overflow-hidden transition-transform touch-pan-y"
                            onTouchStart={(e) => handleTouchStart(e, project.id)}
                            onTouchMove={(e) => handleTouchMove(e, project.id)}
                            onTouchEnd={handleTouchEnd}
                            style={swipedProject === project.id ? {transform: 'translateX(-80px)'} : {}}
                          >
                            {swipedProject === project.id && (
                              <div className="absolute right-0 top-0 bottom-0 w-20 flex items-center justify-center bg-red-500 md:hidden">
                                <button onClick={() => { deleteProject(project.id); setSwipedProject(null); }} className="text-white">
                                  <Trash2 size={24} />
                                </button>
                              </div>
                            )}
                            <div>
                            <div className="flex justify-between items-start mb-2 md:mb-3">
                              <div className="flex-1">
                                <h3 className="text-base md:text-xl font-bold text-gray-800">{project.name}</h3>
                                {project.description && <p className="text-gray-600 text-sm mt-1">{project.description}</p>}
                                {(project.startDate || project.endDate) && (
                                  <p className="text-gray-500 text-sm mt-1">
                                    {project.startDate && `Du ${new Date(project.startDate).toLocaleDateString('fr-FR')}`}
                                    {project.startDate && project.endDate && ' - '}
                                    {project.endDate && `au ${new Date(project.endDate).toLocaleDateString('fr-FR')}`}
                                  </p>
                                )}
                                {project.tags && ([...(project.tags.client || []), ...(project.tags.type || []), ...(project.tags.priority || [])].length > 0) && (
                                  <div className="flex flex-wrap gap-1 mt-2">
                                    {(project.tags.client || []).map(tag => (
                                      <span key={tag} className="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800 border border-blue-300">{tag}</span>
                                    ))}
                                    {(project.tags.type || []).map(tag => (
                                      <span key={tag} className="px-2 py-0.5 rounded-full text-xs bg-purple-100 text-purple-800 border border-purple-300">{tag}</span>
                                    ))}
                                    {(project.tags.priority || []).map(tag => (
                                      <span key={tag} className="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 border border-red-300">{tag}</span>
                                    ))}
                                  </div>
                                )}
                              </div>
                              <span className={`px-3 py-1 rounded-full text-sm font-semibold ${statusConfig[project.status]?.color || 'bg-gray-100 text-gray-800'}`}>
                                {statusConfig[project.status]?.label || project.status}
                              </span>
                            </div>
                            {getProjectManager(project) && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-1">Chef de projet :</p>
                                <div className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm inline-flex items-center gap-2">
                                  <UserCog size={14} /> {getProjectManager(project).name} {getProjectManager(project).department && `(${getProjectManager(project).department})`}
                                </div>
                              </div>
                            )}
                            {getAssignedEngineers(project).length > 0 && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-2">Ing√©nieurs :</p>
                                <div className="flex flex-wrap gap-2">
                                  {getAssignedEngineers(project).map(eng => (
                                    <div key={eng.id} className="bg-pink-50 text-[#c10f47] px-3 py-1 rounded-full text-sm">
                                      {eng.name} {eng.specialty && `(${eng.specialty})`}
                                      {project.engineerDays && project.engineerDays[eng.id] ? ` - ${project.engineerDays[eng.id]}j` : ''}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            {getAssignedResources(project).length > 0 && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-2">Ressources :</p>
                                <div className="flex flex-wrap gap-2">
                                  {getAssignedResources(project).map(res => (
                                    <div key={res.id} className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                                      {res.name} {res.type && `(${res.type})`}
                                      {project.resourceDays && project.resourceDays[res.id] ? ` - ${project.resourceDays[res.id]}j` : ''}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            {getAssignedGenericResources(project).length > 0 && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-2">Ressources G√©n√©riques :</p>
                                <div className="flex flex-wrap gap-2">
                                  {getAssignedGenericResources(project).map(res => (
                                    <div key={res.id} className="bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-sm">
                                      {res.name} {res.type && `(${res.type})`}
                                      {project.genericResourceDays && project.genericResourceDays[res.id] ? ` - ${project.genericResourceDays[res.id]}j` : ''}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            {(!isReadOnly && (isAdmin || (isEngineer && project.selectedEngineers?.includes(currentEngineerId)))) && (
                              <div className="flex gap-2 mt-4">
                                <button onClick={() => startEdit(project)} className="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 md:px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-1 md:gap-2 text-sm md:text-base"><Edit2 size={14} className="md:w-4 md:h-4" /> <span className="hidden sm:inline">Modifier</span><span className="sm:hidden">Mod.</span></button>
                                <button onClick={() => deleteProject(project.id)} className="flex-1 bg-red-50 hover:bg-red-100 text-red-600 px-2 md:px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-1 md:gap-2 text-sm md:text-base"><Trash2 size={14} className="md:w-4 md:h-4" /> <span className="hidden sm:inline">Supprimer</span><span className="sm:hidden">Supp.</span></button>
                              </div>
                            )}
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                )}

                {activeTab === 'calendar' && renderCalendar()}

                {activeTab === 'timeline' && (
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                      <div>
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                          üìà Gantt Interactif
                        </h2>
                        <p className="text-gray-600 text-sm">Glissez les projets pour modifier dates ‚Ä¢ Redimensionnez pour ajuster dur√©e</p>
                      </div>
                      
                      {/* Contr√¥les */}
                      <div className="flex flex-wrap gap-2 items-center">
                        {/* Navigation */}
                        <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                          <button 
                            onClick={() => {
                              if (ganttStartMonth === 0) {
                                setGanttStartMonth(11);
                                setGanttStartYear(ganttStartYear - 1);
                              } else {
                                setGanttStartMonth(ganttStartMonth - 1);
                              }
                            }}
                            className="px-3 py-1 bg-white hover:bg-gray-200 rounded text-sm font-semibold transition-colors"
                          >
                            ‚Üê
                          </button>
                          <span className="px-3 text-sm font-semibold text-gray-700 whitespace-nowrap">
                            {new Date(ganttStartYear, ganttStartMonth).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' })}
                          </span>
                          <button 
                            onClick={() => {
                              if (ganttStartMonth === 11) {
                                setGanttStartMonth(0);
                                setGanttStartYear(ganttStartYear + 1);
                              } else {
                                setGanttStartMonth(ganttStartMonth + 1);
                              }
                            }}
                            className="px-3 py-1 bg-white hover:bg-gray-200 rounded text-sm font-semibold transition-colors"
                          >
                            ‚Üí
                          </button>
                        </div>
                        
                        {/* Zoom */}
                        <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                          <button 
                            onClick={() => {
                              if (ganttViewMonths < 12) {
                                const newMonths = ganttViewMonths + 3;
                                setGanttViewMonths(newMonths);
                                setGanttZoom(3 / newMonths);
                              }
                            }}
                            disabled={ganttViewMonths >= 12}
                            className="px-2 py-1 bg-white hover:bg-gray-200 disabled:bg-gray-50 disabled:text-gray-400 rounded text-sm font-semibold transition-colors"
                            title="Zoom out"
                          >
                            ‚àí
                          </button>
                          <span className="px-2 text-xs font-semibold text-gray-600">{ganttViewMonths}M</span>
                          <button 
                            onClick={() => {
                              if (ganttViewMonths > 1) {
                                const newMonths = ganttViewMonths - 1;
                                setGanttViewMonths(newMonths);
                                setGanttZoom(3 / newMonths);
                              }
                            }}
                            disabled={ganttViewMonths <= 1}
                            className="px-2 py-1 bg-white hover:bg-gray-200 disabled:bg-gray-50 disabled:text-gray-400 rounded text-sm font-semibold transition-colors"
                            title="Zoom in"
                          >
                            +
                          </button>
                        </div>
                        
                        {/* Today */}
                        <button
                          onClick={() => {
                            const today = new Date();
                            setGanttStartMonth(today.getMonth());
                            setGanttStartYear(today.getFullYear());
                          }}
                          className="px-3 py-1 bg-pink-50 hover:bg-indigo-200 text-[#c10f47] rounded text-sm font-semibold transition-colors"
                        >
                          Aujourd'hui
                        </button>
                      </div>
                    </div>

                    {(() => {
                      // Calcolo mesi da visualizzare
                      const months = [];
                      for (let i = 0; i < ganttViewMonths; i++) {
                        const month = new Date(ganttStartYear, ganttStartMonth + i, 1);
                        months.push(month);
                      }
                      
                      const periodStart = new Date(ganttStartYear, ganttStartMonth, 1);
                      const periodEnd = new Date(ganttStartYear, ganttStartMonth + ganttViewMonths, 0);
                      
                      // Progetti nel periodo
                      const timelineVisibleProjects = visibleProjects.filter(p => {
                        if (!p.startDate || !p.endDate) return false;
                        const pStart = new Date(p.startDate);
                        const pEnd = new Date(p.endDate);
                        return pStart <= periodEnd && pEnd >= periodStart;
                      });
                      
                      // Raggruppa per status
                      const projectsByStatus = {
                        'programme': timelineVisibleProjects.filter(p => p.status === 'programme'),
                        'presente': timelineVisibleProjects.filter(p => p.status === 'presente'),
                        'probable': timelineVisibleProjects.filter(p => p.status === 'probable')
                      };
                      
                      // Calcolo posizione progetto
                      const getPosition = (project) => {
                        const pStart = new Date(project.startDate);
                        const pEnd = new Date(project.endDate);
                        
                        const periodStartTime = periodStart.getTime();
                        const periodDuration = periodEnd.getTime() - periodStartTime;
                        
                        const projectStart = Math.max(pStart.getTime(), periodStartTime);
                        const projectEnd = Math.min(pEnd.getTime(), periodEnd.getTime());
                        
                        const left = ((projectStart - periodStartTime) / periodDuration) * 100;
                        const width = ((projectEnd - projectStart) / periodDuration) * 100;
                        
                        return { left, width };
                      };
                      
                      // Handle drag start
                      const handleDragStart = (project, e) => {
                        if (isReadOnly) return;
                        e.stopPropagation();
                        setDraggedProject(project);
                        setDragStartX(e.clientX);
                        setDragStartDate(new Date(project.startDate));
                      };
                      
                      // Handle drag
                      const handleDrag = (e) => {
                        if (!draggedProject || !dragStartDate) return;
                        
                        const container = e.currentTarget.getBoundingClientRect();
                        const deltaX = e.clientX - dragStartX;
                        const percentDelta = (deltaX / container.width) * 100;
                        
                        const periodStartTime = periodStart.getTime();
                        const periodDuration = periodEnd.getTime() - periodStartTime;
                        const timeDelta = (percentDelta / 100) * periodDuration;
                        
                        const newStart = new Date(dragStartDate.getTime() + timeDelta);
                        const duration = new Date(draggedProject.endDate).getTime() - new Date(draggedProject.startDate).getTime();
                        const newEnd = new Date(newStart.getTime() + duration);
                        
                        // Aggiorna temporaneamente (visual feedback)
                        const updatedProjects = projects.map(p => 
                          p.id === draggedProject.id 
                            ? { ...p, startDate: newStart.toISOString().split('T')[0], endDate: newEnd.toISOString().split('T')[0] }
                            : p
                        );
                        setProjects(updatedProjects);
                      };
                      
                      // Handle drag end
                      const handleDragEnd = () => {
                        setDraggedProject(null);
                        setDragStartX(0);
                        setDragStartDate(null);
                      };
                      
                      // Handle resize start
                      const handleResizeStart = (project, side, e) => {
                        if (isReadOnly) return;
                        e.stopPropagation();
                        setResizingProject(project);
                        setResizingSide(side);
                        setDragStartX(e.clientX);
                      };
                      
                      // Handle resize
                      const handleResize = (e) => {
                        if (!resizingProject) return;
                        
                        const container = e.currentTarget.getBoundingClientRect();
                        const deltaX = e.clientX - dragStartX;
                        const percentDelta = (deltaX / container.width) * 100;
                        
                        const periodStartTime = periodStart.getTime();
                        const periodDuration = periodEnd.getTime() - periodStartTime;
                        const timeDelta = (percentDelta / 100) * periodDuration;
                        
                        let newStart = new Date(resizingProject.startDate);
                        let newEnd = new Date(resizingProject.endDate);
                        
                        if (resizingSide === 'start') {
                          newStart = new Date(newStart.getTime() + timeDelta);
                          if (newStart >= newEnd) return; // Impedisci overlap
                        } else {
                          newEnd = new Date(newEnd.getTime() + timeDelta);
                          if (newEnd <= newStart) return; // Impedisci overlap
                        }
                        
                        const updatedProjects = projects.map(p => 
                          p.id === resizingProject.id 
                            ? { ...p, startDate: newStart.toISOString().split('T')[0], endDate: newEnd.toISOString().split('T')[0] }
                            : p
                        );
                        setProjects(updatedProjects);
                        setDragStartX(e.clientX);
                      };
                      
                      // Handle resize end
                      const handleResizeEnd = () => {
                        setResizingProject(null);
                        setResizingSide(null);
                      };

                      return (
                        <div 
                          className="space-y-6"
                          onMouseMove={(e) => {
                            if (draggedProject) handleDrag(e);
                            if (resizingProject) handleResize(e);
                          }}
                          onMouseUp={() => {
                            handleDragEnd();
                            handleResizeEnd();
                          }}
                          onMouseLeave={() => {
                            handleDragEnd();
                            handleResizeEnd();
                          }}
                        >
                          {/* Header con mesi */}
                          <div className="flex border-b-2 border-gray-300 pb-2 sticky top-0 bg-white z-10">
                            <div className="w-56 font-semibold text-sm text-gray-700 flex items-center">
                              <span>Projet</span>
                              {!isReadOnly && <span className="ml-2 text-xs text-gray-500">(glisser/redimensionner)</span>}
                            </div>
                            <div className="flex-1 flex relative">
                              {months.map((month, idx) => {
                                const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
                                return (
                                  <div key={idx} className="flex-1 text-center relative border-l-2 border-gray-300">
                                    <div className="font-bold text-sm text-gray-800">
                                      {month.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' })}
                                    </div>
                                    <div className="text-xs text-gray-500">{daysInMonth}j</div>
                                    
                                    {/* Linea oggi */}
                                    {(() => {
                                      const today = new Date();
                                      if (today.getFullYear() === month.getFullYear() && today.getMonth() === month.getMonth()) {
                                        const dayOfMonth = today.getDate();
                                        const percentInMonth = (dayOfMonth / daysInMonth) * 100;
                                        return (
                                          <div 
                                            className="absolute top-0 bottom-0 w-0.5 bg-red-500 opacity-50 z-20"
                                            style={{ left: `${percentInMonth}%` }}
                                            title="Aujourd'hui"
                                          />
                                        );
                                      }
                                    })()}
                                  </div>
                                );
                              })}
                            </div>
                          </div>

                          {/* Progetti per status */}
                          {Object.entries(projectsByStatus).map(([status, statusProjects]) => (
                            statusProjects.length > 0 && (
                              <div key={status} className="space-y-1">
                                <h3 className={`font-bold text-xs px-3 py-1 rounded-lg inline-block ${statusConfig[status]?.color || 'bg-gray-100'}`}>
                                  {statusConfig[status]?.label || status} ({statusProjects.length})
                                </h3>
                                {statusProjects.map(project => {
                                  const pos = getPosition(project);
                                  const resourcesCount = (project.selectedEngineers || []).length + (project.selectedResources || []).length + (project.selectedGenericResources || []).length;
                                  const isDragging = draggedProject?.id === project.id;
                                  const isResizing = resizingProject?.id === project.id;
                                  const isHovered = hoveredProject?.id === project.id;
                                  
                                  return (
                                    <div key={project.id} className="flex items-center group">
                                      <div className="w-56 pr-2">
                                        <div className="text-sm font-semibold text-gray-800 truncate" title={project.name}>{project.name}</div>
                                        <div className="text-xs text-gray-600">
                                          {resourcesCount} ressource(s) ‚Ä¢ {project.soldDays || 0}j vendus
                                        </div>
                                      </div>
                                      <div className="flex-1 relative h-12 border-l-2 border-gray-300">
                                        {/* Griglia mesi */}
                                        {months.map((month, idx) => (
                                          <div 
                                            key={idx} 
                                            className="absolute h-full border-l border-gray-200" 
                                            style={{ left: `${(idx / months.length) * 100}%`, width: `${100 / months.length}%` }}
                                          />
                                        ))}
                                        
                                        {/* Barra progetto */}
                                        <div 
                                          className={`absolute h-8 rounded-lg flex items-center px-3 transition-all ${
                                            statusConfig[project.status]?.calendarColor || 'bg-gray-200'
                                          } ${
                                            isDragging || isResizing ? 'shadow-2xl scale-105 ring-4 ring-indigo-300 z-30' : 
                                            isHovered ? 'shadow-lg ring-2 ring-indigo-200 z-20' : 
                                            'shadow-md hover:shadow-lg z-10'
                                          } ${
                                            !isReadOnly ? 'cursor-move' : 'cursor-default'
                                          }`}
                                          style={{ 
                                            left: `${pos.left}%`, 
                                            width: `${pos.width}%`, 
                                            top: '8px',
                                            minWidth: '80px'
                                          }}
                                          onMouseDown={(e) => !isReadOnly && handleDragStart(project, e)}
                                          onMouseEnter={() => setHoveredProject(project)}
                                          onMouseLeave={() => setHoveredProject(null)}
                                          title={`${project.name}
${new Date(project.startDate).toLocaleDateString('fr-FR')} ‚Üí ${new Date(project.endDate).toLocaleDateString('fr-FR')}
${resourcesCount} ressource(s)
${!isReadOnly ? 'Glisser pour d√©placer ‚Ä¢ Bordures pour redimensionner' : ''}`}
                                        >
                                          {/* Handle resize gauche */}
                                          {!isReadOnly && (
                                            <div 
                                              className="absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize bg-gray-800 bg-opacity-0 hover:bg-opacity-30 transition-colors rounded-l-lg"
                                              onMouseDown={(e) => handleResizeStart(project, 'start', e)}
                                              onClick={(e) => e.stopPropagation()}
                                            />
                                          )}
                                          
                                          <div className="text-xs font-bold truncate flex items-center gap-1 text-gray-900">
                                            {project.name}
                                            {getProjectManager(project) && <span title="PM assign√©">üë§</span>}
                                            {resourcesCount > 0 && <span className="bg-white bg-opacity-30 px-1 rounded">({resourcesCount})</span>}
                                          </div>
                                          
                                          {/* Handle resize destra */}
                                          {!isReadOnly && (
                                            <div 
                                              className="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize bg-gray-800 bg-opacity-0 hover:bg-opacity-30 transition-colors rounded-r-lg"
                                              onMouseDown={(e) => handleResizeStart(project, 'end', e)}
                                              onClick={(e) => e.stopPropagation()}
                                            />
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            )
                          ))}

                          {visibleProjects.length === 0 && (
                            <div className="text-center py-12">
                              <p className="text-gray-500 text-lg">Aucun projet dans cette p√©riode</p>
                              <p className="text-gray-400 text-sm mt-2">Utilisez les fl√®ches pour naviguer ou cr√©ez un nouveau projet</p>
                            </div>
                          )}
                          
                          {/* L√©gende */}
                          {visibleProjects.length > 0 && (
                            <div className="mt-8 pt-4 border-t border-gray-200">
                              <p className="text-xs text-gray-600 mb-2 font-semibold">üí° Conseils d'utilisation:</p>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-600">
                                {!isReadOnly && (
                                  <>
                                    <div className="flex items-center gap-2">
                                      <span className="text-[#e61252]">üñ±Ô∏è</span>
                                      <span>Glissez une barre pour d√©placer le projet</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                      <span className="text-[#e61252]">‚ÜîÔ∏è</span>
                                      <span>Tirez les bordures pour ajuster la dur√©e</span>
                                    </div>
                                  </>
                                )}
                                <div className="flex items-center gap-2">
                                  <span className="text-[#e61252]">üîç</span>
                                  <span>Zoom +/- pour voir plus/moins de mois</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-red-600">‚îÇ</span>
                                  <span>Ligne rouge = aujourd'hui</span>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                )}

                {activeTab === 'cra' && hasCRAAccess && currentEngineerId && (() => {
                  // Filtra progetti dell'engineer
                  const myProjects = visibleProjects.filter(p => 
                    p.selectedEngineers && p.selectedEngineers.includes(currentEngineerId)
                  );
                  
                  // Progetto selezionato o tutti
                  const displayProjects = craSelectedProject === 'all' 
                    ? myProjects 
                    : myProjects.filter(p => p.id === craSelectedProject);
                  
                  return (
                    <div className="space-y-6">
                      {/* Header */}
                      <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                          <User size={32} className="text-[#e61252]" /> Mes Activit√©s (CRA)
                        </h2>
                        <p className="text-gray-600">
                          Suivez et mettez √† jour vos heures r√©ellement travaill√©es. Les modifications sont enregistr√©es dans Ingetool mais ne modifient pas votre calendrier Teams (g√©r√© par l'admin).
                        </p>
                      </div>

                      {/* Filtres */}
                      <div className="bg-white rounded-lg shadow p-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Projet</label>
                            <select 
                              value={craSelectedProject}
                              onChange={(e) => setCraSelectedProject(e.target.value)}
                              className="w-full border rounded-lg px-3 py-2"
                            >
                              <option value="all">Tous mes projets</option>
                              {myProjects.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Mois</label>
                            <select 
                              value={craSelectedMonth}
                              onChange={(e) => setCraSelectedMonth(parseInt(e.target.value))}
                              className="w-full border rounded-lg px-3 py-2"
                            >
                              {['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'].map((m, i) => (
                                <option key={i} value={i}>{m}</option>
                              ))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Ann√©e</label>
                            <select 
                              value={craSelectedYear}
                              onChange={(e) => setCraSelectedYear(parseInt(e.target.value))}
                              className="w-full border rounded-lg px-3 py-2"
                            >
                              {[2024, 2025, 2026, 2027, 2028].map(y => (
                                <option key={y} value={y}>{y}</option>
                              ))}
                            </select>
                          </div>
                        </div>
                      </div>

                      {/* Projets */}
                      {displayProjects.length === 0 ? (
                        <div className="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                          Aucun projet trouv√©
                        </div>
                      ) : (
                        displayProjects.map(project => {
                          const plannedDays = calculatePlannedDays(project, currentEngineerId);
                          const actualDays = calculateActualDays(project, currentEngineerId);
                          const remainingDays = calculateRemainingDays(project, currentEngineerId);
                          const completionRate = calculateCompletionRate(project, currentEngineerId);
                          
                          const hasActual = (project.engineerActualAllocation?.[currentEngineerId] && 
                            Object.keys(project.engineerActualAllocation[currentEngineerId]).length > 0);
                          
                          const dates = getCRADatesForMonth(project, currentEngineerId, craSelectedYear, craSelectedMonth);
                          
                          // Calcul jours restants jusqu'√† fin projet
                          const endDate = new Date(project.endDate);
                          const today = new Date();
                          const daysUntilEnd = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                          
                          return (
                            <div key={project.id} className="bg-white rounded-lg shadow">
                              {/* Vue d'ensemble */}
                              <div className="p-6 border-b">
                                <div className="flex justify-between items-start mb-4">
                                  <div>
                                    <h3 className="text-2xl font-bold text-gray-800">{project.name}</h3>
                                    <p className="text-gray-600">
                                      {new Date(project.startDate).toLocaleDateString('fr-FR')} - {new Date(project.endDate).toLocaleDateString('fr-FR')}
                                    </p>
                                  </div>
                                  <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                                    project.status === 'programme' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                  }`}>
                                    {project.status === 'programme' ? 'Programm√©' : 
                                     project.status === 'probable' ? 'Probable' : 'Place Holder'}
                                  </span>
                                </div>
                                
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                  <div className="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                    <div className="text-sm text-gray-600">Budget projet</div>
                                    <div className="text-2xl font-bold text-purple-800">{project.engineerDays?.[currentEngineerId] || 0}j</div>
                                    <div className="text-xs text-gray-500 mt-1">Jours √† planifier</div>
                                  </div>
                                  <div className={`p-3 rounded-lg border ${
                                    plannedDays === (project.engineerDays?.[currentEngineerId] || 0) ? 'bg-blue-50 border-blue-200' :
                                    plannedDays < (project.engineerDays?.[currentEngineerId] || 0) ? 'bg-yellow-50 border-yellow-200' :
                                    'bg-orange-50 border-orange-200'
                                  }`}>
                                    <div className="text-sm text-gray-600">Jours planifi√©s</div>
                                    <div className={`text-2xl font-bold ${
                                      plannedDays === (project.engineerDays?.[currentEngineerId] || 0) ? 'text-blue-800' :
                                      plannedDays < (project.engineerDays?.[currentEngineerId] || 0) ? 'text-yellow-800' :
                                      'text-orange-800'
                                    }`}>
                                      {plannedDays.toFixed(1)}j
                                    </div>
                                    {(project.engineerDays?.[currentEngineerId] || 0) > 0 && (
                                      <div className="text-xs text-gray-600 mt-1">
                                        {Math.round((plannedDays / (project.engineerDays?.[currentEngineerId] || 1)) * 100)}% du budget
                                      </div>
                                    )}
                                  </div>
                                  <div className="bg-green-50 p-3 rounded-lg">
                                    <div className="text-sm text-gray-600">Jours r√©alis√©s</div>
                                    <div className="text-2xl font-bold text-green-800">{actualDays.toFixed(1)}j</div>
                                    <div className="text-xs text-gray-600 mt-1">({completionRate}%)</div>
                                  </div>
                                  <div className={`p-3 rounded-lg ${remainingDays < 0 ? 'bg-red-50' : 'bg-gray-50'}`}>
                                    <div className="text-sm text-gray-600">√âcart</div>
                                    <div className={`text-2xl font-bold ${remainingDays < 0 ? 'text-red-800' : 'text-gray-800'}`}>
                                      {remainingDays > 0 ? '+' : ''}{(actualDays - plannedDays).toFixed(1)}j
                                    </div>
                                    <div className="text-xs text-gray-500 mt-1">R√©alis√© - Planifi√©</div>
                                  </div>
                                </div>
                                
                                {daysUntilEnd < 60 && remainingDays > 0 && (
                                  <div className="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-start gap-2">
                                    <span className="text-yellow-600">‚ö†Ô∏è</span>
                                    <div className="text-sm text-yellow-800">
                                      <strong>Attention:</strong> Le projet se termine dans {daysUntilEnd} jours et il reste {remainingDays.toFixed(1)}j √† r√©aliser.
                                    </div>
                                  </div>
                                )}
                                
                                {remainingDays < 0 && project.soldDays > 0 && (
                                  <div className="mt-4 bg-red-50 border border-red-200 rounded-lg p-3 flex items-start gap-2">
                                    <span className="text-red-600">‚ö†Ô∏è</span>
                                    <div className="text-sm text-red-800">
                                      <strong>D√©passement:</strong> Vous avez travaill√© {Math.abs(remainingDays).toFixed(1)}j de plus que les jours vendus ({project.soldDays}j).
                                    </div>
                                  </div>
                                )}
                              </div>
                              
                              {/* Saisie CRA - CALENDARIO INTERATTIVO */}
                              <div className="p-6">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                                  <h4 className="text-lg font-semibold text-gray-800">
                                    üìÖ Saisie CRA - Calendrier Interactif
                                  </h4>
                                  <div className="flex gap-2">
                                    {!hasActual && (
                                      <button
                                        onClick={() => copyPlannedToActual(project.id)}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                                      >
                                        üîÑ Copier du planifi√©
                                      </button>
                                    )}
                                    {hasActual && (
                                      <button
                                        onClick={() => prepareCRAPDFExport(project.id)}
                                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2 font-semibold"
                                      >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        üìÑ Exporter PDF
                                      </button>
                                    )}
                                    {hasActual && (
                                      <button
                                        onClick={() => prepareCRAPDFExport(project.id, 'excel')}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 font-semibold"
                                      >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                                        </svg>
                                        üìä Exporter Excel
                                      </button>
                                    )}
                                  </div>
                                </div>
                                
                                {/* Navigation mois */}
                                <div className="flex items-center justify-between mb-6 bg-gray-50 rounded-lg p-4">
                                  <button
                                    onClick={() => {
                                      if (craCalendarMonth === 0) {
                                        setCraCalendarMonth(11);
                                        setCraCalendarYear(craCalendarYear - 1);
                                      } else {
                                        setCraCalendarMonth(craCalendarMonth - 1);
                                      }
                                    }}
                                    className="p-2 hover:bg-gray-200 rounded"
                                  >
                                    ‚óÄ
                                  </button>
                                  
                                  <div className="text-center">
                                    <h3 className="text-xl font-bold text-gray-800">
                                      {['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'][craCalendarMonth]} {craCalendarYear}
                                    </h3>
                                  </div>
                                  
                                  <button
                                    onClick={() => {
                                      if (craCalendarMonth === 11) {
                                        setCraCalendarMonth(0);
                                        setCraCalendarYear(craCalendarYear + 1);
                                      } else {
                                        setCraCalendarMonth(craCalendarMonth + 1);
                                      }
                                    }}
                                    className="p-2 hover:bg-gray-200 rounded"
                                  >
                                    ‚ñ∂
                                  </button>
                                </div>
                                
                                {/* L√©gende */}
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4 text-xs">
                                  <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 bg-blue-500 rounded"></div>
                                    <span>Planifi√©</span>
                                  </div>
                                  <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 bg-green-500 rounded"></div>
                                    <span>Conforme</span>
                                  </div>
                                  <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 bg-orange-500 rounded"></div>
                                    <span>Diff√©rent</span>
                                  </div>
                                  <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 bg-red-500 rounded"></div>
                                    <span>Bloqu√©</span>
                                  </div>
                                  <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 bg-amber-300 rounded"></div>
                                    <span>Partiel</span>
                                  </div>
                                  <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 rounded" style={{backgroundColor: '#8f00ff'}}></div>
                                    <span>Indispo</span>
                                  </div>
                                  <div className="flex items-center gap-1">
                                    <div className="w-4 h-4 bg-gray-300 rounded"></div>
                                    <span>Jours f√©ri√©s</span>
                                  </div>
                                </div>
                                
                                {/* Calendario */}
                                <div className="bg-white border rounded-lg overflow-hidden">
                                  <div className="grid grid-cols-7 bg-gray-100">
                                    {['Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa', 'Di'].map(day => (
                                      <div key={day} className="text-center py-2 font-semibold text-gray-700 text-sm">
                                        {day}
                                      </div>
                                    ))}
                                  </div>
                                  
                                  <div className="grid grid-cols-7">
                                    {generateCRACalendarDays(craCalendarYear, craCalendarMonth, project.id, currentEngineerId).map((dayData, idx) => {
                                      if (!dayData) {
                                        return <div key={`empty-${idx}`} className="h-16 border border-gray-200"></div>;
                                      }
                                      
                                      const isMatch = dayData.planned === dayData.actual && dayData.planned > 0;
                                      const isDifferent = dayData.planned !== dayData.actual && dayData.planned > 0;
                                      
                                      let bgColor = 'bg-white';
                                      let availabilityText = '';
                                      
                                      if (dayData.isFestivity) {
                                        bgColor = 'bg-gray-300';
                                      } else if (dayData.isUnavailable) {
                                        bgColor = 'purple-indispo';
                                      } else if (dayData.isFullyBlocked) {
                                        bgColor = 'bg-red-100';
                                        availabilityText = 'üî¥';
                                      } else if (dayData.hasOtherProjects && dayData.availableCapacity > 0) {
                                        bgColor = 'bg-amber-100';
                                        availabilityText = `‚ö†Ô∏è${dayData.availableCapacity}j`;
                                      } else if (isMatch) {
                                        bgColor = 'bg-green-100';
                                      } else if (isDifferent) {
                                        bgColor = 'bg-orange-100';
                                      } else if (dayData.planned > 0) {
                                        bgColor = 'bg-blue-100';
                                      }
                                      
                                      return (
                                        <div
                                          key={dayData.date}
                                          onClick={() => handleCRADayClick(project.id, dayData)}
                                          className={`h-16 border border-gray-200 p-1 cursor-pointer hover:ring-2 hover:ring-[#e61252] ${bgColor !== 'purple-indispo' ? bgColor : ''} ${dayData.isToday ? 'ring-2 ring-blue-500' : ''}`}
                                          style={bgColor === 'purple-indispo' ? {backgroundColor: '#e6ccff'} : {}}
                                          title={dayData.hasOtherProjects ? 
                                            `Autres projets: ${dayData.otherProjects.map(p => `${p.name} (${p.allocation}j)`).join(', ')}
Disponible: ${dayData.availableCapacity}j` : ''}
                                        >
                                          <div className="h-full flex flex-col">
                                            <div className="text-xs font-semibold text-gray-700">
                                              {dayData.day}
                                              {dayData.isToday && <span className="ml-1">‚≠ê</span>}
                                            </div>
                                            
                                            {dayData.planned > 0 && (
                                              <div className="text-[9px] text-blue-700 font-bold truncate leading-tight">
                                                üìò {dayData.planned}j {project.name.substring(0, 8)}{project.name.length > 8 ? '...' : ''}
                                              </div>
                                            )}
                                            
                                            {dayData.actual > 0 && (
                                              <div className="text-[9px] text-green-700 font-bold truncate leading-tight">
                                                üìä {dayData.actual}j {project.name.substring(0, 8)}{project.name.length > 8 ? '...' : ''}
                                              </div>
                                            )}
                                            
                                            {availabilityText && (
                                              <div className="text-[8px] text-gray-600 font-bold leading-tight">
                                                {availabilityText}
                                                {dayData.otherProjects && dayData.otherProjects.length > 0 && (
                                                  <div className="text-[7px] mt-0.5">
                                                    {dayData.otherProjects.length === 1 ? (
                                                      <div className="truncate">{dayData.otherProjects[0].allocation}j {dayData.otherProjects[0].name.substring(0, 6)}</div>
                                                    ) : (
                                                      <div>+{dayData.otherProjects.length} prj</div>
                                                    )}
                                                  </div>
                                                )}
                                              </div>
                                            )}
                                            
                                            {dayData.isUnavailable && (
                                              <div className="text-xs" style={{color: '#8f00ff'}}>
                                                üö´
                                              </div>
                                            )}
                                            
                                            {dayData.isFestivity && (
                                              <div className="text-xs text-gray-600">
                                                üéâ
                                              </div>
                                            )}
                                          </div>
                                        </div>
                                      );
                                    })}
                                  </div>
                                </div>
                                
                                {/* Totali mese */}
                                <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                  <div className="bg-blue-50 p-3 rounded-lg">
                                    <div className="text-sm text-gray-600">Planifi√© ce mois</div>
                                    <div className="text-xl font-bold text-blue-700">
                                      {generateCRACalendarDays(craCalendarYear, craCalendarMonth, project.id, currentEngineerId)
                                        .filter(d => d)
                                        .reduce((sum, d) => sum + d.planned, 0)
                                        .toFixed(1)}j
                                    </div>
                                  </div>
                                  <div className="bg-green-50 p-3 rounded-lg">
                                    <div className="text-sm text-gray-600">R√©alis√© ce mois</div>
                                    <div className="text-xl font-bold text-green-700">
                                      {generateCRACalendarDays(craCalendarYear, craCalendarMonth, project.id, currentEngineerId)
                                        .filter(d => d)
                                        .reduce((sum, d) => sum + d.actual, 0)
                                        .toFixed(1)}j
                                    </div>
                                  </div>
                                  <div className="bg-gray-50 p-3 rounded-lg">
                                    <div className="text-sm text-gray-600">√âcart</div>
                                    <div className="text-xl font-bold text-gray-700">
                                      {(() => {
                                        const days = generateCRACalendarDays(craCalendarYear, craCalendarMonth, project.id, currentEngineerId).filter(d => d);
                                        const diff = days.reduce((sum, d) => sum + d.actual, 0) - days.reduce((sum, d) => sum + d.planned, 0);
                                        return (diff > 0 ? '+' : '') + diff.toFixed(1);
                                      })()}j
                                    </div>
                                  </div>
                                </div>
                                
                                {/* Info conseil */}
                                <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
                                  üí° <strong>Conseil:</strong> Cliquez sur un jour pour modifier les heures r√©elles travaill√©es.
                                </div>
                              </div>
                            </div>
                          );
                        })
                      )}
                    </div>
                  );
                })()}

                {activeTab === 'resource' && (
                  <div className="space-y-4">
                    <div className="bg-white rounded-lg shadow p-4 md:p-6">
                      <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <User size={28} className="text-[#e61252]" /> Vue Ressource Personnelle
                      </h2>
                      
                      {/* Resource Selector */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">S√©lectionner une ressource</label>
                          <select 
                            value={selectedResourceId}
                            onChange={(e) => setSelectedResourceId(e.target.value)}
                            className="w-full border rounded px-3 py-2 text-base"
                          >
                            <option value="">-- Choisir une ressource --</option>
                            <optgroup label="Ing√©nieurs">
                              {engineers.map(e => <option key={e.id} value={e.id}>{e.name} {e.specialty && `(${e.specialty})`}</option>)}
                            </optgroup>
                            <optgroup label="Ressources">
                              {resources.map(r => <option key={r.id} value={r.id}>{r.name} {r.type && `(${r.type})`}</option>)}
                            </optgroup>
                            <optgroup label="G√©n√©riques">
                              {genericResources.map(g => <option key={g.id} value={g.id}>{g.name} {g.type && `(${g.type})`}</option>)}
                            </optgroup>
                          </select>
                        </div>
                        
                        {selectedResourceId && (
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Mode d'affichage</label>
                            <div className="flex gap-2">
                              <button 
                                onClick={() => setResourceViewMode('quarter')}
                                className={`flex-1 px-4 py-2 rounded-lg font-semibold ${resourceViewMode === 'quarter' ? 'bg-[#e61252] text-white' : 'bg-gray-200 text-gray-700'}`}
                              >
                                Trimestre
                              </button>
                              <button 
                                onClick={() => setResourceViewMode('month')}
                                className={`flex-1 px-4 py-2 rounded-lg font-semibold ${resourceViewMode === 'month' ? 'bg-[#e61252] text-white' : 'bg-gray-200 text-gray-700'}`}
                              >
                                Mois
                              </button>
                            </div>
                          </div>
                        )}
                      </div>

                      {selectedResourceId && (() => {
                        const resource = getSelectedResource();
                        
                        // Se la risorsa non viene trovata, mostra un messaggio
                        if (!resource) {
                          return (
                            <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6 text-center">
                              <p className="text-yellow-800 font-semibold">‚ö†Ô∏è Ressource non trouv√©e</p>
                              <p className="text-yellow-600 text-sm mt-2">Veuillez s√©lectionner une autre ressource</p>
                            </div>
                          );
                        }
                        
                        const resourceProjects = getResourceProjects(selectedResourceId);
                        const conflicts = getResourceConflicts(selectedResourceId);
                        
                        return (
                          <div className="space-y-6">
                            {/* Resource Info */}
                            <div className="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-4 border-2 border-indigo-200">
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">Nom</p>
                                  <p className="font-bold text-gray-800">{resource?.name || 'N/A'}</p>
                                </div>
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">Type</p>
                                  <p className="font-semibold text-gray-800">{resource?.type || 'N/A'}</p>
                                </div>
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">{resource?.resourceType === 'engineer' ? 'Sp√©cialit√©' : 'D√©tails'}</p>
                                  <p className="font-semibold text-gray-800">{resource?.specialty || resource?.type || '-'}</p>
                                </div>
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">Projets actifs</p>
                                  <p className="font-bold text-[#e61252] text-xl">{resourceProjects?.length || 0}</p>
                                </div>
                              </div>
                            </div>

                            {/* Conflicts Alert */}
                            {conflicts.length > 0 && (
                              <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <AlertTriangle size={24} className="text-red-600 flex-shrink-0" />
                                  <div className="flex-1">
                                    <p className="font-bold text-red-800 mb-2">‚ö†Ô∏è {conflicts.length} Chevauchement(s) d√©tect√©(s)</p>
                                    <div className="space-y-2">
                                      {conflicts.map((conflict, idx) => (
                                        <div key={idx} className="bg-white rounded p-3 border border-red-300">
                                          <p className="text-sm font-semibold text-red-900 mb-1">
                                            {conflict.project1.name} ‚ö° {conflict.project2.name}
                                          </p>
                                          <p className="text-xs text-red-700">
                                            P√©riode: {conflict.overlapStart.toLocaleDateString('fr-FR')} ‚Üí {conflict.overlapEnd.toLocaleDateString('fr-FR')}
                                          </p>
                                          {!isReadOnly && (
                                            <button 
                                              onClick={() => { 
                                                // Ottieni info risorsa corrente
                                                const resource = getSelectedResource();
                                                
                                                // Aggiungi resourceId e resourceType al conflitto
                                                const enrichedConflict = {
                                                  ...conflict,
                                                  resourceId: selectedResourceId,
                                                  resourceType: resource?.resourceType || null,
                                                  resourceName: resource?.name || null
                                                };
                                                
                                                setConflictToResolve(enrichedConflict);
                                                
                                                // Inizializza giorni selezionati basandosi su date esistenti progetti
                                                const initSelectedDays = (startDate, endDate) => {
                                                  const days = {};
                                                  const start = new Date(startDate);
                                                  const end = new Date(endDate);
                                                  
                                                  let currentDate = new Date(start);
                                                  while (currentDate <= end) {
                                                    const dayOfWeek = currentDate.getDay();
                                                    
                                                    // ‚úÖ Solo giorni lavorativi (Lun-Ven)
                                                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                                      const dateKey = currentDate.toISOString().split('T')[0];
                                                      days[dateKey] = 1.0; // Intera giornata per default
                                                    }
                                                    
                                                    currentDate.setDate(currentDate.getDate() + 1);
                                                  }
                                                  
                                                  return days;
                                                };
                                                
                                                setConflictSelectedDays({
                                                  project1: initSelectedDays(conflict.project1.startDate, conflict.project1.endDate),
                                                  project2: initSelectedDays(conflict.project2.startDate, conflict.project2.endDate)
                                                });
                                                
                                                // Inizializza calendario al mese del primo progetto
                                                const startDate = new Date(conflict.project1.startDate);
                                                setConflictCalendarMonth(startDate);
                                                
                                                // Reset range selection
                                                setConflictRangeStart('');
                                                setConflictRangeEnd('');
                                                
                                                // Reset modalit√† calendario
                                                setConflictCalendarMode(null);
                                                
                                                // Reset priorit√† progetto
                                                setPriorityProject(null);
                                                
                                                setShowConflictModal(true);
                                              }}
                                              className="mt-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-semibold"
                                            >
                                              R√©soudre ce conflit
                                            </button>
                                          )}
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* Navigation */}
                            {resourceViewMode === 'quarter' ? (
                              <div className="flex justify-between items-center">
                                <button 
                                  onClick={() => { 
                                    if (resourceViewQuarter === 0) { 
                                      setResourceViewQuarter(3); 
                                      setResourceViewYear(resourceViewYear - 1); 
                                    } else { 
                                      setResourceViewQuarter(resourceViewQuarter - 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  ‚Üê Trimestre pr√©c√©dent
                                </button>
                                <span className="text-lg font-bold text-gray-800">Q{resourceViewQuarter + 1} {resourceViewYear}</span>
                                <button 
                                  onClick={() => { 
                                    if (resourceViewQuarter === 3) { 
                                      setResourceViewQuarter(0); 
                                      setResourceViewYear(resourceViewYear + 1); 
                                    } else { 
                                      setResourceViewQuarter(resourceViewQuarter + 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  Trimestre suivant ‚Üí
                                </button>
                              </div>
                            ) : (
                              <div className="flex justify-between items-center">
                                <button 
                                  onClick={() => { 
                                    if (selectedMonth === 0) { 
                                      setSelectedMonth(11); 
                                      setResourceViewYear(resourceViewYear - 1); 
                                    } else { 
                                      setSelectedMonth(selectedMonth - 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  ‚Üê Mois pr√©c√©dent
                                </button>
                                <span className="text-lg font-bold text-gray-800">
                                  {new Date(resourceViewYear, selectedMonth).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                                </span>
                                <button 
                                  onClick={() => { 
                                    if (selectedMonth === 11) { 
                                      setSelectedMonth(0); 
                                      setResourceViewYear(resourceViewYear + 1); 
                                    } else { 
                                      setSelectedMonth(selectedMonth + 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  Mois suivant ‚Üí
                                </button>
                              </div>
                            )}

                            {/* Statistics by Month */}
                            {resourceViewMode === 'quarter' ? (
                              <div className="bg-white rounded-lg border-2 border-gray-200 p-4">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                  üìä R√©partition par mois
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                  {[0, 1, 2].map(offset => {
                                    const month = resourceViewQuarter * 3 + offset;
                                    const monthData = getResourceDaysInMonth(selectedResourceId, resourceViewYear, month);
                                    const workingDays = 20;
                                    const percentage = Math.round((monthData.total / workingDays) * 100);
                                    const colorClass = percentage > 100 ? 'bg-red-100 border-red-300 text-red-800' : 
                                                       percentage > 80 ? 'bg-orange-100 border-orange-300 text-orange-800' : 
                                                       percentage > 50 ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 
                                                       'bg-green-100 border-green-300 text-green-800';
                                    
                                    return (
                                      <div key={month} className={`rounded-lg border-2 p-3 ${colorClass}`}>
                                        <p className="text-sm font-bold mb-1">
                                          {new Date(resourceViewYear, month).toLocaleDateString('fr-FR', { month: 'long' })}
                                        </p>
                                        <p className="text-2xl font-bold mb-1">{monthData.total}j</p>
                                        <p className="text-xs font-semibold">{percentage}% charge</p>
                                        {percentage > 100 && <p className="text-xs font-bold mt-1">‚ö†Ô∏è SURCHARGE!</p>}
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            ) : (
                              <div className="bg-white rounded-lg border-2 border-gray-200 p-4">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                  üìä Charge du mois
                                </h3>
                                {(() => {
                                  const monthData = getResourceDaysInMonth(selectedResourceId, resourceViewYear, selectedMonth);
                                  const workingDays = 20;
                                  const percentage = Math.round((monthData.total / workingDays) * 100);
                                  const colorClass = percentage > 100 ? 'bg-red-100 border-red-300 text-red-800' : 
                                                     percentage > 80 ? 'bg-orange-100 border-orange-300 text-orange-800' : 
                                                     percentage > 50 ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 
                                                     'bg-green-100 border-green-300 text-green-800';
                                  
                                  return (
                                    <div>
                                      <div className={`rounded-lg border-2 p-4 mb-3 ${colorClass}`}>
                                        <div className="flex justify-between items-center">
                                          <div>
                                            <p className="text-3xl font-bold mb-1">{monthData.total} jours</p>
                                            <p className="text-sm font-semibold">{percentage}% de charge</p>
                                          </div>
                                          {percentage > 100 && (
                                            <div className="text-right">
                                              <AlertTriangle size={32} />
                                              <p className="text-sm font-bold">SURCHARGE!</p>
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                      <div className="space-y-2">
                                        <p className="text-sm font-semibold text-gray-700">D√©tail par projet:</p>
                                        {Object.entries(monthData.byProject).map(([projectId, data]) => (
                                          <div key={projectId} className="flex justify-between items-center bg-gray-50 rounded p-2">
                                            <span className="text-sm">{data.name}</span>
                                            <span className={`text-sm font-bold px-2 py-1 rounded ${statusConfig[data.status]?.color || 'bg-gray-200'}`}>
                                              {data.days}j
                                            </span>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  );
                                })()}
                              </div>
                            )}

                            {/* Projects List */}
                            <div className="bg-white rounded-lg border-2 border-gray-200 p-4">
                              <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                üìã Projets assign√©s ({resourceProjects.length})
                              </h3>
                              {resourceProjects.length === 0 ? (
                                <p className="text-gray-500 text-center py-4">Aucun projet assign√©</p>
                              ) : (
                                <div className="space-y-3">
                                  {resourceProjects.map(project => {
                                    const hasConflict = conflicts.some(c => 
                                      c.project1.id === project.id || c.project2.id === project.id
                                    );
                                    let days = 0;
                                    if (resource.resourceType === 'engineer') {
                                      days = project.engineerDays?.[selectedResourceId] || 0;
                                    } else if (resource.resourceType === 'resource') {
                                      days = project.resourceDays?.[selectedResourceId] || 0;
                                    } else {
                                      days = project.genericResourceDays?.[selectedResourceId] || 0;
                                    }
                                    
                                    return (
                                      <div key={project.id} className={`rounded-lg border-2 p-3 ${hasConflict ? 'border-red-300 bg-red-50' : 'border-gray-200'}`}>
                                        <div className="flex justify-between items-start mb-2">
                                          <div className="flex-1">
                                            <p className="font-bold text-gray-800">{project.name}</p>
                                            <p className="text-sm text-gray-600 mt-1">
                                              {new Date(project.startDate).toLocaleDateString('fr-FR')} ‚Üí {new Date(project.endDate).toLocaleDateString('fr-FR')}
                                            </p>
                                          </div>
                                          <div className="text-right">
                                            <span className={`px-2 py-1 rounded text-xs font-semibold ${statusConfig[project.status]?.color || 'bg-gray-200'}`}>
                                              {statusConfig[project.status]?.label || project.status}
                                            </span>
                                            <p className="text-lg font-bold text-[#e61252] mt-1">{days}j</p>
                                          </div>
                                        </div>
                                        {hasConflict && (
                                          <div className="bg-red-100 rounded p-2 mt-2">
                                            <p className="text-xs text-red-800 font-semibold">‚ö†Ô∏è Chevauchement avec un autre projet</p>
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })()}

                      {!selectedResourceId && (
                        <div className="text-center py-12">
                          <User size={64} className="mx-auto text-gray-300 mb-4" />
                          <p className="text-gray-500 text-lg">S√©lectionnez une ressource pour voir sa vue personnelle</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {activeTab === 'team' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Users size={24} className="text-[#e61252]" /> Ing√©nieurs</h2>
                      {!isReadOnly && (
                        <>
                          {showEngineerForm ? (
                            <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                              <input type="text" placeholder="Nom" value={engineerForm.name} onChange={(e) => setEngineerForm({ ...engineerForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="email" placeholder="Email (@askida.fr)" value={engineerForm.email || ''} onChange={(e) => setEngineerForm({ ...engineerForm, email: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 1" value={engineerForm.specialty} onChange={(e) => setEngineerForm({ ...engineerForm, specialty: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 2" value={engineerForm.specialty2 || ''} onChange={(e) => setEngineerForm({ ...engineerForm, specialty2: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 3" value={engineerForm.specialty3 || ''} onChange={(e) => setEngineerForm({ ...engineerForm, specialty3: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 4" value={engineerForm.specialty4 || ''} onChange={(e) => setEngineerForm({ ...engineerForm, specialty4: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              
                              <div className="bg-green-50 p-3 rounded mb-2">
                                <p className="text-xs font-semibold text-green-800 mb-2">üìÖ Calendrier Teams (v3.0)</p>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input 
                                    type="checkbox" 
                                    checked={engineerForm.syncToTeamsCalendar !== false}
                                    onChange={(e) => setEngineerForm({ ...engineerForm, syncToTeamsCalendar: e.target.checked })}
                                    className="w-4 h-4 text-green-600 rounded"
                                  />
                                  <span className="text-sm text-gray-700">
                                    Synchroniser automatiquement les projets "Programm√©" dans son calendrier Teams/Outlook
                                  </span>
                                </label>
                              </div>
                              
                              <div className="bg-blue-50 p-3 rounded mb-2">
                                <p className="text-xs font-semibold text-blue-800 mb-2">‚öôÔ∏è Configuration</p>
                                <input 
                                  type="number" 
                                  placeholder="Max heures/mois (d√©faut: 160)" 
                                  value={engineerForm.maxMonthlyHours} 
                                  onChange={(e) => setEngineerForm({ ...engineerForm, maxMonthlyHours: parseInt(e.target.value) || 160 })} 
                                  className="w-full border rounded px-3 py-2 mb-2 text-sm" 
                                />
                                <input 
                                  type="number" 
                                  placeholder="Heures/jour (d√©faut: 8)" 
                                  value={engineerForm.defaultDailyHours} 
                                  onChange={(e) => setEngineerForm({ ...engineerForm, defaultDailyHours: parseInt(e.target.value) || 8 })} 
                                  className="w-full border rounded px-3 py-2 text-sm" 
                                />
                              </div>
                              <div className="flex gap-2">
                                <button onClick={addEngineer} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                                <button onClick={() => setShowEngineerForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                              </div>
                            </div>
                          ) : (
                            <button onClick={() => setShowEngineerForm(true)} className="w-full bg-[#e61252] hover:bg-[#c10f47] text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Ing√©nieur</button>
                          )}
                        </>
                      )}
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {engineers.map(eng => {
                          const occupation = calculateWeeklyOccupation(eng.id, 'engineer');
                          const currentMonth = new Date().getMonth();
                          const currentYear = new Date().getFullYear();
                          const monthlyHours = calculateMonthlyLoad(eng.id, 'engineer', currentYear, currentMonth);
                          const maxHours = eng.maxMonthlyHours || 160;
                          const allocationPct = calculateAllocationPercentage(eng.id, 'engineer', currentYear, currentMonth);
                          
                          return (
                            <div key={eng.id} className="p-3 bg-gray-50 rounded hover:bg-gray-100">
                              <div className="flex justify-between items-start mb-2">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-1">
                                    <p className="font-semibold text-gray-800 text-sm">{eng.name}</p>
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${occupation > 100 ? 'bg-red-100 text-red-800' : occupation > 80 ? 'bg-orange-100 text-orange-800' : occupation > 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                      {occupation}%
                                    </span>
                                  </div>
                                  {eng.specialty && <p className="text-gray-600 text-xs">{eng.specialty}</p>}
                                  {eng.specialty2 && <p className="text-gray-600 text-xs">{eng.specialty2}</p>}
                                  {eng.specialty3 && <p className="text-gray-600 text-xs">{eng.specialty3}</p>}
                                  {eng.specialty4 && <p className="text-gray-600 text-xs">{eng.specialty4}</p>}
                                  
                                  {/* Progress Bar Carico Mensile */}
                                  <div className="mt-2">
                                    <div className="flex justify-between text-xs text-gray-600 mb-1">
                                      <span>Ce mois: {monthlyHours}h / {maxHours}h</span>
                                      <span className={allocationPct > 100 ? 'text-red-600 font-bold' : allocationPct > 80 ? 'text-orange-600' : 'text-green-600'}>{allocationPct}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                      <div 
                                        className={`h-2 rounded-full transition-all ${allocationPct > 100 ? 'bg-red-500' : allocationPct > 80 ? 'bg-orange-500' : 'bg-green-500'}`}
                                        style={{ width: `${Math.min(allocationPct, 100)}%` }}
                                      ></div>
                                    </div>
                                  </div>
                                  
                                  {/* Indisponibilit√† */}
                                  {eng.unavailability && eng.unavailability.length > 0 && (
                                    <div className="mt-2 text-xs">
                                      <div 
                                        className="flex items-center justify-between cursor-pointer hover:bg-gray-50 px-1 py-1 rounded"
                                        onClick={() => {
                                          const newExpanded = new Set(expandedUnavailability);
                                          if (newExpanded.has(`eng-${eng.id}`)) {
                                            newExpanded.delete(`eng-${eng.id}`);
                                          } else {
                                            newExpanded.add(`eng-${eng.id}`);
                                          }
                                          setExpandedUnavailability(newExpanded);
                                        }}
                                      >
                                        <p className="text-gray-600 font-semibold">
                                          {expandedUnavailability.has(`eng-${eng.id}`) ? '‚ñº' : '‚ñ∂'} üö´ Indisponibilit√©s ({groupUnavailability(eng.unavailability).length})
                                        </p>
                                      </div>
                                      {expandedUnavailability.has(`eng-${eng.id}`) && groupUnavailability(eng.unavailability).map((group, groupIdx) => (
                                        <div key={groupIdx} className="flex items-center justify-between bg-red-50 px-2 py-1 rounded mt-1">
                                          <div className="flex-1">
                                            {group.recurring ? (
                                              <div className="text-red-700">
                                                <div className="font-semibold">
                                                  üîÑ R√©current: {
                                                    group.recurrencePattern === 'weekly' ? 'Hebdomadaire' :
                                                    group.recurrencePattern === 'monthly' ? 'Mensuel' :
                                                    'Annuel'
                                                  }
                                                </div>
                                                <div className="text-xs">
                                                  Du {new Date(group.startDate).toLocaleDateString('fr-FR')} au {new Date(group.endDate).toLocaleDateString('fr-FR')}
                                                  {group.reason && ` (${group.reason})`}
                                                  <span className="ml-2 font-semibold">‚Ä¢ {group.count} jours</span>
                                                </div>
                                              </div>
                                            ) : (
                                              <span className="text-red-700">
                                                {new Date(group.startDate).toLocaleDateString('fr-FR')} - {new Date(group.endDate).toLocaleDateString('fr-FR')}
                                                {group.reason && ` (${group.reason})`}
                                              </span>
                                            )}
                                          </div>
                                          {!isReadOnly && (
                                            <button 
                                              onClick={() => group.recurring 
                                                ? removeRecurringGroup(eng.id, 'engineer', group.indices)
                                                : removeUnavailability(eng.id, 'engineer', group.index)
                                              } 
                                              className="text-red-600 hover:text-red-800 ml-2"
                                              title={group.recurring ? 'Supprimer toutes les occurrences' : 'Supprimer'}
                                            >
                                              <X size={12} />
                                            </button>
                                          )}
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                                {!isReadOnly && (
                                  <div className="flex gap-1 ml-2">
                                    <button 
                                      onClick={() => {
                                        setSelectedResourceForConfig({ id: eng.id, type: 'engineer', name: eng.name, maxMonthlyHours: eng.maxMonthlyHours || 160, defaultDailyHours: eng.defaultDailyHours || 8 });
                                        setShowResourceConfigModal(true);
                                      }}
                                      className="text-blue-600 hover:text-blue-800 p-1"
                                      title="Configurer"
                                    >
                                      <Settings size={14} />
                                    </button>
                                    <button 
                                      onClick={() => {
                                        setUnavailabilityForm({ ...unavailabilityForm, resourceId: eng.id, resourceType: 'engineer' });
                                        setShowUnavailabilityModal(true);
                                      }}
                                      className="text-orange-600 hover:text-orange-800 p-1"
                                      title="Ajouter indisponibilit√©"
                                    >
                                      <Calendar size={14} />
                                    </button>
                                    <button onClick={() => initiateDelete(eng.id, eng.name, 'engineer')} className="text-red-600 hover:text-red-800 p-1">
                                      <Trash2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Briefcase size={24} className="text-purple-600" /> Ressources Askida</h2>
                      {!isReadOnly && (
                        <>
                          {showResourceForm ? (
                            <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                              <input type="text" placeholder="Nom" value={resourceForm.name} onChange={(e) => setResourceForm({ ...resourceForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Type" value={resourceForm.type} onChange={(e) => setResourceForm({ ...resourceForm, type: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <div className="bg-blue-50 p-3 rounded mb-2">
                                <p className="text-xs font-semibold text-blue-800 mb-2">‚öôÔ∏è Configuration</p>
                                <input 
                                  type="number" 
                                  placeholder="Max heures/mois (d√©faut: 160)" 
                                  value={resourceForm.maxMonthlyHours} 
                                  onChange={(e) => setResourceForm({ ...resourceForm, maxMonthlyHours: parseInt(e.target.value) || 160 })} 
                                  className="w-full border rounded px-3 py-2 mb-2 text-sm" 
                                />
                                <input 
                                  type="number" 
                                  placeholder="Heures/jour (d√©faut: 8)" 
                                  value={resourceForm.defaultDailyHours} 
                                  onChange={(e) => setResourceForm({ ...resourceForm, defaultDailyHours: parseInt(e.target.value) || 8 })} 
                                  className="w-full border rounded px-3 py-2 text-sm" 
                                />
                              </div>
                              <div className="flex gap-2">
                                <button onClick={addResource} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                                <button onClick={() => setShowResourceForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                              </div>
                            </div>
                          ) : (
                            <button onClick={() => setShowResourceForm(true)} className="w-full bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Ressource</button>
                          )}
                        </>
                      )}
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {resources.map(res => {
                          const occupation = calculateWeeklyOccupation(res.id, 'resource');
                          const currentMonth = new Date().getMonth();
                          const currentYear = new Date().getFullYear();
                          const monthlyHours = calculateMonthlyLoad(res.id, 'resource', currentYear, currentMonth);
                          const maxHours = res.maxMonthlyHours || 160;
                          const allocationPct = calculateAllocationPercentage(res.id, 'resource', currentYear, currentMonth);
                          
                          return (
                            <div key={res.id} className="p-3 bg-gray-50 rounded hover:bg-gray-100">
                              <div className="flex justify-between items-start mb-2">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-1">
                                    <p className="font-semibold text-gray-800 text-sm">{res.name}</p>
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${occupation > 100 ? 'bg-red-100 text-red-800' : occupation > 80 ? 'bg-orange-100 text-orange-800' : occupation > 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                      {occupation}%
                                    </span>
                                  </div>
                                  {res.type && <p className="text-gray-600 text-xs">{res.type}</p>}
                                  
                                  {/* Progress Bar Carico Mensile */}
                                  <div className="mt-2">
                                    <div className="flex justify-between text-xs text-gray-600 mb-1">
                                      <span>Ce mois: {monthlyHours}h / {maxHours}h</span>
                                      <span className={allocationPct > 100 ? 'text-red-600 font-bold' : allocationPct > 80 ? 'text-orange-600' : 'text-green-600'}>{allocationPct}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                      <div 
                                        className={`h-2 rounded-full transition-all ${allocationPct > 100 ? 'bg-red-500' : allocationPct > 80 ? 'bg-orange-500' : 'bg-green-500'}`}
                                        style={{ width: `${Math.min(allocationPct, 100)}%` }}
                                      ></div>
                                    </div>
                                  </div>
                                  
                                  {/* Indisponibilit√† */}
                                  {res.unavailability && res.unavailability.length > 0 && (
                                    <div className="mt-2 text-xs">
                                      <div 
                                        className="flex items-center justify-between cursor-pointer hover:bg-gray-50 px-1 py-1 rounded"
                                        onClick={() => {
                                          const newExpanded = new Set(expandedUnavailability);
                                          if (newExpanded.has(`res-${res.id}`)) {
                                            newExpanded.delete(`res-${res.id}`);
                                          } else {
                                            newExpanded.add(`res-${res.id}`);
                                          }
                                          setExpandedUnavailability(newExpanded);
                                        }}
                                      >
                                        <p className="text-gray-600 font-semibold">
                                          {expandedUnavailability.has(`res-${res.id}`) ? '‚ñº' : '‚ñ∂'} üö´ Indisponibilit√©s ({groupUnavailability(res.unavailability).length})
                                        </p>
                                      </div>
                                      {expandedUnavailability.has(`res-${res.id}`) && groupUnavailability(res.unavailability).map((group, groupIdx) => (
                                        <div key={groupIdx} className="flex items-center justify-between bg-red-50 px-2 py-1 rounded mt-1">
                                          <div className="flex-1">
                                            {group.recurring ? (
                                              <div className="text-red-700">
                                                <div className="font-semibold">
                                                  üîÑ R√©current: {
                                                    group.recurrencePattern === 'weekly' ? 'Hebdomadaire' :
                                                    group.recurrencePattern === 'monthly' ? 'Mensuel' :
                                                    'Annuel'
                                                  }
                                                </div>
                                                <div className="text-xs">
                                                  Du {new Date(group.startDate).toLocaleDateString('fr-FR')} au {new Date(group.endDate).toLocaleDateString('fr-FR')}
                                                  {group.reason && ` (${group.reason})`}
                                                  <span className="ml-2 font-semibold">‚Ä¢ {group.count} jours</span>
                                                </div>
                                              </div>
                                            ) : (
                                              <span className="text-red-700">
                                                {new Date(group.startDate).toLocaleDateString('fr-FR')} - {new Date(group.endDate).toLocaleDateString('fr-FR')}
                                                {group.reason && ` (${group.reason})`}
                                              </span>
                                            )}
                                          </div>
                                          {!isReadOnly && (
                                            <button 
                                              onClick={() => group.recurring 
                                                ? removeRecurringGroup(res.id, 'resource', group.indices)
                                                : removeUnavailability(res.id, 'resource', group.index)
                                              } 
                                              className="text-red-600 hover:text-red-800 ml-2"
                                              title={group.recurring ? 'Supprimer toutes les occurrences' : 'Supprimer'}
                                            >
                                              <X size={12} />
                                            </button>
                                          )}
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                                {!isReadOnly && (
                                  <div className="flex gap-1 ml-2">
                                    <button 
                                      onClick={() => {
                                        setSelectedResourceForConfig({ id: res.id, type: 'resource', name: res.name, maxMonthlyHours: res.maxMonthlyHours || 160, defaultDailyHours: res.defaultDailyHours || 8 });
                                        setShowResourceConfigModal(true);
                                      }}
                                      className="text-blue-600 hover:text-blue-800 p-1"
                                      title="Configurer"
                                    >
                                      <Settings size={14} />
                                    </button>
                                    <button 
                                      onClick={() => {
                                        setUnavailabilityForm({ ...unavailabilityForm, resourceId: res.id, resourceType: 'resource' });
                                        setShowUnavailabilityModal(true);
                                      }}
                                      className="text-orange-600 hover:text-orange-800 p-1"
                                      title="Ajouter indisponibilit√©"
                                    >
                                      <Calendar size={14} />
                                    </button>
                                    <button onClick={() => initiateDelete(res.id, res.name, 'resource')} className="text-red-600 hover:text-red-800 p-1">
                                      <Trash2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Package size={24} className="text-teal-600" /> Ressources G√©n√©riques</h2>
                      {!isReadOnly && (
                        <>
                          {showGenericResourceForm ? (
                            <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                              <input type="text" placeholder="Nom" value={genericResourceForm.name} onChange={(e) => setGenericResourceForm({ ...genericResourceForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Type" value={genericResourceForm.type} onChange={(e) => setGenericResourceForm({ ...genericResourceForm, type: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <div className="bg-blue-50 p-3 rounded mb-2">
                                <p className="text-xs font-semibold text-blue-800 mb-2">‚öôÔ∏è Configuration</p>
                                <input 
                                  type="number" 
                                  placeholder="Max heures/mois (d√©faut: 160)" 
                                  value={genericResourceForm.maxMonthlyHours} 
                                  onChange={(e) => setGenericResourceForm({ ...genericResourceForm, maxMonthlyHours: parseInt(e.target.value) || 160 })} 
                                  className="w-full border rounded px-3 py-2 mb-2 text-sm" 
                                />
                                <input 
                                  type="number" 
                                  placeholder="Heures/jour (d√©faut: 8)" 
                                  value={genericResourceForm.defaultDailyHours} 
                                  onChange={(e) => setGenericResourceForm({ ...genericResourceForm, defaultDailyHours: parseInt(e.target.value) || 8 })} 
                                  className="w-full border rounded px-3 py-2 text-sm" 
                                />
                              </div>
                              <div className="flex gap-2">
                                <button onClick={addGenericResource} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                                <button onClick={() => setShowGenericResourceForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                              </div>
                            </div>
                          ) : (
                            <button onClick={() => setShowGenericResourceForm(true)} className="w-full bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Ressource</button>
                          )}
                        </>
                      )}
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {genericResources.map(res => {
                          const occupation = calculateWeeklyOccupation(res.id, 'generic');
                          const currentMonth = new Date().getMonth();
                          const currentYear = new Date().getFullYear();
                          const monthlyHours = calculateMonthlyLoad(res.id, 'genericResource', currentYear, currentMonth);
                          const maxHours = res.maxMonthlyHours || 160;
                          const allocationPct = calculateAllocationPercentage(res.id, 'genericResource', currentYear, currentMonth);
                          
                          return (
                            <div key={res.id} className="p-3 bg-gray-50 rounded hover:bg-gray-100">
                              <div className="flex justify-between items-start mb-2">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-1">
                                    <p className="font-semibold text-gray-800 text-sm">{res.name}</p>
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${occupation > 100 ? 'bg-red-100 text-red-800' : occupation > 80 ? 'bg-orange-100 text-orange-800' : occupation > 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                      {occupation}%
                                    </span>
                                  </div>
                                  {res.type && <p className="text-gray-600 text-xs">{res.type}</p>}
                                  
                                  {/* Progress Bar Carico Mensile */}
                                  <div className="mt-2">
                                    <div className="flex justify-between text-xs text-gray-600 mb-1">
                                      <span>Ce mois: {monthlyHours}h / {maxHours}h</span>
                                      <span className={allocationPct > 100 ? 'text-red-600 font-bold' : allocationPct > 80 ? 'text-orange-600' : 'text-green-600'}>{allocationPct}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                      <div 
                                        className={`h-2 rounded-full transition-all ${allocationPct > 100 ? 'bg-red-500' : allocationPct > 80 ? 'bg-orange-500' : 'bg-green-500'}`}
                                        style={{ width: `${Math.min(allocationPct, 100)}%` }}
                                      ></div>
                                    </div>
                                  </div>
                                  
                                  {/* Indisponibilit√† */}
                                  {res.unavailability && res.unavailability.length > 0 && (
                                    <div className="mt-2 text-xs">
                                      <div 
                                        className="flex items-center justify-between cursor-pointer hover:bg-gray-50 px-1 py-1 rounded"
                                        onClick={() => {
                                          const newExpanded = new Set(expandedUnavailability);
                                          if (newExpanded.has(`gen-${res.id}`)) {
                                            newExpanded.delete(`gen-${res.id}`);
                                          } else {
                                            newExpanded.add(`gen-${res.id}`);
                                          }
                                          setExpandedUnavailability(newExpanded);
                                        }}
                                      >
                                        <p className="text-gray-600 font-semibold">
                                          {expandedUnavailability.has(`gen-${res.id}`) ? '‚ñº' : '‚ñ∂'} üö´ Indisponibilit√©s ({groupUnavailability(res.unavailability).length})
                                        </p>
                                      </div>
                                      {expandedUnavailability.has(`gen-${res.id}`) && groupUnavailability(res.unavailability).map((group, groupIdx) => (
                                        <div key={groupIdx} className="flex items-center justify-between bg-red-50 px-2 py-1 rounded mt-1">
                                          <div className="flex-1">
                                            {group.recurring ? (
                                              <div className="text-red-700">
                                                <div className="font-semibold">
                                                  üîÑ R√©current: {
                                                    group.recurrencePattern === 'weekly' ? 'Hebdomadaire' :
                                                    group.recurrencePattern === 'monthly' ? 'Mensuel' :
                                                    'Annuel'
                                                  }
                                                </div>
                                                <div className="text-xs">
                                                  Du {new Date(group.startDate).toLocaleDateString('fr-FR')} au {new Date(group.endDate).toLocaleDateString('fr-FR')}
                                                  {group.reason && ` (${group.reason})`}
                                                  <span className="ml-2 font-semibold">‚Ä¢ {group.count} jours</span>
                                                </div>
                                              </div>
                                            ) : (
                                              <span className="text-red-700">
                                                {new Date(group.startDate).toLocaleDateString('fr-FR')} - {new Date(group.endDate).toLocaleDateString('fr-FR')}
                                                {group.reason && ` (${group.reason})`}
                                              </span>
                                            )}
                                          </div>
                                          {!isReadOnly && (
                                            <button 
                                              onClick={() => group.recurring 
                                                ? removeRecurringGroup(res.id, 'genericResource', group.indices)
                                                : removeUnavailability(res.id, 'genericResource', group.index)
                                              } 
                                              className="text-red-600 hover:text-red-800 ml-2"
                                              title={group.recurring ? 'Supprimer toutes les occurrences' : 'Supprimer'}
                                            >
                                              <X size={12} />
                                            </button>
                                          )}
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                                {!isReadOnly && (
                                  <div className="flex gap-1 ml-2">
                                    <button 
                                      onClick={() => {
                                        setSelectedResourceForConfig({ id: res.id, type: 'genericResource', name: res.name, maxMonthlyHours: res.maxMonthlyHours || 160, defaultDailyHours: res.defaultDailyHours || 8 });
                                        setShowResourceConfigModal(true);
                                      }}
                                      className="text-blue-600 hover:text-blue-800 p-1"
                                      title="Configurer"
                                    >
                                      <Settings size={14} />
                                    </button>
                                    <button 
                                      onClick={() => {
                                        setUnavailabilityForm({ ...unavailabilityForm, resourceId: res.id, resourceType: 'genericResource' });
                                        setShowUnavailabilityModal(true);
                                      }}
                                      className="text-orange-600 hover:text-orange-800 p-1"
                                      title="Ajouter indisponibilit√©"
                                    >
                                      <Calendar size={14} />
                                    </button>
                                    <button onClick={() => initiateDelete(res.id, res.name, 'generic')} className="text-red-600 hover:text-red-800 p-1">
                                      <Trash2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><UserCog size={24} className="text-orange-600" /> Chefs de Projet</h2>
                      {!isReadOnly && (
                        <>
                          {showPMForm ? (
                        <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                          <input type="text" placeholder="Nom" value={pmForm.name} onChange={(e) => setPMForm({ ...pmForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                          <input type="text" placeholder="D√©partement" value={pmForm.department} onChange={(e) => setPMForm({ ...pmForm, department: e.target.value })} className="w-full border rounded px-3 py-2 mb-3" />
                          <div className="flex gap-2">
                            <button onClick={addPM} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                            <button onClick={() => setShowPMForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                          </div>
                        </div>
                      ) : (
                        <button onClick={() => setShowPMForm(true)} className="w-full bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Chef de Projet</button>
                      )}
                    </>
                  )}
                  <div className="space-y-2 max-h-96 overflow-y-auto">
                    {projectManagers.map(pm => (
                      <div key={pm.id} className="flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100">
                        <div className="flex-1">
                          <p className="font-semibold text-gray-800 text-sm">{pm.name}</p>
                          {pm.department && <p className="text-gray-600 text-xs">{pm.department}</p>}
                        </div>
                        {!isReadOnly && (
                          <button onClick={() => initiateDelete(pm.id, pm.name, 'pm')} className="text-red-600 hover:text-red-800"><Trash2 size={16} /></button>
                        )}
                      </div>
                    ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'stats' && (
                  <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-3xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <BarChart size={32} className="text-[#e61252]" /> Statistiques & Analyse
                      </h2>
                      <p className="text-gray-600">
                        Analysez le temps pass√© par les ing√©nieurs sur les projets et exportez les donn√©es.
                      </p>
                    </div>

                    {/* Sub-menu Dashboard */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex flex-wrap gap-2">
                        <button 
                          onClick={() => setDashboardView('dashboard')}
                          className={`px-4 py-2 rounded-lg font-semibold ${dashboardView === 'dashboard' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}
                        >
                          üìä Tableau de Bord
                        </button>
                        <button 
                          onClick={() => setDashboardView('individuel')}
                          className={`px-4 py-2 rounded-lg font-semibold ${dashboardView === 'individuel' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}
                        >
                          üë§ Vue Individuelle
                        </button>
                        <button 
                          onClick={() => setDashboardView('clients')}
                          className={`px-4 py-2 rounded-lg font-semibold ${dashboardView === 'clients' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}
                        >
                          üè¢ Analyse Clients
                        </button>
                        <button 
                          onClick={() => setDashboardView('heatmap')}
                          className={`px-4 py-2 rounded-lg font-semibold ${dashboardView === 'heatmap' ? 'bg-[#e61252] text-white' : 'bg-gray-100 text-gray-700'}`}
                        >
                          üî• Heatmap Allocation
                        </button>
                      </div>
                    </div>

                    {/* Tableau de Bord Ex√©cutif */}
                    {dashboardView === 'dashboard' && (() => {
                      const kpis = calculateGlobalKPIs(statsSelectedYear, statsSelectedMonth);
                      const alerts = generateAlerts(statsSelectedYear, statsSelectedMonth);
                      
                      return (
                        <div className="space-y-6">
                          {/* KPI Globali */}
                          <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="font-semibold text-gray-800 mb-4 text-xl">üìà KPIs Globaux - {['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'][statsSelectedMonth]} {statsSelectedYear}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                              <div className="bg-blue-50 p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-1">Utilisation Rate</div>
                                <div className="text-3xl font-bold text-blue-700">{safePercent(kpis.utilisationRate)}%</div>
                                <div className="text-xs text-gray-500 mt-1">Target: 85%</div>
                              </div>
                              <div className="bg-green-50 p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-1">Projets Actifs</div>
                                <div className="text-3xl font-bold text-green-700">{kpis.projetsActifs || 0}</div>
                              </div>
                              <div className="bg-purple-50 p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-1">Respect des Commandes</div>
                                <div className="text-3xl font-bold text-purple-700">{safePercent(kpis.budgetRespect)}%</div>
                                <div className="text-xs text-gray-500 mt-1">On-budget projects</div>
                              </div>
                              <div className="bg-orange-50 p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-1">Planning Accuracy</div>
                                <div className="text-3xl font-bold text-orange-700">{safePercent(kpis.planningAccuracy)}%</div>
                                <div className="text-xs text-gray-500 mt-1">¬±10% target</div>
                              </div>
                            </div>
                          </div>

                          {/* Capacit√© R√©siduelle Team */}
                          {(() => {
                            const capacity = calculateTeamCapacity(statsSelectedYear, statsSelectedMonth);
                            return (
                              <div className="bg-white rounded-lg shadow p-6">
                                <h3 className="font-semibold text-gray-800 mb-4 text-xl">üíº Capacit√© Disponible ce Mois</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                  <div className="bg-indigo-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Capacit√© Disponible</div>
                                    <div className="text-3xl font-bold text-indigo-700">{capacity.capaciteDisponible.toFixed(1)}j</div>
                                    <div className="text-xs text-gray-500 mt-1">Sur {capacity.capaciteTheorique}j th√©oriques</div>
                                  </div>
                                  <div className="bg-cyan-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Nouveaux Projets</div>
                                    <div className="text-3xl font-bold text-cyan-700">{capacity.nbProjetsAcceptables}</div>
                                    <div className="text-xs text-gray-500 mt-1">Projets moyens acceptables (8j)</div>
                                  </div>
                                  <div className="bg-teal-50 p-4 rounded-lg">
                                    <div className="text-sm text-gray-600 mb-1">Utilisation</div>
                                    <div className="text-3xl font-bold text-teal-700">{Math.round((capacity.capaciteUtilisee / capacity.capaciteTheorique) * 100)}%</div>
                                    <div className="text-xs text-gray-500 mt-1">{capacity.capaciteUtilisee.toFixed(1)}j utilis√©s</div>
                                  </div>
                                </div>
                                
                                {capacity.engineersCapacity.length > 0 && (
                                  <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700 mb-2">üîπ Ing√©nieurs Disponibles</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                      {capacity.engineersCapacity.map((eng, idx) => (
                                        <div key={idx} className="bg-gray-50 p-2 rounded flex justify-between items-center">
                                          <span className="text-sm font-medium">{eng.name}</span>
                                          <span className="text-sm font-bold text-green-700">{eng.disponible.toFixed(1)}j libres</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            );
                          })()}

                          {/* Alerts */}
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            {/* Urgent */}
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                              <h4 className="font-semibold text-red-800 mb-3 flex items-center gap-2">
                                üî¥ URGENT ({alerts.urgent.length})
                              </h4>
                              {alerts.urgent.length === 0 ? (
                                <p className="text-sm text-gray-600">Aucune alerte urgente</p>
                              ) : (
                                <div className="space-y-2">
                                  {alerts.urgent.map((alert, idx) => (
                                    <div key={idx} className="text-sm text-red-700 bg-white p-2 rounded">
                                      {alert.message}
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>

                            {/* Attention */}
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                              <h4 className="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                ‚ö†Ô∏è ATTENTION ({alerts.attention.length})
                              </h4>
                              {alerts.attention.length === 0 ? (
                                <p className="text-sm text-gray-600">Aucune alerte</p>
                              ) : (
                                <div className="space-y-2">
                                  {alerts.attention.map((alert, idx) => (
                                    <div key={idx} className="text-sm text-yellow-700 bg-white p-2 rounded">
                                      {alert.message}
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>

                            {/* Deadlines */}
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                              <h4 className="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                üìÖ DEADLINES PROCHES ({alerts.deadlines.length})
                              </h4>
                              {alerts.deadlines.length === 0 ? (
                                <p className="text-sm text-gray-600">Aucune deadline proche</p>
                              ) : (
                                <div className="space-y-2">
                                  {alerts.deadlines.map((alert, idx) => (
                                    <div key={idx} className="text-sm text-blue-700 bg-white p-2 rounded">
                                      {alert.message}
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Top Performers */}
                          {kpis.topPerformers.length > 0 && (
                            <div className="bg-white rounded-lg shadow p-6">
                              <h3 className="font-semibold text-gray-800 mb-4">üèÜ Top Performers (Accuracy)</h3>
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                {kpis.topPerformers.map((perf, idx) => (
                                  <div key={idx} className="bg-gradient-to-r from-yellow-50 to-white p-4 rounded-lg border">
                                    <div className="text-2xl mb-1">{idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'}</div>
                                    <div className="font-semibold">{perf.name}</div>
                                    <div className="text-2xl font-bold text-green-700">{safePercent(perf.accuracy)}%</div>
                                    <div className="text-xs text-gray-500 mt-1">Accuracy</div>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}
                    
                    {/* Pulsante Export PDF Dashboard */}
                    {dashboardView === 'dashboard' && (
                      <div className="bg-white rounded-lg shadow p-6">
                        <button
                          onClick={exportDashboardPDF}
                          className="w-full bg-[#e61252] hover:bg-[#c21045] text-white px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all"
                        >
                          <Download size={20} />
                          üìÑ Export Dashboard PDF
                        </button>
                        <p className="text-sm text-gray-500 mt-2 text-center">
                          Export complet: KPIs, Capacit√©, Alerts, Top Performers
                        </p>
                      </div>
                    )}

                    {/* Analyse Clients */}
                    {dashboardView === 'clients' && (() => {
                      const clientsData = calculateClientAnalysis(statsSelectedYear, statsSelectedMonth, true);
                      
                      return (
                        <div className="bg-white rounded-lg shadow p-6">
                          <h3 className="font-semibold text-gray-800 mb-4 text-xl">üè¢ Analyse par Client</h3>
                          {clientsData.length === 0 ? (
                            <p className="text-gray-600">Aucune donn√©e pour cette p√©riode</p>
                          ) : (
                            <div className="overflow-x-auto">
                              <table className="w-full">
                                <thead>
                                  <tr className="border-b bg-gray-50">
                                    <th className="text-left py-3 px-4 font-semibold text-gray-700">Client</th>
                                    <th className="text-center py-3 px-4 font-semibold text-gray-700">Projets</th>
                                    <th className="text-right py-3 px-4 font-semibold text-gray-700">Jours command√©s</th>
                                    <th className="text-right py-3 px-4 font-semibold text-gray-700">Planifi√©</th>
                                    <th className="text-right py-3 px-4 font-semibold text-gray-700">R√©alis√©</th>
                                    <th className="text-right py-3 px-4 font-semibold text-gray-700">√âcart %</th>
                                    <th className="text-center py-3 px-4 font-semibold text-gray-700">Status</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {clientsData.map((client, idx) => (
                                    <tr key={idx} className="border-b hover:bg-gray-50">
                                      <td className="py-3 px-4 font-semibold">{client.client}</td>
                                      <td className="py-3 px-4 text-center">{client.nbProjets}</td>
                                      <td className="py-3 px-4 text-right font-semibold text-purple-700">{formatDays(client.totalBudget)}</td>
                                      <td className="py-3 px-4 text-right font-semibold text-blue-700">{formatDays(client.totalPlanned)}</td>
                                      <td className="py-3 px-4 text-right font-semibold text-green-700">{formatDays(client.totalActual)}</td>
                                      <td className={`py-3 px-4 text-right font-semibold ${client.ecartPercent > 0 ? 'text-red-700' : 'text-green-700'}`}>
                                        {client.ecartPercent > 0 ? '+' : ''}{client.ecartPercent.toFixed(1)}%
                                      </td>
                                      <td className="py-3 px-4 text-center text-2xl">{client.status}</td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          )}
                        </div>
                      );
                    })()}

                    {/* Heatmap Allocation */}
                    {dashboardView === 'heatmap' && (() => {
                      const { weeks, heatmapData } = calculateWeeklyHeatmap(statsSelectedYear, statsSelectedMonth);
                      
                      return (
                        <div className="bg-white rounded-lg shadow p-6">
                          <h3 className="font-semibold text-gray-800 mb-4 text-xl">üî• Heatmap Allocation Hebdomadaire</h3>
                          {heatmapData.length === 0 ? (
                            <p className="text-gray-600">Aucune donn√©e pour cette p√©riode</p>
                          ) : (
                            <div className="overflow-x-auto">
                              <table className="w-full">
                                <thead>
                                  <tr className="border-b bg-gray-50">
                                    <th className="text-left py-3 px-4 font-semibold text-gray-700">Ing√©nieur</th>
                                    {weeks.map((week, idx) => (
                                      <th key={idx} className="text-center py-3 px-4 font-semibold text-gray-700">{week.label}</th>
                                    ))}
                                  </tr>
                                </thead>
                                <tbody>
                                  {heatmapData.map((eng, idx) => (
                                    <tr key={idx} className="border-b hover:bg-gray-50">
                                      <td className="py-3 px-4 font-semibold">{eng.engineerName}</td>
                                      {eng.weeks.map((week, widx) => (
                                        <td key={widx} className="py-3 px-4 text-center">
                                          <div className="flex flex-col items-center">
                                            <span className="text-2xl mb-1">{week.color}</span>
                                            <span className="font-semibold">{safePercent(week.percent)}%</span>
                                            <span className="text-xs text-gray-500">{week.days.toFixed(1)}j</span>
                                          </div>
                                        </td>
                                      ))}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                              <div className="mt-4 flex gap-4 text-sm">
                                <div><span className="text-xl">üü¢</span> {'<'}90% (OK)</div>
                                <div><span className="text-xl">üü°</span> {'<'}50% (Sous-utilis√©)</div>
                                <div><span className="text-xl">üî¥</span> {'>'}100% (Surcharg√©)</div>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}

                    {/* Vue Individuelle (codice esistente) */}
                    {dashboardView === 'individuel' && (
                      <>
                    {/* Filtres */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <h3 className="font-semibold text-gray-800 mb-4">üìä Filtres</h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Ing√©nieur</label>
                          <select 
                            value={statsSelectedEngineer}
                            onChange={(e) => setStatsSelectedEngineer(e.target.value)}
                            className="w-full border rounded-lg px-3 py-2"
                          >
                            <option value="all">Tous les ing√©nieurs</option>
                            {engineers.map(eng => (
                              <option key={eng.id} value={eng.id}>{eng.name}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Mois</label>
                          <select 
                            value={statsSelectedMonth}
                            onChange={(e) => setStatsSelectedMonth(parseInt(e.target.value))}
                            className="w-full border rounded-lg px-3 py-2"
                          >
                            {['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                              'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'].map((m, i) => (
                              <option key={i} value={i}>{m}</option>
                            ))}
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Ann√©e</label>
                          <select 
                            value={statsSelectedYear}
                            onChange={(e) => setStatsSelectedYear(parseInt(e.target.value))}
                            className="w-full border rounded-lg px-3 py-2"
                          >
                            {[2024, 2025, 2026, 2027, 2028].map(y => (
                              <option key={y} value={y}>{y}</option>
                            ))}
                          </select>
                        </div>
                      </div>
                    </div>

                    {/* KPIs */}
                    {(() => {
                      if (statsSelectedEngineer === 'all') {
                        // Calcul global pour tous les ing√©nieurs
                        let totalPlanned = 0;
                        let totalActual = 0;
                        
                        engineers.forEach(eng => {
                          const stats = calculateEngineerStats(eng.id, statsSelectedYear, statsSelectedMonth);
                          totalPlanned += stats.totalPlanned;
                          totalActual += stats.totalActual;
                        });
                        
                        const delta = totalActual - totalPlanned;
                        const tauxUtilisation = totalPlanned > 0 ? Math.round((totalActual / totalPlanned) * 100) : 0;
                        
                        return (
                          <div className="bg-white rounded-lg shadow p-6">
                            <h3 className="font-semibold text-gray-800 mb-4">üìà KPIs Globaux</h3>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                              <div className="bg-blue-50 p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-1">Jours Planifi√©s</div>
                                <div className="text-3xl font-bold text-blue-700">{totalPlanned.toFixed(1)}j</div>
                              </div>
                              <div className="bg-green-50 p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-1">Jours R√©alis√©s</div>
                                <div className="text-3xl font-bold text-green-700">{totalActual.toFixed(1)}j</div>
                              </div>
                              <div className={`${delta >= 0 ? 'bg-orange-50' : 'bg-red-50'} p-4 rounded-lg`}>
                                <div className="text-sm text-gray-600 mb-1">√âcart</div>
                                <div className={`text-3xl font-bold ${delta >= 0 ? 'text-orange-700' : 'text-red-700'}`}>
                                  {delta > 0 ? '+' : ''}{delta.toFixed(1)}j
                                </div>
                              </div>
                              <div className="bg-purple-50 p-4 rounded-lg">
                                <div className="text-sm text-gray-600 mb-1">Taux Utilisation</div>
                                <div className="text-3xl font-bold text-purple-700">{tauxUtilisation}%</div>
                              </div>
                            </div>
                          </div>
                        );
                      } else {
                        // Calcul pour un ing√©nieur sp√©cifique
                        const stats = calculateEngineerStats(statsSelectedEngineer, statsSelectedYear, statsSelectedMonth);
                        // CRITICAL: Converti engineerId in numero per find
                        const engineerIdNum = parseInt(statsSelectedEngineer);
                        const engineer = engineers.find(e => e.id === engineerIdNum);
                        
                        return (
                          <div className="space-y-6">
                            <div className="bg-white rounded-lg shadow p-6">
                              <h3 className="font-semibold text-gray-800 mb-4">
                                üìà KPIs - {engineer?.name}
                              </h3>
                              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="bg-blue-50 p-4 rounded-lg">
                                  <div className="text-sm text-gray-600 mb-1">Jours Planifi√©s</div>
                                  <div className="text-3xl font-bold text-blue-700">{stats.totalPlanned.toFixed(1)}j</div>
                                </div>
                                <div className="bg-green-50 p-4 rounded-lg">
                                  <div className="text-sm text-gray-600 mb-1">Jours R√©alis√©s</div>
                                  <div className="text-3xl font-bold text-green-700">{stats.totalActual.toFixed(1)}j</div>
                                </div>
                                <div className={`${stats.delta >= 0 ? 'bg-orange-50' : 'bg-red-50'} p-4 rounded-lg`}>
                                  <div className="text-sm text-gray-600 mb-1">√âcart</div>
                                  <div className={`text-3xl font-bold ${stats.delta >= 0 ? 'text-orange-700' : 'text-red-700'}`}>
                                    {stats.delta > 0 ? '+' : ''}{stats.delta.toFixed(1)}j
                                  </div>
                                </div>
                                <div className="bg-purple-50 p-4 rounded-lg">
                                  <div className="text-sm text-gray-600 mb-1">Taux Utilisation</div>
                                  <div className="text-3xl font-bold text-purple-700">{stats.tauxUtilisation}%</div>
                                </div>
                              </div>
                            </div>

                            {/* Breakdown par projet */}
                            {stats.projectsBreakdown.length > 0 && (
                              <div className="bg-white rounded-lg shadow p-6">
                                <h3 className="font-semibold text-gray-800 mb-4">üìä R√©partition par Projet</h3>
                                <div className="overflow-x-auto">
                                  <table className="w-full text-xs">
                                    <thead>
                                      <tr className="border-b bg-gray-50">
                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Projet</th>
                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Client</th>
                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Type</th>
                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Priorit√©</th>
                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">Statut</th>
                                        <th className="text-left py-2 px-2 font-semibold text-gray-700">P√©riode</th>
                                        <th className="text-right py-2 px-2 font-semibold text-gray-700">Jours command√©s</th>
                                        <th className="text-right py-2 px-2 font-semibold text-gray-700">Planifi√©</th>
                                        <th className="text-right py-2 px-2 font-semibold text-gray-700">R√©alis√©</th>
                                        <th className="text-right py-2 px-2 font-semibold text-gray-700">√âcart</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {stats.projectsBreakdown
                                        .sort((a, b) => b.actual - a.actual)
                                        .map((proj, idx) => (
                                        <tr key={idx} className="border-b hover:bg-gray-50">
                                          <td className="py-2 px-2 font-semibold">{proj.projectName}</td>
                                          <td className="py-2 px-2">
                                            <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded">
                                              {proj.client}
                                            </span>
                                          </td>
                                          <td className="py-2 px-2">
                                            <span className="px-2 py-1 bg-purple-100 text-purple-800 rounded">
                                              {proj.type}
                                            </span>
                                          </td>
                                          <td className="py-2 px-2">
                                            <span className={`px-2 py-1 rounded ${
                                              proj.priority === 'High' ? 'bg-red-100 text-red-800' :
                                              proj.priority === 'Medium' ? 'bg-orange-100 text-orange-800' :
                                              'bg-gray-100 text-gray-800'
                                            }`}>
                                              {proj.priority}
                                            </span>
                                          </td>
                                          <td className="py-2 px-2">
                                            <span className={`px-2 py-1 rounded ${
                                              proj.status === 'Probable' ? 'bg-yellow-100 text-yellow-800' :
                                              proj.status === 'Pr√©sent√©' ? 'bg-blue-100 text-blue-800' :
                                              proj.status === 'Programm√©' ? 'bg-green-100 text-green-800' :
                                              'bg-gray-100 text-gray-800'
                                            }`}>
                                              {proj.status}
                                            </span>
                                          </td>
                                          <td className="py-2 px-2 text-gray-600">
                                            {proj.startDate} ‚Üí {proj.endDate}
                                          </td>
                                          <td className="py-2 px-2 text-right font-semibold text-purple-700">
                                            {proj.budget}j
                                          </td>
                                          <td className="py-2 px-2 text-right font-semibold text-blue-700">
                                            {proj.planned.toFixed(1)}j
                                          </td>
                                          <td className="py-2 px-2 text-right font-semibold text-green-700">
                                            {proj.actual.toFixed(1)}j
                                          </td>
                                          <td className={`py-2 px-2 text-right font-semibold ${
                                            proj.delta > 0 ? 'text-orange-700' : 
                                            proj.delta < 0 ? 'text-red-700' : 'text-gray-700'
                                          }`}>
                                            {proj.delta > 0 ? '+' : ''}{proj.delta.toFixed(1)}j
                                          </td>
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      }
                    })()}

                    {/* Export CSV */}
                    <div className="bg-white rounded-lg shadow p-6">
                      <h3 className="font-semibold text-gray-800 mb-4">üíæ Exports CSV</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button
                          onClick={exportTimesheetCSV}
                          className="bg-green-600 hover:bg-green-700 text-white px-6 py-4 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all"
                        >
                          <Download size={20} />
                          Timesheet D√©taill√©
                        </button>
                        <button
                          onClick={exportSyntheseCSV}
                          className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-lg font-semibold flex items-center justify-center gap-2 transition-all"
                        >
                          <Download size={20} />
                          Synth√®se Mensuelle
                        </button>
                      </div>
                      <p className="text-sm text-gray-500 mt-4">
                        üí° Les exports incluent les donn√©es filtr√©es selon votre s√©lection (ing√©nieur, mois, ann√©e)
                      </p>
                    </div>
                      </>
                    )}
                  </div>
                )}

                {activeTab === 'export' && (
                  <div className="space-y-4">
                    <div className="bg-white rounded-lg shadow p-4 md:p-6">
                      <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-4">Export & Backup</h2>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 rounded-lg p-4 text-center">
                          <FileText size={32} className="mx-auto text-red-600 mb-2" />
                          <p className="text-sm font-semibold text-red-800 mb-1">Export PDF</p>
                          <p className="text-xs text-red-600 mb-3">Rapport complet format√©</p>
                          <button onClick={exportToPDF} className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                            G√©n√©rer PDF
                          </button>
                        </div>
                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-4 text-center">
                          <Database size={32} className="mx-auto text-blue-600 mb-2" />
                          <p className="text-sm font-semibold text-blue-800 mb-1">Backup JSON</p>
                          <p className="text-xs text-blue-600 mb-3">Sauvegarde compl√®te</p>
                          <button onClick={exportBackup} className="w-full bg-[#e61252] hover:bg-[#c10f47] text-white px-4 py-2 rounded-lg font-semibold text-sm">
                            T√©l√©charger Backup
                          </button>
                        </div>
                        {!isReadOnly && (
                          <div className="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-lg p-4 text-center">
                            <Upload size={32} className="mx-auto text-green-600 mb-2" />
                            <p className="text-sm font-semibold text-green-800 mb-1">Restaurer</p>
                            <p className="text-xs text-green-600 mb-3">Importer un backup</p>
                            <label className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold text-sm cursor-pointer inline-block">
                              Choisir fichier
                              <input type="file" accept=".json" onChange={importBackup} className="hidden" />
                            </label>
                          </div>
                        )}
                      </div>
                      
                      {/* OneDrive Sync Section */}
                      {isOneDriveConnected && (
                        <div className="bg-gradient-to-br from-green-50 via-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-6 mb-6">
                          <div className="flex items-start gap-4">
                            <svg className="w-12 h-12 text-blue-600 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            <div className="flex-1">
                              <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                                ‚òÅÔ∏è Synchronisation OneDrive
                                <span className="text-xs bg-green-500 text-white px-2 py-1 rounded-full">Connect√©</span>
                              </h3>
                              <p className="text-sm text-gray-600 mb-3">
                                Vos donn√©es sont automatiquement sauvegard√©es sur OneDrive. Vous pouvez forcer une synchronisation manuelle si n√©cessaire.
                              </p>
                              <div className="flex flex-wrap gap-3 items-center">
                                <button 
                                  onClick={forceSyncFromOneDrive}
                                  disabled={isSyncing}
                                  className="bg-[#e61252] hover:bg-[#c10f47] disabled:bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all"
                                >
                                  {isSyncing ? (
                                    <>
                                      <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                      </svg>
                                      <span>Synchronisation...</span>
                                    </>
                                  ) : (
                                    <>
                                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                      </svg>
                                      <span>Synchroniser maintenant</span>
                                    </>
                                  )}
                                </button>
                                {lastSyncTime && (
                                  <span className="text-sm text-gray-600">
                                    Derni√®re sync: <span className="font-semibold">{lastSyncTime}</span>
                                  </span>
                                )}
                                <button 
                                  onClick={signOutOneDrive}
                                  className="text-sm text-red-600 hover:text-red-800 font-semibold underline"
                                >
                                  D√©connecter Drive
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {!isOneDriveConnected && isOneDriveReady && (
                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                          <div className="flex items-start gap-4">
                            <svg className="w-12 h-12 text-blue-600 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            <div className="flex-1">
                              <h3 className="text-lg font-bold text-gray-800 mb-2">
                                ‚òÅÔ∏è Synchronisation Cloud avec OneDrive
                              </h3>
                              <p className="text-sm text-gray-600 mb-3">
                                Connectez OneDrive pour synchroniser automatiquement vos donn√©es entre tous vos appareils (PC, tablette, mobile). Les donn√©es seront sauvegard√©es en temps r√©el dans le cloud.
                              </p>
                              <div className="bg-blue-100 border border-blue-300 rounded-lg p-3 mb-3">
                                <p className="text-sm text-blue-900 font-semibold mb-2">‚ú® Avantages:</p>
                                <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
                                  <li>Synchronisation automatique entre appareils</li>
                                  <li>Backup automatique dans le cloud</li>
                                  <li>Acc√®s depuis n'importe o√π</li>
                                  <li>Gratuit et s√©curis√©</li>
                                </ul>
                              </div>
                              <button 
                                onClick={signInOneDrive}
                                className="bg-[#e61252] hover:bg-[#c10f47] text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg"
                              >
                                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                  <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                                </svg>
                                Connecter OneDrive
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    <div className="bg-white rounded-lg shadow p-4 md:p-8">
                    <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <Download size={28} className="text-[#e61252]" /> Export CSV
                    </h2>
                    <div className="mb-6">
                      <p className="text-gray-600 mb-4">Exportez toutes vos donn√©es de projets, ressources et affectations dans un fichier CSV compatible Excel.</p>
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 className="font-semibold text-blue-900 mb-2">Le fichier export√© contient :</h3>
                        <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
                          <li>Tous les projets avec leurs dates et statuts</li>
                          <li>Chefs de projet assign√©s</li>
                          <li>Toutes les ressources (Ing√©nieurs, Ressources, Ressources G√©n√©riques)</li>
                          <li>Sp√©cialit√©s et types</li>
                          <li>Nombre de jours vendus par ressource</li>
                        </ul>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-white border rounded-lg p-4 text-center">
                          <p className="text-3xl font-bold text-[#e61252]">{projects.length}</p>
                          <p className="text-sm text-gray-600">Projets √† exporter</p>
                        </div>
                        <div className="bg-white border rounded-lg p-4 text-center">
                          <p className="text-3xl font-bold text-green-600">{engineers.length + resources.length + genericResources.length}</p>
                          <p className="text-sm text-gray-600">Ressources totales</p>
                        </div>
                        <div className="bg-white border rounded-lg p-4 text-center">
                          <p className="text-3xl font-bold text-orange-600">{projectManagers.length}</p>
                          <p className="text-sm text-gray-600">Chefs de projet</p>
                        </div>
                      </div>
                    </div>
                    <button onClick={exportToExcel} className="w-full md:w-auto bg-[#e61252] hover:bg-[#c10f47] text-white px-8 py-4 rounded-lg font-semibold text-lg flex items-center justify-center gap-3 shadow-lg">
                      <Download size={24} /> T√©l√©charger le fichier CSV
                    </button>
                    <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                      <h4 className="font-semibold text-gray-800 mb-2">üí° Conseil :</h4>
                      <p className="text-sm text-gray-600">Le fichier t√©l√©charg√© est au format CSV avec s√©parateur point-virgule (;). Pour l'ouvrir correctement dans Excel, utilisez "Donn√©es" ‚Üí "Importer depuis un fichier texte/CSV" et s√©lectionnez le d√©limiteur point-virgule.</p>
                    </div>
                  </div>
                  </div>
                )}
              </div>

              {showProjectForm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 my-8 max-h-screen overflow-y-auto">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">{editingProject ? 'Modifier le Projet' : 'Nouveau Projet'}</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="md:col-span-2">
                        <input type="text" placeholder="Nom du projet" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} className="w-full border rounded px-3 py-2" />
                      </div>
                      <div className="md:col-span-2">
                        <textarea placeholder="Description" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} className="w-full border rounded px-3 py-2 h-20" />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Statut</label>
                        <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })} className="w-full border rounded px-3 py-2">
                          <option value="probable">Probable</option>
                          <option value="presente">Place Holder</option>
                          <option value="programme">‚úÖ Programm√© (sync calendrier)</option>
                        </select>
                        
                        {formData.status === 'programme' && sessionStorage.getItem('auth_method') === 'microsoft' && (
                          <div className="bg-green-50 border-2 border-green-300 rounded-lg p-3 mt-2">
                            <p className="text-sm text-green-800 font-semibold flex items-center gap-2">
                              <span>‚úÖ</span>
                              <span>Calendrier Teams: Les ing√©nieurs assign√©s recevront automatiquement cet √©v√©nement dans leur calendrier Outlook/Teams.</span>
                            </p>
                          </div>
                        )}
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Chef de projet</label>
                        <select value={formData.projectManager} onChange={(e) => setFormData({ ...formData, projectManager: e.target.value })} className="w-full border rounded px-3 py-2">
                          <option value="">Aucun</option>
                          {projectManagers.map(pm => <option key={pm.id} value={pm.id}>{pm.name} {pm.department && `(${pm.department})`}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date de d√©but</label>
                        <input type="date" value={formData.startDate} onChange={(e) => setFormData({ ...formData, startDate: e.target.value })} className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date de fin</label>
                        <input type="date" value={formData.endDate} onChange={(e) => setFormData({ ...formData, endDate: e.target.value })} className="w-full border rounded px-3 py-2" />
                      </div>
                    </div>
                    {engineers.length > 0 && (
                      <div className="mt-4">
                        <p className="font-semibold text-gray-800 mb-2">Ing√©nieurs assign√©s :</p>
                        <div className="space-y-2 max-h-60 overflow-y-auto border rounded p-2">
                          {engineers.map(eng => {
                            const conflicts = checkResourceConflict(eng.id, 'engineer', formData.startDate, formData.endDate, editingProject?.id);
                            const isSelected = (formData.selectedEngineers || []).includes(eng.id);
                            return (
                              <div key={eng.id} className={`p-2 rounded ${conflicts.length > 0 && isSelected ? 'bg-yellow-50 border border-yellow-300' : ''}`}>
                                <label className="flex items-start gap-2 cursor-pointer">
                                  <input type="checkbox" checked={isSelected} onChange={() => toggleEngineer(eng.id)} className="rounded mt-1" />
                                  <div className="flex-1">
                                    <span className="text-sm font-semibold">{eng.name} {eng.specialty && `(${eng.specialty})`}</span>
                                    {conflicts.length > 0 && isSelected && (
                                      <div className="text-xs text-yellow-700 mt-1">‚ö†Ô∏è D√©j√† assign√©: {conflicts.map(p => p.name).join(', ')}</div>
                                    )}
                                    {isSelected && (
                                      <div className="mt-2 space-y-2">
                                        {/* Campo Budget */}
                                        <div className="flex items-center gap-2">
                                          <label className="text-xs text-gray-600 font-semibold">Jours √† planifier:</label>
                                          <input 
                                            type="number" 
                                            min="0" 
                                            step="0.25"
                                            value={formData.engineerDays[eng.id] || 0} 
                                            onChange={(e) => setFormData(prev => ({
                                              ...prev, 
                                              engineerDays: {...prev.engineerDays, [eng.id]: parseFloat(e.target.value) || 0}
                                            }))} 
                                            className="w-20 border rounded px-2 py-1 text-sm" 
                                            onClick={(e) => e.stopPropagation()} 
                                          />
                                          <span className="text-xs text-gray-500">jours (budget)</span>
                                        </div>
                                        
                                        {/* Badge Planification */}
                                        {formData.engineerMonthlyAllocation[eng.id] && (() => {
                                          const totalPlanned = Object.values(formData.engineerMonthlyAllocation[eng.id] || {}).reduce((sum, val) => sum + val, 0);
                                          const budget = formData.engineerDays[eng.id] || 0;
                                          const isComplete = budget > 0 && totalPlanned >= budget;
                                          const isPartial = budget > 0 && totalPlanned > 0 && totalPlanned < budget;
                                          
                                          return (
                                            <div className={`border rounded px-2 py-1 ${
                                              isComplete ? 'bg-green-50 border-green-200' : 
                                              isPartial ? 'bg-yellow-50 border-yellow-200' : 
                                              'bg-blue-50 border-blue-200'
                                            }`}>
                                              <span className={`text-xs font-bold ${
                                                isComplete ? 'text-green-800' : 
                                                isPartial ? 'text-yellow-800' : 
                                                'text-blue-800'
                                              }`}>
                                                {isComplete ? '‚úì' : isPartial ? '‚ö†Ô∏è' : 'üìÖ'} {totalPlanned.toFixed(1)}j planifi√©s
                                                {budget > 0 && ` sur ${budget.toFixed(1)}j √† planifier`}
                                              </span>
                                            </div>
                                          );
                                        })()}
                                        
                                        {/* Bottoni */}
                                        {formData.startDate && formData.endDate && (
                                          <div className="flex gap-2">
                                            <button 
                                              type="button"
                                              onClick={(e) => { e.stopPropagation(); openMonthlyAllocationModal(eng.id, eng.name, 'engineer'); }}
                                              className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded font-semibold flex items-center gap-1"
                                            >
                                              üìÖ D√©tailler par mois
                                            </button>
                                            {formData.engineerMonthlyAllocation[eng.id] && (
                                              <button 
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); clearMonthlyAllocation(eng.id, 'engineer'); }}
                                                className="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded"
                                              >
                                                ‚úï
                                              </button>
                                            )}
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </label>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    {resources.length > 0 && (
                      <div className="mt-4">
                        <p className="font-semibold text-gray-800 mb-2">Ressources assign√©es :</p>
                        <div className="space-y-2 max-h-60 overflow-y-auto border rounded p-2">
                          {resources.map(res => {
                            const conflicts = checkResourceConflict(res.id, 'resource', formData.startDate, formData.endDate, editingProject?.id);
                            const isSelected = (formData.selectedResources || []).includes(res.id);
                            return (
                              <div key={res.id} className={`p-2 rounded ${conflicts.length > 0 && isSelected ? 'bg-yellow-50 border border-yellow-300' : ''}`}>
                                <label className="flex items-start gap-2 cursor-pointer">
                                  <input type="checkbox" checked={isSelected} onChange={() => toggleResource(res.id)} className="rounded mt-1" />
                                  <div className="flex-1">
                                    <span className="text-sm font-semibold">{res.name} {res.type && `(${res.type})`}</span>
                                    {conflicts.length > 0 && isSelected && (
                                      <div className="text-xs text-yellow-700 mt-1">‚ö†Ô∏è D√©j√† assign√©: {conflicts.map(p => p.name).join(', ')}</div>
                                    )}
                                    {isSelected && (
                                      <div className="mt-2 space-y-2">
                                        <div className="flex items-center gap-2">
                                          <label className="text-xs text-gray-600">Jours vendus:</label>
                                          <input type="number" min="0" value={formData.resourceDays[res.id] || 0} onChange={(e) => setFormData(prev => ({...prev, resourceDays: {...prev.resourceDays, [res.id]: parseInt(e.target.value) || 0}}))} className="w-20 border rounded px-2 py-1 text-sm" onClick={(e) => e.stopPropagation()} />
                                          <span className="text-xs text-gray-500">jours</span>
                                        </div>
                                        {formData.startDate && formData.endDate && formData.resourceDays[res.id] > 0 && (
                                          <div className="flex gap-2">
                                            <button 
                                              type="button"
                                              onClick={(e) => { e.stopPropagation(); openMonthlyAllocationModal(res.id, res.name, 'resource'); }}
                                              className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded font-semibold flex items-center gap-1"
                                            >
                                              üìÖ D√©tailler par mois
                                            </button>
                                            {formData.resourceMonthlyAllocation[res.id] && (
                                              <button 
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); clearMonthlyAllocation(res.id, 'resource'); }}
                                                className="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded"
                                              >
                                                ‚úï
                                              </button>
                                            )}
                                          </div>
                                        )}
                                        {formData.resourceMonthlyAllocation[res.id] && (
                                          <p className="text-xs text-green-700 font-semibold">‚úì Allocation d√©taill√©e d√©finie</p>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </label>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    {genericResources.length > 0 && (
                      <div className="mt-4">
                        <p className="font-semibold text-gray-800 mb-2">Ressources G√©n√©riques assign√©es :</p>
                        <div className="space-y-2 max-h-60 overflow-y-auto border rounded p-2">
                          {genericResources.map(res => {
                            const conflicts = checkResourceConflict(res.id, 'generic', formData.startDate, formData.endDate, editingProject?.id);
                            const isSelected = (formData.selectedGenericResources || []).includes(res.id);
                            return (
                              <div key={res.id} className={`p-2 rounded ${conflicts.length > 0 && isSelected ? 'bg-yellow-50 border border-yellow-300' : ''}`}>
                                <label className="flex items-start gap-2 cursor-pointer">
                                  <input type="checkbox" checked={isSelected} onChange={() => toggleGenericResource(res.id)} className="rounded mt-1" />
                                  <div className="flex-1">
                                    <span className="text-sm font-semibold">{res.name} {res.type && `(${res.type})`}</span>
                                    {conflicts.length > 0 && isSelected && (
                                      <div className="text-xs text-yellow-700 mt-1">‚ö†Ô∏è D√©j√† assign√©: {conflicts.map(p => p.name).join(', ')}</div>
                                    )}
                                    {isSelected && (
                                      <div className="mt-2 space-y-2">
                                        <div className="flex items-center gap-2">
                                          <label className="text-xs text-gray-600">Jours vendus:</label>
                                          <input type="number" min="0" value={formData.genericResourceDays[res.id] || 0} onChange={(e) => setFormData(prev => ({...prev, genericResourceDays: {...prev.genericResourceDays, [res.id]: parseInt(e.target.value) || 0}}))} className="w-20 border rounded px-2 py-1 text-sm" onClick={(e) => e.stopPropagation()} />
                                          <span className="text-xs text-gray-500">jours</span>
                                        </div>
                                        {formData.startDate && formData.endDate && formData.genericResourceDays[res.id] > 0 && (
                                          <div className="flex gap-2">
                                            <button 
                                              type="button"
                                              onClick={(e) => { e.stopPropagation(); openMonthlyAllocationModal(res.id, res.name, 'generic'); }}
                                              className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded font-semibold flex items-center gap-1"
                                            >
                                              üìÖ D√©tailler par mois
                                            </button>
                                            {formData.genericResourceMonthlyAllocation[res.id] && (
                                              <button 
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); clearMonthlyAllocation(res.id, 'generic'); }}
                                                className="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded"
                                              >
                                                ‚úï
                                              </button>
                                            )}
                                          </div>
                                        )}
                                        {formData.genericResourceMonthlyAllocation[res.id] && (
                                          <p className="text-xs text-green-700 font-semibold">‚úì Allocation d√©taill√©e d√©finie</p>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </label>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    <div className="mt-6 border-t pt-4">
                      <h3 className="font-semibold text-gray-800 mb-3">üè∑Ô∏è Tags</h3>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Client</label>
                          <div className="flex gap-2 mb-2">
                            <input type="text" id="newClientTag" placeholder="Nouveau client" className="flex-1 border rounded px-3 py-2 text-sm" onKeyDown={(e) => { if (e.key === 'Enter') { const val = e.target.value.trim(); if (val) { addClientTag(val); toggleTag('client', val); e.target.value = ''; } } }} />
                            <button onClick={() => { const input = document.getElementById('newClientTag'); const val = input.value.trim(); if (val) { addClientTag(val); toggleTag('client', val); input.value = ''; } }} className="bg-[#e61252] hover:bg-[#c10f47] text-white px-4 py-2 rounded text-sm font-semibold">Ajouter</button>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {availableTags.client.map(tag => (
                              <div key={tag} className="relative inline-flex items-center">
                                <button onClick={() => toggleTag('client', tag)} className={`px-3 py-1 rounded-full text-sm border-2 ${(formData.tags.client || []).includes(tag) ? 'bg-blue-100 text-blue-800 border-blue-400 font-semibold' : 'bg-white text-gray-700 border-gray-300'} ${!isReadOnly ? 'pr-8' : ''}`}>
                                  {tag}
                                </button>
                                {!isReadOnly && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (confirm(`Supprimer le tag "${tag}" ? Il sera retir√© de tous les projets.`)) {
                                        deleteTag('client', tag);
                                      }
                                    }}
                                    className="absolute right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold"
                                    title="Supprimer ce tag"
                                  >
                                    ‚úï
                                  </button>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Type de projet</label>
                          <div className="flex flex-wrap gap-2">
                            {availableTags.type.map(tag => (
                              <div key={tag} className="relative inline-flex items-center">
                                <button onClick={() => toggleTag('type', tag)} className={`px-3 py-1 rounded-full text-sm border-2 ${(formData.tags.type || []).includes(tag) ? 'bg-purple-100 text-purple-800 border-purple-400 font-semibold' : 'bg-white text-gray-700 border-gray-300'} ${!isReadOnly ? 'pr-8' : ''}`}>
                                  {tag}
                                </button>
                                {!isReadOnly && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (confirm(`Supprimer le tag "${tag}" ? Il sera retir√© de tous les projets.`)) {
                                        deleteTag('type', tag);
                                      }
                                    }}
                                    className="absolute right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold"
                                    title="Supprimer ce tag"
                                  >
                                    ‚úï
                                  </button>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Priorit√©</label>
                          <div className="flex flex-wrap gap-2">
                            {availableTags.priority.map(tag => (
                              <div key={tag} className="relative inline-flex items-center">
                                <button onClick={() => toggleTag('priority', tag)} className={`px-3 py-1 rounded-full text-sm border-2 ${(formData.tags.priority || []).includes(tag) ? 'bg-red-100 text-red-800 border-red-400 font-semibold' : 'bg-white text-gray-700 border-gray-300'} ${!isReadOnly ? 'pr-8' : ''}`}>
                                  {tag}
                                </button>
                                {!isReadOnly && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      if (confirm(`Supprimer le tag "${tag}" ? Il sera retir√© de tous les projets.`)) {
                                        deleteTag('priority', tag);
                                      }
                                    }}
                                    className="absolute right-1 bg-red-500 hover:bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold"
                                    title="Supprimer ce tag"
                                  >
                                    ‚úï
                                  </button>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-2 mt-6">
                      <button onClick={addProject} className="flex-1 bg-[#e61252] hover:bg-[#c10f47] text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2"><Check size={18} /> {editingProject ? 'Mettre √† jour' : 'Cr√©er'}</button>
                      <button onClick={resetProjectForm} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2"><X size={18} /> Annuler</button>
                    </div>
                  </div>
                </div>
              )}

              {showDeleteWarning && resourceToDelete && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={cancelDelete}>
                  <div className="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4" onClick={(e) => e.stopPropagation()}>
                    <div className="flex items-start gap-3 mb-4">
                      <div className="bg-red-100 rounded-full p-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" strokeWidth="2">
                          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                          <line x1="12" y1="9" x2="12" y2="13"/>
                          <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                      </div>
                      <div className="flex-1">
                        <h3 className="text-lg font-bold text-gray-900 mb-2">‚ö†Ô∏è Attention - Ressource utilis√©e</h3>
                        <p className="text-gray-700 mb-3">
                          Voulez-vous vraiment supprimer <strong>{resourceToDelete.name}</strong> ?
                        </p>
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                          <p className="text-sm font-semibold text-yellow-800 mb-1">
                            Cette ressource est assign√©e √† {resourceToDelete.usedIn.length} projet(s) :
                          </p>
                          <ul className="text-sm text-yellow-700 space-y-1">
                            {resourceToDelete.usedIn.map(p => (
                              <li key={p.id}>‚Ä¢ {p.name}</li>
                            ))}
                          </ul>
                        </div>
                        <p className="text-sm text-gray-600">
                          La ressource sera automatiquement retir√©e de tous ces projets.
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-3">
                      <button onClick={() => confirmDelete(resourceToDelete.id, resourceToDelete.type)} className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                        Confirmer la suppression
                      </button>
                      <button onClick={cancelDelete} className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showAlerts && (
                <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50" onClick={() => setShowAlerts(false)}>
                  <div className="bg-white rounded-lg shadow-xl p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-gray-900">üîî Alertes et notifications</h3>
                      <button onClick={() => setShowAlerts(false)} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                      </button>
                    </div>
                    {allAlerts.length === 0 ? (
                      <div className="text-center py-8">
                        <div className="text-6xl mb-2">‚úÖ</div>
                        <p className="text-gray-600">Aucune alerte ! Tout est en ordre.</p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {allAlerts.map((alert, idx) => {
                          if (alert.type === 'overlap') {
                            return (
                              <div key={idx} className="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-red-100 rounded-full p-2">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" strokeWidth="2">
                                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                      <line x1="12" y1="9" x2="12" y2="13"/>
                                      <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                  </div>
                                  <div>
                                    <p className="font-semibold text-red-800">Chevauchement de dates</p>
                                    <p className="text-sm text-red-700">
                                      <strong>{alert.resource}</strong> ({alert.resourceType}) est assign√©(e) simultan√©ment sur :
                                    </p>
                                    <ul className="text-sm text-red-700 mt-1 ml-4">
                                      {alert.projects.map((p, i) => <li key={i}>‚Ä¢ {p}</li>)}
                                    </ul>
                                  </div>
                                </div>
                              </div>
                            );
                          } else if (alert.type === 'no-dates') {
                            return (
                              <div key={idx} className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-yellow-100 rounded-full p-2">
                                    <Calendar size={20} className="text-yellow-600" />
                                  </div>
                                  <div>
                                    <p className="font-semibold text-yellow-800">Dates manquantes</p>
                                    <p className="text-sm text-yellow-700">
                                      Le projet <strong>{alert.project}</strong> n'a pas de dates d√©finies.
                                    </p>
                                  </div>
                                </div>
                              </div>
                            );
                          } else if (alert.type === 'no-resources') {
                            return (
                              <div key={idx} className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-orange-100 rounded-full p-2">
                                    <Users size={20} className="text-orange-600" />
                                  </div>
                                  <div>
                                    <p className="font-semibold text-orange-800">Ressources manquantes</p>
                                    <p className="text-sm text-orange-700">
                                      Le projet <strong>{alert.project}</strong> est "En cours" mais n'a aucune ressource assign√©e.
                                    </p>
                                  </div>
                                </div>
                              </div>
                            );
                          } else if (alert.category === 'stats-urgent') {
                            return (
                              <div key={idx} className="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-red-100 rounded-full p-2">
                                    <span className="text-xl">üî¥</span>
                                  </div>
                                  <div>
                                    <p className="font-semibold text-red-800">URGENT</p>
                                    <p className="text-sm text-red-700">{alert.message}</p>
                                  </div>
                                </div>
                              </div>
                            );
                          } else if (alert.category === 'stats-attention') {
                            return (
                              <div key={idx} className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-yellow-100 rounded-full p-2">
                                    <span className="text-xl">‚ö†Ô∏è</span>
                                  </div>
                                  <div>
                                    <p className="font-semibold text-yellow-800">ATTENTION</p>
                                    <p className="text-sm text-yellow-700">{alert.message}</p>
                                  </div>
                                </div>
                              </div>
                            );
                          } else if (alert.category === 'stats-deadline') {
                            return (
                              <div key={idx} className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-blue-100 rounded-full p-2">
                                    <Calendar size={20} className="text-blue-600" />
                                  </div>
                                  <div>
                                    <p className="font-semibold text-blue-800">DEADLINE PROCHE</p>
                                    <p className="text-sm text-blue-700">{alert.message}</p>
                                  </div>
                                </div>
                              </div>
                            );
                          }
                        })}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {showDayModal && selectedDayProjects && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowDayModal(false)}>
                  <div className="bg-white rounded-lg shadow-xl p-6 max-w-3xl w-full mx-4 max-h-96 overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-gray-900">
                        üìÖ {selectedDayProjects.day} {new Date(selectedDayProjects.year, selectedDayProjects.month).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                      </h3>
                      <button onClick={() => setShowDayModal(false)} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                      </button>
                    </div>
                    {selectedDayProjects.projects.length === 0 ? (
                      <p className="text-gray-500 text-center py-8">Aucun projet actif ce jour</p>
                    ) : (
                      <div className="space-y-3">
                        <p className="text-sm text-gray-600">{selectedDayProjects.projects.length} projet(s) actif(s) ce jour</p>
                        {selectedDayProjects.projects.map(project => (
                          <div key={project.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <h4 className="font-bold text-gray-800">{project.name}</h4>
                                <p className="text-sm text-gray-600 mt-1">
                                  {project.startDate && `Du ${new Date(project.startDate).toLocaleDateString('fr-FR')}`}
                                  {project.startDate && project.endDate && ' - '}
                                  {project.endDate && `au ${new Date(project.endDate).toLocaleDateString('fr-FR')}`}
                                </p>
                              </div>
                              <span className={`px-2 py-1 rounded-full text-xs font-semibold ${statusConfig[project.status]?.color || 'bg-gray-100 text-gray-800'}`}>
                                {statusConfig[project.status]?.label || project.status}
                              </span>
                            </div>
                            <div className="mt-2 space-y-2">
                              {getProjectManager(project) && (
                                <div className="flex items-center gap-2">
                                  <span className="text-xs font-semibold text-gray-600">PM:</span>
                                  <span className="text-xs bg-orange-100 text-orange-800 px-2 py-0.5 rounded">{getProjectManager(project).name}</span>
                                </div>
                              )}
                              {getAssignedEngineers(project).length > 0 && (
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="text-xs font-semibold text-gray-600">Ing√©nieurs:</span>
                                  {getAssignedEngineers(project).map(eng => (
                                    <span key={eng.id} className="text-xs bg-pink-50 text-[#c10f47] px-2 py-0.5 rounded">{eng.name}</span>
                                  ))}
                                </div>
                              )}
                              {getAssignedResources(project).length > 0 && (
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="text-xs font-semibold text-gray-600">Ressources:</span>
                                  {getAssignedResources(project).map(res => (
                                    <span key={res.id} className="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded">{res.name}</span>
                                  ))}
                                </div>
                              )}
                              {getAssignedGenericResources(project).length > 0 && (
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="text-xs font-semibold text-gray-600">G√©n√©riques:</span>
                                  {getAssignedGenericResources(project).map(res => (
                                    <span key={res.id} className="text-xs bg-teal-100 text-teal-800 px-2 py-0.5 rounded">{res.name}</span>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {showConflictModal && conflictToResolve && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowConflictModal(false)}>
                  <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6 max-h-[85vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <AlertTriangle size={24} className="text-red-600" />
                        R√©soudre le conflit
                      </h3>
                      <button onClick={() => setShowConflictModal(false)} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                      </button>
                    </div>

                    <div className="mb-6">
                      <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
                        <p className="text-sm text-red-900 font-semibold mb-2">Chevauchement d√©tect√©:</p>
                        <p className="text-sm text-red-800">
                          <strong>{conflictToResolve.project1.name}</strong> et <strong>{conflictToResolve.project2.name}</strong> 
                          se chevauchent du {conflictToResolve.overlapStart.toLocaleDateString('fr-FR')} au {conflictToResolve.overlapEnd.toLocaleDateString('fr-FR')}
                        </p>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="border-2 border-indigo-200 rounded-lg p-4">
                          <p className="font-bold text-gray-800 mb-2">{conflictToResolve.project1.name}</p>
                          <p className="text-sm text-gray-600 mb-3">
                            Du {new Date(conflictToResolve.project1.startDate).toLocaleDateString('fr-FR')} 
                            au {new Date(conflictToResolve.project1.endDate).toLocaleDateString('fr-FR')}
                          </p>
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project1.status]?.color || 'bg-gray-200'}`}>
                            {statusConfig[conflictToResolve.project1.status]?.label || conflictToResolve.project1.status}
                          </span>
                        </div>

                        <div className="border-2 border-indigo-200 rounded-lg p-4">
                          <p className="font-bold text-gray-800 mb-2">{conflictToResolve.project2.name}</p>
                          <p className="text-sm text-gray-600 mb-3">
                            Du {new Date(conflictToResolve.project2.startDate).toLocaleDateString('fr-FR')} 
                            au {new Date(conflictToResolve.project2.endDate).toLocaleDateString('fr-FR')}
                          </p>
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project2.status]?.color || 'bg-gray-200'}`}>
                            {statusConfig[conflictToResolve.project2.status]?.label || conflictToResolve.project2.status}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* R√©solution Automatique par Priorit√© */}
                    <div className="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-lg p-5 shadow-md">
                      <div className="flex items-center gap-2 mb-4">
                        <span className="text-2xl">üéØ</span>
                        <h4 className="text-lg font-bold text-purple-900">R√©solution Automatique par Priorit√©</h4>
                      </div>
                      
                      <p className="text-sm text-purple-700 mb-4">
                        Choisissez quel projet est prioritaire. Ses allocations resteront <strong>fixes</strong>. 
                        L'autre projet sera automatiquement allou√© dans les jours disponibles restants.
                      </p>
                      
                      {/* Radio buttons selezione progetto prioritario */}
                      <div className="space-y-3 mb-5">
                        <label className={`flex items-start gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                          priorityProject === 'project1' 
                            ? 'bg-purple-100 border-purple-500' 
                            : 'bg-white border-gray-300 hover:border-purple-300'
                        }`}>
                          <input
                            type="radio"
                            name="priorityProject"
                            checked={priorityProject === 'project1'}
                            onChange={() => setPriorityProject('project1')}
                            className="mt-1 w-5 h-5 text-purple-600"
                          />
                          <div className="flex-1">
                            <p className="font-bold text-gray-800">{conflictToResolve.project1.name}</p>
                            <p className="text-sm text-gray-600">
                              {new Date(conflictToResolve.project1.startDate).toLocaleDateString('fr-FR')} ‚Üí 
                              {new Date(conflictToResolve.project1.endDate).toLocaleDateString('fr-FR')}
                            </p>
                            <span className={`inline-block mt-1 px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project1.status]?.color || 'bg-gray-200'}`}>
                              {statusConfig[conflictToResolve.project1.status]?.label || conflictToResolve.project1.status}
                            </span>
                            {priorityProject === 'project1' && (
                              <p className="text-xs text-purple-700 mt-2 font-semibold">
                                ‚úì Prioritaire - Dates gard√©es fixes
                              </p>
                            )}
                          </div>
                        </label>
                        
                        <label className={`flex items-start gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                          priorityProject === 'project2' 
                            ? 'bg-purple-100 border-purple-500' 
                            : 'bg-white border-gray-300 hover:border-purple-300'
                        }`}>
                          <input
                            type="radio"
                            name="priorityProject"
                            checked={priorityProject === 'project2'}
                            onChange={() => setPriorityProject('project2')}
                            className="mt-1 w-5 h-5 text-purple-600"
                          />
                          <div className="flex-1">
                            <p className="font-bold text-gray-800">{conflictToResolve.project2.name}</p>
                            <p className="text-sm text-gray-600">
                              {new Date(conflictToResolve.project2.startDate).toLocaleDateString('fr-FR')} ‚Üí 
                              {new Date(conflictToResolve.project2.endDate).toLocaleDateString('fr-FR')}
                            </p>
                            <span className={`inline-block mt-1 px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project2.status]?.color || 'bg-gray-200'}`}>
                              {statusConfig[conflictToResolve.project2.status]?.label || conflictToResolve.project2.status}
                            </span>
                            {priorityProject === 'project2' && (
                              <p className="text-xs text-purple-700 mt-2 font-semibold">
                                ‚úì Prioritaire - Dates gard√©es fixes
                              </p>
                            )}
                          </div>
                        </label>
                      </div>
                      
                      {/* Button applicazione */}
                      <button
                        onClick={() => {
                          if (!priorityProject) {
                            alert('‚ö†Ô∏è Veuillez s√©lectionner un projet prioritaire');
                            return;
                          }
                          
                          const result = resolveByPriority(conflictToResolve, priorityProject);
                          
                          // üîß FIX #3: Se giorni insufficienti ‚Üí BLOCCA e torna a manuale
                          if (result.warning) {
                            alert(`‚ùå ${result.warning}\n\n‚ö†Ô∏è Jours disponibles insuffisants!\n\nVeuillez r√©soudre le conflit manuellement en utilisant les calendriers ci-dessous.`);
                            return; // NON applica niente, modal rimane aperto
                          }
                          
                          // Ottieni info risorsa dal conflitto
                          const resourceId = conflictToResolve.resourceId;
                          const resourceType = conflictToResolve.resourceType;
                          
                          // üîß FIX #1: Applica la risoluzione con aggiornamento campi corretti
                          const updatedProjects = projects.map(p => {
                            if (p.id === result.priorityProject.id) {
                              // Progetto prioritario: mantieni com'√® (date bloccate)
                              return p;
                            } else if (p.id === result.secondaryProject.id) {
                              // Progetto secondario: aggiorna con nuove allocazioni
                              
                              // Prepara update base
                              const updatedProject = {
                                ...p,
                                startDate: result.secondaryProject.newStartDate,
                                endDate: result.secondaryProject.newEndDate,
                                selectedDates: result.secondaryProject.allocations  // ‚úÖ SOSTITUISCI completamente
                              };
                              
                              // üîß FIX #1: Aggiorna campo corretto per tipo risorsa
                              if (resourceId && resourceType) {
                                if (resourceType === 'engineer') {
                                  updatedProject.engineerMonthlyAllocation = {
                                    ...(p.engineerMonthlyAllocation || {}),
                                    [resourceId]: result.secondaryProject.allocations
                                  };
                                } else if (resourceType === 'resource') {
                                  updatedProject.resourceMonthlyAllocation = {
                                    ...(p.resourceMonthlyAllocation || {}),
                                    [resourceId]: result.secondaryProject.allocations
                                  };
                                } else if (resourceType === 'generic') {
                                  updatedProject.genericResourceMonthlyAllocation = {
                                    ...(p.genericResourceMonthlyAllocation || {}),
                                    [resourceId]: result.secondaryProject.allocations
                                  };
                                }
                              }
                              
                              return updatedProject;
                            }
                            return p;
                          });
                          
                          setProjects(updatedProjects);
                          
                          // üîß FIX: Refresh PRIMA di chiudere modal
                          if (resourceId) {
                            setSelectedResourceId(''); // Reset
                            setTimeout(() => {
                              setSelectedResourceId(resourceId); // Restore ‚Üí triggers recalc
                              
                              // Chiudi modal DOPO refresh
                              setShowConflictModal(false);
                              setConflictToResolve(null);
                              setPriorityProject(null);
                              
                              // Alert finale
                              const oldStart = new Date(result.secondaryProject.id === conflictToResolve.project1.id ? conflictToResolve.project1.startDate : conflictToResolve.project2.startDate).toLocaleDateString('fr-FR');
                              const oldEnd = new Date(result.secondaryProject.id === conflictToResolve.project1.id ? conflictToResolve.project1.endDate : conflictToResolve.project2.endDate).toLocaleDateString('fr-FR');
                              const newStart = new Date(result.secondaryProject.newStartDate).toLocaleDateString('fr-FR');
                              const newEnd = new Date(result.secondaryProject.newEndDate).toLocaleDateString('fr-FR');
                              
                              alert(`‚úÖ R√©solution appliqu√©e avec succ√®s!\n\nüìä ${result.secondaryProject.name}:\n‚Ä¢ Allou√©: ${result.daysAllocated}j / ${result.daysNeeded}j\n‚Ä¢ Anciennes dates: ${oldStart} - ${oldEnd}\n‚Ä¢ Nouvelles dates: ${newStart} - ${newEnd}\n\n‚ö†Ô∏è V√©rifiez le calendrier pour confirmer les nouvelles allocations.`);
                            }, 300);
                          } else {
                            // Fallback se no resourceId
                            setShowConflictModal(false);
                            setConflictToResolve(null);
                            setPriorityProject(null);
                            const newStart = new Date(result.secondaryProject.newStartDate).toLocaleDateString('fr-FR');
                            const newEnd = new Date(result.secondaryProject.newEndDate).toLocaleDateString('fr-FR');
                            alert(`‚úÖ R√©solution appliqu√©e avec succ√®s!\n\nüìä ${result.secondaryProject.name}:\n‚Ä¢ Allou√©: ${result.daysAllocated}j / ${result.daysNeeded}j\n‚Ä¢ Nouvelles dates: ${newStart} - ${newEnd}`);
                          }
                        }}
                        disabled={!priorityProject}
                        className={`w-full font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg ${
                          priorityProject 
                            ? 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white' 
                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        }`}
                      >
                        <span className="text-xl">‚ú®</span>
                        <span>Appliquer r√©solution par priorit√©</span>
                      </button>
                      
                      <div className="mt-3 text-xs text-purple-800 bg-purple-100 rounded px-3 py-2">
                        üí° <strong>Info:</strong> Cette r√©solution automatique trouve les jours disponibles en √©vitant les conflits avec le projet prioritaire. Si pas assez de jours, un avertissement sera affich√©.
                      </div>
                    </div>

                    <div className="space-y-3">
                      <p className="font-semibold text-gray-800 mb-3">Options de r√©solution:</p>
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="font-semibold text-blue-900 mb-3 flex items-center justify-between">
                          <span>üìÖ Modifier les dates de {conflictToResolve.project1.name}</span>
                          <span className="text-sm font-normal">
                            Total: {getConflictTotalDays('project1')} jour(s)
                          </span>
                        </p>
                        
                        {/* Toggle Calendario */}
                        <button
                          onClick={() => setConflictCalendarMode(conflictCalendarMode === 'project1' ? null : 'project1')}
                          className="w-full mb-3 bg-blue-100 hover:bg-blue-200 text-blue-900 px-3 py-2 rounded font-semibold text-sm flex items-center justify-center gap-2"
                        >
                          {conflictCalendarMode === 'project1' ? 'üìÖ Masquer' : 'üìÖ Ouvrir'} le calendrier
                        </button>
                        
                        {/* Calendario Interattivo */}
                        {conflictCalendarMode === 'project1' && (
                          <div className="bg-white border-2 border-blue-300 rounded-lg p-4 mb-3">
                            {/* Range Selection */}
                            <div className="mb-4 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-3">
                              <h4 className="text-sm font-bold text-green-900 mb-3">‚ö° S√©lection Rapide par P√©riode</h4>
                              
                              <div className="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date d√©but</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeStart}
                                    onChange={(e) => setConflictRangeStart(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date fin</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeEnd}
                                    onChange={(e) => setConflictRangeEnd(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                              </div>
                              
                              <div className="mb-3">
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="checkbox"
                                    checked={conflictRangeWorkdaysOnly}
                                    onChange={(e) => setConflictRangeWorkdaysOnly(e.target.checked)}
                                    className="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-xs font-semibold text-gray-700 group-hover:text-green-700">
                                    üìÜ Seulement jours ouvrables (Lun-Ven)
                                  </span>
                                </label>
                              </div>
                              
                              <div className="flex gap-2">
                                <button
                                  onClick={() => applyConflictRangeSelection('project1', 0.5)}
                                  className="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 0.5j
                                </button>
                                <button
                                  onClick={() => applyConflictRangeSelection('project1', 1.0)}
                                  className="flex-1 bg-[#e61252] hover:bg-[#c10f47] text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 1.0j
                                </button>
                              </div>
                            </div>
                            
                            {/* Header: Mois/Anno navigation */}
                            <div className="flex items-center justify-between mb-3 bg-blue-50 p-2 rounded">
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() - 1))}
                                className="text-blue-900 hover:bg-blue-200 px-3 py-1 rounded font-bold"
                              >
                                ‚óÄ
                              </button>
                              <span className="font-bold text-blue-900 text-sm">
                                {conflictCalendarMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                              </span>
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() + 1))}
                                className="text-blue-900 hover:bg-blue-200 px-3 py-1 rounded font-bold"
                              >
                                ‚ñ∂
                              </button>
                            </div>
                            
                            {/* Giorni settimana header */}
                            <div className="grid grid-cols-7 gap-1 mb-2">
                              {['Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa', 'Di'].map(day => (
                                <div key={day} className="text-center text-xs font-bold text-gray-600 py-1">
                                  {day}
                                </div>
                              ))}
                            </div>
                            
                            {/* Giorni calendario */}
                            <div className="grid grid-cols-7 gap-1">
                              {generateConflictCalendarDays(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth()).map((day, index) => {
                                const allocation = getConflictDayAllocation(day, 'project1');
                                
                                // V√©rifier conflit avec autres projets (syst√®me intelligent)
                                const year = conflictCalendarMonth.getFullYear();
                                const month = conflictCalendarMonth.getMonth();
                                const dateKey = day ? `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : null;
                                const isAllocatedElsewhere = dateKey ? isDayAllocatedElsewhere(
                                  dateKey, 
                                  conflictToResolve?.project1?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : false;
                                const allocationDetails = isAllocatedElsewhere ? getAllocationDetails(
                                  dateKey, 
                                  conflictToResolve?.project1?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : null;
                                
                                return (
                                  <button
                                    key={index}
                                    onClick={() => handleConflictDayClick(day, 'project1')}
                                    disabled={!day}
                                    title={allocationDetails ? 
                                      `‚ö†Ô∏è D√©j√† allou√© dans:\n${allocationDetails.map(a => `${a.projectName} (${a.allocation}j)`).join('\n')}` 
                                      : ''
                                    }
                                    className={`
                                      aspect-square text-xs rounded flex flex-col items-center justify-center font-semibold relative
                                      ${!day ? 'invisible' : ''}
                                      ${allocation === 1.0 ? 'bg-[#e61252] text-white hover:bg-[#c10f47]' : ''}
                                      ${allocation === 0.5 ? 'bg-orange-400 text-white hover:bg-orange-500' : ''}
                                      ${!allocation ? 'bg-gray-100 hover:bg-blue-100 text-gray-700' : ''}
                                      ${isAllocatedElsewhere ? 'border-2 border-red-500' : ''}
                                    `}
                                  >
                                    {isAllocatedElsewhere && (
                                      <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px] font-bold">
                                        ‚ö†
                                      </div>
                                    )}
                                    <span>{day}</span>
                                    {allocation && <span className="text-[8px]">{allocation}j</span>}
                                  </button>
                                );
                              })}
                            </div>
                            
                            {/* Legenda */}
                            <div className="mt-3 pt-3 border-t border-blue-200 flex gap-3 text-xs">
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                                <span>Vide</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-orange-400 rounded"></div>
                                <span>0.5j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-[#e61252] rounded"></div>
                                <span>1.0j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px]">‚ö†</div>
                                <span>D√©j√† allou√©</span>
                              </div>
                            </div>
                            
                            <p className="mt-3 text-xs text-blue-800 bg-blue-50 p-2 rounded">
                              üí° <strong>Conseil:</strong> Click sur un jour pour cycler entre √©tats (Vide ‚Üí 0.5j ‚Üí 1.0j ‚Üí Vide)
                            </p>
                          </div>
                        )}
                        
                        <button 
                          onClick={() => {
                            const dates = calculateConflictProjectDates('project1');
                            if (dates.start && dates.end) {
                              resolveConflict(conflictToResolve, 'modify1', { startDate: dates.start, endDate: dates.end }, conflictSelectedDays.project1);
                              setConflictCalendarMode(null);
                            } else {
                              alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un jour');
                            }
                          }}
                          className="w-full bg-[#e61252] hover:bg-[#c10f47] text-white px-4 py-2 rounded font-semibold text-sm"
                        >
                          Appliquer √† {conflictToResolve.project1.name}
                        </button>
                      </div>

                      <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p className="font-semibold text-green-900 mb-3 flex items-center justify-between">
                          <span>üìÖ Modifier les dates de {conflictToResolve.project2.name}</span>
                          <span className="text-sm font-normal">
                            Total: {getConflictTotalDays('project2')} jour(s)
                          </span>
                        </p>
                        
                        {/* Toggle Calendario */}
                        <button
                          onClick={() => setConflictCalendarMode(conflictCalendarMode === 'project2' ? null : 'project2')}
                          className="w-full mb-3 bg-green-100 hover:bg-green-200 text-green-900 px-3 py-2 rounded font-semibold text-sm flex items-center justify-center gap-2"
                        >
                          {conflictCalendarMode === 'project2' ? 'üìÖ Masquer' : 'üìÖ Ouvrir'} le calendrier
                        </button>
                        
                        {/* Calendario Interattivo */}
                        {conflictCalendarMode === 'project2' && (
                          <div className="bg-white border-2 border-green-300 rounded-lg p-4 mb-3">
                            {/* Range Selection */}
                            <div className="mb-4 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-3">
                              <h4 className="text-sm font-bold text-green-900 mb-3">‚ö° S√©lection Rapide par P√©riode</h4>
                              
                              <div className="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date d√©but</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeStart}
                                    onChange={(e) => setConflictRangeStart(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date fin</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeEnd}
                                    onChange={(e) => setConflictRangeEnd(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                              </div>
                              
                              <div className="mb-3">
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="checkbox"
                                    checked={conflictRangeWorkdaysOnly}
                                    onChange={(e) => setConflictRangeWorkdaysOnly(e.target.checked)}
                                    className="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-xs font-semibold text-gray-700 group-hover:text-green-700">
                                    üìÜ Seulement jours ouvrables (Lun-Ven)
                                  </span>
                                </label>
                              </div>
                              
                              <div className="flex gap-2">
                                <button
                                  onClick={() => applyConflictRangeSelection('project2', 0.5)}
                                  className="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 0.5j
                                </button>
                                <button
                                  onClick={() => applyConflictRangeSelection('project2', 1.0)}
                                  className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 1.0j
                                </button>
                              </div>
                            </div>
                            
                            {/* Header: Mois/Anno navigation */}
                            <div className="flex items-center justify-between mb-3 bg-green-50 p-2 rounded">
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() - 1))}
                                className="text-green-900 hover:bg-green-200 px-3 py-1 rounded font-bold"
                              >
                                ‚óÄ
                              </button>
                              <span className="font-bold text-green-900 text-sm">
                                {conflictCalendarMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                              </span>
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() + 1))}
                                className="text-green-900 hover:bg-green-200 px-3 py-1 rounded font-bold"
                              >
                                ‚ñ∂
                              </button>
                            </div>
                            
                            {/* Giorni settimana header */}
                            <div className="grid grid-cols-7 gap-1 mb-2">
                              {['Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa', 'Di'].map(day => (
                                <div key={day} className="text-center text-xs font-bold text-gray-600 py-1">
                                  {day}
                                </div>
                              ))}
                            </div>
                            
                            {/* Giorni calendario */}
                            <div className="grid grid-cols-7 gap-1">
                              {generateConflictCalendarDays(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth()).map((day, index) => {
                                const allocation = getConflictDayAllocation(day, 'project2');
                                
                                // V√©rifier conflit avec autres projets (syst√®me intelligent)
                                const year = conflictCalendarMonth.getFullYear();
                                const month = conflictCalendarMonth.getMonth();
                                const dateKey = day ? `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : null;
                                const isAllocatedElsewhere = dateKey ? isDayAllocatedElsewhere(
                                  dateKey, 
                                  conflictToResolve?.project2?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : false;
                                const allocationDetails = isAllocatedElsewhere ? getAllocationDetails(
                                  dateKey, 
                                  conflictToResolve?.project2?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : null;
                                
                                return (
                                  <button
                                    key={index}
                                    onClick={() => handleConflictDayClick(day, 'project2')}
                                    disabled={!day}
                                    title={allocationDetails ? 
                                      `‚ö†Ô∏è D√©j√† allou√© dans:\n${allocationDetails.map(a => `${a.projectName} (${a.allocation}j)`).join('\n')}` 
                                      : ''
                                    }
                                    className={`
                                      aspect-square text-xs rounded flex flex-col items-center justify-center font-semibold relative
                                      ${!day ? 'invisible' : ''}
                                      ${allocation === 1.0 ? 'bg-green-600 text-white hover:bg-green-700' : ''}
                                      ${allocation === 0.5 ? 'bg-orange-400 text-white hover:bg-orange-500' : ''}
                                      ${!allocation ? 'bg-gray-100 hover:bg-green-100 text-gray-700' : ''}
                                      ${isAllocatedElsewhere ? 'border-2 border-red-500' : ''}
                                    `}
                                  >
                                    {isAllocatedElsewhere && (
                                      <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px] font-bold">
                                        ‚ö†
                                      </div>
                                    )}
                                    <span>{day}</span>
                                    {allocation && <span className="text-[8px]">{allocation}j</span>}
                                  </button>
                                );
                              })}
                            </div>
                            
                            {/* Legenda */}
                            <div className="mt-3 pt-3 border-t border-green-200 flex gap-3 text-xs">
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                                <span>Vide</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-orange-400 rounded"></div>
                                <span>0.5j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-green-600 rounded"></div>
                                <span>1.0j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px]">‚ö†</div>
                                <span>D√©j√† allou√©</span>
                              </div>
                            </div>
                            
                            <p className="mt-3 text-xs text-green-800 bg-green-50 p-2 rounded">
                              üí° <strong>Conseil:</strong> Click sur un jour pour cycler entre √©tats (Vide ‚Üí 0.5j ‚Üí 1.0j ‚Üí Vide)
                            </p>
                          </div>
                        )}
                        
                        <button 
                          onClick={() => {
                            const dates = calculateConflictProjectDates('project2');
                            if (dates.start && dates.end) {
                              resolveConflict(conflictToResolve, 'modify2', { startDate: dates.start, endDate: dates.end }, conflictSelectedDays.project2);
                              setConflictCalendarMode(null);
                            } else {
                              alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un jour');
                            }
                          }}
                          className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold text-sm"
                        >
                          Appliquer √† {conflictToResolve.project2.name}
                        </button>
                      </div>

                      <div className="bg-gray-100 border border-gray-300 rounded-lg p-4 text-center">
                        <p className="text-sm text-gray-600 mb-2">üí° Conseil: Cliquez sur les jours individuels ou utilisez la s√©lection rapide par p√©riode</p>
                        <button 
                          onClick={() => setShowConflictModal(false)}
                          className="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded font-semibold text-sm"
                        >
                          Annuler
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal Confirmation Conflits (Syst√®me Intelligent) */}
              {showConflictWarningModal && conflictWarningData && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
                    {/* Header fisso */}
                    <div className="flex items-center gap-3 p-6 border-b border-gray-200">
                      <div className="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                        ‚ö†
                      </div>
                      <div>
                        <h3 className="text-xl font-bold text-gray-900">Conflit d'allocation d√©tect√©</h3>
                        <p className="text-sm text-gray-600">Des jours sont d√©j√† allou√©s dans d'autres projets</p>
                      </div>
                    </div>
                    
                    {/* Contenuto scrollabile */}
                    <div className="flex-1 overflow-y-auto p-6">
                      <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
                        <h4 className="font-bold text-red-900 mb-3">Jours en conflit:</h4>
                        
                        {Object.entries(conflictWarningData.days).map(([date, info]) => (
                          <div key={date} className="mb-3 bg-white rounded p-3">
                            <p className="font-semibold text-gray-900 mb-1">
                              üìÖ {new Date(date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                            </p>
                            <div className="ml-4 space-y-1">
                              {info.map((alloc, idx) => (
                                <div key={idx} className="text-sm text-gray-700">
                                  <span className="font-semibold">{alloc.projectName}</span>
                                  <span className="text-gray-500"> - </span>
                                  <span className={`px-2 py-0.5 rounded ${
                                    alloc.allocation === 1.0 ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'
                                  }`}>
                                    {alloc.allocation}j allou√©
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                        <h4 className="font-bold text-yellow-900 mb-2">‚ö° Action propos√©e:</h4>
                        <p className="text-sm text-yellow-800 mb-2">
                          Si vous confirmez, les jours s√©lectionn√©s seront:
                        </p>
                        <ul className="text-sm text-yellow-800 space-y-1 ml-4">
                          <li>‚Ä¢ <strong>Retir√©s ou r√©duits</strong> des projets existants selon la r√®gle de split</li>
                          <li>‚Ä¢ <strong>Allou√©s</strong> au projet <span className="font-semibold">{conflictWarningData.currentProject}</span></li>
                        </ul>
                        <p className="text-xs text-yellow-700 mt-3 italic">
                          üí° R√®gle de split: Si vous allouez 0.5j sur un jour qui a d√©j√† 1.0j, 
                          l'ancien projet sera r√©duit √† 0.5j (partage √©quitable)
                        </p>
                      </div>
                    </div>
                    
                    {/* Footer fisso con bottoni */}
                    <div className="flex gap-3 p-6 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                      <button
                        onClick={() => {
                          setShowConflictWarningModal(false);
                          setConflictWarningData(null);
                          setPendingAllocationAction(null);
                        }}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-3 rounded-lg font-semibold"
                      >
                        ‚ùå Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (pendingAllocationAction) {
                            pendingAllocationAction();
                          }
                          setShowConflictWarningModal(false);
                          setConflictWarningData(null);
                          setPendingAllocationAction(null);
                        }}
                        className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold"
                      >
                        ‚úÖ Confirmer et appliquer
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal Allocation Mensuelle D√©taill√©e */}
              {showMonthlyAllocationModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowMonthlyAllocationModal(false)}>
                  <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="sticky top-0 bg-gradient-to-r from-indigo-600 to-blue-600 text-white p-6 rounded-t-lg z-10">
                      <h3 className="text-xl font-bold flex items-center gap-2">
                        üìÖ R√©partition Mensuelle D√©taill√©e
                      </h3>
                      <p className="text-sm mt-1 text-indigo-100">
                        {monthlyAllocationData.resourceName} - Total: {monthlyAllocationData.totalDays} jours
                      </p>
                    </div>
                    
                    <div className="p-6">
                      {!formData.startDate || !formData.endDate ? (
                        <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-center">
                          <p className="text-yellow-800 font-semibold">‚ö†Ô∏è D√©finissez d'abord les dates du projet</p>
                        </div>
                      ) : (
                        <>
                          {/* Sezione Selezione Rapida Range Date */}
                          <div className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-5 mb-6 shadow-md">
                            <h4 className="text-lg font-bold text-green-900 mb-4 flex items-center gap-2">
                              ‚ö° S√©lection Rapide par P√©riode
                            </h4>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  üìÖ Date d√©but
                                </label>
                                <input 
                                  type="date"
                                  value={rangeStartDate}
                                  onChange={(e) => setRangeStartDate(e.target.value)}
                                  min={formData.startDate}
                                  max={formData.endDate}
                                  className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  üìÖ Date fin
                                </label>
                                <input 
                                  type="date"
                                  value={rangeEndDate}
                                  onChange={(e) => setRangeEndDate(e.target.value)}
                                  min={formData.startDate}
                                  max={formData.endDate}
                                  className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all"
                                />
                              </div>
                            </div>
                            
                            <div className="mb-4">
                              <label className="flex items-center gap-2 cursor-pointer group">
                                <input 
                                  type="checkbox"
                                  checked={rangeWorkdaysOnly}
                                  onChange={(e) => setRangeWorkdaysOnly(e.target.checked)}
                                  className="w-5 h-5 text-green-600 rounded focus:ring-2 focus:ring-green-300"
                                />
                                <span className="text-sm font-semibold text-gray-700 group-hover:text-green-700">
                                  üìÜ Seulement jours ouvrables (Lun-Ven)
                                </span>
                              </label>
                            </div>
                            
                            <div className="mb-4">
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Allocation par d√©faut:
                              </label>
                              <div className="flex gap-4">
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="radio"
                                    name="rangeAllocationType"
                                    checked={rangeAllocationType === 0.5}
                                    onChange={() => setRangeAllocationType(0.5)}
                                    className="w-4 h-4 text-green-600 focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-sm font-semibold text-gray-700 group-hover:text-green-700">
                                    üîµ¬Ω Demi-journ√©e (0.5j)
                                  </span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="radio"
                                    name="rangeAllocationType"
                                    checked={rangeAllocationType === 1.0}
                                    onChange={() => setRangeAllocationType(1.0)}
                                    className="w-4 h-4 text-green-600 focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-sm font-semibold text-gray-700 group-hover:text-green-700">
                                    üîµ Journ√©e enti√®re (1j)
                                  </span>
                                </label>
                              </div>
                            </div>
                            
                            <button 
                              onClick={applyDateRange}
                              className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg"
                            >
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>
                              </svg>
                              üìÖ Appliquer le range sur le calendrier
                            </button>
                            
                            <div className="mt-3 text-xs text-green-800 bg-green-100 rounded px-3 py-2">
                              üí° <strong>Astuce:</strong> Apr√®s avoir appliqu√© le range, vous pouvez encore modifier individuellement chaque jour en cliquant dessus dans le calendrier ci-dessous.
                            </div>
                          </div>
                          
                          {/* Pannello Suggestions Smart - Feature #4 */}
                          <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-5 mb-6 shadow-md">
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-2xl">üí°</span>
                              <h4 className="text-lg font-bold text-purple-900">Suggestions d'Allocation Rapide</h4>
                            </div>
                            <p className="text-sm text-purple-700 mb-4">
                              Cliquez sur une suggestion pour s√©lectionner automatiquement les jours ouvrables
                            </p>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                              {(() => {
                                const totalDays = monthlyAllocationData.totalDays;
                                const suggestions = [];
                                
                                // Suggestion: 1 mois complet (22j)
                                if (totalDays >= 20 && totalDays <= 23) {
                                  suggestions.push({
                                    label: 'üìÜ 1 mois complet',
                                    days: 22,
                                    color: 'bg-[#e61252] hover:bg-[#e61252]'
                                  });
                                }
                                
                                // Suggestion: 3 semaines (15j)
                                if (totalDays >= 14 && totalDays <= 16) {
                                  suggestions.push({
                                    label: 'üìä 3 semaines',
                                    days: 15,
                                    color: 'bg-green-500 hover:bg-green-600'
                                  });
                                }
                                
                                // Suggestion: 2 semaines (10j)
                                if (totalDays >= 9 && totalDays <= 11) {
                                  suggestions.push({
                                    label: 'üìã 2 semaines',
                                    days: 10,
                                    color: 'bg-yellow-500 hover:bg-yellow-600'
                                  });
                                }
                                
                                // Suggestion: 1 semaine (5j)
                                if (totalDays >= 4 && totalDays <= 6) {
                                  suggestions.push({
                                    label: 'üìå 1 semaine',
                                    days: 5,
                                    color: 'bg-orange-500 hover:bg-orange-600'
                                  });
                                }
                                
                                // Toujours: 50% disponibilit√©
                                suggestions.push({
                                  label: '‚öñÔ∏è 50% disponibilit√©',
                                  days: Math.round(totalDays / 2),
                                  color: 'bg-pink-500 hover:bg-[#e61252]'
                                });
                                
                                // Toujours: Total disponible
                                suggestions.push({
                                  label: 'üíØ Total disponible',
                                  days: totalDays,
                                  color: 'bg-purple-500 hover:bg-purple-600'
                                });
                                
                                return suggestions.map((suggestion, idx) => (
                                  <button
                                    key={idx}
                                    onClick={() => {
                                      // Applique la suggestion: s√©lection N jours ouvrables
                                      const projectStart = new Date(formData.startDate);
                                      const projectEnd = new Date(formData.endDate);
                                      const newSelectedDates = {};
                                      let currentDate = new Date(projectStart);
                                      let workingDaysCount = 0;
                                      
                                      // Seleziona N giorni lavorativi (Lun-Ven) dall'inizio progetto
                                      while (workingDaysCount < suggestion.days && currentDate <= projectEnd) {
                                        const dayOfWeek = currentDate.getDay();
                                        const dateStr = currentDate.toISOString().split('T')[0];
                                        
                                        // Skip weekend (0=Domenica, 6=Sabato)
                                        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                          // ‚úÖ NUOVO: Verifica se il giorno √® disponibile
                                          const isAvailable = isResourceAvailable(
                                            monthlyAllocationData.resourceId,
                                            monthlyAllocationData.resourceType,
                                            dateStr,
                                            dateStr
                                          );
                                          
                                          // ‚úÖ NUOVO: Salta giorni indisponibili
                                          if (isAvailable) {
                                            newSelectedDates[dateStr] = 1.0; // Journ√©e enti√®re par d√©faut
                                            workingDaysCount++;
                                          }
                                        }
                                        currentDate.setDate(currentDate.getDate() + 1);
                                      }
                                      
                                      // Aggiorna stato
                                      setMonthlyAllocationData(prev => ({
                                        ...prev,
                                        selectedDates: newSelectedDates
                                      }));
                                    }}
                                    className={`${suggestion.color} text-white px-3 py-3 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg flex flex-col items-center justify-center gap-1`}
                                  >
                                    <span className="text-center">{suggestion.label}</span>
                                    <span className="text-xs opacity-90">{suggestion.days}j</span>
                                  </button>
                                ));
                              })()}
                            </div>
                            <div className="mt-3 text-xs text-purple-800 bg-purple-100 rounded px-3 py-2">
                              üí° <strong>Astuce:</strong> Les suggestions s√©lectionnent automatiquement les jours ouvrables (Lun-Ven) depuis le d√©but du projet. Vous pouvez ensuite ajuster manuellement.
                            </div>
                          </div>
                          
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p className="text-sm text-blue-800 mb-2">
                              <span className="font-bold">R√®gle:</span> S√©lectionnez exactement <span className="font-bold text-blue-900">{monthlyAllocationData.totalDays} jours</span> en cliquant sur les cases du calendrier
                            </p>
                            <div className="flex items-center gap-4 text-xs text-blue-700 mt-2 flex-wrap">
                              <div className="flex items-center gap-1">
                                <div className="w-6 h-6 bg-gray-50 border-2 border-gray-200 rounded flex items-center justify-center text-xs">1</div>
                                <span>Non s√©lectionn√©</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-6 h-6 bg-blue-300 border-2 border-blue-700 rounded flex items-center justify-center text-xs font-bold">¬Ω</div>
                                <span>Demi-journ√©e (0.5j)</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-6 h-6 bg-[#e61252] text-white border-2 border-blue-700 rounded flex items-center justify-center text-xs">1</div>
                                <span>Journ√©e enti√®re (1j)</span>
                              </div>
                              <div className="text-blue-900 font-semibold">üëÜ Cliquez plusieurs fois pour changer</div>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            {getProjectMonths().map(month => {
                              const daysInMonth = getDaysInMonth(month.month, month.year);
                              const firstDay = getFirstDayOfMonth(month.month, month.year);
                              const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
                              const daysSelected = getDatesInMonth(month.year, month.month);
                              
                              return (
                                <div key={month.key} className="bg-white border-2 border-gray-200 rounded-lg p-3">
                                  <h4 className="font-bold text-gray-800 text-center mb-2 capitalize">{month.label}</h4>
                                  <p className="text-xs text-center text-gray-600 mb-2">{daysSelected} jour{daysSelected !== 1 ? 's' : ''} s√©lectionn√©{daysSelected !== 1 ? 's' : ''}</p>
                                  
                                  {/* Jours de la semaine */}
                                  <div className="grid grid-cols-7 gap-1 mb-1">
                                    {['L', 'M', 'M', 'J', 'V', 'S', 'D'].map((day, idx) => (
                                      <div key={idx} className={`text-xs font-bold text-center py-1 ${idx >= 5 ? 'text-red-600' : 'text-gray-700'}`}>
                                        {day}
                                      </div>
                                    ))}
                                  </div>
                                  
                                  {/* Grille des jours */}
                                  <div className="grid grid-cols-7 gap-1">
                                    {/* Jours vides avant le d√©but du mois */}
                                    {[...Array(adjustedFirstDay)].map((_, idx) => (
                                      <div key={`empty-${idx}`} className="aspect-square"></div>
                                    ))}
                                    
                                    {/* Jours du mois */}
                                    {[...Array(daysInMonth)].map((_, dayIndex) => {
                                      const day = dayIndex + 1;
                                      const dateKey = formatDateKey(month.year, month.month, day);
                                      const dayValue = monthlyAllocationData.selectedDates[dateKey] || 0;
                                      const dayOfWeek = new Date(month.year, month.month, day).getDay();
                                      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                      
                                      // ‚úÖ NUOVO: V√©rifier si le jour est indisponible pour cette ressource
                                      const isUnavailable = !isResourceAvailable(
                                        monthlyAllocationData.resourceId,
                                        monthlyAllocationData.resourceType,
                                        dateKey,
                                        dateKey
                                      );
                                      
                                      // V√©rifier si le jour est d√©j√† allou√© ailleurs pour cette ressource sp√©cifique (syst√®me intelligent)
                                      const isAllocatedElsewhere = isDayAllocatedElsewhere(
                                        dateKey, 
                                        editingProject?.id, 
                                        monthlyAllocationData.resourceName, 
                                        monthlyAllocationData.resourceType
                                      );
                                      const allocationDetails = isAllocatedElsewhere ? getAllocationDetails(
                                        dateKey, 
                                        editingProject?.id,
                                        monthlyAllocationData.resourceName,
                                        monthlyAllocationData.resourceType
                                      ) : null;
                                      
                                      return (
                                        <button
                                          key={day}
                                          type="button"
                                          onClick={() => !isUnavailable && toggleDateSelection(dateKey)}
                                          disabled={isUnavailable}
                                          title={
                                            isUnavailable 
                                              ? 'üö´ Indisponible - Allez dans "√âquipe" pour supprimer l\'indisponibilit√©'
                                              : allocationDetails 
                                              ? `‚ö†Ô∏è D√©j√† allou√© dans:\n${allocationDetails.map(a => `${a.projectName} (${a.allocation}j)`).join('\n')}` 
                                              : ''
                                          }
                                          className={`aspect-square rounded text-sm font-semibold transition-all relative ${
                                            isUnavailable
                                              ? 'bg-gray-300 text-gray-500 cursor-not-allowed opacity-50 line-through'
                                              : dayValue === 1.0
                                              ? 'bg-[#e61252] text-white hover:bg-[#c10f47] shadow-md scale-105' 
                                              : dayValue === 0.5
                                              ? 'bg-blue-300 text-blue-900 hover:bg-blue-400 shadow-sm'
                                              : isWeekend
                                              ? 'bg-gray-100 text-gray-500 hover:bg-blue-100 hover:text-blue-700'
                                              : 'bg-gray-50 text-gray-700 hover:bg-blue-100 hover:text-blue-700'
                                          } border-2 ${
                                            isUnavailable
                                              ? 'border-gray-400'
                                              : isAllocatedElsewhere
                                              ? 'border-red-500 border-solid' 
                                              : dayValue > 0 ? 'border-blue-700' : 'border-gray-200 hover:border-blue-300'
                                          }`}
                                        >
                                          {isUnavailable && (
                                            <div className="absolute -top-1 -right-1 w-4 h-4 bg-gray-600 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                              üö´
                                            </div>
                                          )}
                                          {isAllocatedElsewhere && !isUnavailable && (
                                            <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                              ‚ö†
                                            </div>
                                          )}
                                          {day}
                                          {dayValue === 0.5 && !isUnavailable && (
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                              <div className="text-xs font-bold bg-white bg-opacity-70 px-1 rounded">¬Ω</div>
                                            </div>
                                          )}
                                        </button>
                                      );
                                    })}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                          
                          <div className={`p-4 rounded-lg mb-4 ${getSelectedDatesCount() === monthlyAllocationData.totalDays ? 'bg-green-50 border-2 border-green-300' : 'bg-red-50 border-2 border-red-300'}`}>
                            <div className="flex justify-between items-center">
                              <span className="font-bold text-gray-800">Jours s√©lectionn√©s:</span>
                              <span className={`text-2xl font-bold ${getSelectedDatesCount() === monthlyAllocationData.totalDays ? 'text-green-700' : 'text-red-700'}`}>
                                {getSelectedDatesCount()} / {monthlyAllocationData.totalDays} jours
                              </span>
                            </div>
                            {getSelectedDatesCount() === monthlyAllocationData.totalDays ? (
                              <p className="text-sm text-green-700 font-semibold mt-2">‚úì R√©partition valide</p>
                            ) : (
                              <p className="text-sm text-red-700 font-semibold mt-2">
                                ‚úó {getSelectedDatesCount() > monthlyAllocationData.totalDays ? 'Trop de jours' : 'Pas assez de jours'} 
                                ({Math.abs(getSelectedDatesCount() - monthlyAllocationData.totalDays)} jour{Math.abs(getSelectedDatesCount() - monthlyAllocationData.totalDays) !== 1 ? 's' : ''} {getSelectedDatesCount() > monthlyAllocationData.totalDays ? 'en trop' : 'manquant' + (Math.abs(getSelectedDatesCount() - monthlyAllocationData.totalDays) !== 1 ? 's' : '')})
                              </p>
                            )}
                          </div>
                          
                          <div className="flex gap-3">
                            <button 
                              onClick={saveMonthlyAllocation}
                              disabled={getSelectedDatesCount() !== monthlyAllocationData.totalDays}
                              className={`flex-1 px-6 py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 ${
                                getSelectedDatesCount() === monthlyAllocationData.totalDays 
                                  ? 'bg-green-600 hover:bg-green-700' 
                                  : 'bg-gray-400 cursor-not-allowed'
                              }`}
                            >
                              <Check size={20} /> Valider la r√©partition
                            </button>
                            <button 
                              onClick={() => setShowMonthlyAllocationModal(false)}
                              className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2"
                            >
                              <X size={20} /> Annuler
                            </button>
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* Sync Status Indicator */}
              {isOneDriveConnected && (
                <div className="fixed bottom-6 right-6 z-50">
                  {syncStatus === 'saving' && (
                    <div className="bg-[#e61252] text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-pulse">
                      <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                      </svg>
                      <span className="font-semibold">Synchronisation...</span>
                    </div>
                  )}
                  {syncStatus === 'saved' && (
                    <div className="bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>
                      </svg>
                      <span className="font-semibold">Synchronis√© {lastSyncTime}</span>
                    </div>
                  )}
                  {syncStatus === 'error' && (
                    <div className="bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                      <span className="font-semibold">Erreur de synchronisation</span>
                    </div>
                  )}
                </div>
              )}
              
              {/* Banner OneDrive non connect√© */}
              {isOneDriveReady && !isOneDriveConnected && (
                <div className="fixed bottom-6 left-6 right-6 md:left-auto md:right-6 md:max-w-md z-40">
                  <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-4 shadow-xl">
                    <div className="flex items-start gap-3">
                      <svg className="w-8 h-8 text-blue-600 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                      </svg>
                      <div className="flex-1">
                        <div className="font-bold text-blue-900 mb-1">üí° Synchronisation Cloud</div>
                        <div className="text-sm text-blue-800 mb-3">
                          Connectez OneDrive pour synchroniser automatiquement vos donn√©es entre tous vos appareils
                        </div>
                        <div className="flex gap-2">
                          <button 
                            onClick={signInOneDrive}
                            className="bg-[#e61252] hover:bg-[#c10f47] text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all"
                          >
                            <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            Connecter maintenant
                          </button>
                          <button 
                            onClick={() => setIsOneDriveReady(false)}
                            className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                          >
                            Plus tard
                          </button>
                        </div>
                      </div>
                      <button 
                        onClick={() => setIsOneDriveReady(false)}
                        className="text-gray-400 hover:text-gray-600"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* ========================================== */}
              {/* MODAL CONFIGURAZIONE RISORSA */}
              {/* ========================================== */}
              {showResourceConfigModal && selectedResourceForConfig && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowResourceConfigModal(false)}>
                  <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <Settings size={24} className="text-blue-600" />
                        Configuration: {selectedResourceForConfig.name}
                      </h2>
                      <button onClick={() => setShowResourceConfigModal(false)} className="text-gray-400 hover:text-gray-600">
                        <X size={20} />
                      </button>
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Heures maximales par mois
                        </label>
                        <input
                          type="number"
                          value={selectedResourceForConfig.maxMonthlyHours}
                          onChange={(e) => setSelectedResourceForConfig({
                            ...selectedResourceForConfig,
                            maxMonthlyHours: parseInt(e.target.value) || 160
                          })}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="160"
                          min="1"
                        />
                        <p className="text-xs text-gray-500 mt-1">Capacit√© mensuelle maximale (d√©faut: 160h)</p>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Heures par jour
                        </label>
                        <input
                          type="number"
                          value={selectedResourceForConfig.defaultDailyHours}
                          onChange={(e) => setSelectedResourceForConfig({
                            ...selectedResourceForConfig,
                            defaultDailyHours: parseInt(e.target.value) || 8
                          })}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="8"
                          min="1"
                          max="24"
                        />
                        <p className="text-xs text-gray-500 mt-1">Heures de travail par jour (d√©faut: 8h)</p>
                      </div>
                      
                      <div className="bg-blue-50 p-3 rounded">
                        <p className="text-sm text-blue-800">
                          <strong>Allocation maximale:</strong> {selectedResourceForConfig.maxMonthlyHours}h / mois<br />
                          <strong>Jours √©quivalents:</strong> {Math.round(selectedResourceForConfig.maxMonthlyHours / selectedResourceForConfig.defaultDailyHours)} jours/mois
                        </p>
                      </div>
                    </div>
                    
                    <div className="flex gap-2 mt-6">
                      <button
                        onClick={() => {
                          updateResourceConfig(
                            selectedResourceForConfig.id,
                            selectedResourceForConfig.type,
                            selectedResourceForConfig.maxMonthlyHours,
                            selectedResourceForConfig.defaultDailyHours
                          );
                          setShowResourceConfigModal(false);
                          setSelectedResourceForConfig(null);
                        }}
                        className="flex-1 bg-[#e61252] hover:bg-[#c10f47] text-white px-4 py-2 rounded-lg font-semibold"
                      >
                        <Check size={16} className="inline mr-2" />
                        Enregistrer
                      </button>
                      <button
                        onClick={() => {
                          setShowResourceConfigModal(false);
                          setSelectedResourceForConfig(null);
                        }}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold"
                      >
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* ========================================== */}
              {/* MODAL INDISPONIBILIT√â */}
              {/* ========================================== */}
              {showUnavailabilityModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowUnavailabilityModal(false)}>
                  <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <Calendar size={24} className="text-orange-600" />
                        Ajouter indisponibilit√©
                      </h2>
                      <button onClick={() => setShowUnavailabilityModal(false)} className="text-gray-400 hover:text-gray-600">
                        <X size={20} />
                      </button>
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Type
                        </label>
                        <select
                          value={unavailabilityForm.type}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, type: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                        >
                          <option value="vacation">üèñÔ∏è Cong√© / Vacances</option>
                          <option value="sick">ü§í Maladie</option>
                          <option value="training">üìö Formation</option>
                          <option value="other">‚ö†Ô∏è Autre</option>
                        </select>
                      </div>
                      
                      {/* Ricorrenza */}
                      <div className="bg-blue-50 p-3 rounded-lg">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={unavailabilityForm.recurring}
                            onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, recurring: e.target.checked })}
                            className="w-4 h-4"
                          />
                          <span className="text-sm font-semibold text-blue-800">üîÑ R√©current</span>
                        </label>
                      </div>
                      
                      {unavailabilityForm.recurring && (
                        <div className="bg-blue-50 p-3 rounded-lg space-y-3">
                          <div>
                            <label className="block text-xs font-semibold text-blue-800 mb-2">Pattern</label>
                            <select
                              value={unavailabilityForm.recurrencePattern}
                              onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, recurrencePattern: e.target.value })}
                              className="w-full border rounded px-2 py-1 text-sm"
                            >
                              <option value="weekly">üìÖ Hebdomadaire</option>
                              <option value="monthly">üìÜ Mensuel</option>
                              <option value="yearly">üîÑ Annuel</option>
                            </select>
                          </div>
                          
                          {unavailabilityForm.recurrencePattern === 'weekly' && (
                            <div>
                              <label className="block text-xs font-semibold text-blue-800 mb-2">Jour de la semaine</label>
                              <select
                                value={unavailabilityForm.weekday}
                                onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, weekday: parseInt(e.target.value) })}
                                className="w-full border rounded px-2 py-1 text-sm"
                              >
                                <option value="1">Lundi</option>
                                <option value="2">Mardi</option>
                                <option value="3">Mercredi</option>
                                <option value="4">Jeudi</option>
                                <option value="5">Vendredi</option>
                                <option value="6">Samedi</option>
                                <option value="0">Dimanche</option>
                              </select>
                            </div>
                          )}
                          
                          {unavailabilityForm.recurrencePattern === 'monthly' && (
                            <div>
                              <label className="block text-xs font-semibold text-blue-800 mb-2">Jour du mois</label>
                              <input
                                type="number"
                                min="1"
                                max="31"
                                value={unavailabilityForm.dayOfMonth}
                                onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, dayOfMonth: parseInt(e.target.value) || 1 })}
                                className="w-full border rounded px-2 py-1 text-sm"
                              />
                            </div>
                          )}
                          
                          <p className="text-xs text-blue-700">
                            {unavailabilityForm.recurrencePattern === 'weekly' && 'üìä G√©n√®re un jour par semaine'}
                            {unavailabilityForm.recurrencePattern === 'monthly' && 'üìä G√©n√®re un jour par mois'}
                            {unavailabilityForm.recurrencePattern === 'yearly' && 'üìä R√©p√®te chaque ann√©e la m√™me p√©riode'}
                          </p>
                        </div>
                      )}
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          {unavailabilityForm.recurring ? 'P√©riode d\'application - D√©but' : 'Date d√©but'}
                        </label>
                        <input
                          type="date"
                          value={unavailabilityForm.startDate}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, startDate: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          {unavailabilityForm.recurring ? 'P√©riode d\'application - Fin' : 'Date fin'}
                        </label>
                        <input
                          type="date"
                          value={unavailabilityForm.endDate}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, endDate: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Raison (optionnelle)
                        </label>
                        <input
                          type="text"
                          value={unavailabilityForm.reason}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, reason: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="Ex: Part-time mercredi, Formation mensuelle..."
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-2 mt-6">
                      <button
                        onClick={addUnavailability}
                        className="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-semibold"
                        disabled={!unavailabilityForm.startDate || !unavailabilityForm.endDate}
                      >
                        <Check size={16} className="inline mr-2" />
                        {unavailabilityForm.recurring ? 'G√©n√©rer' : 'Ajouter'}
                      </button>
                      <button
                        onClick={() => {
                          setShowUnavailabilityModal(false);
                          setUnavailabilityForm({
                            resourceId: null, resourceType: '',
                            startDate: '', endDate: '', type: 'vacation', reason: '',
                            recurring: false, recurrencePattern: 'weekly', weekday: 1, dayOfMonth: 1
                          });
                        }}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold"
                      >
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* ========================================== */}
              {/* MODAL GESTIONE FESTIVIT√Ä */}
              {/* ========================================== */}
              {showHolidayModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowHolidayModal(false)}>
                  <div className="bg-white rounded-lg shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        üéÑ Gestion des jours f√©ri√©s
                      </h2>
                      <button onClick={() => setShowHolidayModal(false)} className="text-gray-400 hover:text-gray-600">
                        <X size={20} />
                      </button>
                    </div>
                    
                    {/* Form Ajouter Festivit√† */}
                    <div className="bg-gray-50 p-4 rounded-lg mb-4">
                      <h3 className="font-semibold text-gray-700 mb-3">Ajouter un jour f√©ri√©</h3>
                      <div className="flex gap-3">
                        <input
                          type="date"
                          value={holidayForm.date}
                          onChange={(e) => setHolidayForm({ ...holidayForm, date: e.target.value })}
                          className="flex-1 border rounded-lg px-3 py-2"
                        />
                        <input
                          type="text"
                          value={holidayForm.name}
                          onChange={(e) => setHolidayForm({ ...holidayForm, name: e.target.value })}
                          placeholder="Nom du jour f√©ri√©"
                          className="flex-1 border rounded-lg px-3 py-2"
                        />
                        <button
                          onClick={addHoliday}
                          disabled={!holidayForm.date || !holidayForm.name}
                          className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white rounded-lg font-semibold"
                        >
                          <Plus />
                        </button>
                      </div>
                    </div>
                    
                    {/* Liste Festivit√† */}
                    <div>
                      <h3 className="font-semibold text-gray-700 mb-3">
                        Jours f√©ri√©s configur√©s ({holidays.length})
                      </h3>
                      {holidays.length === 0 ? (
                        <p className="text-center text-gray-500 py-8">
                          Aucun jour f√©ri√© configur√©
                        </p>
                      ) : (
                        <div className="space-y-2">
                          {holidays
                            .sort((a, b) => new Date(a.date) - new Date(b.date))
                            .map(holiday => (
                              <div 
                                key={holiday.id} 
                                className="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg hover:border-red-300"
                              >
                                <div>
                                  <div className="font-semibold text-gray-800">{holiday.name}</div>
                                  <div className="text-sm text-gray-600">
                                    {new Date(holiday.date).toLocaleDateString('fr-FR', { 
                                      weekday: 'long', 
                                      day: 'numeric', 
                                      month: 'long', 
                                      year: 'numeric' 
                                    })}
                                  </div>
                                </div>
                                <button
                                  onClick={() => removeHoliday(holiday.id)}
                                  className="text-red-600 hover:text-red-800 p-2"
                                >
                                  <Trash2 size={16} />
                                </button>
                              </div>
                            ))}
                        </div>
                      )}
                    </div>
                    
                    {/* Jours f√©ri√©s fran√ßais - Syst√®me automatique */}
                    <div className="mt-6 bg-blue-50 p-4 rounded-lg">
                      <h3 className="font-semibold text-blue-800 mb-3">üéÑ Jours f√©ri√©s fran√ßais (automatique)</h3>
                      <p className="text-sm text-blue-700 mb-3">Cliquez pour ajouter automatiquement tous les jours f√©ri√©s d'une ann√©e:</p>
                      <div className="flex flex-wrap gap-2">
                        {[2025, 2026, 2027, 2028].map(year => {
                          const yearHolidays = generateFrenchHolidays(year);
                          const alreadyAdded = yearHolidays.filter(h => holidays.some(hol => hol.date === h.date)).length;
                          const total = yearHolidays.length;
                          
                          return (
                            <button
                              key={year}
                              onClick={() => addAllHolidaysForYear(year)}
                              className={`px-4 py-2 rounded-lg font-semibold transition-all ${
                                alreadyAdded === total 
                                  ? 'bg-green-100 text-green-800 cursor-default' 
                                  : 'bg-[#e61252] hover:bg-[#c10f47] text-white'
                              }`}
                              disabled={alreadyAdded === total}
                            >
                              {alreadyAdded === total ? '‚úÖ' : '‚ûï'} {year} ({alreadyAdded}/{total})
                            </button>
                          );
                        })}
                      </div>
                      <div className="mt-3 text-xs text-blue-600 bg-blue-100 p-2 rounded">
                        üí° <strong>Inclus:</strong> Jour de l'An, P√¢ques+1, 1er mai, 8 mai, Ascension, Pentec√¥te+1, 14 juillet, Assomption, Toussaint, Armistice, No√´l
                        <br />
                        üîÑ <strong>Dates mobiles calcul√©es automatiquement</strong> (P√¢ques, Ascension, Pentec√¥te)
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal Modifica Giorno CRA */}
              {craEditingDate && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div className="p-6">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="text-xl font-bold text-gray-800">
                          ‚úèÔ∏è Modifier le {new Date(craEditingDate.dateObj).toLocaleDateString('fr-FR', { 
                            weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' 
                          })}
                        </h3>
                        <button
                          onClick={() => setCraEditingDate(null)}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          ‚úï
                        </button>
                      </div>
                      
                      {/* Informazioni giorno */}
                      <div className="space-y-3 mb-6">
                        {/* Budget info con disponibilit√† */}
                        {craEditingDate.budgetTotal > 0 && (
                          <div className="bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
                            <div className="text-xs text-gray-600 mb-2 font-semibold">üíº Jours command√©s</div>
                            <div className="grid grid-cols-2 gap-3 mb-2">
                              <div>
                                <div className="text-xs text-gray-500">Total command√©</div>
                                <div className="text-lg font-bold text-purple-700">{craEditingDate.budgetTotal.toFixed(1)}j</div>
                              </div>
                              <div>
                                <div className="text-xs text-gray-500">Autres dates</div>
                                <div className="text-lg font-bold text-gray-700">{craEditingDate.otherDatesPlanned.toFixed(1)}j</div>
                              </div>
                            </div>
                            <div className="pt-2 border-t border-purple-200">
                              <div className="text-xs text-gray-500 mb-1">Disponible pour cette date</div>
                              <div className="text-2xl font-bold text-green-700">
                                ‚úì {craEditingDate.budgetDisponible.toFixed(2)}j
                              </div>
                            </div>
                          </div>
                        )}
                        
                        {craEditingDate.hasOtherProjects && (
                          <div className={`border p-3 rounded-lg ${
                            craEditingDate.isFullyBlocked ? 'bg-red-50 border-red-200' : 'bg-amber-50 border-amber-200'
                          }`}>
                            <div className={`text-sm font-semibold mb-2 flex items-center gap-2 ${
                              craEditingDate.isFullyBlocked ? 'text-red-800' : 'text-amber-800'
                            }`}>
                              <span>{craEditingDate.isFullyBlocked ? 'üî¥' : '‚ö†Ô∏è'}</span>
                              <span>{craEditingDate.isFullyBlocked ? 'Jour compl√®tement bloqu√©' : 'Capacit√© partielle disponible'}</span>
                            </div>
                            <div className="text-xs space-y-1">
                              {craEditingDate.otherProjects && craEditingDate.otherProjects.map((proj, idx) => (
                                <div key={idx} className="text-gray-700">
                                  ‚Ä¢ {proj.name}: <strong>{proj.allocation}j</strong>
                                </div>
                              ))}
                              <div className={`mt-2 pt-2 border-t font-semibold ${
                                craEditingDate.isFullyBlocked ? 'border-red-200 text-red-800' : 'border-amber-200 text-amber-800'
                              }`}>
                                üí° Disponible: <strong>{craEditingDate.availableCapacity}j</strong> sur 1j
                              </div>
                            </div>
                          </div>
                        )}
                        
                        {craEditingDate.isUnavailable && (
                          <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                            <div className="text-sm text-yellow-800 flex items-center gap-2">
                              <span>üö´</span>
                              <span>Vous √™tes indisponible ce jour-l√†</span>
                            </div>
                          </div>
                        )}
                        
                        {craEditingDate.isFestivity && (
                          <div className="bg-gray-50 border border-gray-300 p-3 rounded-lg">
                            <div className="text-sm text-gray-700 flex items-center gap-2">
                              <span>üéâ</span>
                              <span>Jour f√©ri√©</span>
                            </div>
                          </div>
                        )}
                      </div>
                      
                      {/* Saisie Planned (modifiable par ing√©nieur) */}
                      <div className="mb-4">
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          üìò Planification (vous pouvez la modifier)
                        </label>
                        <select
                          value={craEditingDate.planned}
                          onChange={(e) => {
                            const newValue = parseFloat(e.target.value);
                            setCraEditingDate({...craEditingDate, planned: newValue, actual: newValue});
                          }}
                          className="w-full border border-blue-300 rounded-lg px-4 py-3 text-lg font-semibold bg-blue-50"
                        >
                          <option value="0">0j</option>
                          <option value="0.125">1h</option>
                          <option value="0.25">2h</option>
                          <option value="0.375">3h</option>
                          <option value="0.5">0.5j</option>
                          <option value="0.625">5h</option>
                          <option value="0.75">6h</option>
                          <option value="0.875">7h</option>
                          <option value="1">1j</option>
                        </select>
                        <p className="text-xs text-gray-500 mt-1">
                          üí° La modification se copie automatiquement dans "Heures travaill√©es"
                        </p>
                      </div>
                      
                      {/* Saisie Actual */}
                      <div className="mb-6">
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          üìä Heures r√©ellement travaill√©es (copi√© automatiquement)
                        </label>
                        <select
                          value={craEditingDate.actual}
                          onChange={(e) => setCraEditingDate({...craEditingDate, actual: parseFloat(e.target.value)})}
                          className="w-full border border-green-300 rounded-lg px-4 py-3 text-lg font-semibold bg-green-50"
                        >
                          <option value="0">0j</option>
                          <option value="0.125">1h</option>
                          <option value="0.25">2h</option>
                          <option value="0.375">3h</option>
                          <option value="0.5">0.5j</option>
                          <option value="0.625">5h</option>
                          <option value="0.75">6h</option>
                          <option value="0.875">7h</option>
                          <option value="1">1j</option>
                        </select>
                        <p className="text-xs text-gray-500 mt-1">
                          üí° Modifiez manuellement si le temps r√©el est diff√©rent du planifi√©
                        </p>
                      </div>
                      
                      {/* Preview */}
                      {craEditingDate.planned !== craEditingDate.actual && (
                        <div className={`mb-6 p-3 rounded-lg ${
                          craEditingDate.actual === 0 ? 'bg-red-50 border border-red-200' :
                          craEditingDate.actual > craEditingDate.planned ? 'bg-orange-50 border border-orange-200' :
                          'bg-orange-50 border border-orange-200'
                        }`}>
                          <div className="text-sm font-semibold mb-1">
                            {craEditingDate.actual === 0 ? '‚ùå Non travaill√©' : 
                             craEditingDate.actual > craEditingDate.planned ? '‚ö†Ô∏è Plus que pr√©vu' :
                             '‚ö†Ô∏è Moins que pr√©vu'}
                          </div>
                          <div className="text-xs text-gray-700">
                            √âcart: {(craEditingDate.actual - craEditingDate.planned > 0 ? '+' : '')}
                            {(craEditingDate.actual - craEditingDate.planned).toFixed(2)}j
                          </div>
                        </div>
                      )}
                      
                      {/* Actions */}
                      <div className="flex gap-3">
                        <button
                          onClick={() => setCraEditingDate(null)}
                          className="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                        >
                          Annuler
                        </button>
                        <button
                          onClick={saveCRAEdit}
                          className="flex-1 px-4 py-2 bg-[#e61252] text-white rounded-lg hover:bg-[#c10f47] font-semibold"
                        >
                          Valider
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal Export PDF CRA avec Commentaires */}
              {showCRAPDFModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                  <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
                    <div className="sticky top-0 bg-white border-b p-6 z-10">
                      <div className="flex justify-between items-center">
                        <h3 className="text-2xl font-bold text-gray-800">
                          {craExportType === 'excel' ? 'üìä' : 'üìÑ'} Export {craExportType === 'excel' ? 'Excel' : 'PDF'} CRA - {craPDFData[0]?.projectName}
                        </h3>
                        <button
                          onClick={() => setShowCRAPDFModal(false)}
                          className="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                        >
                          ‚úï
                        </button>
                      </div>
                      <p className="text-sm text-gray-600 mt-2">
                        Ajoutez un commentaire pour chaque ligne avant de g√©n√©rer le {craExportType === 'excel' ? 'fichier Excel' : 'PDF'}
                      </p>
                    </div>
                    
                    <div className="p-6">
                      {/* Tableau des activit√©s */}
                      <div className="space-y-3">
                        {craPDFData.map((line, idx) => {
                          const key = `${line.date}-${line.projectId}`;
                          return (
                            <div key={idx} className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                  <label className="block text-xs font-semibold text-gray-600 mb-1">Date</label>
                                  <div className="text-sm font-bold text-gray-800">{line.dateFormatted}</div>
                                </div>
                                <div>
                                  <label className="block text-xs font-semibold text-gray-600 mb-1">Temps pass√©</label>
                                  <div className="text-sm font-bold text-gray-800">{formatDays(line.hours)}</div>
                                </div>
                              </div>
                              <div>
                                <label className="block text-xs font-semibold text-gray-600 mb-1">Commentaire</label>
                                <textarea
                                  value={craPDFComments[key] || ''}
                                  onChange={(e) => setCraPDFComments({...craPDFComments, [key]: e.target.value})}
                                  placeholder="Ajouter un commentaire (optionnel)..."
                                  className="w-full border rounded-lg px-3 py-2 text-sm resize-none"
                                  rows="2"
                                />
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      
                      {/* Actions */}
                      <div className="flex gap-3 mt-6 pt-6 border-t">
                        <button
                          onClick={() => setShowCRAPDFModal(false)}
                          className="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-semibold"
                        >
                          Annuler
                        </button>
                        <button
                          onClick={craExportType === 'excel' ? generateCRAExcel : generateCRAPDF}
                          className={`flex-1 px-6 py-3 ${craExportType === 'excel' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white rounded-lg font-semibold flex items-center justify-center gap-2`}
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                          </svg>
                          {craExportType === 'excel' ? 'üìä G√©n√©rer Excel' : 'üìÑ G√©n√©rer PDF'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal Warning Inattivit√† */}
              {showInactivityWarning && (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center animate-pulse">
                    <div className="text-6xl mb-4">‚è∞</div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-3">
                      Session bient√¥t expir√©e
                    </h2>
                    <p className="text-gray-600 mb-2">
                      Votre session expirera dans
                    </p>
                    <p className="text-5xl font-bold text-red-600 mb-6">
                      {inactivityTimeLeft} min
                    </p>
                    <p className="text-sm text-gray-500 mb-6">
                      Vous serez d√©connect√© automatiquement par mesure de s√©curit√©
                    </p>
                    <button
                      onClick={() => {
                        setShowInactivityWarning(false);
                        // Il reset dei timer avviene automaticamente tramite l'evento click
                      }}
                      className="w-full bg-[#e61252] hover:bg-[#c10f47] text-white font-bold py-4 px-6 rounded-lg transition-all text-lg"
                    >
                      ‚úì Rester connect√©
                    </button>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProjectManager />);
    </script>
</body>
</html>
