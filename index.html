<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des √âquipes Ing√©</title>
    
    <!-- üì± PWA Meta Tags -->
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ingetool">
    <meta name="description" content="Gestion des √©quipes et ressources - Askida Broadcast">
    
    <!-- üì± PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <!-- üì± Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            // Create minimal service worker inline
            const swCode = `
              self.addEventListener('install', (event) => {
                console.log('Service Worker install√©');
                self.skipWaiting();
              });
              
              self.addEventListener('activate', (event) => {
                console.log('Service Worker activ√©');
                event.waitUntil(self.clients.claim());
              });
              
              self.addEventListener('fetch', (event) => {
                // Pass-through: no caching for now
                event.respondWith(fetch(event.request));
              });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            const registration = await navigator.serviceWorker.register(swUrl);
            console.log('‚úÖ PWA Service Worker enregistr√©:', registration.scope);
            
            // V√©rifier si installable
            window.addEventListener('beforeinstallprompt', (e) => {
              console.log('‚úÖ PWA installable d√©tect√©!');
              // Sauvegarder l'event pour plus tard si n√©cessaire
              window.deferredPrompt = e;
            });
            
          } catch (error) {
            console.error('‚ùå Erreur Service Worker:', error);
          }
        });
      }
    </script>
    
    <!-- 
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    VERSION ONEDRIVE - Synchronisation Cloud Microsoft
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    üìã CONFIGURATION REQUISE (voir ligne ~415):
       - ONEDRIVE_CLIENT_ID (Azure AD Application ID)
       - ONEDRIVE_TENANT_ID (Azure AD Directory ID)
    
    üìö Documentation compl√®te: GUIDE-ONEDRIVE-FR.md
    ‚ö° Quick Start: QUICKSTART-ONEDRIVE-FR.md
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -->
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- OneDrive/Microsoft Graph API - Utilise OAuth 2.0 Implicit Flow -->
</head>
<body>
    <!-- üîê SISTEMA LOGIN MULTI-UTENTE -->
    <script>
        (function() {
            // ========================================
            // CONFIGURAZIONE UTENTI
            // ========================================
            const USERS = {
                'admin': {
                    password: 'Askida2025',
                    role: 'admin',
                    displayName: 'Administrateur'
                },
                'read': {
                    password: 'Read2025',
                    role: 'reader',
                    displayName: 'Lecteur'
                }
            };
            
            // Chiavi per salvare lo stato di autenticazione
            const AUTH_KEY = 'askida_authenticated';
            const USER_KEY = 'askida_current_user';
            const ROLE_KEY = 'askida_user_role';
            
            // Verifica se l'utente √® gi√† autenticato
            const isAuthenticated = sessionStorage.getItem(AUTH_KEY);
            
            if (!isAuthenticated) {
                // Mostra schermata di login
                document.body.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        z-index: 99999;
                    ">
                        <div style="
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                            text-align: center;
                            max-width: 420px;
                            width: 90%;
                        ">
                            <div style="font-size: 60px; margin-bottom: 20px;">üë§</div>
                            <h1 style="
                                color: #4F46E5;
                                font-size: 1.8em;
                                margin-bottom: 10px;
                                font-weight: 700;
                            ">Connexion</h1>
                            <p style="
                                color: #6B7280;
                                margin-bottom: 30px;
                                font-size: 0.95em;
                            ">Gestion des √âquipes Ing√© - Askida Broadcast</p>
                            
                            <div style="text-align: left; margin-bottom: 20px;">
                                <label style="
                                    display: block;
                                    color: #374151;
                                    font-weight: 600;
                                    margin-bottom: 8px;
                                    font-size: 0.9em;
                                ">Nom d'utilisateur</label>
                                <input 
                                    type="text" 
                                    id="usernameInput" 
                                    placeholder="admin ou read"
                                    style="
                                        width: 100%;
                                        padding: 12px 15px;
                                        border: 2px solid #D1D5DB;
                                        border-radius: 10px;
                                        font-size: 1em;
                                        transition: all 0.3s;
                                    "
                                    onfocus="this.style.borderColor='#4F46E5'"
                                    onblur="this.style.borderColor='#D1D5DB'"
                                />
                            </div>
                            
                            <div style="text-align: left; margin-bottom: 25px;">
                                <label style="
                                    display: block;
                                    color: #374151;
                                    font-weight: 600;
                                    margin-bottom: 8px;
                                    font-size: 0.9em;
                                ">Mot de passe</label>
                                <input 
                                    type="password" 
                                    id="passwordInput" 
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                    style="
                                        width: 100%;
                                        padding: 12px 15px;
                                        border: 2px solid #D1D5DB;
                                        border-radius: 10px;
                                        font-size: 1em;
                                        transition: all 0.3s;
                                    "
                                    onfocus="this.style.borderColor='#4F46E5'"
                                    onblur="this.style.borderColor='#D1D5DB'"
                                />
                            </div>
                            
                            <button 
                                onclick="checkLogin()" 
                                style="
                                    width: 100%;
                                    padding: 15px;
                                    background: #4F46E5;
                                    color: white;
                                    border: none;
                                    border-radius: 10px;
                                    font-size: 1em;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                "
                                onmouseover="this.style.background='#4338CA'"
                                onmouseout="this.style.background='#4F46E5'"
                            >
                                üîì Se connecter
                            </button>
                            
                            <div id="errorMessage" style="
                                color: #DC2626;
                                margin-top: 15px;
                                font-size: 0.9em;
                                font-weight: 600;
                                display: none;
                            ">
                                ‚ùå Identifiants incorrects
                            </div>
                            
                            <div style="
                                margin-top: 30px;
                                padding-top: 20px;
                                border-top: 1px solid #E5E7EB;
                            ">
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 10px;
                                    font-size: 0.75em;
                                    color: #6B7280;
                                    text-align: left;
                                ">
                                    <div style="
                                        background: #F9FAFB;
                                        padding: 8px;
                                        border-radius: 5px;
                                        border-left: 3px solid #8B5CF6;
                                    ">
                                        <div style="font-weight: 700; color: #8B5CF6; margin-bottom: 3px;">üëë Admin</div>
                                        <div>Toutes permissions</div>
                                    </div>
                                    <div style="
                                        background: #F9FAFB;
                                        padding: 8px;
                                        border-radius: 5px;
                                        border-left: 3px solid #3B82F6;
                                    ">
                                        <div style="font-weight: 700; color: #3B82F6; margin-bottom: 3px;">üëÅÔ∏è Read</div>
                                        <div>Lecture seule</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Funzione per verificare il login
                window.checkLogin = function() {
                    const usernameInput = document.getElementById('usernameInput');
                    const passwordInput = document.getElementById('passwordInput');
                    const errorMsg = document.getElementById('errorMessage');
                    
                    const username = usernameInput.value.toLowerCase().trim();
                    const password = passwordInput.value;
                    
                    // Verifica credenziali
                    const user = USERS[username];
                    
                    if (user && user.password === password) {
                        // Login corretto
                        sessionStorage.setItem(AUTH_KEY, 'true');
                        sessionStorage.setItem(USER_KEY, username);
                        sessionStorage.setItem(ROLE_KEY, user.role);
                        
                        // Mostra messaggio di successo
                        const roleIcon = user.role === 'admin' ? 'üëë' : 'üëÅÔ∏è';
                        const roleColor = user.role === 'admin' ? '#8B5CF6' : '#3B82F6';
                        
                        document.body.innerHTML = `
                            <div style="
                                position: fixed;
                                top: 0;
                                left: 0;
                                width: 100%;
                                height: 100%;
                                background: linear-gradient(135deg, #10B981 0%, #059669 100%);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            ">
                                <div style="text-align: center; color: white;">
                                    <div style="font-size: 80px; margin-bottom: 20px;">‚úÖ</div>
                                    <h1 style="font-size: 2em; font-weight: 700; margin-bottom: 10px;">Connexion r√©ussie!</h1>
                                    <p style="font-size: 1.2em; opacity: 0.9; margin-bottom: 10px;">Bienvenue ${roleIcon} ${user.displayName}</p>
                                    <p style="font-size: 1em; opacity: 0.8;">Chargement de l'application...</p>
                                </div>
                            </div>
                        `;
                        
                        // Ricarica la pagina
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // Login errato
                        errorMsg.style.display = 'block';
                        passwordInput.value = '';
                        usernameInput.focus();
                        
                        // Shake animation
                        usernameInput.style.animation = 'shake 0.5s';
                        passwordInput.style.animation = 'shake 0.5s';
                        setTimeout(() => {
                            usernameInput.style.animation = '';
                            passwordInput.style.animation = '';
                        }, 500);
                    }
                };
                
                // Permetti invio con tasto Enter
                setTimeout(() => {
                    const usernameInput = document.getElementById('usernameInput');
                    const passwordInput = document.getElementById('passwordInput');
                    
                    if (usernameInput) {
                        usernameInput.focus();
                        usernameInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                passwordInput.focus();
                            }
                        });
                    }
                    
                    if (passwordInput) {
                        passwordInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                checkLogin();
                            }
                        });
                    }
                }, 100);
                
                // Aggiungi animazione shake
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                        20%, 40%, 60%, 80% { transform: translateX(5px); }
                    }
                `;
                document.head.appendChild(style);
                
                // Blocca l'esecuzione del resto della pagina
                throw new Error('Authentication required');
            }
        })();
    </script>
    
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Icone
        const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Trash2 = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Edit2 = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const Check = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>;
        const X = ({size=16}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Calendar = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Users = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const Briefcase = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const UserCog = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/></svg>;
        const Package = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>;
        const Download = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Bell = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>;
        const Search = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const Filter = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const TrendingUp = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const BarChart = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>;
        const Menu = ({size=24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
        const FileText = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const Database = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
        const Upload = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const User = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const AlertTriangle = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const Settings = ({size=18}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.2-13.2L15 8m-6 3-2.2-2.2M1 12h6m6 0h6M4.8 19.2L7 17m10 0 2.2 2.2M4.8 4.8L7 7m10 0 2.2-2.2"/></svg>;

        window.storage = {
            async get(key) {
                const value = localStorage.getItem(key);
                return value ? { key, value } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value };
            }
        };

        function ProjectManager() {
          const [projects, setProjects] = useState([]);
          const [engineers, setEngineers] = useState([]);
          const [resources, setResources] = useState([]);
          const [genericResources, setGenericResources] = useState([]);
          const [projectManagers, setProjectManagers] = useState([]);
          const [activeTab, setActiveTab] = useState('projects');
          const [showProjectForm, setShowProjectForm] = useState(false);
          const [showEngineerForm, setShowEngineerForm] = useState(false);
          const [showResourceForm, setShowResourceForm] = useState(false);
          const [showGenericResourceForm, setShowGenericResourceForm] = useState(false);
          const [showPMForm, setShowPMForm] = useState(false);
          const [editingProject, setEditingProject] = useState(null);
          const [editingEngineer, setEditingEngineer] = useState(null);
          const [editingResource, setEditingResource] = useState(null);
          const [editingGenericResource, setEditingGenericResource] = useState(null);
          const [editingPM, setEditingPM] = useState(null);
          const [formData, setFormData] = useState({
            name: '', status: 'probable', description: '',
            selectedEngineers: [], selectedResources: [], selectedGenericResources: [],
            engineerDays: {}, resourceDays: {}, genericResourceDays: {},
            engineerMonthlyAllocation: {}, resourceMonthlyAllocation: {}, genericResourceMonthlyAllocation: {},
            projectManager: '', startDate: '', endDate: '',
            tags: { client: [], type: [], priority: [] }
          });
          const [engineerForm, setEngineerForm] = useState({ 
            name: '', specialty: '', specialty2: '', specialty3: '', specialty4: '',
            maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
          });
          const [resourceForm, setResourceForm] = useState({ 
            name: '', type: '',
            maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
          });
          const [genericResourceForm, setGenericResourceForm] = useState({ 
            name: '', type: '',
            maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
          });
          const [pmForm, setPMForm] = useState({ name: '', department: '' });
          const [filterStatus, setFilterStatus] = useState('all');
          const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
          const [filterCalendarStatus, setFilterCalendarStatus] = useState('all');
          const [selectedDayProjects, setSelectedDayProjects] = useState(null);
          const [showDayModal, setShowDayModal] = useState(false);
          const [timelineQuarter, setTimelineQuarter] = useState(Math.floor(new Date().getMonth() / 3));
          const [timelineYear, setTimelineYear] = useState(new Date().getFullYear());
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
          const [showBackupModal, setShowBackupModal] = useState(false);
          const [swipeStart, setSwipeStart] = useState(null);
          const [swipedProject, setSwipedProject] = useState(null);
          const [selectedResourceId, setSelectedResourceId] = useState('');
          const [resourceViewQuarter, setResourceViewQuarter] = useState(Math.floor(new Date().getMonth() / 3));
          const [resourceViewYear, setResourceViewYear] = useState(new Date().getFullYear());
          
          // üìà Gantt Interattivo Stati
          const [ganttZoom, setGanttZoom] = useState(1); // 0.5 = 6 mesi, 1 = 3 mesi, 2 = 1.5 mesi
          const [ganttViewMonths, setGanttViewMonths] = useState(3);
          const [ganttStartMonth, setGanttStartMonth] = useState(new Date().getMonth());
          const [ganttStartYear, setGanttStartYear] = useState(new Date().getFullYear());
          const [draggedProject, setDraggedProject] = useState(null);
          const [dragStartX, setDragStartX] = useState(0);
          const [dragStartDate, setDragStartDate] = useState(null);
          const [resizingProject, setResizingProject] = useState(null);
          const [resizingSide, setResizingSide] = useState(null); // 'start' o 'end'
          const [hoveredProject, setHoveredProject] = useState(null);
          const [resourceViewMode, setResourceViewMode] = useState('quarter');
          const [showConflictModal, setShowConflictModal] = useState(false);
          const [conflictToResolve, setConflictToResolve] = useState(null);
          
          // üìÖ NUOVI STATI - CALENDARIO AVANZATO
          const [calendarView, setCalendarView] = useState('month'); // 'day', 'week', 'month', 'quarter', 'year'
          const [selectedDate, setSelectedDate] = useState(new Date());
          const [holidays, setHolidays] = useState([]); // Festivit√† configurabili
          const [showHolidayModal, setShowHolidayModal] = useState(false);
          const [holidayForm, setHolidayForm] = useState({ date: '', name: '' });
          
          // üë• NUOVI STATI - DISPONIBILIT√Ä RISORSE
          const [showUnavailabilityModal, setShowUnavailabilityModal] = useState(false);
          const [unavailabilityForm, setUnavailabilityForm] = useState({
            resourceId: null, resourceType: '', // 'engineer', 'resource', 'genericResource'
            startDate: '', endDate: '', type: 'vacation', reason: '' // type: 'vacation', 'sick', 'training', 'other'
          });
          const [selectedResourceForConfig, setSelectedResourceForConfig] = useState(null);
          const [showResourceConfigModal, setShowResourceConfigModal] = useState(false);
          
          // üìä NUOVI STATI - MULTI-CALENDARIO COMPARATIVO
          const [multiCalendarResources, setMultiCalendarResources] = useState([]); // Array di {id, type}
          const [showMultiCalendar, setShowMultiCalendar] = useState(false);
          
          // Stati per calendario interattivo risoluzione conflitti (sistema allocazione giorni)
          const [conflictCalendarMode, setConflictCalendarMode] = useState(null); // 'project1' | 'project2' | null
          const [conflictSelectedDays, setConflictSelectedDays] = useState({
            project1: {}, // { '2025-11-28': 1.0, '2025-11-29': 0.5, ... }
            project2: {}
          });
          const [conflictRangeStart, setConflictRangeStart] = useState('');
          const [conflictRangeEnd, setConflictRangeEnd] = useState('');
          const [conflictRangeWorkdaysOnly, setConflictRangeWorkdaysOnly] = useState(true);
          const [conflictCalendarMonth, setConflictCalendarMonth] = useState(new Date());
          
          // Stato per r√©solution par priorit√©
          const [priorityProject, setPriorityProject] = useState(null); // 'project1' | 'project2' | null
          
          // Stati per sistema intelligente gestione conflitti
          const [showConflictWarningModal, setShowConflictWarningModal] = useState(false);
          const [conflictWarningData, setConflictWarningData] = useState(null); // { days: {}, affectedProjects: [], currentProject: null }
          const [pendingAllocationAction, setPendingAllocationAction] = useState(null); // funzione da eseguire dopo conferma
          
          const [showDeleteWarning, setShowDeleteWarning] = useState(false);
          const [resourceToDelete, setResourceToDelete] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [advancedFilters, setAdvancedFilters] = useState({ dateStart: '', dateEnd: '', resourceId: '', pmId: '', tags: [] });
          const [showAlerts, setShowAlerts] = useState(false);
          const [availableTags, setAvailableTags] = useState({
            client: [],
            type: ['POC', 'Upgrade', 'Deploy', 'Workflow', 'Consultancy', 'Day2Day'],
            priority: ['P0', 'P1', 'P2']
          });
          
          // Stati per utente e ruolo
          const [currentUser, setCurrentUser] = useState(sessionStorage.getItem('askida_current_user') || 'admin');
          const [userRole, setUserRole] = useState(sessionStorage.getItem('askida_user_role') || 'admin');
          const isReadOnly = userRole === 'reader';
          
          // Stati per OneDrive/SharePoint
          const [isOneDriveConnected, setIsOneDriveConnected] = useState(false);
          const [isOneDriveReady, setIsOneDriveReady] = useState(true); // Usato per mostrare/nascondere banner connessione
          const [isSyncing, setIsSyncing] = useState(false);
          const [lastSyncTime, setLastSyncTime] = useState(null);
          const [syncStatus, setSyncStatus] = useState(''); // 'saving', 'saved', 'error'
          const [oneDriveError, setOneDriveError] = useState(null);
          const [oneDriveAccessToken, setOneDriveAccessToken] = useState(null);
          const [oneDriveFolderPath, setOneDriveFolderPath] = useState(null); // Path dynamique du dossier Ingetool-Data
          const [sharePointSiteId, setSharePointSiteId] = useState(null); // ID du site SharePoint
          
          // Configuration SharePoint/Microsoft Graph
          // ‚úÖ CONFIGUR√â avec vos valeurs Azure AD + SharePoint + GitHub Pages
          const ONEDRIVE_CLIENT_ID = '0ded32a8-75de-48dc-b866-11cce4a18c99';
          const ONEDRIVE_TENANT_ID = '51b9c03e-2025-4f37-8526-8d499718a398';
          const ONEDRIVE_REDIRECT_URI = 'https://giordanoaskida.github.io/ingetool/';
          const ONEDRIVE_SCOPES = 'https://graph.microsoft.com/Files.ReadWrite https://graph.microsoft.com/Sites.ReadWrite.All https://graph.microsoft.com/User.Read';
          const ONEDRIVE_FILE_NAME = 'askida-ingetool-data.json';
          
          // Configuration SharePoint Site
          const SHAREPOINT_SITE_URL = 'https://askida.sharepoint.com/sites/Engineering';
          const SHAREPOINT_HOSTNAME = 'askida.sharepoint.com';
          const SHAREPOINT_SITE_PATH = '/sites/Engineering';
          const SHAREPOINT_FOLDER_NAME = 'Ingetool-Data';
          
          // √âtats pour allocation mensuelle d√©taill√©e
          const [showMonthlyAllocationModal, setShowMonthlyAllocationModal] = useState(false);
          const [monthlyAllocationData, setMonthlyAllocationData] = useState({
            resourceId: null,
            resourceName: '',
            resourceType: null,
            totalDays: 0,
            selectedDates: {} // Oggetto: { '2026-01-05': 1.0, '2026-01-12': 0.5, ... } (0.5 = mezza giornata, 1.0 = giornata intera)
          });
          
          // Stati per selezione range date
          const [rangeStartDate, setRangeStartDate] = useState('');
          const [rangeEndDate, setRangeEndDate] = useState('');
          const [rangeWorkdaysOnly, setRangeWorkdaysOnly] = useState(true);
          const [rangeAllocationType, setRangeAllocationType] = useState(1.0); // 0.5 o 1.0


          const statusConfig = {
            'probable': { label: 'Probable', color: 'bg-yellow-100 text-yellow-800', calendarColor: 'bg-yellow-100 text-yellow-800' },
            'presente': { label: 'Dummy', color: 'bg-blue-100 text-blue-800', calendarColor: 'bg-blue-100 text-blue-800' },
            'programme': { label: 'Programm√©', color: 'bg-green-100 text-green-800', calendarColor: 'bg-green-100 text-green-800' }
          };

          useEffect(() => { loadData(); }, []);
          useEffect(() => {
            if (projects.length > 0 || engineers.length > 0 || resources.length > 0 || genericResources.length > 0 || projectManagers.length > 0) {
              saveData();
            }
          }, [projects, engineers, resources, genericResources, projectManagers]);

          const saveData = async () => {
            try {
              const data = { projects, engineers, resources, genericResources, projectManagers, availableTags };
              await window.storage.set('project-manager-data', JSON.stringify(data));
            } catch (error) { console.log('Erreur'); }
          };

          const loadData = async () => {
            try {
              const result = await window.storage.get('project-manager-data');
              if (result) {
                const data = JSON.parse(result.value);
                setProjects(data.projects || []);
                setEngineers(data.engineers || []);
                setResources(data.resources || []);
                setGenericResources(data.genericResources || []);
                setProjectManagers(data.projectManagers || []);
                if (data.availableTags) {
                  setAvailableTags(data.availableTags);
                }
              }
            } catch (error) { console.log('Pas de donn√©es'); }
          };

          // =====================================================
          // ONEDRIVE FUNCTIONS
          // =====================================================
          
          // Inizializza OneDrive - Gestione token OAuth 2.0
          useEffect(() => {
            console.log('üîµ V√©rification authentification OneDrive...');
            
            // V√©rifie si on a un token dans l'URL (retour de Microsoft login)
            const checkTokenInUrl = () => {
              const hash = window.location.hash;
              
              if (hash && hash.includes('access_token')) {
                console.log('‚úÖ Token trouv√© dans l\'URL!');
                
                // Parse le hash pour extraire le token
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                const expiresIn = params.get('expires_in');
                
                if (accessToken) {
                  console.log('‚úÖ Token OneDrive r√©cup√©r√©!');
                  setOneDriveAccessToken(accessToken);
                  setIsOneDriveConnected(true);
                  setSyncStatus('');
                  
                  // Nettoie l'URL (enl√®ve le hash)
                  window.history.replaceState(null, null, window.location.pathname);
                  
                  // Sauvegarde le token et l'expiration dans sessionStorage
                  sessionStorage.setItem('onedrive_token', accessToken);
                  const expirationTime = Date.now() + (parseInt(expiresIn || '3600') * 1000);
                  sessionStorage.setItem('onedrive_token_expiry', expirationTime.toString());
                  
                  // Charge les donn√©es depuis OneDrive
                  setTimeout(() => loadFromOneDrive(), 1000);
                }
              } else {
                // V√©rifie si on a un token stock√© dans sessionStorage
                const storedToken = sessionStorage.getItem('onedrive_token');
                const tokenExpiry = sessionStorage.getItem('onedrive_token_expiry');
                
                if (storedToken && tokenExpiry) {
                  const expiryTime = parseInt(tokenExpiry);
                  
                  if (Date.now() < expiryTime) {
                    console.log('‚úÖ Token OneDrive valide trouv√© dans sessionStorage');
                    setOneDriveAccessToken(storedToken);
                    setIsOneDriveConnected(true);
                  } else {
                    console.log('‚ö†Ô∏è Token OneDrive expir√©');
                    sessionStorage.removeItem('onedrive_token');
                    sessionStorage.removeItem('onedrive_token_expiry');
                  }
                }
              }
            };
            
            checkTokenInUrl();
          }, []);
          
          // Login OneDrive - Redirect vers Microsoft
          const signInOneDrive = async () => {
            try {
              console.log('üîµ Redirection vers Microsoft login...');
              
              // V√©rifie que les config sont d√©finies
              if (ONEDRIVE_CLIENT_ID === 'VOTRE_CLIENT_ID_AZURE' || ONEDRIVE_TENANT_ID === 'VOTRE_TENANT_ID_AZURE') {
                alert('‚ùå Erreur: Configuration OneDrive manquante!\n\nVeuillez configurer CLIENT_ID et TENANT_ID dans le code.');
                setOneDriveError('Configuration OneDrive non d√©finie. Consultez la documentation.');
                return;
              }
              
              // Construction de l'URL d'autorisation Microsoft
              const authUrl = `https://login.microsoftonline.com/${ONEDRIVE_TENANT_ID}/oauth2/v2.0/authorize?` +
                `client_id=${encodeURIComponent(ONEDRIVE_CLIENT_ID)}` +
                `&response_type=token` +
                `&redirect_uri=${encodeURIComponent(ONEDRIVE_REDIRECT_URI)}` +
                `&scope=${encodeURIComponent(ONEDRIVE_SCOPES)}` +
                `&response_mode=fragment`;
              
              // Redirection vers Microsoft
              window.location.href = authUrl;
              
            } catch (error) {
              console.error('‚ùå Erreur login OneDrive:', error);
              alert('‚ùå Erreur de connexion √† OneDrive');
              setOneDriveError('Erreur de connexion: ' + (error.message || 'unknown'));
            }
          };
          
          // Logout OneDrive
          const signOutOneDrive = async () => {
            try {
              // Reset stati
              setIsOneDriveConnected(false);
              setOneDriveAccessToken(null);
              setSyncStatus('');
              setLastSyncTime(null);
              
              // Rimuovi token da sessionStorage
              sessionStorage.removeItem('onedrive_token');
              sessionStorage.removeItem('onedrive_token_expiry');
              
              console.log('‚úÖ D√©connexion OneDrive r√©ussie');
            } catch (error) {
              console.error('‚ùå Erreur d√©connexion OneDrive:', error);
            }
          };
          
          // üè¢ Obtenir ID du site SharePoint
          const getSharePointSiteId = async () => {
            if (!oneDriveAccessToken) return null;
            
            // Si d√©j√† en cache, retourne
            if (sharePointSiteId) return sharePointSiteId;
            
            try {
              console.log('üè¢ R√©cup√©ration ID du site SharePoint...');
              
              // API pour obtenir site par hostname et path
              const siteUrl = `https://graph.microsoft.com/v1.0/sites/${SHAREPOINT_HOSTNAME}:${SHAREPOINT_SITE_PATH}`;
              console.log('üè¢ URL:', siteUrl);
              
              const response = await fetch(siteUrl, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${oneDriveAccessToken}`
                }
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erreur r√©cup√©ration site:', response.status, errorText);
                throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
              }
              
              const site = await response.json();
              console.log('‚úÖ Site trouv√©:', site.displayName, 'ID:', site.id);
              
              setSharePointSiteId(site.id);
              return site.id;
              
            } catch (error) {
              console.error('‚ùå Erreur getSharePointSiteId:', error);
              return null;
            }
          };
          
          // üîç Recherche dynamique du dossier Ingetool-Data
          const findIngetoolDataFolder = async () => {
            if (!oneDriveAccessToken) return null;
            
            try {
              console.log('üîç Recherche du dossier Ingetool-Data...');
              
              // üêõ SUPER DEBUG: Lista TUTTI i folder nel root
              console.log('üêõ === SUPER DEBUG: Liste de TOUS les dossiers ===');
              try {
                const rootChildrenUrl = 'https://graph.microsoft.com/v1.0/me/drive/root/children';
                const rootResponse = await fetch(rootChildrenUrl, {
                  method: 'GET',
                  headers: { 'Authorization': `Bearer ${oneDriveAccessToken}` }
                });
                
                if (rootResponse.ok) {
                  const data = await rootResponse.json();
                  console.log(`üêõ Trouv√© ${data.value.length} items dans root:`);
                  data.value.forEach((item, index) => {
                    if (item.folder) {
                      console.log(`üêõ   ${index + 1}. üìÅ ${item.name}`);
                      if (item.name.toLowerCase().includes('ingetool')) {
                        console.log(`üêõ      ‚≠ê CONTIENT "ingetool"! Path: ${item.parentReference?.path || 'N/A'}/${item.name}`);
                      }
                    }
                  });
                }
              } catch (e) {
                console.error('üêõ Erreur debug root children:', e);
              }
              console.log('üêõ === FIN SUPER DEBUG ===');
              
              // Strat√©gie 1: Chercher dans root direct
              try {
                const directUrl = 'https://graph.microsoft.com/v1.0/me/drive/root:/Ingetool-Data';
                const directResponse = await fetch(directUrl, {
                  method: 'GET',
                  headers: { 'Authorization': `Bearer ${oneDriveAccessToken}` }
                });
                
                if (directResponse.ok) {
                  const folder = await directResponse.json();
                  const path = folder.parentReference.path.replace('/drive/root:', '') + '/' + folder.name;
                  console.log('‚úÖ Dossier trouv√© dans root:', path);
                  return path;
                }
              } catch (e) {
                console.log('‚ö†Ô∏è Pas trouv√© dans root, recherche dans sharedWithMe...');
              }
              
              // Strat√©gie 2: Chercher dans sharedWithMe
              const sharedUrl = 'https://graph.microsoft.com/v1.0/me/drive/sharedWithMe';
              const sharedResponse = await fetch(sharedUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${oneDriveAccessToken}` }
              });
              
              if (sharedResponse.ok) {
                const data = await sharedResponse.json();
                
                // üêõ SUPER DEBUG: Lista items in sharedWithMe
                console.log('üêõ === DEBUG sharedWithMe ===');
                console.log(`üêõ Trouv√© ${data.value.length} items partag√©s:`);
                data.value.forEach((item, index) => {
                  console.log(`üêõ   ${index + 1}. ${item.folder ? 'üìÅ' : 'üìÑ'} ${item.name}`);
                  if (item.name.toLowerCase().includes('ingetool')) {
                    console.log(`üêõ      ‚≠ê CONTIENT "ingetool"!`);
                    console.log(`üêõ         parentReference:`, item.parentReference);
                  }
                });
                console.log('üêõ === FIN DEBUG sharedWithMe ===');
                
                const folder = data.value.find(item => 
                  item.name === 'Ingetool-Data' || 
                  item.name.includes('Ingetool-Data')
                );
                
                if (folder && folder.parentReference) {
                  const path = folder.parentReference.path.replace('/drive/root:', '') + '/' + folder.name;
                  console.log('‚úÖ Dossier trouv√© dans sharedWithMe:', path);
                  return path;
                }
              }
              
              // Strat√©gie 3: Recherche globale
              const searchUrl = `https://graph.microsoft.com/v1.0/me/drive/root/search(q='Ingetool-Data')`;
              const searchResponse = await fetch(searchUrl, {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${oneDriveAccessToken}` }
              });
              
              if (searchResponse.ok) {
                const data = await searchResponse.json();
                const folder = data.value.find(item => 
                  item.folder && 
                  (item.name === 'Ingetool-Data' || item.name.includes('Ingetool-Data'))
                );
                
                if (folder && folder.parentReference) {
                  const path = folder.parentReference.path.replace('/drive/root:', '') + '/' + folder.name;
                  console.log('‚úÖ Dossier trouv√© via recherche:', path);
                  return path;
                }
              }
              
              console.log('‚ùå Dossier Ingetool-Data non trouv√©');
              return null;
              
            } catch (error) {
              console.error('‚ùå Erreur recherche dossier:', error);
              return null;
            }
          };
          
          // Salva dati su OneDrive
          const saveToOneDrive = async (data) => {
            if (!isOneDriveConnected || !oneDriveAccessToken) return;
            
            try {
              setIsSyncing(true);
              setSyncStatus('saving');
              
              const jsonData = JSON.stringify(data);
              
              // üè¢ Obtenir ID du site SharePoint
              const siteId = await getSharePointSiteId();
              
              if (!siteId) {
                throw new Error('Impossible de r√©cup√©rer l\'ID du site SharePoint');
              }
              
              // üè¢ Microsoft Graph API endpoint pour SharePoint Site
              const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${SHAREPOINT_FOLDER_NAME}/${ONEDRIVE_FILE_NAME}:/content`;
              console.log('üíæ Sauvegarde vers SharePoint:', url);
              
              const response = await fetch(url, {
                method: 'PUT',
                headers: {
                  'Authorization': `Bearer ${oneDriveAccessToken}`,
                  'Content-Type': 'application/json'
                },
                body: jsonData
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erreur sauvegarde:', response.status, errorText);
                throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
              }
              
              console.log('‚úÖ Donn√©es sauvegard√©es sur SharePoint');
              setSyncStatus('saved');
              setLastSyncTime(new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
              
              // Reset status apr√®s 3 secondes
              setTimeout(() => setSyncStatus(''), 3000);
              
            } catch (error) {
              console.error('‚ùå Erreur sauvegarde OneDrive:', error);
              setSyncStatus('error');
              setTimeout(() => setSyncStatus(''), 3000);
              
              // Si token expir√©, d√©connecte
              if (error.message?.includes('401')) {
                console.log('‚ö†Ô∏è Token expir√©, d√©connexion...');
                signOutOneDrive();
              }
            } finally {
              setIsSyncing(false);
            }
          };
          
          // Carica dati da OneDrive
          const loadFromOneDrive = async () => {
            if (!isOneDriveConnected || !oneDriveAccessToken) return;
            
            try {
              setIsSyncing(true);
              
              // üè¢ Obtenir ID du site SharePoint
              const siteId = await getSharePointSiteId();
              
              if (!siteId) {
                throw new Error('Impossible de r√©cup√©rer l\'ID du site SharePoint');
              }
              
              // üè¢ Microsoft Graph API endpoint pour SharePoint Site
              const url = `https://graph.microsoft.com/v1.0/sites/${siteId}/drive/root:/${SHAREPOINT_FOLDER_NAME}/${ONEDRIVE_FILE_NAME}:/content`;
              console.log('üì• Chargement depuis SharePoint:', url);
              
              const response = await fetch(url, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${oneDriveAccessToken}`
                }
              });
              
              if (response.status === 404) {
                console.log('‚ÑπÔ∏è Fichier non trouv√© sur SharePoint (premier acc√®s)');
                setIsSyncing(false);
                return;
              }
              
              if (!response.ok) {
                const errorText = await response.text();
                console.error('‚ùå Erreur chargement:', response.status, errorText);
                throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
              }
              
              const text = await response.text();
              
              if (text) {
                const data = JSON.parse(text);
                
                // Carica i dati nell'app
                if (data.projects) setProjects(data.projects);
                if (data.engineers) setEngineers(data.engineers);
                if (data.resources) setResources(data.resources);
                if (data.genericResources) setGenericResources(data.genericResources);
                if (data.projectManagers) setProjectManagers(data.projectManagers);
                if (data.availableTags) setAvailableTags(data.availableTags);
                
                console.log('‚úÖ Donn√©es charg√©es depuis SharePoint');
                setLastSyncTime(new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }));
              }
              
            } catch (error) {
              console.error('‚ùå Erreur chargement OneDrive:', error);
              
              // Si token expir√©, d√©connecte
              if (error.message?.includes('401')) {
                console.log('‚ö†Ô∏è Token expir√©, d√©connexion...');
                signOutOneDrive();
              }
            } finally {
              setIsSyncing(false);
            }
          };
          
          // üßπ Cleanup risorse fantasma - rimuove ID risorse che non esistono pi√π
          useEffect(() => {
            if (projects.length > 0 && (engineers.length > 0 || resources.length > 0 || genericResources.length > 0)) {
              const engineerIds = engineers.map(e => e.id);
              const resourceIds = resources.map(r => r.id);
              const genericIds = genericResources.map(g => g.id);
              
              const cleanedProjects = projects.map(p => {
                const cleanedEngineers = (p.selectedEngineers || []).filter(id => engineerIds.includes(id));
                const cleanedResources = (p.selectedResources || []).filter(id => resourceIds.includes(id));
                const cleanedGeneric = (p.selectedGenericResources || []).filter(id => genericIds.includes(id));
                
                // Se c'√® differenza, aggiorna
                if (
                  cleanedEngineers.length !== (p.selectedEngineers || []).length ||
                  cleanedResources.length !== (p.selectedResources || []).length ||
                  cleanedGeneric.length !== (p.selectedGenericResources || []).length
                ) {
                  return {
                    ...p,
                    selectedEngineers: cleanedEngineers,
                    selectedResources: cleanedResources,
                    selectedGenericResources: cleanedGeneric
                  };
                }
                return p;
              });
              
              // Aggiorna solo se c'√® differenza
              const hasChanges = cleanedProjects.some((p, i) => p !== projects[i]);
              if (hasChanges) {
                console.log('üßπ Cleanup risorse fantasma effectu√©');
                setProjects(cleanedProjects);
              }
            }
          }, [engineers, resources, genericResources]); // NON projects per evitare loop infinito
          
          // Auto-save su OneDrive quando cambiano i dati
          useEffect(() => {
            if (isOneDriveConnected && (projects.length > 0 || engineers.length > 0 || resources.length > 0)) {
              const timer = setTimeout(() => {
                const data = { projects, engineers, resources, genericResources, projectManagers, availableTags };
                saveToOneDrive(data);
              }, 2000); // Attente de 2 secondes d'inactivit√© avant de sauvegarder
              
              return () => clearTimeout(timer);
            }
          }, [projects, engineers, resources, genericResources, projectManagers, isOneDriveConnected]);
          
          // Force sync manuelle
          const forceSyncFromOneDrive = async () => {
            if (!isOneDriveConnected) {
              alert('‚ö†Ô∏è Connectez d\'abord OneDrive');
              return;
            }
            await loadFromOneDrive();
            alert('‚úÖ Donn√©es synchronis√©es depuis OneDrive!');
          };
          
          // =====================================================
          // END ONEDRIVE FUNCTIONS
          // =====================================================


          const addProject = () => {
            if (!formData.name.trim()) return;
            
            // Raccogli tutti i giorni allocati nel progetto (da tutte le risorse)
            const allSelectedDays = {};
            
            // Engineer allocations
            if (formData.engineerMonthlyAllocation) {
              Object.values(formData.engineerMonthlyAllocation).forEach(dateMap => {
                Object.entries(dateMap).forEach(([date, allocation]) => {
                  allSelectedDays[date] = Math.max(allSelectedDays[date] || 0, allocation);
                });
              });
            }
            
            // Resource allocations
            if (formData.resourceMonthlyAllocation) {
              Object.values(formData.resourceMonthlyAllocation).forEach(dateMap => {
                Object.entries(dateMap).forEach(([date, allocation]) => {
                  allSelectedDays[date] = Math.max(allSelectedDays[date] || 0, allocation);
                });
              });
            }
            
            // Generic resource allocations
            if (formData.genericResourceMonthlyAllocation) {
              Object.values(formData.genericResourceMonthlyAllocation).forEach(dateMap => {
                Object.entries(dateMap).forEach(([date, allocation]) => {
                  allSelectedDays[date] = Math.max(allSelectedDays[date] || 0, allocation);
                });
              });
            }
            
            // V√©rifier conflits (syst√®me intelligent) - PER RISORSA per evitare falsi positivi
            let conflicts = {};
            
            // Controlla conflitti per ogni Engineer allocato
            if (formData.engineerMonthlyAllocation) {
              Object.entries(formData.engineerMonthlyAllocation).forEach(([engineerId, dateMap]) => {
                const engineer = engineers.find(e => e.id == engineerId || e.id === engineerId);
                if (engineer && dateMap) {
                  const engineerConflicts = getConflictingProjects(dateMap, editingProject?.id, engineer.name, 'Engineer');
                  // Merge conflicts
                  Object.entries(engineerConflicts).forEach(([date, allocs]) => {
                    if (!conflicts[date]) conflicts[date] = [];
                    conflicts[date].push(...allocs);
                  });
                }
              });
            }
            
            // Controlla conflitti per ogni Resource allocato
            if (formData.resourceMonthlyAllocation) {
              Object.entries(formData.resourceMonthlyAllocation).forEach(([resourceId, dateMap]) => {
                const resource = resources.find(r => r.id == resourceId || r.id === resourceId);
                if (resource && dateMap) {
                  const resourceConflicts = getConflictingProjects(dateMap, editingProject?.id, resource.name, 'Resource');
                  // Merge conflicts
                  Object.entries(resourceConflicts).forEach(([date, allocs]) => {
                    if (!conflicts[date]) conflicts[date] = [];
                    conflicts[date].push(...allocs);
                  });
                }
              });
            }
            
            // Controlla conflitti per ogni Generic Resource allocato
            if (formData.genericResourceMonthlyAllocation) {
              Object.entries(formData.genericResourceMonthlyAllocation).forEach(([genericId, dateMap]) => {
                const generic = genericResources.find(g => g.id == genericId || g.id === genericId);
                if (generic && dateMap) {
                  const genericConflicts = getConflictingProjects(dateMap, editingProject?.id, generic.name, 'Generic');
                  // Merge conflicts
                  Object.entries(genericConflicts).forEach(([date, allocs]) => {
                    if (!conflicts[date]) conflicts[date] = [];
                    conflicts[date].push(...allocs);
                  });
                }
              });
            }
            
            if (Object.keys(conflicts).length > 0) {
              // Conflits d√©tect√©s - montrer modal de confirmation
              setConflictWarningData({
                days: conflicts,
                affectedProjects: [...new Set(Object.values(conflicts).flatMap(arr => arr.map(a => a.projectName)))],
                currentProject: formData.name
              });
              
              // Sauvegarder l'action √† ex√©cuter apr√®s confirmation
              setPendingAllocationAction(() => () => {
                // Appliquer les modifications avec gestion des conflits
                const updatedProjects = handleConflictConfirmation(conflicts, allSelectedDays, { 
                  id: editingProject?.id || Date.now(),
                  ...formData
                });
                
                // Finaliser la sauvegarde
                if (editingProject) {
                  setEditingProject(null);
                } else {
                  // Nouveau projet d√©j√† ajout√© par handleConflictConfirmation si n√©cessaire
                  // On doit juste s'assurer qu'il est bien dans la liste
                  const projectExists = updatedProjects.some(p => p.name === formData.name);
                  if (!projectExists) {
                    setProjects([...updatedProjects, { id: Date.now(), ...formData, selectedDates: allSelectedDays }]);
                  }
                }
                resetProjectForm();
              });
              
              setShowConflictWarningModal(true);
            } else {
              // Pas de conflits - sauvegarder directement
              if (editingProject) {
                setProjects(projects.map(p => p.id === editingProject.id ? { 
                  ...p, 
                  ...formData,
                  selectedDates: allSelectedDays
                } : p));
                setEditingProject(null);
              } else {
                setProjects([...projects, { 
                  id: Date.now(), 
                  ...formData,
                  selectedDates: allSelectedDays
                }]);
              }
              resetProjectForm();
            }
          };

          const addEngineer = () => {
            if (!engineerForm.name.trim()) return;
            setEngineers([...engineers, { 
              id: Date.now(), 
              ...engineerForm,
              maxMonthlyHours: engineerForm.maxMonthlyHours || 160,
              defaultDailyHours: engineerForm.defaultDailyHours || 8,
              unavailability: []
            }]);
            setEngineerForm({ 
              name: '', specialty: '', specialty2: '', specialty3: '', specialty4: '',
              maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
            });
            setShowEngineerForm(false);
          };

          const addResource = () => {
            if (!resourceForm.name.trim()) return;
            setResources([...resources, { 
              id: Date.now(), 
              ...resourceForm,
              maxMonthlyHours: resourceForm.maxMonthlyHours || 160,
              defaultDailyHours: resourceForm.defaultDailyHours || 8,
              unavailability: []
            }]);
            setResourceForm({ 
              name: '', type: '',
              maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
            });
            setShowResourceForm(false);
          };

          const addGenericResource = () => {
            if (!genericResourceForm.name.trim()) return;
            setGenericResources([...genericResources, { 
              id: Date.now(), 
              ...genericResourceForm,
              maxMonthlyHours: genericResourceForm.maxMonthlyHours || 160,
              defaultDailyHours: genericResourceForm.defaultDailyHours || 8,
              unavailability: []
            }]);
            setGenericResourceForm({ 
              name: '', type: '',
              maxMonthlyHours: 160, defaultDailyHours: 8, unavailability: []
            });
            setShowGenericResourceForm(false);
          };

          const addPM = () => {
            if (!pmForm.name.trim()) return;
            setProjectManagers([...projectManagers, { id: Date.now(), ...pmForm }]);
            setPMForm({ name: '', department: '' });
            setShowPMForm(false);
          };

          const deleteProject = (id) => setProjects(projects.filter(p => p.id !== id));
          const deleteEngineer = (id) => {
            setProjects(projects.map(p => ({...p, selectedEngineers: (p.selectedEngineers || []).filter(eId => eId !== id)})));
            setEngineers(engineers.filter(e => e.id !== id));
          };
          const deleteResource = (id) => {
            setProjects(projects.map(p => ({...p, selectedResources: (p.selectedResources || []).filter(rId => rId !== id)})));
            setResources(resources.filter(r => r.id !== id));
          };
          const deleteGenericResource = (id) => {
            setProjects(projects.map(p => ({...p, selectedGenericResources: (p.selectedGenericResources || []).filter(rId => rId !== id)})));
            setGenericResources(genericResources.filter(r => r.id !== id));
          };
          const deletePM = (id) => {
            setProjects(projects.map(p => ({...p, projectManager: p.projectManager === id ? '' : p.projectManager})));
            setProjectManagers(projectManagers.filter(pm => pm.id !== id));
          };

          const checkResourceUsage = (id, type) => {
            return projects.filter(p => {
              if (type === 'engineer') return (p.selectedEngineers || []).includes(id);
              if (type === 'resource') return (p.selectedResources || []).includes(id);
              if (type === 'generic') return (p.selectedGenericResources || []).includes(id);
              if (type === 'pm') return p.projectManager === id;
              return false;
            });
          };

          const initiateDelete = (id, name, type) => {
            const usedIn = checkResourceUsage(id, type);
            if (usedIn.length > 0) {
              setResourceToDelete({ id, name, type, usedIn });
              setShowDeleteWarning(true);
            } else {
              confirmDelete(id, type);
            }
          };

          const confirmDelete = (id, type) => {
            if (type === 'engineer') deleteEngineer(id);
            else if (type === 'resource') deleteResource(id);
            else if (type === 'generic') deleteGenericResource(id);
            else if (type === 'pm') deletePM(id);
            setShowDeleteWarning(false);
            setResourceToDelete(null);
          };

          const cancelDelete = () => {
            setShowDeleteWarning(false);
            setResourceToDelete(null);
          };

          // =====================================================
          // NUOVE FUNZIONI - GESTIONE AVANZATA RISORSE
          // =====================================================
          
          // Calcola il carico mensile totale di una risorsa
          const calculateMonthlyLoad = (resourceId, resourceType, year, month) => {
            let totalHours = 0;
            
            projects.forEach(project => {
              if (!project.startDate || !project.endDate) return;
              
              const projectStart = new Date(project.startDate);
              const projectEnd = new Date(project.endDate);
              const monthStart = new Date(year, month, 1);
              const monthEnd = new Date(year, month + 1, 0);
              
              // Verifica se il progetto si sovrappone al mese
              if (projectStart <= monthEnd && projectEnd >= monthStart) {
                let hours = 0;
                
                if (resourceType === 'engineer' && project.selectedEngineers?.includes(resourceId)) {
                  hours = project.engineerDays?.[resourceId] || 0;
                } else if (resourceType === 'resource' && project.selectedResources?.includes(resourceId)) {
                  hours = project.resourceDays?.[resourceId] || 0;
                } else if (resourceType === 'genericResource' && project.selectedGenericResources?.includes(resourceId)) {
                  hours = project.genericResourceDays?.[resourceId] || 0;
                }
                
                // Converti giorni in ore (assumendo defaultDailyHours)
                const resource = getResourceById(resourceId, resourceType);
                const dailyHours = resource?.defaultDailyHours || 8;
                totalHours += hours * dailyHours;
              }
            });
            
            return totalHours;
          };
          
          // Ottiene una risorsa per ID e tipo
          const getResourceById = (id, type) => {
            if (type === 'engineer') return engineers.find(e => e.id === id);
            if (type === 'resource') return resources.find(r => r.id === id);
            if (type === 'genericResource') return genericResources.find(r => r.id === id);
            return null;
          };
          
          // Verifica se una risorsa √® disponibile in un periodo
          const isResourceAvailable = (resourceId, resourceType, startDate, endDate) => {
            const resource = getResourceById(resourceId, resourceType);
            if (!resource || !resource.unavailability) return true;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            return !resource.unavailability.some(unavail => {
              const unavailStart = new Date(unavail.startDate);
              const unavailEnd = new Date(unavail.endDate);
              return (start <= unavailEnd && end >= unavailStart);
            });
          };
          
          // Aggiunge un periodo di indisponibilit√† a una risorsa
          const addUnavailability = () => {
            const { resourceId, resourceType, startDate, endDate, type, reason } = unavailabilityForm;
            if (!resourceId || !startDate || !endDate) return;
            
            const newUnavailability = { startDate, endDate, type, reason };
            
            if (resourceType === 'engineer') {
              setEngineers(engineers.map(e => 
                e.id === resourceId 
                  ? { ...e, unavailability: [...(e.unavailability || []), newUnavailability] }
                  : e
              ));
            } else if (resourceType === 'resource') {
              setResources(resources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: [...(r.unavailability || []), newUnavailability] }
                  : r
              ));
            } else if (resourceType === 'genericResource') {
              setGenericResources(genericResources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: [...(r.unavailability || []), newUnavailability] }
                  : r
              ));
            }
            
            setShowUnavailabilityModal(false);
            setUnavailabilityForm({
              resourceId: null, resourceType: '',
              startDate: '', endDate: '', type: 'vacation', reason: ''
            });
          };
          
          // Rimuove un periodo di indisponibilit√†
          const removeUnavailability = (resourceId, resourceType, index) => {
            if (resourceType === 'engineer') {
              setEngineers(engineers.map(e => 
                e.id === resourceId 
                  ? { ...e, unavailability: e.unavailability.filter((_, i) => i !== index) }
                  : e
              ));
            } else if (resourceType === 'resource') {
              setResources(resources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: r.unavailability.filter((_, i) => i !== index) }
                  : r
              ));
            } else if (resourceType === 'genericResource') {
              setGenericResources(genericResources.map(r => 
                r.id === resourceId 
                  ? { ...r, unavailability: r.unavailability.filter((_, i) => i !== index) }
                  : r
              ));
            }
          };
          
          // Calcola la percentuale di allocazione di una risorsa
          const calculateAllocationPercentage = (resourceId, resourceType, year, month) => {
            const resource = getResourceById(resourceId, resourceType);
            if (!resource) return 0;
            
            const totalHours = calculateMonthlyLoad(resourceId, resourceType, year, month);
            const maxHours = resource.maxMonthlyHours || 160;
            
            return Math.round((totalHours / maxHours) * 100);
          };
          
          // Aggiorna configurazione risorsa (max ore, ore giornaliere)
          const updateResourceConfig = (resourceId, resourceType, maxMonthlyHours, defaultDailyHours) => {
            if (resourceType === 'engineer') {
              setEngineers(engineers.map(e => 
                e.id === resourceId 
                  ? { ...e, maxMonthlyHours, defaultDailyHours }
                  : e
              ));
            } else if (resourceType === 'resource') {
              setResources(resources.map(r => 
                r.id === resourceId 
                  ? { ...r, maxMonthlyHours, defaultDailyHours }
                  : r
              ));
            } else if (resourceType === 'genericResource') {
              setGenericResources(genericResources.map(r => 
                r.id === resourceId 
                  ? { ...r, maxMonthlyHours, defaultDailyHours }
                  : r
              ));
            }
          };
          
          // Gestione festivit√†
          const addHoliday = () => {
            if (!holidayForm.date || !holidayForm.name) return;
            setHolidays([...holidays, { ...holidayForm, id: Date.now() }]);
            setHolidayForm({ date: '', name: '' });
            setShowHolidayModal(false);
          };
          
          const removeHoliday = (id) => {
            setHolidays(holidays.filter(h => h.id !== id));
          };
          
          const isHoliday = (date) => {
            const dateStr = date.toISOString().split('T')[0];
            return holidays.some(h => h.date === dateStr);
          };

          // =====================================================
          // FUNZIONI CALENDARIO INTERATTIVO RISOLUZIONE CONFLITTI
          // =====================================================
          
          // Genera giorni del mese per il calendario
          const generateConflictCalendarDays = (year, month) => {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay(); // 0 = Dimanche, 1 = Lundi, ...
            
            // Adjust per far iniziare da Luned√¨ (standard europeo)
            const adjustedStart = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1;
            
            const days = [];
            
            // Giorni vuoti prima del primo giorno del mese
            for (let i = 0; i < adjustedStart; i++) {
              days.push(null);
            }
            
            // Giorni del mese
            for (let day = 1; day <= daysInMonth; day++) {
              days.push(day);
            }
            
            return days;
          };
          
          // =====================================================
          // FUNZIONI CALENDARIO CONFLITTI - SISTEMA ALLOCAZIONE GIORNI
          // =====================================================
          
          // Genera chiave data da giorno
          const getConflictDateKey = (day) => {
            const year = conflictCalendarMonth.getFullYear();
            const month = conflictCalendarMonth.getMonth();
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          };
          
          // Handler click su giorno - Cicla tra stati: vuoto ‚Üí 0.5j ‚Üí 1.0j ‚Üí vuoto
          const handleConflictDayClick = (day, projectKey) => {
            if (!day) return;
            
            const dateKey = getConflictDateKey(day);
            
            setConflictSelectedDays(prev => {
              const projectDays = prev[projectKey] || {};
              const currentValue = projectDays[dateKey] || 0;
              // Ciclo: 0 ‚Üí 0.5 ‚Üí 1.0 ‚Üí 0
              const newValue = currentValue === 0 ? 0.5 : currentValue === 0.5 ? 1.0 : 0;
              
              const newProjectDays = { ...projectDays };
              
              if (newValue === 0) {
                delete newProjectDays[dateKey];
              } else {
                newProjectDays[dateKey] = newValue;
              }
              
              return {
                ...prev,
                [projectKey]: newProjectDays
              };
            });
          };
          
          // Ottieni allocazione giorno (0.5, 1.0 o null)
          const getConflictDayAllocation = (day, projectKey) => {
            if (!day) return null;
            const dateKey = getConflictDateKey(day);
            return conflictSelectedDays[projectKey]?.[dateKey] || null;
          };
          
          // Calcola date d√©but/fin da giorni selezionati
          const calculateConflictProjectDates = (projectKey) => {
            const projectDays = conflictSelectedDays[projectKey] || {};
            const dates = Object.keys(projectDays).sort();
            
            if (dates.length === 0) return { start: '', end: '' };
            
            return {
              start: dates[0],
              end: dates[dates.length - 1]
            };
          };
          
          // Applica selezione range (da date pickers)
          const applyConflictRangeSelection = (projectKey, value) => {
            if (!conflictRangeStart || !conflictRangeEnd) {
              alert('‚ö†Ô∏è S√©lectionnez d\'abord les dates d√©but et fin');
              return;
            }
            
            const start = new Date(conflictRangeStart);
            const end = new Date(conflictRangeEnd);
            
            if (start > end) {
              alert('‚ö†Ô∏è La date d√©but doit √™tre avant la date fin');
              return;
            }
            
            setConflictSelectedDays(prev => {
              const newProjectDays = { ...prev[projectKey] };
              
              // Itera su tutti i giorni nel range
              let currentDate = new Date(start);
              while (currentDate <= end) {
                const dayOfWeek = currentDate.getDay(); // 0 = Dimanche, 6 = Samedi
                
                // Se conflictRangeWorkdaysOnly √® true, salta weekend
                if (conflictRangeWorkdaysOnly && (dayOfWeek === 0 || dayOfWeek === 6)) {
                  currentDate.setDate(currentDate.getDate() + 1);
                  continue;
                }
                
                const dateKey = currentDate.toISOString().split('T')[0];
                newProjectDays[dateKey] = value; // 0.5 o 1.0
                
                currentDate.setDate(currentDate.getDate() + 1);
              }
              
              return {
                ...prev,
                [projectKey]: newProjectDays
              };
            });
          };
          
          // Conta totale giorni allocati
          const getConflictTotalDays = (projectKey) => {
            const projectDays = conflictSelectedDays[projectKey] || {};
            return Object.values(projectDays).reduce((sum, val) => sum + val, 0);
          };

          // =====================================================
          // SYST√àME INTELLIGENT GESTION CONFLITS
          // =====================================================
          
          // Ottieni mappa globale allocazioni per una risorsa specifica: { '2025-12-12': [{ project, allocation }] }
          const getAllocatedDays = (resourceName = null, resourceType = null) => {
            const allocationMap = {};
            
            projects.forEach(project => {
              // Se nessun filtro risorsa, usa selectedDates globale (vecchio comportamento)
              if (!resourceName || !resourceType) {
                if (!project.selectedDates) return;
                
                Object.entries(project.selectedDates).forEach(([date, allocation]) => {
                  if (!allocationMap[date]) {
                    allocationMap[date] = [];
                  }
                  allocationMap[date].push({
                    projectId: project.id,
                    projectName: project.name,
                    allocation: allocation
                  });
                });
                return;
              }
              
              // Filtra per risorsa specifica
              let resourceAllocation = null;
              
              if (resourceType === 'Engineer') {
                resourceAllocation = project.engineerMonthlyAllocation?.[resourceName];
              } else if (resourceType === 'Resource') {
                resourceAllocation = project.resourceMonthlyAllocation?.[resourceName];
              } else if (resourceType === 'Generic') {
                resourceAllocation = project.genericResourceMonthlyAllocation?.[resourceName];
              }
              
              if (!resourceAllocation) return;
              
              Object.entries(resourceAllocation).forEach(([date, allocation]) => {
                if (!allocationMap[date]) {
                  allocationMap[date] = [];
                }
                allocationMap[date].push({
                  projectId: project.id,
                  projectName: project.name,
                  allocation: allocation
                });
              });
            });
            
            return allocationMap;
          };
          
          // Trova progetti che usano giorni specifici (escluso progetto corrente) per una risorsa specifica
          const getConflictingProjects = (selectedDays, currentProjectId = null, resourceName = null, resourceType = null) => {
            const allocationMap = getAllocatedDays(resourceName, resourceType);
            const conflicts = {};
            
            Object.entries(selectedDays).forEach(([date, allocation]) => {
              if (allocation > 0 && allocationMap[date]) {
                const conflictingAllocs = allocationMap[date].filter(
                  alloc => alloc.projectId !== currentProjectId
                );
                
                if (conflictingAllocs.length > 0) {
                  conflicts[date] = conflictingAllocs;
                }
              }
            });
            
            return conflicts;
          };
          
          // Verifica se un giorno √® allocato in altri progetti per una risorsa specifica
          const isDayAllocatedElsewhere = (date, currentProjectId = null, resourceName = null, resourceType = null) => {
            const allocationMap = getAllocatedDays(resourceName, resourceType);
            if (!allocationMap[date]) return false;
            
            return allocationMap[date].some(alloc => alloc.projectId !== currentProjectId);
          };
          
          // Ottieni dettagli allocazione per tooltip per una risorsa specifica
          const getAllocationDetails = (date, currentProjectId = null, resourceName = null, resourceType = null) => {
            const allocationMap = getAllocatedDays(resourceName, resourceType);
            if (!allocationMap[date]) return null;
            
            const allocations = allocationMap[date].filter(
              alloc => alloc.projectId !== currentProjectId
            );
            
            if (allocations.length === 0) return null;
            
            return allocations;
          };
          
          // Gestisci conferma conflitto e applica modifiche (rimozione/split)
          const handleConflictConfirmation = (conflicts, newSelectedDays, targetProject) => {
            // Update progetti coinvolti
            const updatedProjects = projects.map(project => {
              // Per ogni giorno in conflitto
              Object.keys(conflicts).forEach(date => {
                const conflictingAllocs = conflicts[date];
                const hasConflict = conflictingAllocs.some(alloc => alloc.projectId === project.id);
                
                if (hasConflict && project.selectedDates && project.selectedDates[date]) {
                  const oldAllocation = project.selectedDates[date];
                  const newAllocation = newSelectedDays[date] || 0;
                  
                  // Logica split (Q2: opzione B)
                  if (oldAllocation === 1.0 && newAllocation === 0.5) {
                    // Riduci vecchio progetto a 0.5j
                    project.selectedDates[date] = 0.5;
                  } else if (oldAllocation === 1.0 && newAllocation === 1.0) {
                    // Rimuovi completamente da vecchio progetto
                    delete project.selectedDates[date];
                  } else if (oldAllocation === 0.5 && newAllocation === 0.5) {
                    // Rimuovi da vecchio (split equo non possibile)
                    delete project.selectedDates[date];
                  } else if (oldAllocation === 0.5 && newAllocation === 1.0) {
                    // Rimuovi da vecchio
                    delete project.selectedDates[date];
                  } else {
                    // Default: rimuovi da vecchio progetto
                    delete project.selectedDates[date];
                  }
                }
              });
              
              return project;
            });
            
            // Update progetto target con nuova allocazione
            const finalProjects = updatedProjects.map(project => {
              if (project.id === targetProject.id) {
                return {
                  ...project,
                  selectedDates: {
                    ...project.selectedDates,
                    ...newSelectedDays
                  }
                };
              }
              return project;
            });
            
            setProjects(finalProjects);
            return finalProjects;
          };

          // Funzioni per Alert
          const checkDateOverlap = (date1Start, date1End, date2Start, date2End) => {
            if (!date1Start || !date1End || !date2Start || !date2End) return false;
            return date1Start <= date2End && date2Start <= date1End;
          };
          
          // Nuova funzione: controlla overlap giorni REALI (selectedDates)
          const checkActualDaysOverlap = (project1, project2) => {
            // Se non ci sono selectedDates, usa vecchio metodo date range
            if (!project1.selectedDates || Object.keys(project1.selectedDates).length === 0 ||
                !project2.selectedDates || Object.keys(project2.selectedDates).length === 0) {
              return checkDateOverlap(project1.startDate, project1.endDate, project2.startDate, project2.endDate);
            }
            
            // Controlla se ci sono giorni in comune con allocazione > 0
            const days1 = Object.keys(project1.selectedDates).filter(date => project1.selectedDates[date] > 0);
            const days2 = Object.keys(project2.selectedDates).filter(date => project2.selectedDates[date] > 0);
            
            // Cerca intersezione
            const overlap = days1.some(day => days2.includes(day));
            return overlap;
          };

          const getOverlapAlerts = () => {
            const alerts = [];
            const allResources = [
              ...engineers.map(e => ({ ...e, type: 'engineer' })),
              ...resources.map(r => ({ ...r, type: 'resource' })),
              ...genericResources.map(g => ({ ...g, type: 'generic' }))
            ];

            allResources.forEach(resource => {
              const assignedProjects = projects.filter(p => {
                if (resource.type === 'engineer') return (p.selectedEngineers || []).includes(resource.id);
                if (resource.type === 'resource') return (p.selectedResources || []).includes(resource.id);
                if (resource.type === 'generic') return (p.selectedGenericResources || []).includes(resource.id);
                return false;
              }).filter(p => p.startDate && p.endDate);

              for (let i = 0; i < assignedProjects.length; i++) {
                for (let j = i + 1; j < assignedProjects.length; j++) {
                  // Usa nuova funzione che controlla giorni reali (selectedDates)
                  if (checkActualDaysOverlap(assignedProjects[i], assignedProjects[j])) {
                    alerts.push({
                      type: 'overlap',
                      resource: resource.name,
                      resourceType: resource.type,
                      projects: [assignedProjects[i].name, assignedProjects[j].name]
                    });
                  }
                }
              }
            });
            return alerts;
          };

          const getProjectsWithoutDates = () => {
            return projects.filter(p => !p.startDate || !p.endDate).map(p => ({
              type: 'no-dates',
              project: p.name,
              projectId: p.id
            }));
          };

          const getAllAlerts = () => {
            return [
              ...getOverlapAlerts(),
              ...getProjectsWithoutDates()
            ];
          };

          // Funzioni per Ricerca e Filtri
          const applySearchAndFilters = (projectsList) => {
            let filtered = projectsList;

            // Ricerca globale
            if (searchQuery) {
              const query = searchQuery.toLowerCase();
              filtered = filtered.filter(p => {
                const projectMatch = p.name.toLowerCase().includes(query) || 
                                    (p.description && p.description.toLowerCase().includes(query));
                const pmMatch = getProjectManager(p) && getProjectManager(p).name.toLowerCase().includes(query);
                const engMatch = getAssignedEngineers(p).some(e => e.name.toLowerCase().includes(query));
                const resMatch = getAssignedResources(p).some(r => r.name.toLowerCase().includes(query));
                const genMatch = getAssignedGenericResources(p).some(g => g.name.toLowerCase().includes(query));
                return projectMatch || pmMatch || engMatch || resMatch || genMatch;
              });
            }

            // Filtro date (esclude progetti senza date)
            if (advancedFilters.dateStart) {
              filtered = filtered.filter(p => p.endDate && p.endDate >= advancedFilters.dateStart);
            }
            if (advancedFilters.dateEnd) {
              filtered = filtered.filter(p => p.startDate && p.startDate <= advancedFilters.dateEnd);
            }

            // Filtro risorsa
            if (advancedFilters.resourceId) {
              filtered = filtered.filter(p => 
                (p.selectedEngineers || []).includes(advancedFilters.resourceId) ||
                (p.selectedResources || []).includes(advancedFilters.resourceId) ||
                (p.selectedGenericResources || []).includes(advancedFilters.resourceId)
              );
            }

            // Filtro PM
            if (advancedFilters.pmId) {
              filtered = filtered.filter(p => p.projectManager === advancedFilters.pmId);
            }

            // Filtro Tags
            if (advancedFilters.tags && advancedFilters.tags.length > 0) {
              filtered = filtered.filter(p => {
                if (!p.tags) return false;
                const projectTags = [...(p.tags.client || []), ...(p.tags.type || []), ...(p.tags.priority || [])];
                return advancedFilters.tags.some(tag => projectTags.includes(tag));
              });
            }

            return filtered;
          };

          const resetFilters = () => {
            setSearchQuery('');
            setAdvancedFilters({ dateStart: '', dateEnd: '', resourceId: '', pmId: '', tags: [] });
          };

          const addClientTag = (clientName) => {
            if (clientName && !availableTags.client.includes(clientName)) {
              setAvailableTags({ ...availableTags, client: [...availableTags.client, clientName] });
            }
          };

          const toggleTag = (category, tag) => {
            const currentTags = formData.tags[category] || [];
            const newTags = currentTags.includes(tag) 
              ? currentTags.filter(t => t !== tag)
              : [...currentTags, tag];
            setFormData({ ...formData, tags: { ...formData.tags, [category]: newTags } });
          };

          const toggleFilterTag = (tag) => {
            const currentTags = advancedFilters.tags || [];
            const newTags = currentTags.includes(tag)
              ? currentTags.filter(t => t !== tag)
              : [...currentTags, tag];
            setAdvancedFilters({ ...advancedFilters, tags: newTags });
          };

          const getTagColor = (category) => {
            if (category === 'client') return 'bg-blue-100 text-blue-800 border-blue-300';
            if (category === 'type') return 'bg-purple-100 text-purple-800 border-purple-300';
            if (category === 'priority') return 'bg-red-100 text-red-800 border-red-300';
            return 'bg-gray-100 text-gray-800 border-gray-300';
          };

          // Export PDF
          const exportToPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('Gestion des √âquipes Ing√© - Askida Broadcast', 14, 20);
            doc.setFontSize(11);
            doc.text(`Rapport g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 14, 28);
            
            let yPos = 40;
            
            // Statistiques
            doc.setFontSize(14);
            doc.text('Statistiques', 14, yPos);
            yPos += 8;
            doc.setFontSize(10);
            doc.text(`Total projets: ${projects.length}`, 20, yPos);
            yPos += 6;
            doc.text(`Probables: ${projects.filter(p => p.status === 'probable').length}`, 20, yPos);
            yPos += 6;
            doc.text(`Dummy: ${projects.filter(p => p.status === 'presente').length}`, 20, yPos);
            yPos += 6;
            doc.text(`Programm√©s: ${projects.filter(p => p.status === 'programme').length}`, 20, yPos);
            yPos += 10;
            
            // Table projets
            doc.setFontSize(14);
            doc.text('Liste des Projets', 14, yPos);
            yPos += 8;
            
            const tableData = projects.map(p => [
              p.name,
              statusConfig[p.status]?.label || p.status,
              p.startDate ? new Date(p.startDate).toLocaleDateString('fr-FR') : '-',
              p.endDate ? new Date(p.endDate).toLocaleDateString('fr-FR') : '-',
              getAssignedEngineers(p).length + getAssignedResources(p).length + getAssignedGenericResources(p).length
            ]);
            
            doc.autoTable({
              startY: yPos,
              head: [['Projet', 'Statut', 'D√©but', 'Fin', 'Ressources']],
              body: tableData,
              theme: 'striped',
              headStyles: { fillColor: [79, 70, 229] },
              margin: { left: 14, right: 14 }
            });
            
            yPos = doc.lastAutoTable.finalY + 15;
            
            doc.save('askida-broadcast-rapport.pdf');
          };

          // Backup JSON
          const exportBackup = () => {
            const data = {
              projects,
              engineers,
              resources,
              genericResources,
              projectManagers,
              availableTags,
              exportDate: new Date().toISOString(),
              version: '1.0'
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `askida-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
          };

          // Restore from backup
          const importBackup = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = JSON.parse(e.target.result);
                
                if (data.version && data.projects) {
                  setProjects(data.projects || []);
                  setEngineers(data.engineers || []);
                  setResources(data.resources || []);
                  setGenericResources(data.genericResources || []);
                  setProjectManagers(data.projectManagers || []);
                  if (data.availableTags) {
                    setAvailableTags(data.availableTags);
                  }
                  alert(`‚úÖ Backup restaur√© avec succ√®s!\n${data.projects.length} projets import√©s`);
                  setShowBackupModal(false);
                } else {
                  alert('‚ùå Format de backup invalide');
                }
              } catch (error) {
                alert('‚ùå Erreur lors de la lecture du backup');
              }
            };
            reader.readAsText(file);
          };

          // Vue Ressource functions
          const getAllResources = () => {
            return [
              ...engineers.map(e => ({ ...e, type: 'Ing√©nieur', resourceType: 'engineer' })),
              ...resources.map(r => ({ ...r, type: r.type || 'Ressource', resourceType: 'resource' })),
              ...genericResources.map(g => ({ ...g, type: g.type || 'G√©n√©rique', resourceType: 'generic' }))
            ];
          };

          const getSelectedResource = () => {
            return getAllResources().find(r => r.id == selectedResourceId || r.id === selectedResourceId);
          };

          const getResourceProjects = (resourceId) => {
            if (!resourceId) return [];
            return projects.filter(p => {
              const resource = getAllResources().find(r => r.id == resourceId || r.id === resourceId);
              if (!resource) return false;
              
              if (resource.resourceType === 'engineer') {
                return (p.selectedEngineers || []).some(id => id == resourceId || id === resourceId);
              } else if (resource.resourceType === 'resource') {
                return (p.selectedResources || []).some(id => id == resourceId || id === resourceId);
              } else {
                return (p.selectedGenericResources || []).some(id => id == resourceId || id === resourceId);
              }
            }).filter(p => p.startDate && p.endDate);
          };

          const getResourceConflicts = (resourceId) => {
            const resourceProjects = getResourceProjects(resourceId);
            const conflicts = [];
            
            for (let i = 0; i < resourceProjects.length; i++) {
              for (let j = i + 1; j < resourceProjects.length; j++) {
                // Usa nuova funzione che controlla giorni reali (selectedDates)
                if (checkActualDaysOverlap(resourceProjects[i], resourceProjects[j])) {
                  // Calcola overlap start/end basato su selectedDates se disponibili
                  let overlapStart, overlapEnd;
                  
                  if (resourceProjects[i].selectedDates && resourceProjects[j].selectedDates) {
                    const days1 = Object.keys(resourceProjects[i].selectedDates).filter(d => resourceProjects[i].selectedDates[d] > 0).sort();
                    const days2 = Object.keys(resourceProjects[j].selectedDates).filter(d => resourceProjects[j].selectedDates[d] > 0).sort();
                    const commonDays = days1.filter(d => days2.includes(d)).sort();
                    
                    if (commonDays.length > 0) {
                      overlapStart = new Date(commonDays[0]);
                      overlapEnd = new Date(commonDays[commonDays.length - 1]);
                    } else {
                      // Fallback (non dovrebbe succedere)
                      overlapStart = new Date(Math.max(new Date(resourceProjects[i].startDate), new Date(resourceProjects[j].startDate)));
                      overlapEnd = new Date(Math.min(new Date(resourceProjects[i].endDate), new Date(resourceProjects[j].endDate)));
                    }
                  } else {
                    // Se non ci sono selectedDates, usa date range
                    overlapStart = new Date(Math.max(new Date(resourceProjects[i].startDate), new Date(resourceProjects[j].startDate)));
                    overlapEnd = new Date(Math.min(new Date(resourceProjects[i].endDate), new Date(resourceProjects[j].endDate)));
                  }
                  
                  conflicts.push({
                    project1: resourceProjects[i],
                    project2: resourceProjects[j],
                    overlapStart,
                    overlapEnd
                  });
                }
              }
            }
            return conflicts;
          };

          const getMonthDays = (year, month) => {
            return new Date(year, month + 1, 0).getDate();
          };

          const getResourceDaysInMonth = (resourceId, year, month) => {
            const resource = getAllResources().find(r => r.id == resourceId || r.id === resourceId);
            if (!resource) return { total: 0, byProject: {} };
            
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);
            const monthStartStr = monthStart.toISOString().split('T')[0];
            const monthEndStr = monthEnd.toISOString().split('T')[0];
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            
            const resourceProjects = getResourceProjects(resourceId);
            const byProject = {};
            let total = 0;
            
            resourceProjects.forEach(p => {
              if (p.startDate <= monthEndStr && p.endDate >= monthStartStr) {
                let days = 0;
                
                // Cherche si une allocation mensuelle d√©taill√©e existe (avec dates sp√©cifiques)
                let dateAllocation = null;
                if (resource.resourceType === 'engineer') {
                  dateAllocation = p.engineerMonthlyAllocation?.[resourceId];
                } else if (resource.resourceType === 'resource') {
                  dateAllocation = p.resourceMonthlyAllocation?.[resourceId];
                } else {
                  dateAllocation = p.genericResourceMonthlyAllocation?.[resourceId];
                }
                
                // Si allocation d√©taill√©e existe, compte les dates du mois
                if (dateAllocation) {
                  if (Array.isArray(dateAllocation)) {
                    // Vecchio formato: array di stringhe di date
                    days = dateAllocation.filter(d => d.startsWith(monthKey)).length;
                  } else if (typeof dateAllocation === 'object') {
                    // Nuovo formato: oggetto { '2026-01-05': 1.0, '2026-01-12': 0.5 }
                    days = Object.entries(dateAllocation)
                      .filter(([date]) => date.startsWith(monthKey))
                      .reduce((sum, [, value]) => sum + value, 0);
                  }
                } else {
                  // Sinon, distribution uniforme comme avant
                  let totalDays = 0;
                  if (resource.resourceType === 'engineer') {
                    totalDays = p.engineerDays?.[resourceId] || 0;
                    if (!totalDays) {
                      const matchingKey = Object.keys(p.engineerDays || {}).find(k => k == resourceId);
                      if (matchingKey) totalDays = p.engineerDays[matchingKey];
                    }
                  } else if (resource.resourceType === 'resource') {
                    totalDays = p.resourceDays?.[resourceId] || 0;
                    if (!totalDays) {
                      const matchingKey = Object.keys(p.resourceDays || {}).find(k => k == resourceId);
                      if (matchingKey) totalDays = p.resourceDays[matchingKey];
                    }
                  } else {
                    totalDays = p.genericResourceDays?.[resourceId] || 0;
                    if (!totalDays) {
                      const matchingKey = Object.keys(p.genericResourceDays || {}).find(k => k == resourceId);
                      if (matchingKey) totalDays = p.genericResourceDays[matchingKey];
                    }
                  }
                  
                  const projectStart = new Date(Math.max(new Date(p.startDate), monthStart));
                  const projectEnd = new Date(Math.min(new Date(p.endDate), monthEnd));
                  const daysInMonth = Math.ceil((projectEnd - projectStart) / (1000 * 60 * 60 * 24)) + 1;
                  const totalProjectDays = Math.ceil((new Date(p.endDate) - new Date(p.startDate)) / (1000 * 60 * 60 * 24)) + 1;
                  days = Math.round((totalDays * daysInMonth) / totalProjectDays);
                }
                
                byProject[p.id] = { name: p.name, days: days, status: p.status };
                total += days;
              }
            });
            
            return { total, byProject };
          };
          
          // R√©solution automatique par priorit√©
          const resolveByPriority = (conflictData, priorityProjectKey) => {
            // Determina progetti
            const priorityProj = priorityProjectKey === 'project1' ? conflictData.project1 : conflictData.project2;
            const secondaryProj = priorityProjectKey === 'project1' ? conflictData.project2 : conflictData.project1;
            
            // Ottieni info risorsa dal conflictData
            const resourceId = conflictData.resourceId;
            const resourceType = conflictData.resourceType;
            
            // Il progetto prioritario mantiene le sue allocazioni esistenti
            const priorityDays = priorityProj.selectedDates || {};
            
            // Trova giorni disponibili per progetto secondario
            const secondaryStart = new Date(secondaryProj.startDate);
            const secondaryEnd = new Date(secondaryProj.endDate);
            
            // üîß FIX: Usa jours vendus per questa risorsa specifica invece di contare tutti i giorni
            let totalDaysNeeded = 0;
            
            if (resourceId && resourceType) {
              // Leggi i jours vendus per la risorsa specifica
              if (resourceType === 'engineer') {
                totalDaysNeeded = secondaryProj.engineerDays?.[resourceId] || 0;
                // Fallback per match con conversione tipo
                if (!totalDaysNeeded) {
                  const matchingKey = Object.keys(secondaryProj.engineerDays || {}).find(k => k == resourceId);
                  if (matchingKey) totalDaysNeeded = secondaryProj.engineerDays[matchingKey];
                }
              } else if (resourceType === 'resource') {
                totalDaysNeeded = secondaryProj.resourceDays?.[resourceId] || 0;
                if (!totalDaysNeeded) {
                  const matchingKey = Object.keys(secondaryProj.resourceDays || {}).find(k => k == resourceId);
                  if (matchingKey) totalDaysNeeded = secondaryProj.resourceDays[matchingKey];
                }
              } else if (resourceType === 'generic') {
                totalDaysNeeded = secondaryProj.genericResourceDays?.[resourceId] || 0;
                if (!totalDaysNeeded) {
                  const matchingKey = Object.keys(secondaryProj.genericResourceDays || {}).find(k => k == resourceId);
                  if (matchingKey) totalDaysNeeded = secondaryProj.genericResourceDays[matchingKey];
                }
              }
            }
            
            // Se non trovato jours vendus, fallback a selectedDates o conteggio giorni
            if (!totalDaysNeeded) {
              if (secondaryProj.selectedDates) {
                totalDaysNeeded = Object.values(secondaryProj.selectedDates).reduce((sum, val) => sum + val, 0);
              } else {
                // Ultimo fallback: conta tutti i giorni lavorativi nel range
                let current = new Date(secondaryStart);
                while (current <= secondaryEnd) {
                  const dayOfWeek = current.getDay();
                  if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    totalDaysNeeded += 1;
                  }
                  current.setDate(current.getDate() + 1);
                }
              }
            }
            
            // Trova giorni disponibili (non occupati dal progetto prioritario)
            const availableDays = [];
            let current = new Date(secondaryStart);
            
            while (current <= secondaryEnd) {
              const dateStr = current.toISOString().split('T')[0];
              const dayOfWeek = current.getDay();
              
              // Solo giorni lavorativi
              if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                const priorityAllocation = priorityDays[dateStr] || 0;
                const availableCapacity = 1.0 - priorityAllocation;
                
                if (availableCapacity > 0) {
                  availableDays.push({
                    date: dateStr,
                    capacity: availableCapacity
                  });
                }
              }
              
              current.setDate(current.getDate() + 1);
            }
            
            // Alloca progetto secondario nei giorni disponibili
            const secondaryAllocations = {};
            let daysAllocated = 0;
            let warningMessage = null;
            
            for (const day of availableDays) {
              if (daysAllocated >= totalDaysNeeded) break;
              
              const allocationNeeded = Math.min(day.capacity, totalDaysNeeded - daysAllocated);
              secondaryAllocations[day.date] = allocationNeeded;
              daysAllocated += allocationNeeded;
            }
            
            // Verifica se giorni sufficienti
            if (daysAllocated < totalDaysNeeded) {
              const shortage = totalDaysNeeded - daysAllocated;
              warningMessage = `‚ö†Ô∏è Seulement ${daysAllocated}j disponibles sur ${totalDaysNeeded}j demand√©s. Manque: ${shortage.toFixed(1)}j`;
            }
            
            // Calcola nuove date range per progetto secondario
            const allocatedDates = Object.keys(secondaryAllocations).sort();
            const newStartDate = allocatedDates.length > 0 ? allocatedDates[0] : secondaryProj.startDate;
            const newEndDate = allocatedDates.length > 0 ? allocatedDates[allocatedDates.length - 1] : secondaryProj.endDate;
            
            return {
              priorityProject: {
                id: priorityProj.id,
                name: priorityProj.name,
                allocations: priorityDays,
                modified: false
              },
              secondaryProject: {
                id: secondaryProj.id,
                name: secondaryProj.name,
                allocations: secondaryAllocations,
                newStartDate: newStartDate,
                newEndDate: newEndDate,
                modified: true
              },
              warning: warningMessage,
              daysAllocated: daysAllocated,
              daysNeeded: totalDaysNeeded
            };
          };

          const resolveConflict = (conflictData, action, newDates, newSelectedDays = null) => {
            // Determina quale progetto stiamo modificando
            const targetProjectId = action === 'modify1' ? conflictData.project1.id : conflictData.project2.id;
            const targetProjectName = action === 'modify1' ? conflictData.project1.name : conflictData.project2.name;
            
            // Se newSelectedDays non √® fornito, usa solo le date
            const daysToAllocate = newSelectedDays || {};
            
            // V√©rifier conflits avec autres projets (syst√®me intelligent)
            const conflicts = getConflictingProjects(daysToAllocate, targetProjectId);
            
            if (Object.keys(conflicts).length > 0) {
              // Conflits d√©tect√©s - montrer modal de confirmation
              setConflictWarningData({
                days: conflicts,
                affectedProjects: [...new Set(Object.values(conflicts).flatMap(arr => arr.map(a => a.projectName)))],
                currentProject: targetProjectName
              });
              
              // Sauvegarder l'action √† ex√©cuter apr√®s confirmation
              setPendingAllocationAction(() => () => {
                // Appliquer les modifications avec gestion des conflits
                handleConflictConfirmation(conflicts, daysToAllocate, { id: targetProjectId });
                
                // Finaliser la modification du projet
                const updatedProjects = projects.map(p => {
                  if (p.id === targetProjectId) {
                    return { 
                      ...p, 
                      startDate: newDates.startDate, 
                      endDate: newDates.endDate,
                      selectedDates: daysToAllocate
                    };
                  }
                  return p;
                });
                
                setProjects(updatedProjects);
                setShowConflictModal(false);
                setConflictToResolve(null);
              });
              
              setShowConflictWarningModal(true);
            } else {
              // Pas de conflits - appliquer directement
              if (action === 'modify1') {
                const updatedProjects = projects.map(p => 
                  p.id === conflictData.project1.id 
                    ? { ...p, startDate: newDates.startDate, endDate: newDates.endDate, selectedDates: daysToAllocate }
                    : p
                );
                setProjects(updatedProjects);
              } else if (action === 'modify2') {
                const updatedProjects = projects.map(p => 
                  p.id === conflictData.project2.id 
                    ? { ...p, startDate: newDates.startDate, endDate: newDates.endDate, selectedDates: daysToAllocate }
                    : p
                );
                setProjects(updatedProjects);
              }
              setShowConflictModal(false);
              setConflictToResolve(null);
            }
          };
          
          // Fonctions pour allocation mensuelle d√©taill√©e
          const getProjectMonths = () => {
            if (!formData.startDate || !formData.endDate) return [];
            const start = new Date(formData.startDate);
            const end = new Date(formData.endDate);
            const months = [];
            let current = new Date(start.getFullYear(), start.getMonth(), 1);
            
            while (current <= end) {
              months.push({
                key: `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`,
                label: current.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }),
                year: current.getFullYear(),
                month: current.getMonth()
              });
              current.setMonth(current.getMonth() + 1);
            }
            return months;
          };
          
          const formatDateKey = (year, month, day) => {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          };
          
          const toggleDateSelection = (dateKey) => {
            setMonthlyAllocationData(prev => {
              const currentValue = prev.selectedDates[dateKey] || 0;
              const newValue = currentValue === 0 ? 0.5 : currentValue === 0.5 ? 1.0 : 0;
              const newDates = { ...prev.selectedDates };
              
              if (newValue === 0) {
                delete newDates[dateKey];
              } else {
                newDates[dateKey] = newValue;
              }
              
              return { ...prev, selectedDates: newDates };
            });
          };
          
          const getSelectedDatesCount = () => {
            return Object.values(monthlyAllocationData.selectedDates).reduce((sum, val) => sum + val, 0);
          };
          
          const getDatesInMonth = (year, month) => {
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            return Object.entries(monthlyAllocationData.selectedDates)
              .filter(([date]) => date.startsWith(monthKey))
              .reduce((sum, [, value]) => sum + value, 0);
          };
          
          // Funzione per applicare selezione range date
          const applyDateRange = () => {
            if (!rangeStartDate || !rangeEndDate) {
              alert('‚ö†Ô∏è Veuillez s√©lectionner une date de d√©but et une date de fin');
              return;
            }
            
            const start = new Date(rangeStartDate);
            const end = new Date(rangeEndDate);
            
            if (start > end) {
              alert('‚ö†Ô∏è La date de d√©but doit √™tre ant√©rieure √† la date de fin');
              return;
            }
            
            const newDates = { ...monthlyAllocationData.selectedDates };
            const currentDate = new Date(start);
            
            while (currentDate <= end) {
              const dayOfWeek = currentDate.getDay(); // 0 = Dimanche, 6 = Samedi
              
              // Se rangeWorkdaysOnly √® true, salta weekend
              if (rangeWorkdaysOnly && (dayOfWeek === 0 || dayOfWeek === 6)) {
                currentDate.setDate(currentDate.getDate() + 1);
                continue;
              }
              
              // Formatta data come 'YYYY-MM-DD'
              const dateKey = currentDate.toISOString().split('T')[0];
              
              // Aggiungi o aggiorna la data con il tipo di allocazione selezionato
              newDates[dateKey] = rangeAllocationType;
              
              currentDate.setDate(currentDate.getDate() + 1);
            }
            
            setMonthlyAllocationData(prev => ({
              ...prev,
              selectedDates: newDates
            }));
            
            // Calcola quanti giorni sono stati selezionati
            const totalSelected = Object.values(newDates).reduce((sum, val) => sum + val, 0);
            alert(`‚úÖ Range appliqu√©! ${totalSelected} jour${totalSelected !== 1 ? 's' : ''} s√©lectionn√©${totalSelected !== 1 ? 's' : ''}`);
          };
          
          const openMonthlyAllocationModal = (resourceId, resourceName, resourceType) => {
            const totalDays = resourceType === 'engineer' 
              ? (formData.engineerDays[resourceId] || 0)
              : resourceType === 'resource'
              ? (formData.resourceDays[resourceId] || 0)
              : (formData.genericResourceDays[resourceId] || 0);
            
            const existingAllocation = resourceType === 'engineer'
              ? (formData.engineerMonthlyAllocation[resourceId])
              : resourceType === 'resource'
              ? (formData.resourceMonthlyAllocation[resourceId])
              : (formData.genericResourceMonthlyAllocation[resourceId]);
            
            // Converti vecchio formato (array) in nuovo formato (oggetto) se necessario
            let selectedDates = {};
            if (existingAllocation) {
              if (Array.isArray(existingAllocation)) {
                // Vecchio formato: array di date, converti in oggetto con valore 1.0
                existingAllocation.forEach(date => {
                  selectedDates[date] = 1.0;
                });
              } else {
                // Nuovo formato: gi√† un oggetto
                selectedDates = { ...existingAllocation };
              }
            }
            
            setMonthlyAllocationData({
              resourceId,
              resourceName,
              resourceType,
              totalDays,
              selectedDates
            });
            
            // Inizializza date range con date del progetto
            setRangeStartDate(formData.startDate || '');
            setRangeEndDate(formData.endDate || '');
            setRangeWorkdaysOnly(true);
            setRangeAllocationType(1.0);
            
            setShowMonthlyAllocationModal(true);
          };
          
          const saveMonthlyAllocation = () => {
            const total = getSelectedDatesCount();
            if (total !== monthlyAllocationData.totalDays) {
              alert(`‚ùå Erreur: Le nombre de jours s√©lectionn√©s (${total}j) ne correspond pas au total (${monthlyAllocationData.totalDays}j)`);
              return;
            }
            
            const { resourceId, resourceType, selectedDates } = monthlyAllocationData;
            
            if (resourceType === 'engineer') {
              setFormData(prev => ({
                ...prev,
                engineerMonthlyAllocation: {
                  ...prev.engineerMonthlyAllocation,
                  [resourceId]: selectedDates
                }
              }));
            } else if (resourceType === 'resource') {
              setFormData(prev => ({
                ...prev,
                resourceMonthlyAllocation: {
                  ...prev.resourceMonthlyAllocation,
                  [resourceId]: selectedDates
                }
              }));
            } else {
              setFormData(prev => ({
                ...prev,
                genericResourceMonthlyAllocation: {
                  ...prev.genericResourceMonthlyAllocation,
                  [resourceId]: selectedDates
                }
              }));
            }
            
            setShowMonthlyAllocationModal(false);
          };
          
          const clearMonthlyAllocation = (resourceId, resourceType) => {
            if (resourceType === 'engineer') {
              setFormData(prev => {
                const newAllocation = { ...prev.engineerMonthlyAllocation };
                delete newAllocation[resourceId];
                return { ...prev, engineerMonthlyAllocation: newAllocation };
              });
            } else if (resourceType === 'resource') {
              setFormData(prev => {
                const newAllocation = { ...prev.resourceMonthlyAllocation };
                delete newAllocation[resourceId];
                return { ...prev, resourceMonthlyAllocation: newAllocation };
              });
            } else {
              setFormData(prev => {
                const newAllocation = { ...prev.genericResourceMonthlyAllocation };
                delete newAllocation[resourceId];
                return { ...prev, genericResourceMonthlyAllocation: newAllocation };
              });
            }
          };

          // Swipe functions for mobile
          const handleTouchStart = (e, projectId) => {
            setSwipeStart(e.touches[0].clientX);
          };

          const handleTouchMove = (e, projectId) => {
            if (!swipeStart) return;
            const currentX = e.touches[0].clientX;
            const diff = swipeStart - currentX;
            
            if (Math.abs(diff) > 50) {
              if (diff > 0) {
                setSwipedProject(projectId);
              } else {
                setSwipedProject(null);
              }
            }
          };

          const handleTouchEnd = () => {
            setSwipeStart(null);
          };

          // Funzioni per Vista Carico di Lavoro
          const getResourceWorkload = () => {
            const workload = [];

            engineers.forEach(eng => {
              const assignedProjects = projects.filter(p => (p.selectedEngineers || []).includes(eng.id));
              const totalDays = assignedProjects.reduce((sum, p) => sum + (p.engineerDays?.[eng.id] || 0), 0);
              workload.push({
                id: eng.id,
                name: eng.name,
                type: 'Ing√©nieur',
                specialty: eng.specialty,
                projects: assignedProjects.map(p => ({
                  name: p.name,
                  days: p.engineerDays?.[eng.id] || 0,
                  startDate: p.startDate,
                  endDate: p.endDate,
                  status: p.status
                })),
                totalDays
              });
            });

            resources.forEach(res => {
              const assignedProjects = projects.filter(p => (p.selectedResources || []).includes(res.id));
              const totalDays = assignedProjects.reduce((sum, p) => sum + (p.resourceDays?.[res.id] || 0), 0);
              workload.push({
                id: res.id,
                name: res.name,
                type: 'Ressource',
                specialty: res.type,
                projects: assignedProjects.map(p => ({
                  name: p.name,
                  days: p.resourceDays?.[res.id] || 0,
                  startDate: p.startDate,
                  endDate: p.endDate,
                  status: p.status
                })),
                totalDays
              });
            });

            genericResources.forEach(gen => {
              const assignedProjects = projects.filter(p => (p.selectedGenericResources || []).includes(gen.id));
              const totalDays = assignedProjects.reduce((sum, p) => sum + (p.genericResourceDays?.[gen.id] || 0), 0);
              workload.push({
                id: gen.id,
                name: gen.name,
                type: 'Ressource G√©n√©rique',
                specialty: gen.type,
                projects: assignedProjects.map(p => ({
                  name: p.name,
                  days: p.genericResourceDays?.[gen.id] || 0,
                  startDate: p.startDate,
                  endDate: p.endDate,
                  status: p.status
                })),
                totalDays
              });
            });

            return workload;
          };

          const resetProjectForm = () => {
            setFormData({ 
              name: '', status: 'probable', description: '', 
              selectedEngineers: [], selectedResources: [], selectedGenericResources: [], 
              engineerDays: {}, resourceDays: {}, genericResourceDays: {},
              engineerMonthlyAllocation: {}, resourceMonthlyAllocation: {}, genericResourceMonthlyAllocation: {},
              projectManager: '', startDate: '', endDate: '', 
              tags: { client: [], type: [], priority: [] } 
            });
            setShowProjectForm(false);
            setEditingProject(null);
          };

          const startEdit = (project) => {
            setEditingProject(project);
            setFormData({
              ...project,
              engineerDays: project.engineerDays || {},
              resourceDays: project.resourceDays || {},
              genericResourceDays: project.genericResourceDays || {},
              engineerMonthlyAllocation: project.engineerMonthlyAllocation || {},
              resourceMonthlyAllocation: project.resourceMonthlyAllocation || {},
              genericResourceMonthlyAllocation: project.genericResourceMonthlyAllocation || {}
            });
            setShowProjectForm(true);
          };

          const calculateWorkDays = (startDate, endDate) => {
            if (!startDate || !endDate) return 0;
            const start = new Date(startDate);
            const end = new Date(endDate);
            return Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
          };

          const checkResourceConflict = (resourceId, resourceType, startDate, endDate, currentProjectId = null) => {
            if (!startDate || !endDate) return [];
            
            // Crea oggetto temporaneo per il progetto corrente (per usare checkActualDaysOverlap)
            const currentProject = {
              startDate,
              endDate,
              selectedDates: {} // Non ha selectedDates perch√© √® in fase di creazione/modifica
            };
            
            return projects.filter(p => {
              if (p.id === currentProjectId || !p.startDate || !p.endDate) return false;
              const hasResource = resourceType === 'engineer' ? (p.selectedEngineers || []).includes(resourceId)
                : resourceType === 'resource' ? (p.selectedResources || []).includes(resourceId)
                : (p.selectedGenericResources || []).includes(resourceId);
              
              if (!hasResource) return false;
              
              // Usa checkActualDaysOverlap per controllo intelligente
              return checkActualDaysOverlap(currentProject, p);
            });
          };

          const toggleEngineer = (engineerId) => {
            setFormData(prev => {
              const isSelected = (prev.selectedEngineers || []).includes(engineerId);
              const newEngineers = isSelected ? prev.selectedEngineers.filter(id => id !== engineerId) : [...(prev.selectedEngineers || []), engineerId];
              const newEngineerDays = {...prev.engineerDays};
              if (!isSelected && !newEngineerDays[engineerId]) {
                newEngineerDays[engineerId] = calculateWorkDays(prev.startDate, prev.endDate);
              } else if (isSelected) {
                delete newEngineerDays[engineerId];
              }
              return { ...prev, selectedEngineers: newEngineers, engineerDays: newEngineerDays };
            });
          };

          const toggleResource = (resourceId) => {
            setFormData(prev => {
              const isSelected = (prev.selectedResources || []).includes(resourceId);
              const newResources = isSelected ? prev.selectedResources.filter(id => id !== resourceId) : [...(prev.selectedResources || []), resourceId];
              const newResourceDays = {...prev.resourceDays};
              if (!isSelected && !newResourceDays[resourceId]) {
                newResourceDays[resourceId] = calculateWorkDays(prev.startDate, prev.endDate);
              } else if (isSelected) {
                delete newResourceDays[resourceId];
              }
              return { ...prev, selectedResources: newResources, resourceDays: newResourceDays };
            });
          };

          const toggleGenericResource = (resourceId) => {
            setFormData(prev => {
              const isSelected = (prev.selectedGenericResources || []).includes(resourceId);
              const newResources = isSelected ? prev.selectedGenericResources.filter(id => id !== resourceId) : [...(prev.selectedGenericResources || []), resourceId];
              const newGenericResourceDays = {...prev.genericResourceDays};
              if (!isSelected && !newGenericResourceDays[resourceId]) {
                newGenericResourceDays[resourceId] = calculateWorkDays(prev.startDate, prev.endDate);
              } else if (isSelected) {
                delete newGenericResourceDays[resourceId];
              }
              return { ...prev, selectedGenericResources: newResources, genericResourceDays: newGenericResourceDays };
            });
          };

          const getAssignedEngineers = (project) => engineers.filter(e => (project.selectedEngineers || []).includes(e.id));
          const getAssignedResources = (project) => resources.filter(r => (project.selectedResources || []).includes(r.id));
          const getAssignedGenericResources = (project) => genericResources.filter(r => (project.selectedGenericResources || []).includes(r.id));
          const getProjectManager = (project) => projectManagers.find(pm => pm.id === project.projectManager);

          // Calcola percentuale occupazione settimanale per una risorsa
          const calculateWeeklyOccupation = (resourceId, resourceType) => {
            let totalDays = 0;
            
            projects.forEach(project => {
              if (!project.startDate || !project.endDate) return;
              
              let days = 0;
              if (resourceType === 'engineer' && (project.selectedEngineers || []).includes(resourceId)) {
                days = project.engineerDays && project.engineerDays[resourceId] ? project.engineerDays[resourceId] : 0;
              } else if (resourceType === 'resource' && (project.selectedResources || []).includes(resourceId)) {
                days = project.resourceDays && project.resourceDays[resourceId] ? project.resourceDays[resourceId] : 0;
              } else if (resourceType === 'generic' && (project.selectedGenericResources || []).includes(resourceId)) {
                days = project.genericResourceDays && project.genericResourceDays[resourceId] ? project.genericResourceDays[resourceId] : 0;
              }
              
              if (days > 0) {
                const projectDuration = calculateWorkDays(project.startDate, project.endDate);
                const weeks = projectDuration / 5; // semaines
                const daysPerWeek = days / weeks;
                totalDays += daysPerWeek;
              }
            });
            
            const percentage = (totalDays / 5) * 100;
            return Math.round(percentage);
          };

          const exportToExcel = () => {
            let csv = '\uFEFF';
            csv += 'Projet;Statut;Date D√©but;Date Fin;Chef de Projet;Type Ressource;Nom Ressource;Sp√©cialit√©s;Jours Vendus\n';
            
            projects.forEach(project => {
              const pm = getProjectManager(project);
              const pmName = pm ? pm.name : '';
              const startDate = project.startDate ? new Date(project.startDate).toLocaleDateString('fr-FR') : '';
              const endDate = project.endDate ? new Date(project.endDate).toLocaleDateString('fr-FR') : '';
              const status = statusConfig[project.status]?.label || project.status;
              
              getAssignedEngineers(project).forEach(eng => {
                const specialties = [eng.specialty, eng.specialty2, eng.specialty3, eng.specialty4].filter(s => s).join(' / ');
                const days = project.engineerDays && project.engineerDays[eng.id] ? project.engineerDays[eng.id] : 0;
                csv += `${project.name};${status};${startDate};${endDate};${pmName};Ing√©nieur;${eng.name};${specialties};${days}\n`;
              });
              
              getAssignedResources(project).forEach(res => {
                const type = res.type || '';
                const days = project.resourceDays && project.resourceDays[res.id] ? project.resourceDays[res.id] : 0;
                csv += `${project.name};${status};${startDate};${endDate};${pmName};Ressource;${res.name};${type};${days}\n`;
              });
              
              getAssignedGenericResources(project).forEach(res => {
                const type = res.type || '';
                const days = project.genericResourceDays && project.genericResourceDays[res.id] ? project.genericResourceDays[res.id] : 0;
                csv += `${project.name};${status};${startDate};${endDate};${pmName};Ressource G√©n√©rique;${res.name};${type};${days}\n`;
              });
              
              if (getAssignedEngineers(project).length === 0 && getAssignedResources(project).length === 0 && getAssignedGenericResources(project).length === 0) {
                csv += `${project.name};${status};${startDate};${endDate};${pmName};;;;\n`;
              }
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `projets_export_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
          };

          const baseFiltered = filterStatus === 'all' ? projects : projects.filter(p => p.status === filterStatus);
          const filteredProjects = applySearchAndFilters(baseFiltered);
          const allAlerts = getAllAlerts();
          const projectsProbables = projects.filter(p => p.status === 'probable').length;
          const projectsPresente = projects.filter(p => p.status === 'presente').length;
          const projectsProgramme = projects.filter(p => p.status === 'programme').length;

          const getDaysInMonth = (month, year) => new Date(year, month + 1, 0).getDate();
          const getFirstDayOfMonth = (month, year) => new Date(year, month, 1).getDay();
          const getProjectsForDate = (day) => {
            const dateStr = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const dateProjects = projects.filter(p => {
              if (!p.startDate || !p.endDate) return false;
              if (dateStr < p.startDate || dateStr > p.endDate) return false;
              
              // V√©rifie si une ressource a une allocation d√©taill√©e pour ce jour
              let hasDetailedAllocation = false;
              let isDateIncluded = false;
              
              // V√©rifie toutes les ressources du projet
              const allResourceIds = [
                ...(p.selectedEngineers || []),
                ...(p.selectedResources || []),
                ...(p.selectedGenericResources || [])
              ];
              
              for (const resourceId of allResourceIds) {
                // Cherche allocation d√©taill√©e pour cette ressource
                let allocation = null;
                if ((p.selectedEngineers || []).includes(resourceId)) {
                  allocation = p.engineerMonthlyAllocation?.[resourceId];
                } else if ((p.selectedResources || []).includes(resourceId)) {
                  allocation = p.resourceMonthlyAllocation?.[resourceId];
                } else if ((p.selectedGenericResources || []).includes(resourceId)) {
                  allocation = p.genericResourceMonthlyAllocation?.[resourceId];
                }
                
                // Si allocation d√©taill√©e existe
                if (allocation) {
                  hasDetailedAllocation = true;
                  
                  // Gestisce sia vecchio formato (array) che nuovo formato (oggetto)
                  if (Array.isArray(allocation)) {
                    // Vecchio formato: array di stringhe di date
                    if (allocation.includes(dateStr)) {
                      isDateIncluded = true;
                      break;
                    }
                  } else if (typeof allocation === 'object') {
                    // Nuovo formato: oggetto { '2026-01-05': 1.0, '2026-01-12': 0.5 }
                    if (allocation[dateStr] && allocation[dateStr] > 0) {
                      isDateIncluded = true;
                      break;
                    }
                  }
                }
              }
              
              // Si pas d'allocation d√©taill√©e, afficher comme avant
              // Si allocation d√©taill√©e, afficher seulement si date incluse
              return hasDetailedAllocation ? isDateIncluded : true;
            });
            
            return filterCalendarStatus === 'all' ? dateProjects : dateProjects.filter(p => p.status === filterCalendarStatus);
          };

          // Timeline functions
          const getQuarterMonths = (quarter, year) => {
            const startMonth = quarter * 3;
            return [0, 1, 2].map(i => new Date(year, startMonth + i, 1));
          };

          const getQuarterProjects = () => {
            const months = getQuarterMonths(timelineQuarter, timelineYear);
            const quarterStart = months[0].toISOString().split('T')[0];
            const quarterEnd = new Date(months[2].getFullYear(), months[2].getMonth() + 1, 0).toISOString().split('T')[0];
            
            const filteredProjects = projects.filter(p => {
              if (!p.startDate || !p.endDate) return false;
              return p.startDate <= quarterEnd && p.endDate >= quarterStart;
            });
            
            return filterCalendarStatus === 'all' ? filteredProjects : filteredProjects.filter(p => p.status === filterCalendarStatus);
          };

          const getProjectPosition = (project, quarterStart, quarterEnd) => {
            const start = new Date(Math.max(new Date(project.startDate), new Date(quarterStart)));
            const end = new Date(Math.min(new Date(project.endDate), new Date(quarterEnd)));
            const quarterStartDate = new Date(quarterStart);
            const quarterEndDate = new Date(quarterEnd);
            
            const totalDays = (quarterEndDate - quarterStartDate) / (1000 * 60 * 60 * 24);
            const startOffset = (start - quarterStartDate) / (1000 * 60 * 60 * 24);
            const duration = (end - start) / (1000 * 60 * 60 * 24) + 1;
            
            return {
              left: (startOffset / totalDays) * 100,
              width: (duration / totalDays) * 100
            };
          };

          const renderCalendar = () => {
            const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
            const firstDay = getFirstDayOfMonth(selectedMonth, selectedYear);
            const days = [];
            const weekDays = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

            for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="p-2"></div>);

            for (let day = 1; day <= daysInMonth; day++) {
              const projectsOnDay = getProjectsForDate(day);
              
              // Count resources by type for sub-badges
              const resourceCounts = { engineers: 0, resources: 0, generic: 0, pm: 0 };
              projectsOnDay.forEach(p => {
                if (p.selectedEngineers) resourceCounts.engineers += p.selectedEngineers.length;
                if (p.selectedResources) resourceCounts.resources += p.selectedResources.length;
                if (p.selectedGenericResources) resourceCounts.generic += p.selectedGenericResources.length;
                if (p.projectManager) resourceCounts.pm += 1;
              });
              
              days.push(
                <div key={day} onClick={() => { setSelectedDayProjects({ day, month: selectedMonth, year: selectedYear, projects: projectsOnDay }); setShowDayModal(true); }} className="border border-gray-200 p-2 min-h-32 bg-white hover:bg-blue-50 cursor-pointer transition-colors" title={projectsOnDay.length > 0 ? `${projectsOnDay.length} projet(s) - Cliquer pour d√©tails` : ''}>
                  <div className="font-semibold text-gray-700 mb-1 flex justify-between items-center">
                    <span>{day}</span>
                    {projectsOnDay.length > 0 && (
                      <span className="text-xs bg-indigo-600 text-white rounded-full px-2 py-0.5">{projectsOnDay.length}</span>
                    )}
                  </div>
                  <div className="space-y-1 max-h-16 overflow-y-auto">
                    {projectsOnDay.slice(0, 3).map(project => (
                      <div key={project.id} className={`text-xs px-2 py-1 rounded truncate ${statusConfig[project.status]?.calendarColor || 'bg-gray-100 text-gray-800'}`} title={`${project.name} - ${statusConfig[project.status]?.label || project.status}`}>
                        {project.name}
                      </div>
                    ))}
                    {projectsOnDay.length > 3 && (
                      <div className="text-xs text-gray-500 text-center">+{projectsOnDay.length - 3} autre(s)</div>
                    )}
                  </div>
                  {projectsOnDay.length > 0 && (
                    <div className="mt-2 pt-1 border-t border-gray-200 flex gap-1 flex-wrap">
                      {resourceCounts.pm > 0 && <span className="text-xs bg-orange-100 text-orange-700 px-1 rounded" title="Chefs de projet">üë§{resourceCounts.pm}</span>}
                      {resourceCounts.engineers > 0 && <span className="text-xs bg-indigo-100 text-indigo-700 px-1 rounded" title="Ing√©nieurs">üîß{resourceCounts.engineers}</span>}
                      {resourceCounts.resources > 0 && <span className="text-xs bg-purple-100 text-purple-700 px-1 rounded" title="Ressources">üì¶{resourceCounts.resources}</span>}
                      {resourceCounts.generic > 0 && <span className="text-xs bg-teal-100 text-teal-700 px-1 rounded" title="G√©n√©riques">‚öôÔ∏è{resourceCounts.generic}</span>}
                    </div>
                  )}
                </div>
              );
            }

            return (
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex justify-between items-center mb-4">
                  <button onClick={() => { if (selectedMonth === 0) { setSelectedMonth(11); setSelectedYear(selectedYear - 1); } else { setSelectedMonth(selectedMonth - 1); } }} className="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">‚Üê</button>
                  <h2 className="text-xl font-bold text-gray-800">{new Date(selectedYear, selectedMonth).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h2>
                  <button onClick={() => { if (selectedMonth === 11) { setSelectedMonth(0); setSelectedYear(selectedYear + 1); } else { setSelectedMonth(selectedMonth + 1); } }} className="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">‚Üí</button>
                </div>
                <div className="grid grid-cols-7 gap-1">
                  {weekDays.map(day => <div key={day} className="text-center font-semibold text-gray-700 p-2">{day}</div>)}
                  {days}
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
              <div className="max-w-7xl mx-auto">
                <div className="mb-8">
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <h1 className="text-4xl font-bold text-gray-800 mb-2">Gestion des √âquipes Ing√©</h1>
                      <p className="text-gray-600">Askida Broadcast</p>
                    </div>
                    <div className="flex items-center gap-3">
                      {/* Badge Utente */}
                      <div className={`px-4 py-2 rounded-lg shadow-md font-semibold text-sm flex items-center gap-2 ${
                        userRole === 'admin' 
                          ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white' 
                          : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white'
                      }`}>
                        <span className="text-xl">{userRole === 'admin' ? 'üëë' : 'üëÅÔ∏è'}</span>
                        <div>
                          <div className="text-xs opacity-90">
                            {userRole === 'admin' ? 'Administrateur' : 'Lecteur'}
                          </div>
                          <div className="font-bold">{currentUser}</div>
                        </div>
                      </div>
                      
                      {/* OneDrive Status/Connection */}
                      {oneDriveError && (
                        <div className="bg-red-100 text-red-800 px-3 py-2 rounded-lg shadow-md font-semibold text-xs flex items-center gap-2">
                          <span>‚ö†Ô∏è</span>
                          <span className="hidden md:inline">Erreur Drive</span>
                        </div>
                      )}
                      
                      {isOneDriveReady && !isOneDriveConnected && (
                        <button 
                          onClick={signInOneDrive}
                          className="bg-white hover:bg-blue-50 text-blue-600 px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all font-semibold text-sm flex items-center gap-2"
                          title="Connecter OneDrive"
                        >
                          <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                          </svg>
                          <span className="hidden md:inline">Connecter OneDrive</span>
                        </button>
                      )}
                      
                      {isOneDriveConnected && (
                        <div className="flex items-center gap-2">
                          <div className="bg-green-500 text-white px-3 py-2 rounded-lg shadow-md font-semibold text-xs flex items-center gap-2">
                            <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            <span>Drive</span>
                          </div>
                          <button 
                            onClick={signOutOneDrive}
                            className="bg-white hover:bg-gray-100 text-gray-600 px-2 py-2 rounded-lg shadow-md hover:shadow-lg transition-all text-xs"
                            title="D√©connecter Drive"
                          >
                            ‚úï
                          </button>
                        </div>
                      )}
                      
                      {/* Bottone Logout */}
                      <button 
                        onClick={() => {
                          sessionStorage.clear();
                          location.reload();
                        }}
                        className="bg-white hover:bg-red-50 text-red-600 px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all font-semibold text-sm flex items-center gap-2"
                        title="D√©connexion"
                      >
                        <span>üö™</span>
                        <span className="hidden md:inline">D√©connexion</span>
                      </button>
                      
                      {/* Alerts */}
                      <button onClick={() => setShowAlerts(!showAlerts)} className="relative bg-white p-3 rounded-lg shadow hover:shadow-lg transition-all">
                        <Bell size={24} className={allAlerts.length > 0 ? 'text-red-600' : 'text-gray-600'} />
                        {allAlerts.length > 0 && (
                          <span className="absolute -top-1 -right-1 bg-red-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">
                            {allAlerts.length}
                          </span>
                        )}
                      </button>
                    </div>
                  </div>

                  {/* Banner Mode Lecture Seule */}
                  {isReadOnly && (
                    <div className="bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-400 rounded-lg p-3 mb-4 flex items-center gap-3 shadow-md">
                      <span className="text-2xl">‚ö†Ô∏è</span>
                      <div>
                        <div className="font-bold text-yellow-900">Mode Lecture Seule</div>
                        <div className="text-sm text-yellow-800">Vous pouvez consulter tous les projets mais vous ne pouvez pas les modifier</div>
                      </div>
                    </div>
                  )}

                  {/* Banner Errore OneDrive */}
                  {oneDriveError && (
                    <div className="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-400 rounded-lg p-4 mb-4 shadow-md">
                      <div className="flex items-start gap-3">
                        <span className="text-3xl">‚ö†Ô∏è</span>
                        <div className="flex-1">
                          <div className="font-bold text-red-900 mb-2">Erreur de chargement OneDrive</div>
                          <div className="text-sm text-red-800 mb-3">{oneDriveError}</div>
                          <div className="bg-red-100 border border-red-300 rounded-lg p-3 mb-3 text-sm">
                            <div className="font-semibold text-red-900 mb-2">üí° Solutions possibles:</div>
                            <ul className="text-red-800 space-y-1 list-disc list-inside">
                              <li>V√©rifier votre connexion internet</li>
                              <li>D√©sactiver les bloqueurs de publicit√©s/extensions</li>
                              <li>Ouvrir la <strong>Console</strong> (F12) et chercher erreurs rouges</li>
                              <li>Essayer un autre navigateur (Chrome, Firefox)</li>
                              <li>Vider le cache du navigateur (Ctrl+Shift+Delete)</li>
                            </ul>
                          </div>
                          <div className="text-sm text-red-700 mb-3">
                            <strong>Note:</strong> L'application fonctionne sans OneDrive, mais les donn√©es ne seront pas synchronis√©es entre appareils.
                          </div>
                          <button 
                            onClick={() => {
                              setOneDriveError(null);
                              location.reload();
                            }}
                            className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm"
                          >
                            üîÑ R√©essayer
                          </button>
                        </div>
                        <button 
                          onClick={() => setOneDriveError(null)}
                          className="text-red-400 hover:text-red-600"
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                          </svg>
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Barra di ricerca e filtri */}
                  <div className="bg-white rounded-lg shadow p-3 md:p-4 mb-3 md:mb-4">
                    <div className="flex gap-2 md:gap-3 flex-wrap items-end">
                      <div className="flex-1 min-w-full md:min-w-64">
                        <label className="block text-xs md:text-sm font-semibold text-gray-700 mb-1">
                          <Search size={14} className="inline mr-1" /> Recherche
                        </label>
                        <input 
                          type="text" 
                          placeholder="Rechercher..." 
                          value={searchQuery}
                          onChange={(e) => setSearchQuery(e.target.value)}
                          className="w-full border rounded px-2 md:px-3 py-1.5 md:py-2 text-sm"
                        />
                      </div>
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date d√©but</label>
                        <input 
                          type="date" 
                          value={advancedFilters.dateStart}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, dateStart: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        />
                      </div>
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date fin</label>
                        <input 
                          type="date" 
                          value={advancedFilters.dateEnd}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, dateEnd: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        />
                      </div>
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Ressource</label>
                        <select 
                          value={advancedFilters.resourceId}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, resourceId: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        >
                          <option value="">Toutes</option>
                          <optgroup label="Ing√©nieurs">
                            {engineers.filter(e => projects.some(p => (p.selectedEngineers || []).includes(e.id))).map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                          </optgroup>
                          <optgroup label="Ressources">
                            {resources.filter(r => projects.some(p => (p.selectedResources || []).includes(r.id))).map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                          </optgroup>
                          <optgroup label="G√©n√©riques">
                            {genericResources.filter(g => projects.some(p => (p.selectedGenericResources || []).includes(g.id))).map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                          </optgroup>
                        </select>
                      </div>
                      <div className="flex-1 min-w-48">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Chef de projet</label>
                        <select 
                          value={advancedFilters.pmId}
                          onChange={(e) => setAdvancedFilters({...advancedFilters, pmId: e.target.value})}
                          className="w-full border rounded px-3 py-2"
                        >
                          <option value="">Tous</option>
                          {projectManagers.map(pm => <option key={pm.id} value={pm.id}>{pm.name}</option>)}
                        </select>
                      </div>
                      <div className="w-full md:col-span-5">
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Filtrer par tags</label>
                        <div className="flex flex-wrap gap-2 p-2 border rounded bg-gray-50 min-h-10">
                          {[...availableTags.client.map(t => ({t, c:'client'})), ...availableTags.type.map(t => ({t, c:'type'})), ...availableTags.priority.map(t => ({t, c:'priority'}))].map(({t, c}) => (
                            <button key={t} onClick={() => toggleFilterTag(t)} className={`px-3 py-1 rounded-full text-sm border ${(advancedFilters.tags || []).includes(t) ? getTagColor(c) + ' border-current font-semibold' : 'bg-white text-gray-600 border-gray-300'}`}>
                              {t}
                            </button>
                          ))}
                        </div>
                      </div>
                      <button onClick={resetFilters} className="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold whitespace-nowrap">
                        R√©initialiser
                      </button>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                  <div onClick={() => setFilterCalendarStatus('probable')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'probable' ? 'ring-4 ring-yellow-400' : ''}`}><p className="text-sm text-gray-600">Probables</p><p className="text-3xl font-bold text-yellow-600">{projectsProbables}</p></div>
                  <div onClick={() => setFilterCalendarStatus('presente')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'presente' ? 'ring-4 ring-blue-400' : ''}`}><p className="text-sm text-gray-600">Dummy</p><p className="text-3xl font-bold text-blue-600">{projectsPresente}</p></div>
                  <div onClick={() => setFilterCalendarStatus('programme')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'programme' ? 'ring-4 ring-green-400' : ''}`}><p className="text-sm text-gray-600">Programm√©s</p><p className="text-3xl font-bold text-green-600">{projectsProgramme}</p></div>
                  <div onClick={() => setFilterCalendarStatus('all')} className={`bg-white rounded-lg shadow p-4 cursor-pointer hover:shadow-lg transition-all ${filterCalendarStatus === 'all' ? 'ring-4 ring-indigo-400' : ''}`}><p className="text-sm text-gray-600">All Projets</p><p className="text-3xl font-bold text-indigo-600">{projects.length}</p></div>
                </div>

                <div className="mb-4 md:mb-6 hidden md:flex gap-2 flex-wrap">
                  <button onClick={() => setActiveTab('projects')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'projects' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}><Briefcase /> Projets</button>
                  <button onClick={() => setActiveTab('calendar')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'calendar' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}><Calendar /> Calendrier</button>
                  <button onClick={() => setActiveTab('timeline')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'timeline' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}><BarChart /> Timeline</button>
                  <button onClick={() => setActiveTab('resource')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'resource' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}><User /> Vue Ressource</button>
                  <button onClick={() => setActiveTab('team')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'team' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}><Users /> √âquipe</button>
                  <button onClick={() => setActiveTab('stats')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'stats' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}><BarChart /> Statistiques</button>
                  <button onClick={() => setActiveTab('export')} className={`px-4 py-2 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'export' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}><Download /> Export</button>
                </div>

                {mobileMenuOpen && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 z-50 md:hidden" onClick={() => setMobileMenuOpen(false)}>
                    <div className="bg-white w-64 h-full shadow-xl p-4" onClick={(e) => e.stopPropagation()}>
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold text-gray-800">Menu</h2>
                        <button onClick={() => setMobileMenuOpen(false)} className="text-gray-500">
                          <X size={24} />
                        </button>
                      </div>
                      <div className="space-y-2">
                        <button onClick={() => { setActiveTab('projects'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'projects' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`}><Briefcase /> Projets</button>
                        <button onClick={() => { setActiveTab('calendar'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'calendar' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`}><Calendar /> Calendrier</button>
                        <button onClick={() => { setActiveTab('timeline'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'timeline' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`}><BarChart /> Timeline</button>
                        <button onClick={() => { setActiveTab('resource'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'resource' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`}><User /> Vue Ressource</button>
                        <button onClick={() => { setActiveTab('team'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'team' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`}><Users /> √âquipe</button>
                        <button onClick={() => { setActiveTab('stats'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'stats' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`}><BarChart /> Statistiques</button>
                        <button onClick={() => { setActiveTab('export'); setMobileMenuOpen(false); }} className={`w-full px-4 py-3 rounded-lg font-semibold flex items-center gap-2 ${activeTab === 'export' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}`}><Download /> Export</button>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'projects' && (
                  <div>
                    <div className="flex gap-3 mb-6 flex-wrap">
                      {!isReadOnly && (
                        <button onClick={() => setShowProjectForm(true)} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-semibold"><Plus /> Nouveau Projet</button>
                      )}
                      {['all', 'probable', 'presente', 'programme'].map(status => (
                        <button key={status} onClick={() => setFilterStatus(status)} className={`px-4 py-2 rounded-lg font-medium ${filterStatus === status ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 border'}`}>
                          {status === 'all' ? 'Tous' : statusConfig[status]?.label || status}
                        </button>
                      ))}
                    </div>
                    <div className="space-y-4">
                      {filteredProjects.length === 0 ? (
                        <div className="bg-white rounded-lg shadow p-8 text-center"><p className="text-gray-500">Aucun projet trouv√©</p></div>
                      ) : (
                        filteredProjects.map(project => (
                          <div 
                            key={project.id} 
                            className="bg-white rounded-lg shadow-md p-3 md:p-6 relative overflow-hidden transition-transform touch-pan-y"
                            onTouchStart={(e) => handleTouchStart(e, project.id)}
                            onTouchMove={(e) => handleTouchMove(e, project.id)}
                            onTouchEnd={handleTouchEnd}
                            style={swipedProject === project.id ? {transform: 'translateX(-80px)'} : {}}
                          >
                            {swipedProject === project.id && (
                              <div className="absolute right-0 top-0 bottom-0 w-20 flex items-center justify-center bg-red-500 md:hidden">
                                <button onClick={() => { deleteProject(project.id); setSwipedProject(null); }} className="text-white">
                                  <Trash2 size={24} />
                                </button>
                              </div>
                            )}
                            <div>
                            <div className="flex justify-between items-start mb-2 md:mb-3">
                              <div className="flex-1">
                                <h3 className="text-base md:text-xl font-bold text-gray-800">{project.name}</h3>
                                {project.description && <p className="text-gray-600 text-sm mt-1">{project.description}</p>}
                                {(project.startDate || project.endDate) && (
                                  <p className="text-gray-500 text-sm mt-1">
                                    {project.startDate && `Du ${new Date(project.startDate).toLocaleDateString('fr-FR')}`}
                                    {project.startDate && project.endDate && ' - '}
                                    {project.endDate && `au ${new Date(project.endDate).toLocaleDateString('fr-FR')}`}
                                  </p>
                                )}
                                {project.tags && ([...(project.tags.client || []), ...(project.tags.type || []), ...(project.tags.priority || [])].length > 0) && (
                                  <div className="flex flex-wrap gap-1 mt-2">
                                    {(project.tags.client || []).map(tag => (
                                      <span key={tag} className="px-2 py-0.5 rounded-full text-xs bg-blue-100 text-blue-800 border border-blue-300">{tag}</span>
                                    ))}
                                    {(project.tags.type || []).map(tag => (
                                      <span key={tag} className="px-2 py-0.5 rounded-full text-xs bg-purple-100 text-purple-800 border border-purple-300">{tag}</span>
                                    ))}
                                    {(project.tags.priority || []).map(tag => (
                                      <span key={tag} className="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 border border-red-300">{tag}</span>
                                    ))}
                                  </div>
                                )}
                              </div>
                              <span className={`px-3 py-1 rounded-full text-sm font-semibold ${statusConfig[project.status]?.color || 'bg-gray-100 text-gray-800'}`}>
                                {statusConfig[project.status]?.label || project.status}
                              </span>
                            </div>
                            {getProjectManager(project) && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-1">Chef de projet :</p>
                                <div className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm inline-flex items-center gap-2">
                                  <UserCog size={14} /> {getProjectManager(project).name} {getProjectManager(project).department && `(${getProjectManager(project).department})`}
                                </div>
                              </div>
                            )}
                            {getAssignedEngineers(project).length > 0 && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-2">Ing√©nieurs :</p>
                                <div className="flex flex-wrap gap-2">
                                  {getAssignedEngineers(project).map(eng => (
                                    <div key={eng.id} className="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm">
                                      {eng.name} {eng.specialty && `(${eng.specialty})`}
                                      {project.engineerDays && project.engineerDays[eng.id] ? ` - ${project.engineerDays[eng.id]}j` : ''}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            {getAssignedResources(project).length > 0 && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-2">Ressources :</p>
                                <div className="flex flex-wrap gap-2">
                                  {getAssignedResources(project).map(res => (
                                    <div key={res.id} className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm">
                                      {res.name} {res.type && `(${res.type})`}
                                      {project.resourceDays && project.resourceDays[res.id] ? ` - ${project.resourceDays[res.id]}j` : ''}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            {getAssignedGenericResources(project).length > 0 && (
                              <div className="mt-3 pb-3 border-b">
                                <p className="text-sm font-semibold text-gray-700 mb-2">Ressources G√©n√©riques :</p>
                                <div className="flex flex-wrap gap-2">
                                  {getAssignedGenericResources(project).map(res => (
                                    <div key={res.id} className="bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-sm">
                                      {res.name} {res.type && `(${res.type})`}
                                      {project.genericResourceDays && project.genericResourceDays[res.id] ? ` - ${project.genericResourceDays[res.id]}j` : ''}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                            {!isReadOnly && (
                              <div className="flex gap-2 mt-4">
                                <button onClick={() => startEdit(project)} className="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-600 px-2 md:px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-1 md:gap-2 text-sm md:text-base"><Edit2 size={14} className="md:w-4 md:h-4" /> <span className="hidden sm:inline">Modifier</span><span className="sm:hidden">Mod.</span></button>
                                <button onClick={() => deleteProject(project.id)} className="flex-1 bg-red-50 hover:bg-red-100 text-red-600 px-2 md:px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-1 md:gap-2 text-sm md:text-base"><Trash2 size={14} className="md:w-4 md:h-4" /> <span className="hidden sm:inline">Supprimer</span><span className="sm:hidden">Supp.</span></button>
                              </div>
                            )}
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                )}

                {activeTab === 'calendar' && renderCalendar()}

                {activeTab === 'timeline' && (
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                      <div>
                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                          üìà Gantt Interactif
                        </h2>
                        <p className="text-gray-600 text-sm">Glissez les projets pour modifier dates ‚Ä¢ Redimensionnez pour ajuster dur√©e</p>
                      </div>
                      
                      {/* Contr√¥les */}
                      <div className="flex flex-wrap gap-2 items-center">
                        {/* Navigation */}
                        <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                          <button 
                            onClick={() => {
                              if (ganttStartMonth === 0) {
                                setGanttStartMonth(11);
                                setGanttStartYear(ganttStartYear - 1);
                              } else {
                                setGanttStartMonth(ganttStartMonth - 1);
                              }
                            }}
                            className="px-3 py-1 bg-white hover:bg-gray-200 rounded text-sm font-semibold transition-colors"
                          >
                            ‚Üê
                          </button>
                          <span className="px-3 text-sm font-semibold text-gray-700 whitespace-nowrap">
                            {new Date(ganttStartYear, ganttStartMonth).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' })}
                          </span>
                          <button 
                            onClick={() => {
                              if (ganttStartMonth === 11) {
                                setGanttStartMonth(0);
                                setGanttStartYear(ganttStartYear + 1);
                              } else {
                                setGanttStartMonth(ganttStartMonth + 1);
                              }
                            }}
                            className="px-3 py-1 bg-white hover:bg-gray-200 rounded text-sm font-semibold transition-colors"
                          >
                            ‚Üí
                          </button>
                        </div>
                        
                        {/* Zoom */}
                        <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                          <button 
                            onClick={() => {
                              if (ganttViewMonths < 12) {
                                const newMonths = ganttViewMonths + 3;
                                setGanttViewMonths(newMonths);
                                setGanttZoom(3 / newMonths);
                              }
                            }}
                            disabled={ganttViewMonths >= 12}
                            className="px-2 py-1 bg-white hover:bg-gray-200 disabled:bg-gray-50 disabled:text-gray-400 rounded text-sm font-semibold transition-colors"
                            title="Zoom out"
                          >
                            ‚àí
                          </button>
                          <span className="px-2 text-xs font-semibold text-gray-600">{ganttViewMonths}M</span>
                          <button 
                            onClick={() => {
                              if (ganttViewMonths > 1) {
                                const newMonths = ganttViewMonths - 1;
                                setGanttViewMonths(newMonths);
                                setGanttZoom(3 / newMonths);
                              }
                            }}
                            disabled={ganttViewMonths <= 1}
                            className="px-2 py-1 bg-white hover:bg-gray-200 disabled:bg-gray-50 disabled:text-gray-400 rounded text-sm font-semibold transition-colors"
                            title="Zoom in"
                          >
                            +
                          </button>
                        </div>
                        
                        {/* Today */}
                        <button
                          onClick={() => {
                            const today = new Date();
                            setGanttStartMonth(today.getMonth());
                            setGanttStartYear(today.getFullYear());
                          }}
                          className="px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded text-sm font-semibold transition-colors"
                        >
                          Aujourd'hui
                        </button>
                      </div>
                    </div>

                    {(() => {
                      // Calcolo mesi da visualizzare
                      const months = [];
                      for (let i = 0; i < ganttViewMonths; i++) {
                        const month = new Date(ganttStartYear, ganttStartMonth + i, 1);
                        months.push(month);
                      }
                      
                      const periodStart = new Date(ganttStartYear, ganttStartMonth, 1);
                      const periodEnd = new Date(ganttStartYear, ganttStartMonth + ganttViewMonths, 0);
                      
                      // Progetti nel periodo
                      const visibleProjects = projects.filter(p => {
                        if (!p.startDate || !p.endDate) return false;
                        const pStart = new Date(p.startDate);
                        const pEnd = new Date(p.endDate);
                        return pStart <= periodEnd && pEnd >= periodStart;
                      });
                      
                      // Raggruppa per status
                      const projectsByStatus = {
                        'programme': visibleProjects.filter(p => p.status === 'programme'),
                        'presente': visibleProjects.filter(p => p.status === 'presente'),
                        'probable': visibleProjects.filter(p => p.status === 'probable')
                      };
                      
                      // Calcolo posizione progetto
                      const getPosition = (project) => {
                        const pStart = new Date(project.startDate);
                        const pEnd = new Date(project.endDate);
                        
                        const periodStartTime = periodStart.getTime();
                        const periodDuration = periodEnd.getTime() - periodStartTime;
                        
                        const projectStart = Math.max(pStart.getTime(), periodStartTime);
                        const projectEnd = Math.min(pEnd.getTime(), periodEnd.getTime());
                        
                        const left = ((projectStart - periodStartTime) / periodDuration) * 100;
                        const width = ((projectEnd - projectStart) / periodDuration) * 100;
                        
                        return { left, width };
                      };
                      
                      // Handle drag start
                      const handleDragStart = (project, e) => {
                        if (isReadOnly) return;
                        e.stopPropagation();
                        setDraggedProject(project);
                        setDragStartX(e.clientX);
                        setDragStartDate(new Date(project.startDate));
                      };
                      
                      // Handle drag
                      const handleDrag = (e) => {
                        if (!draggedProject || !dragStartDate) return;
                        
                        const container = e.currentTarget.getBoundingClientRect();
                        const deltaX = e.clientX - dragStartX;
                        const percentDelta = (deltaX / container.width) * 100;
                        
                        const periodStartTime = periodStart.getTime();
                        const periodDuration = periodEnd.getTime() - periodStartTime;
                        const timeDelta = (percentDelta / 100) * periodDuration;
                        
                        const newStart = new Date(dragStartDate.getTime() + timeDelta);
                        const duration = new Date(draggedProject.endDate).getTime() - new Date(draggedProject.startDate).getTime();
                        const newEnd = new Date(newStart.getTime() + duration);
                        
                        // Aggiorna temporaneamente (visual feedback)
                        const updatedProjects = projects.map(p => 
                          p.id === draggedProject.id 
                            ? { ...p, startDate: newStart.toISOString().split('T')[0], endDate: newEnd.toISOString().split('T')[0] }
                            : p
                        );
                        setProjects(updatedProjects);
                      };
                      
                      // Handle drag end
                      const handleDragEnd = () => {
                        setDraggedProject(null);
                        setDragStartX(0);
                        setDragStartDate(null);
                      };
                      
                      // Handle resize start
                      const handleResizeStart = (project, side, e) => {
                        if (isReadOnly) return;
                        e.stopPropagation();
                        setResizingProject(project);
                        setResizingSide(side);
                        setDragStartX(e.clientX);
                      };
                      
                      // Handle resize
                      const handleResize = (e) => {
                        if (!resizingProject) return;
                        
                        const container = e.currentTarget.getBoundingClientRect();
                        const deltaX = e.clientX - dragStartX;
                        const percentDelta = (deltaX / container.width) * 100;
                        
                        const periodStartTime = periodStart.getTime();
                        const periodDuration = periodEnd.getTime() - periodStartTime;
                        const timeDelta = (percentDelta / 100) * periodDuration;
                        
                        let newStart = new Date(resizingProject.startDate);
                        let newEnd = new Date(resizingProject.endDate);
                        
                        if (resizingSide === 'start') {
                          newStart = new Date(newStart.getTime() + timeDelta);
                          if (newStart >= newEnd) return; // Impedisci overlap
                        } else {
                          newEnd = new Date(newEnd.getTime() + timeDelta);
                          if (newEnd <= newStart) return; // Impedisci overlap
                        }
                        
                        const updatedProjects = projects.map(p => 
                          p.id === resizingProject.id 
                            ? { ...p, startDate: newStart.toISOString().split('T')[0], endDate: newEnd.toISOString().split('T')[0] }
                            : p
                        );
                        setProjects(updatedProjects);
                        setDragStartX(e.clientX);
                      };
                      
                      // Handle resize end
                      const handleResizeEnd = () => {
                        setResizingProject(null);
                        setResizingSide(null);
                      };

                      return (
                        <div 
                          className="space-y-6"
                          onMouseMove={(e) => {
                            if (draggedProject) handleDrag(e);
                            if (resizingProject) handleResize(e);
                          }}
                          onMouseUp={() => {
                            handleDragEnd();
                            handleResizeEnd();
                          }}
                          onMouseLeave={() => {
                            handleDragEnd();
                            handleResizeEnd();
                          }}
                        >
                          {/* Header con mesi */}
                          <div className="flex border-b-2 border-gray-300 pb-2 sticky top-0 bg-white z-10">
                            <div className="w-56 font-semibold text-sm text-gray-700 flex items-center">
                              <span>Projet</span>
                              {!isReadOnly && <span className="ml-2 text-xs text-gray-500">(glisser/redimensionner)</span>}
                            </div>
                            <div className="flex-1 flex relative">
                              {months.map((month, idx) => {
                                const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
                                return (
                                  <div key={idx} className="flex-1 text-center relative border-l-2 border-gray-300">
                                    <div className="font-bold text-sm text-gray-800">
                                      {month.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' })}
                                    </div>
                                    <div className="text-xs text-gray-500">{daysInMonth}j</div>
                                    
                                    {/* Linea oggi */}
                                    {(() => {
                                      const today = new Date();
                                      if (today.getFullYear() === month.getFullYear() && today.getMonth() === month.getMonth()) {
                                        const dayOfMonth = today.getDate();
                                        const percentInMonth = (dayOfMonth / daysInMonth) * 100;
                                        return (
                                          <div 
                                            className="absolute top-0 bottom-0 w-0.5 bg-red-500 opacity-50 z-20"
                                            style={{ left: `${percentInMonth}%` }}
                                            title="Aujourd'hui"
                                          />
                                        );
                                      }
                                    })()}
                                  </div>
                                );
                              })}
                            </div>
                          </div>

                          {/* Progetti per status */}
                          {Object.entries(projectsByStatus).map(([status, statusProjects]) => (
                            statusProjects.length > 0 && (
                              <div key={status} className="space-y-1">
                                <h3 className={`font-bold text-xs px-3 py-1 rounded-lg inline-block ${statusConfig[status]?.color || 'bg-gray-100'}`}>
                                  {statusConfig[status]?.label || status} ({statusProjects.length})
                                </h3>
                                {statusProjects.map(project => {
                                  const pos = getPosition(project);
                                  const resourcesCount = (project.selectedEngineers || []).length + (project.selectedResources || []).length + (project.selectedGenericResources || []).length;
                                  const isDragging = draggedProject?.id === project.id;
                                  const isResizing = resizingProject?.id === project.id;
                                  const isHovered = hoveredProject?.id === project.id;
                                  
                                  return (
                                    <div key={project.id} className="flex items-center group">
                                      <div className="w-56 pr-2">
                                        <div className="text-sm font-semibold text-gray-800 truncate" title={project.name}>{project.name}</div>
                                        <div className="text-xs text-gray-600">
                                          {resourcesCount} ressource(s) ‚Ä¢ {project.soldDays || 0}j vendus
                                        </div>
                                      </div>
                                      <div className="flex-1 relative h-12 border-l-2 border-gray-300">
                                        {/* Griglia mesi */}
                                        {months.map((month, idx) => (
                                          <div 
                                            key={idx} 
                                            className="absolute h-full border-l border-gray-200" 
                                            style={{ left: `${(idx / months.length) * 100}%`, width: `${100 / months.length}%` }}
                                          />
                                        ))}
                                        
                                        {/* Barra progetto */}
                                        <div 
                                          className={`absolute h-8 rounded-lg flex items-center px-3 transition-all ${
                                            statusConfig[project.status]?.calendarColor || 'bg-gray-200'
                                          } ${
                                            isDragging || isResizing ? 'shadow-2xl scale-105 ring-4 ring-indigo-300 z-30' : 
                                            isHovered ? 'shadow-lg ring-2 ring-indigo-200 z-20' : 
                                            'shadow-md hover:shadow-lg z-10'
                                          } ${
                                            !isReadOnly ? 'cursor-move' : 'cursor-default'
                                          }`}
                                          style={{ 
                                            left: `${pos.left}%`, 
                                            width: `${pos.width}%`, 
                                            top: '8px',
                                            minWidth: '80px'
                                          }}
                                          onMouseDown={(e) => !isReadOnly && handleDragStart(project, e)}
                                          onMouseEnter={() => setHoveredProject(project)}
                                          onMouseLeave={() => setHoveredProject(null)}
                                          title={`${project.name}
${new Date(project.startDate).toLocaleDateString('fr-FR')} ‚Üí ${new Date(project.endDate).toLocaleDateString('fr-FR')}
${resourcesCount} ressource(s)
${!isReadOnly ? 'Glisser pour d√©placer ‚Ä¢ Bordures pour redimensionner' : ''}`}
                                        >
                                          {/* Handle resize gauche */}
                                          {!isReadOnly && (
                                            <div 
                                              className="absolute left-0 top-0 bottom-0 w-2 cursor-ew-resize bg-gray-800 bg-opacity-0 hover:bg-opacity-30 transition-colors rounded-l-lg"
                                              onMouseDown={(e) => handleResizeStart(project, 'start', e)}
                                              onClick={(e) => e.stopPropagation()}
                                            />
                                          )}
                                          
                                          <div className="text-xs font-bold truncate flex items-center gap-1 text-gray-900">
                                            {project.name}
                                            {getProjectManager(project) && <span title="PM assign√©">üë§</span>}
                                            {resourcesCount > 0 && <span className="bg-white bg-opacity-30 px-1 rounded">({resourcesCount})</span>}
                                          </div>
                                          
                                          {/* Handle resize destra */}
                                          {!isReadOnly && (
                                            <div 
                                              className="absolute right-0 top-0 bottom-0 w-2 cursor-ew-resize bg-gray-800 bg-opacity-0 hover:bg-opacity-30 transition-colors rounded-r-lg"
                                              onMouseDown={(e) => handleResizeStart(project, 'end', e)}
                                              onClick={(e) => e.stopPropagation()}
                                            />
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            )
                          ))}

                          {visibleProjects.length === 0 && (
                            <div className="text-center py-12">
                              <p className="text-gray-500 text-lg">Aucun projet dans cette p√©riode</p>
                              <p className="text-gray-400 text-sm mt-2">Utilisez les fl√®ches pour naviguer ou cr√©ez un nouveau projet</p>
                            </div>
                          )}
                          
                          {/* L√©gende */}
                          {visibleProjects.length > 0 && (
                            <div className="mt-8 pt-4 border-t border-gray-200">
                              <p className="text-xs text-gray-600 mb-2 font-semibold">üí° Conseils d'utilisation:</p>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-600">
                                {!isReadOnly && (
                                  <>
                                    <div className="flex items-center gap-2">
                                      <span className="text-indigo-600">üñ±Ô∏è</span>
                                      <span>Glissez une barre pour d√©placer le projet</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                      <span className="text-indigo-600">‚ÜîÔ∏è</span>
                                      <span>Tirez les bordures pour ajuster la dur√©e</span>
                                    </div>
                                  </>
                                )}
                                <div className="flex items-center gap-2">
                                  <span className="text-indigo-600">üîç</span>
                                  <span>Zoom +/- pour voir plus/moins de mois</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-red-600">‚îÇ</span>
                                  <span>Ligne rouge = aujourd'hui</span>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                )}

                {activeTab === 'resource' && (
                  <div className="space-y-4">
                    <div className="bg-white rounded-lg shadow p-4 md:p-6">
                      <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <User size={28} className="text-indigo-600" /> Vue Ressource Personnelle
                      </h2>
                      
                      {/* Resource Selector */}
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">S√©lectionner une ressource</label>
                          <select 
                            value={selectedResourceId}
                            onChange={(e) => setSelectedResourceId(e.target.value)}
                            className="w-full border rounded px-3 py-2 text-base"
                          >
                            <option value="">-- Choisir une ressource --</option>
                            <optgroup label="Ing√©nieurs">
                              {engineers.map(e => <option key={e.id} value={e.id}>{e.name} {e.specialty && `(${e.specialty})`}</option>)}
                            </optgroup>
                            <optgroup label="Ressources">
                              {resources.map(r => <option key={r.id} value={r.id}>{r.name} {r.type && `(${r.type})`}</option>)}
                            </optgroup>
                            <optgroup label="G√©n√©riques">
                              {genericResources.map(g => <option key={g.id} value={g.id}>{g.name} {g.type && `(${g.type})`}</option>)}
                            </optgroup>
                          </select>
                        </div>
                        
                        {selectedResourceId && (
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Mode d'affichage</label>
                            <div className="flex gap-2">
                              <button 
                                onClick={() => setResourceViewMode('quarter')}
                                className={`flex-1 px-4 py-2 rounded-lg font-semibold ${resourceViewMode === 'quarter' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                              >
                                Trimestre
                              </button>
                              <button 
                                onClick={() => setResourceViewMode('month')}
                                className={`flex-1 px-4 py-2 rounded-lg font-semibold ${resourceViewMode === 'month' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700'}`}
                              >
                                Mois
                              </button>
                            </div>
                          </div>
                        )}
                      </div>

                      {selectedResourceId && (() => {
                        const resource = getSelectedResource();
                        
                        // Se la risorsa non viene trovata, mostra un messaggio
                        if (!resource) {
                          return (
                            <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6 text-center">
                              <p className="text-yellow-800 font-semibold">‚ö†Ô∏è Ressource non trouv√©e</p>
                              <p className="text-yellow-600 text-sm mt-2">Veuillez s√©lectionner une autre ressource</p>
                            </div>
                          );
                        }
                        
                        const resourceProjects = getResourceProjects(selectedResourceId);
                        const conflicts = getResourceConflicts(selectedResourceId);
                        
                        return (
                          <div className="space-y-6">
                            {/* Resource Info */}
                            <div className="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-lg p-4 border-2 border-indigo-200">
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">Nom</p>
                                  <p className="font-bold text-gray-800">{resource?.name || 'N/A'}</p>
                                </div>
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">Type</p>
                                  <p className="font-semibold text-gray-800">{resource?.type || 'N/A'}</p>
                                </div>
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">{resource?.resourceType === 'engineer' ? 'Sp√©cialit√©' : 'D√©tails'}</p>
                                  <p className="font-semibold text-gray-800">{resource?.specialty || resource?.type || '-'}</p>
                                </div>
                                <div>
                                  <p className="text-xs text-gray-600 mb-1">Projets actifs</p>
                                  <p className="font-bold text-indigo-600 text-xl">{resourceProjects?.length || 0}</p>
                                </div>
                              </div>
                            </div>

                            {/* Conflicts Alert */}
                            {conflicts.length > 0 && (
                              <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <AlertTriangle size={24} className="text-red-600 flex-shrink-0" />
                                  <div className="flex-1">
                                    <p className="font-bold text-red-800 mb-2">‚ö†Ô∏è {conflicts.length} Chevauchement(s) d√©tect√©(s)</p>
                                    <div className="space-y-2">
                                      {conflicts.map((conflict, idx) => (
                                        <div key={idx} className="bg-white rounded p-3 border border-red-300">
                                          <p className="text-sm font-semibold text-red-900 mb-1">
                                            {conflict.project1.name} ‚ö° {conflict.project2.name}
                                          </p>
                                          <p className="text-xs text-red-700">
                                            P√©riode: {conflict.overlapStart.toLocaleDateString('fr-FR')} ‚Üí {conflict.overlapEnd.toLocaleDateString('fr-FR')}
                                          </p>
                                          <button 
                                            onClick={() => { 
                                              // Ottieni info risorsa corrente
                                              const resource = getSelectedResource();
                                              
                                              // Aggiungi resourceId e resourceType al conflitto
                                              const enrichedConflict = {
                                                ...conflict,
                                                resourceId: selectedResourceId,
                                                resourceType: resource?.resourceType || null,
                                                resourceName: resource?.name || null
                                              };
                                              
                                              setConflictToResolve(enrichedConflict);
                                              
                                              // Inizializza giorni selezionati basandosi su date esistenti progetti
                                              const initSelectedDays = (startDate, endDate) => {
                                                const days = {};
                                                const start = new Date(startDate);
                                                const end = new Date(endDate);
                                                
                                                let currentDate = new Date(start);
                                                while (currentDate <= end) {
                                                  const dayOfWeek = currentDate.getDay();
                                                  
                                                  // ‚úÖ Solo giorni lavorativi (Lun-Ven)
                                                  if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                                    const dateKey = currentDate.toISOString().split('T')[0];
                                                    days[dateKey] = 1.0; // Intera giornata per default
                                                  }
                                                  
                                                  currentDate.setDate(currentDate.getDate() + 1);
                                                }
                                                
                                                return days;
                                              };
                                              
                                              setConflictSelectedDays({
                                                project1: initSelectedDays(conflict.project1.startDate, conflict.project1.endDate),
                                                project2: initSelectedDays(conflict.project2.startDate, conflict.project2.endDate)
                                              });
                                              
                                              // Inizializza calendario al mese del primo progetto
                                              const startDate = new Date(conflict.project1.startDate);
                                              setConflictCalendarMonth(startDate);
                                              
                                              // Reset range selection
                                              setConflictRangeStart('');
                                              setConflictRangeEnd('');
                                              
                                              // Reset modalit√† calendario
                                              setConflictCalendarMode(null);
                                              
                                              // Reset priorit√† progetto
                                              setPriorityProject(null);
                                              
                                              setShowConflictModal(true);
                                            }}
                                            className="mt-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm font-semibold"
                                          >
                                            R√©soudre ce conflit
                                          </button>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* Navigation */}
                            {resourceViewMode === 'quarter' ? (
                              <div className="flex justify-between items-center">
                                <button 
                                  onClick={() => { 
                                    if (resourceViewQuarter === 0) { 
                                      setResourceViewQuarter(3); 
                                      setResourceViewYear(resourceViewYear - 1); 
                                    } else { 
                                      setResourceViewQuarter(resourceViewQuarter - 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  ‚Üê Trimestre pr√©c√©dent
                                </button>
                                <span className="text-lg font-bold text-gray-800">Q{resourceViewQuarter + 1} {resourceViewYear}</span>
                                <button 
                                  onClick={() => { 
                                    if (resourceViewQuarter === 3) { 
                                      setResourceViewQuarter(0); 
                                      setResourceViewYear(resourceViewYear + 1); 
                                    } else { 
                                      setResourceViewQuarter(resourceViewQuarter + 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  Trimestre suivant ‚Üí
                                </button>
                              </div>
                            ) : (
                              <div className="flex justify-between items-center">
                                <button 
                                  onClick={() => { 
                                    if (selectedMonth === 0) { 
                                      setSelectedMonth(11); 
                                      setResourceViewYear(resourceViewYear - 1); 
                                    } else { 
                                      setSelectedMonth(selectedMonth - 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  ‚Üê Mois pr√©c√©dent
                                </button>
                                <span className="text-lg font-bold text-gray-800">
                                  {new Date(resourceViewYear, selectedMonth).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                                </span>
                                <button 
                                  onClick={() => { 
                                    if (selectedMonth === 11) { 
                                      setSelectedMonth(0); 
                                      setResourceViewYear(resourceViewYear + 1); 
                                    } else { 
                                      setSelectedMonth(selectedMonth + 1); 
                                    } 
                                  }} 
                                  className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold"
                                >
                                  Mois suivant ‚Üí
                                </button>
                              </div>
                            )}

                            {/* Statistics by Month */}
                            {resourceViewMode === 'quarter' ? (
                              <div className="bg-white rounded-lg border-2 border-gray-200 p-4">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                  üìä R√©partition par mois
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                  {[0, 1, 2].map(offset => {
                                    const month = resourceViewQuarter * 3 + offset;
                                    const monthData = getResourceDaysInMonth(selectedResourceId, resourceViewYear, month);
                                    const workingDays = 20;
                                    const percentage = Math.round((monthData.total / workingDays) * 100);
                                    const colorClass = percentage > 100 ? 'bg-red-100 border-red-300 text-red-800' : 
                                                       percentage > 80 ? 'bg-orange-100 border-orange-300 text-orange-800' : 
                                                       percentage > 50 ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 
                                                       'bg-green-100 border-green-300 text-green-800';
                                    
                                    return (
                                      <div key={month} className={`rounded-lg border-2 p-3 ${colorClass}`}>
                                        <p className="text-sm font-bold mb-1">
                                          {new Date(resourceViewYear, month).toLocaleDateString('fr-FR', { month: 'long' })}
                                        </p>
                                        <p className="text-2xl font-bold mb-1">{monthData.total}j</p>
                                        <p className="text-xs font-semibold">{percentage}% charge</p>
                                        {percentage > 100 && <p className="text-xs font-bold mt-1">‚ö†Ô∏è SURCHARGE!</p>}
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            ) : (
                              <div className="bg-white rounded-lg border-2 border-gray-200 p-4">
                                <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                  üìä Charge du mois
                                </h3>
                                {(() => {
                                  const monthData = getResourceDaysInMonth(selectedResourceId, resourceViewYear, selectedMonth);
                                  const workingDays = 20;
                                  const percentage = Math.round((monthData.total / workingDays) * 100);
                                  const colorClass = percentage > 100 ? 'bg-red-100 border-red-300 text-red-800' : 
                                                     percentage > 80 ? 'bg-orange-100 border-orange-300 text-orange-800' : 
                                                     percentage > 50 ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 
                                                     'bg-green-100 border-green-300 text-green-800';
                                  
                                  return (
                                    <div>
                                      <div className={`rounded-lg border-2 p-4 mb-3 ${colorClass}`}>
                                        <div className="flex justify-between items-center">
                                          <div>
                                            <p className="text-3xl font-bold mb-1">{monthData.total} jours</p>
                                            <p className="text-sm font-semibold">{percentage}% de charge</p>
                                          </div>
                                          {percentage > 100 && (
                                            <div className="text-right">
                                              <AlertTriangle size={32} />
                                              <p className="text-sm font-bold">SURCHARGE!</p>
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                      <div className="space-y-2">
                                        <p className="text-sm font-semibold text-gray-700">D√©tail par projet:</p>
                                        {Object.entries(monthData.byProject).map(([projectId, data]) => (
                                          <div key={projectId} className="flex justify-between items-center bg-gray-50 rounded p-2">
                                            <span className="text-sm">{data.name}</span>
                                            <span className={`text-sm font-bold px-2 py-1 rounded ${statusConfig[data.status]?.color || 'bg-gray-200'}`}>
                                              {data.days}j
                                            </span>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  );
                                })()}
                              </div>
                            )}

                            {/* Projects List */}
                            <div className="bg-white rounded-lg border-2 border-gray-200 p-4">
                              <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                üìã Projets assign√©s ({resourceProjects.length})
                              </h3>
                              {resourceProjects.length === 0 ? (
                                <p className="text-gray-500 text-center py-4">Aucun projet assign√©</p>
                              ) : (
                                <div className="space-y-3">
                                  {resourceProjects.map(project => {
                                    const hasConflict = conflicts.some(c => 
                                      c.project1.id === project.id || c.project2.id === project.id
                                    );
                                    let days = 0;
                                    if (resource.resourceType === 'engineer') {
                                      days = project.engineerDays?.[selectedResourceId] || 0;
                                    } else if (resource.resourceType === 'resource') {
                                      days = project.resourceDays?.[selectedResourceId] || 0;
                                    } else {
                                      days = project.genericResourceDays?.[selectedResourceId] || 0;
                                    }
                                    
                                    return (
                                      <div key={project.id} className={`rounded-lg border-2 p-3 ${hasConflict ? 'border-red-300 bg-red-50' : 'border-gray-200'}`}>
                                        <div className="flex justify-between items-start mb-2">
                                          <div className="flex-1">
                                            <p className="font-bold text-gray-800">{project.name}</p>
                                            <p className="text-sm text-gray-600 mt-1">
                                              {new Date(project.startDate).toLocaleDateString('fr-FR')} ‚Üí {new Date(project.endDate).toLocaleDateString('fr-FR')}
                                            </p>
                                          </div>
                                          <div className="text-right">
                                            <span className={`px-2 py-1 rounded text-xs font-semibold ${statusConfig[project.status]?.color || 'bg-gray-200'}`}>
                                              {statusConfig[project.status]?.label || project.status}
                                            </span>
                                            <p className="text-lg font-bold text-indigo-600 mt-1">{days}j</p>
                                          </div>
                                        </div>
                                        {hasConflict && (
                                          <div className="bg-red-100 rounded p-2 mt-2">
                                            <p className="text-xs text-red-800 font-semibold">‚ö†Ô∏è Chevauchement avec un autre projet</p>
                                          </div>
                                        )}
                                      </div>
                                    );
                                  })}
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })()}

                      {!selectedResourceId && (
                        <div className="text-center py-12">
                          <User size={64} className="mx-auto text-gray-300 mb-4" />
                          <p className="text-gray-500 text-lg">S√©lectionnez une ressource pour voir sa vue personnelle</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {activeTab === 'team' && (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Users size={24} className="text-indigo-600" /> Ing√©nieurs</h2>
                      {!isReadOnly && (
                        <>
                          {showEngineerForm ? (
                            <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                              <input type="text" placeholder="Nom" value={engineerForm.name} onChange={(e) => setEngineerForm({ ...engineerForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 1" value={engineerForm.specialty} onChange={(e) => setEngineerForm({ ...engineerForm, specialty: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 2" value={engineerForm.specialty2 || ''} onChange={(e) => setEngineerForm({ ...engineerForm, specialty2: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 3" value={engineerForm.specialty3 || ''} onChange={(e) => setEngineerForm({ ...engineerForm, specialty3: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Sp√©cialit√© 4" value={engineerForm.specialty4 || ''} onChange={(e) => setEngineerForm({ ...engineerForm, specialty4: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <div className="bg-blue-50 p-3 rounded mb-2">
                                <p className="text-xs font-semibold text-blue-800 mb-2">‚öôÔ∏è Configuration</p>
                                <input 
                                  type="number" 
                                  placeholder="Max heures/mois (d√©faut: 160)" 
                                  value={engineerForm.maxMonthlyHours} 
                                  onChange={(e) => setEngineerForm({ ...engineerForm, maxMonthlyHours: parseInt(e.target.value) || 160 })} 
                                  className="w-full border rounded px-3 py-2 mb-2 text-sm" 
                                />
                                <input 
                                  type="number" 
                                  placeholder="Heures/jour (d√©faut: 8)" 
                                  value={engineerForm.defaultDailyHours} 
                                  onChange={(e) => setEngineerForm({ ...engineerForm, defaultDailyHours: parseInt(e.target.value) || 8 })} 
                                  className="w-full border rounded px-3 py-2 text-sm" 
                                />
                              </div>
                              <div className="flex gap-2">
                                <button onClick={addEngineer} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                                <button onClick={() => setShowEngineerForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                              </div>
                            </div>
                          ) : (
                            <button onClick={() => setShowEngineerForm(true)} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Ing√©nieur</button>
                          )}
                        </>
                      )}
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {engineers.map(eng => {
                          const occupation = calculateWeeklyOccupation(eng.id, 'engineer');
                          const currentMonth = new Date().getMonth();
                          const currentYear = new Date().getFullYear();
                          const monthlyHours = calculateMonthlyLoad(eng.id, 'engineer', currentYear, currentMonth);
                          const maxHours = eng.maxMonthlyHours || 160;
                          const allocationPct = calculateAllocationPercentage(eng.id, 'engineer', currentYear, currentMonth);
                          
                          return (
                            <div key={eng.id} className="p-3 bg-gray-50 rounded hover:bg-gray-100">
                              <div className="flex justify-between items-start mb-2">
                                <div className="flex-1">
                                  <div className="flex items-center gap-2 mb-1">
                                    <p className="font-semibold text-gray-800 text-sm">{eng.name}</p>
                                    <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${occupation > 100 ? 'bg-red-100 text-red-800' : occupation > 80 ? 'bg-orange-100 text-orange-800' : occupation > 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                      {occupation}%
                                    </span>
                                  </div>
                                  {eng.specialty && <p className="text-gray-600 text-xs">{eng.specialty}</p>}
                                  {eng.specialty2 && <p className="text-gray-600 text-xs">{eng.specialty2}</p>}
                                  {eng.specialty3 && <p className="text-gray-600 text-xs">{eng.specialty3}</p>}
                                  {eng.specialty4 && <p className="text-gray-600 text-xs">{eng.specialty4}</p>}
                                  
                                  {/* Progress Bar Carico Mensile */}
                                  <div className="mt-2">
                                    <div className="flex justify-between text-xs text-gray-600 mb-1">
                                      <span>Ce mois: {monthlyHours}h / {maxHours}h</span>
                                      <span className={allocationPct > 100 ? 'text-red-600 font-bold' : allocationPct > 80 ? 'text-orange-600' : 'text-green-600'}>{allocationPct}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                      <div 
                                        className={`h-2 rounded-full transition-all ${allocationPct > 100 ? 'bg-red-500' : allocationPct > 80 ? 'bg-orange-500' : 'bg-green-500'}`}
                                        style={{ width: `${Math.min(allocationPct, 100)}%` }}
                                      ></div>
                                    </div>
                                  </div>
                                  
                                  {/* Indisponibilit√† */}
                                  {eng.unavailability && eng.unavailability.length > 0 && (
                                    <div className="mt-2 text-xs">
                                      <p className="text-gray-600 font-semibold">üö´ Indisponibilit√©s:</p>
                                      {eng.unavailability.map((unavail, idx) => (
                                        <div key={idx} className="flex items-center justify-between bg-red-50 px-2 py-1 rounded mt-1">
                                          <span className="text-red-700">
                                            {new Date(unavail.startDate).toLocaleDateString('fr-FR')} - {new Date(unavail.endDate).toLocaleDateString('fr-FR')}
                                            {unavail.reason && ` (${unavail.reason})`}
                                          </span>
                                          {!isReadOnly && (
                                            <button onClick={() => removeUnavailability(eng.id, 'engineer', idx)} className="text-red-600 hover:text-red-800 ml-2">
                                              <X size={12} />
                                            </button>
                                          )}
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                                {!isReadOnly && (
                                  <div className="flex gap-1 ml-2">
                                    <button 
                                      onClick={() => {
                                        setSelectedResourceForConfig({ id: eng.id, type: 'engineer', name: eng.name, maxMonthlyHours: eng.maxMonthlyHours || 160, defaultDailyHours: eng.defaultDailyHours || 8 });
                                        setShowResourceConfigModal(true);
                                      }}
                                      className="text-blue-600 hover:text-blue-800 p-1"
                                      title="Configurer"
                                    >
                                      <Settings size={14} />
                                    </button>
                                    <button 
                                      onClick={() => {
                                        setUnavailabilityForm({ ...unavailabilityForm, resourceId: eng.id, resourceType: 'engineer' });
                                        setShowUnavailabilityModal(true);
                                      }}
                                      className="text-orange-600 hover:text-orange-800 p-1"
                                      title="Ajouter indisponibilit√©"
                                    >
                                      <Calendar size={14} />
                                    </button>
                                    <button onClick={() => initiateDelete(eng.id, eng.name, 'engineer')} className="text-red-600 hover:text-red-800 p-1">
                                      <Trash2 size={14} />
                                    </button>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Briefcase size={24} className="text-purple-600" /> Ressources Askida</h2>
                      {!isReadOnly && (
                        <>
                          {showResourceForm ? (
                            <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                              <input type="text" placeholder="Nom" value={resourceForm.name} onChange={(e) => setResourceForm({ ...resourceForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Type" value={resourceForm.type} onChange={(e) => setResourceForm({ ...resourceForm, type: e.target.value })} className="w-full border rounded px-3 py-2 mb-3" />
                              <div className="flex gap-2">
                                <button onClick={addResource} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                                <button onClick={() => setShowResourceForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                              </div>
                            </div>
                          ) : (
                            <button onClick={() => setShowResourceForm(true)} className="w-full bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Ressource</button>
                          )}
                        </>
                      )}
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {resources.map(res => {
                          const occupation = calculateWeeklyOccupation(res.id, 'resource');
                          return (
                            <div key={res.id} className="flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                  <p className="font-semibold text-gray-800 text-sm">{res.name}</p>
                                  <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${occupation > 100 ? 'bg-red-100 text-red-800' : occupation > 80 ? 'bg-orange-100 text-orange-800' : occupation > 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                    {occupation}%
                                  </span>
                                </div>
                                {res.type && <p className="text-gray-600 text-xs">{res.type}</p>}
                              </div>
                              <button onClick={() => initiateDelete(res.id, res.name, 'resource')} className="text-red-600 hover:text-red-800"><Trash2 size={16} /></button>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><Package size={24} className="text-teal-600" /> Ressources G√©n√©riques</h2>
                      {!isReadOnly && (
                        <>
                          {showGenericResourceForm ? (
                            <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                              <input type="text" placeholder="Nom" value={genericResourceForm.name} onChange={(e) => setGenericResourceForm({ ...genericResourceForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                              <input type="text" placeholder="Type" value={genericResourceForm.type} onChange={(e) => setGenericResourceForm({ ...genericResourceForm, type: e.target.value })} className="w-full border rounded px-3 py-2 mb-3" />
                              <div className="flex gap-2">
                                <button onClick={addGenericResource} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                                <button onClick={() => setShowGenericResourceForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                              </div>
                            </div>
                          ) : (
                            <button onClick={() => setShowGenericResourceForm(true)} className="w-full bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Ressource</button>
                          )}
                        </>
                      )}
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {genericResources.map(res => {
                          const occupation = calculateWeeklyOccupation(res.id, 'generic');
                          return (
                            <div key={res.id} className="flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                  <p className="font-semibold text-gray-800 text-sm">{res.name}</p>
                                  <span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${occupation > 100 ? 'bg-red-100 text-red-800' : occupation > 80 ? 'bg-orange-100 text-orange-800' : occupation > 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                    {occupation}%
                                  </span>
                                </div>
                                {res.type && <p className="text-gray-600 text-xs">{res.type}</p>}
                              </div>
                              {!isReadOnly && (
                                <button onClick={() => initiateDelete(res.id, res.name, 'generic')} className="text-red-600 hover:text-red-800"><Trash2 size={16} /></button>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><UserCog size={24} className="text-orange-600" /> Chefs de Projet</h2>
                      {!isReadOnly && (
                        <>
                          {showPMForm ? (
                        <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                          <input type="text" placeholder="Nom" value={pmForm.name} onChange={(e) => setPMForm({ ...pmForm, name: e.target.value })} className="w-full border rounded px-3 py-2 mb-2" />
                          <input type="text" placeholder="D√©partement" value={pmForm.department} onChange={(e) => setPMForm({ ...pmForm, department: e.target.value })} className="w-full border rounded px-3 py-2 mb-3" />
                          <div className="flex gap-2">
                            <button onClick={addPM} className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded font-semibold"><Check size={16} className="inline" /> Ajouter</button>
                            <button onClick={() => setShowPMForm(false)} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-3 py-2 rounded font-semibold"><X size={16} className="inline" /> Annuler</button>
                          </div>
                        </div>
                      ) : (
                        <button onClick={() => setShowPMForm(true)} className="w-full bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 mb-4"><Plus /> Ajouter Chef de Projet</button>
                      )}
                    </>
                  )}
                  <div className="space-y-2 max-h-96 overflow-y-auto">
                    {projectManagers.map(pm => (
                      <div key={pm.id} className="flex justify-between items-center p-3 bg-gray-50 rounded hover:bg-gray-100">
                        <div className="flex-1">
                          <p className="font-semibold text-gray-800 text-sm">{pm.name}</p>
                          {pm.department && <p className="text-gray-600 text-xs">{pm.department}</p>}
                        </div>
                        {!isReadOnly && (
                          <button onClick={() => initiateDelete(pm.id, pm.name, 'pm')} className="text-red-600 hover:text-red-800"><Trash2 size={16} /></button>
                        )}
                      </div>
                    ))}
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'stats' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        üìä Tableau de bord - Statistiques
                      </h2>
                      
                      {/* KPI Cards */}
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 border-2 border-indigo-200 rounded-lg p-6">
                          <p className="text-sm font-semibold text-indigo-700 mb-2">Total Projets</p>
                          <p className="text-4xl font-bold text-indigo-900">{projects.length}</p>
                        </div>
                        <div className="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-lg p-6">
                          <p className="text-sm font-semibold text-green-700 mb-2">Projets Actifs</p>
                          <p className="text-4xl font-bold text-green-900">{projects.filter(p => {
                            const now = new Date();
                            const start = p.startDate ? new Date(p.startDate) : null;
                            const end = p.endDate ? new Date(p.endDate) : null;
                            return start && end && start <= now && now <= end;
                          }).length}</p>
                        </div>
                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-6">
                          <p className="text-sm font-semibold text-blue-700 mb-2">Total Ressources</p>
                          <p className="text-4xl font-bold text-blue-900">{engineers.length + resources.length + genericResources.length}</p>
                        </div>
                        <div className="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-lg p-6">
                          <p className="text-sm font-semibold text-purple-700 mb-2">Jours Vendus Total</p>
                          <p className="text-4xl font-bold text-purple-900">{projects.reduce((sum, p) => sum + (parseFloat(p.soldDays) || 0), 0).toFixed(1)}</p>
                        </div>
                      </div>

                      {/* Utilisation Ressources */}
                      <div className="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                          üîß Utilisation des Ing√©nieurs
                        </h3>
                        <div className="space-y-3">
                          {engineers.length === 0 ? (
                            <div className="bg-white rounded-lg p-8 border border-gray-200 text-center">
                              <p className="text-gray-500">Aucun ing√©nieur d√©fini. Cr√©ez des ing√©nieurs dans l'onglet √âquipe.</p>
                            </div>
                          ) : (
                            engineers.map(eng => {
                              // Calcolo sicuro con gestione array
                              const allocations = projects.flatMap(p => {
                                const alloc = p.engineerMonthlyAllocation;
                                if (!alloc || !Array.isArray(alloc)) return [];
                                return alloc.filter(a => a && a.engineerId === eng.id);
                              });
                              const totalDays = allocations.reduce((sum, a) => sum + (parseFloat(a.days) || 0), 0);
                              const projectCount = new Set(allocations.map(a => a.projectId).filter(Boolean)).size;
                              
                              return (
                                <div key={eng.id} className="bg-white rounded-lg p-4 border border-gray-200">
                                  <div className="flex justify-between items-center mb-2">
                                    <span className="font-semibold text-gray-800">{eng.name}</span>
                                    <span className="text-sm text-gray-600">{projectCount} projet(s)</span>
                                  </div>
                                  <div className="flex items-center gap-3">
                                    <div className="flex-1 bg-gray-200 rounded-full h-4">
                                      <div 
                                        className="bg-indigo-600 h-4 rounded-full flex items-center justify-center text-xs text-white font-bold"
                                        style={{width: `${Math.min(100, (totalDays / 220) * 100)}%`}}
                                      >
                                        {totalDays > 0 && `${Math.round(totalDays)}j`}
                                      </div>
                                    </div>
                                    <span className="text-sm font-semibold text-gray-700 w-16 text-right">{((totalDays / 220) * 100).toFixed(0)}%</span>
                                  </div>
                                </div>
                              );
                            })
                          )}
                        </div>
                      </div>

                      {/* Ressources Askida */}
                      <div className="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                          üì¶ Utilisation des Ressources
                        </h3>
                        <div className="space-y-3">
                          {resources.length === 0 ? (
                            <div className="bg-white rounded-lg p-8 border border-gray-200 text-center">
                              <p className="text-gray-500">Aucune ressource d√©finie. Cr√©ez des ressources dans l'onglet √âquipe.</p>
                            </div>
                          ) : (
                            resources.map(res => {
                              const projectsWithResource = projects.filter(p => 
                                Array.isArray(p.selectedResources) && p.selectedResources.includes(res.id)
                              );
                              const totalDays = projectsWithResource.reduce((sum, p) => {
                                const alloc = p.resourceAllocation;
                                if (!alloc || !Array.isArray(alloc)) return sum;
                                const resourceAlloc = alloc.find(a => a && a.resourceId === res.id);
                                return sum + (parseFloat(resourceAlloc?.days) || 0);
                              }, 0);
                              
                              return (
                                <div key={res.id} className="bg-white rounded-lg p-4 border border-gray-200">
                                  <div className="flex justify-between items-center mb-2">
                                    <span className="font-semibold text-gray-800">{res.name}</span>
                                    <span className="text-sm text-gray-600">{projectsWithResource.length} projet(s)</span>
                                  </div>
                                  <div className="flex items-center gap-3">
                                    <div className="flex-1 bg-gray-200 rounded-full h-4">
                                      <div 
                                        className="bg-purple-600 h-4 rounded-full flex items-center justify-center text-xs text-white font-bold"
                                        style={{width: `${Math.min(100, (totalDays / 220) * 100)}%`}}
                                      >
                                        {totalDays > 0 && `${Math.round(totalDays)}j`}
                                      </div>
                                    </div>
                                    <span className="text-sm font-semibold text-gray-700 w-16 text-right">{Math.round(totalDays)}j</span>
                                  </div>
                                </div>
                              );
                            })
                          )}
                        </div>
                      </div>

                      {/* Top Projets par Jours Vendus */}
                      <div className="bg-gray-50 rounded-lg p-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                          üèÜ Top 10 Projets par Jours Vendus
                        </h3>
                        <div className="space-y-2">
                          {projects.length === 0 ? (
                            <div className="bg-white rounded-lg p-8 border border-gray-200 text-center">
                              <p className="text-gray-500">Aucun projet d√©fini. Cr√©ez des projets dans l'onglet Projets.</p>
                            </div>
                          ) : (
                            [...projects]
                              .sort((a, b) => (parseFloat(b.soldDays) || 0) - (parseFloat(a.soldDays) || 0))
                              .slice(0, 10)
                              .map((p, idx) => (
                                <div key={p.id} className="bg-white rounded-lg p-4 border border-gray-200 flex items-center gap-4">
                                  <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                                    idx === 0 ? 'bg-yellow-500' : idx === 1 ? 'bg-gray-400' : idx === 2 ? 'bg-orange-600' : 'bg-gray-300 text-gray-700'
                                  }`}>
                                    {idx + 1}
                                  </div>
                                  <div className="flex-1">
                                    <p className="font-semibold text-gray-800">{p.name}</p>
                                    <p className="text-sm text-gray-600">
                                      {p.client || 'Sans client'} ‚Ä¢ {p.startDate && p.endDate ? `${p.startDate} ‚Üí ${p.endDate}` : 'Dates non d√©finies'}
                                    </p>
                                  </div>
                                  <div className="text-right">
                                    <p className="text-2xl font-bold text-indigo-600">{parseFloat(p.soldDays || 0).toFixed(1)}</p>
                                    <p className="text-xs text-gray-600">jours vendus</p>
                                  </div>
                                </div>
                              ))
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'export' && (
                  <div className="space-y-4">
                    <div className="bg-white rounded-lg shadow p-4 md:p-6">
                      <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-4">Export & Backup</h2>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-200 rounded-lg p-4 text-center">
                          <FileText size={32} className="mx-auto text-red-600 mb-2" />
                          <p className="text-sm font-semibold text-red-800 mb-1">Export PDF</p>
                          <p className="text-xs text-red-600 mb-3">Rapport complet format√©</p>
                          <button onClick={exportToPDF} className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                            G√©n√©rer PDF
                          </button>
                        </div>
                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-lg p-4 text-center">
                          <Database size={32} className="mx-auto text-blue-600 mb-2" />
                          <p className="text-sm font-semibold text-blue-800 mb-1">Backup JSON</p>
                          <p className="text-xs text-blue-600 mb-3">Sauvegarde compl√®te</p>
                          <button onClick={exportBackup} className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                            T√©l√©charger Backup
                          </button>
                        </div>
                        {!isReadOnly && (
                          <div className="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-200 rounded-lg p-4 text-center">
                            <Upload size={32} className="mx-auto text-green-600 mb-2" />
                            <p className="text-sm font-semibold text-green-800 mb-1">Restaurer</p>
                            <p className="text-xs text-green-600 mb-3">Importer un backup</p>
                            <label className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold text-sm cursor-pointer inline-block">
                              Choisir fichier
                              <input type="file" accept=".json" onChange={importBackup} className="hidden" />
                            </label>
                          </div>
                        )}
                      </div>
                      
                      {/* OneDrive Sync Section */}
                      {isOneDriveConnected && (
                        <div className="bg-gradient-to-br from-green-50 via-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-6 mb-6">
                          <div className="flex items-start gap-4">
                            <svg className="w-12 h-12 text-blue-600 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            <div className="flex-1">
                              <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                                ‚òÅÔ∏è Synchronisation OneDrive
                                <span className="text-xs bg-green-500 text-white px-2 py-1 rounded-full">Connect√©</span>
                              </h3>
                              <p className="text-sm text-gray-600 mb-3">
                                Vos donn√©es sont automatiquement sauvegard√©es sur OneDrive. Vous pouvez forcer une synchronisation manuelle si n√©cessaire.
                              </p>
                              <div className="flex flex-wrap gap-3 items-center">
                                <button 
                                  onClick={forceSyncFromOneDrive}
                                  disabled={isSyncing}
                                  className="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all"
                                >
                                  {isSyncing ? (
                                    <>
                                      <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                      </svg>
                                      <span>Synchronisation...</span>
                                    </>
                                  ) : (
                                    <>
                                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                      </svg>
                                      <span>Synchroniser maintenant</span>
                                    </>
                                  )}
                                </button>
                                {lastSyncTime && (
                                  <span className="text-sm text-gray-600">
                                    Derni√®re sync: <span className="font-semibold">{lastSyncTime}</span>
                                  </span>
                                )}
                                <button 
                                  onClick={signOutOneDrive}
                                  className="text-sm text-red-600 hover:text-red-800 font-semibold underline"
                                >
                                  D√©connecter Drive
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {!isOneDriveConnected && isOneDriveReady && (
                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
                          <div className="flex items-start gap-4">
                            <svg className="w-12 h-12 text-blue-600 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            <div className="flex-1">
                              <h3 className="text-lg font-bold text-gray-800 mb-2">
                                ‚òÅÔ∏è Synchronisation Cloud avec OneDrive
                              </h3>
                              <p className="text-sm text-gray-600 mb-3">
                                Connectez OneDrive pour synchroniser automatiquement vos donn√©es entre tous vos appareils (PC, tablette, mobile). Les donn√©es seront sauvegard√©es en temps r√©el dans le cloud.
                              </p>
                              <div className="bg-blue-100 border border-blue-300 rounded-lg p-3 mb-3">
                                <p className="text-sm text-blue-900 font-semibold mb-2">‚ú® Avantages:</p>
                                <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
                                  <li>Synchronisation automatique entre appareils</li>
                                  <li>Backup automatique dans le cloud</li>
                                  <li>Acc√®s depuis n'importe o√π</li>
                                  <li>Gratuit et s√©curis√©</li>
                                </ul>
                              </div>
                              <button 
                                onClick={signInOneDrive}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2 transition-all shadow-md hover:shadow-lg"
                              >
                                <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                  <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                                </svg>
                                Connecter OneDrive
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    <div className="bg-white rounded-lg shadow p-4 md:p-8">
                    <h2 className="text-xl md:text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <Download size={28} className="text-indigo-600" /> Export CSV
                    </h2>
                    <div className="mb-6">
                      <p className="text-gray-600 mb-4">Exportez toutes vos donn√©es de projets, ressources et affectations dans un fichier CSV compatible Excel.</p>
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 className="font-semibold text-blue-900 mb-2">Le fichier export√© contient :</h3>
                        <ul className="text-sm text-blue-800 space-y-1 list-disc list-inside">
                          <li>Tous les projets avec leurs dates et statuts</li>
                          <li>Chefs de projet assign√©s</li>
                          <li>Toutes les ressources (Ing√©nieurs, Ressources, Ressources G√©n√©riques)</li>
                          <li>Sp√©cialit√©s et types</li>
                          <li>Nombre de jours vendus par ressource</li>
                        </ul>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-white border rounded-lg p-4 text-center">
                          <p className="text-3xl font-bold text-indigo-600">{projects.length}</p>
                          <p className="text-sm text-gray-600">Projets √† exporter</p>
                        </div>
                        <div className="bg-white border rounded-lg p-4 text-center">
                          <p className="text-3xl font-bold text-green-600">{engineers.length + resources.length + genericResources.length}</p>
                          <p className="text-sm text-gray-600">Ressources totales</p>
                        </div>
                        <div className="bg-white border rounded-lg p-4 text-center">
                          <p className="text-3xl font-bold text-orange-600">{projectManagers.length}</p>
                          <p className="text-sm text-gray-600">Chefs de projet</p>
                        </div>
                      </div>
                    </div>
                    <button onClick={exportToExcel} className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-lg font-semibold text-lg flex items-center justify-center gap-3 shadow-lg">
                      <Download size={24} /> T√©l√©charger le fichier CSV
                    </button>
                    <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                      <h4 className="font-semibold text-gray-800 mb-2">üí° Conseil :</h4>
                      <p className="text-sm text-gray-600">Le fichier t√©l√©charg√© est au format CSV avec s√©parateur point-virgule (;). Pour l'ouvrir correctement dans Excel, utilisez "Donn√©es" ‚Üí "Importer depuis un fichier texte/CSV" et s√©lectionnez le d√©limiteur point-virgule.</p>
                    </div>
                  </div>
                  </div>
                )}
              </div>

              {showProjectForm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 my-8 max-h-screen overflow-y-auto">
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">{editingProject ? 'Modifier le Projet' : 'Nouveau Projet'}</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="md:col-span-2">
                        <input type="text" placeholder="Nom du projet" value={formData.name} onChange={(e) => setFormData({ ...formData, name: e.target.value })} className="w-full border rounded px-3 py-2" />
                      </div>
                      <div className="md:col-span-2">
                        <textarea placeholder="Description" value={formData.description} onChange={(e) => setFormData({ ...formData, description: e.target.value })} className="w-full border rounded px-3 py-2 h-20" />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Statut</label>
                        <select value={formData.status} onChange={(e) => setFormData({ ...formData, status: e.target.value })} className="w-full border rounded px-3 py-2">
                          <option value="probable">Probable</option>
                          <option value="presente">Dummy</option>
                          <option value="programme">Programm√©</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Chef de projet</label>
                        <select value={formData.projectManager} onChange={(e) => setFormData({ ...formData, projectManager: e.target.value })} className="w-full border rounded px-3 py-2">
                          <option value="">Aucun</option>
                          {projectManagers.map(pm => <option key={pm.id} value={pm.id}>{pm.name} {pm.department && `(${pm.department})`}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date de d√©but</label>
                        <input type="date" value={formData.startDate} onChange={(e) => setFormData({ ...formData, startDate: e.target.value })} className="w-full border rounded px-3 py-2" />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">Date de fin</label>
                        <input type="date" value={formData.endDate} onChange={(e) => setFormData({ ...formData, endDate: e.target.value })} className="w-full border rounded px-3 py-2" />
                      </div>
                    </div>
                    {engineers.length > 0 && (
                      <div className="mt-4">
                        <p className="font-semibold text-gray-800 mb-2">Ing√©nieurs assign√©s :</p>
                        <div className="space-y-2 max-h-60 overflow-y-auto border rounded p-2">
                          {engineers.map(eng => {
                            const conflicts = checkResourceConflict(eng.id, 'engineer', formData.startDate, formData.endDate, editingProject?.id);
                            const isSelected = (formData.selectedEngineers || []).includes(eng.id);
                            return (
                              <div key={eng.id} className={`p-2 rounded ${conflicts.length > 0 && isSelected ? 'bg-yellow-50 border border-yellow-300' : ''}`}>
                                <label className="flex items-start gap-2 cursor-pointer">
                                  <input type="checkbox" checked={isSelected} onChange={() => toggleEngineer(eng.id)} className="rounded mt-1" />
                                  <div className="flex-1">
                                    <span className="text-sm font-semibold">{eng.name} {eng.specialty && `(${eng.specialty})`}</span>
                                    {conflicts.length > 0 && isSelected && (
                                      <div className="text-xs text-yellow-700 mt-1">‚ö†Ô∏è D√©j√† assign√©: {conflicts.map(p => p.name).join(', ')}</div>
                                    )}
                                    {isSelected && (
                                      <div className="mt-2 space-y-2">
                                        <div className="flex items-center gap-2">
                                          <label className="text-xs text-gray-600">Jours vendus:</label>
                                          <input type="number" min="0" value={formData.engineerDays[eng.id] || 0} onChange={(e) => setFormData(prev => ({...prev, engineerDays: {...prev.engineerDays, [eng.id]: parseInt(e.target.value) || 0}}))} className="w-20 border rounded px-2 py-1 text-sm" onClick={(e) => e.stopPropagation()} />
                                          <span className="text-xs text-gray-500">jours</span>
                                        </div>
                                        {formData.startDate && formData.endDate && formData.engineerDays[eng.id] > 0 && (
                                          <div className="flex gap-2">
                                            <button 
                                              type="button"
                                              onClick={(e) => { e.stopPropagation(); openMonthlyAllocationModal(eng.id, eng.name, 'engineer'); }}
                                              className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded font-semibold flex items-center gap-1"
                                            >
                                              üìÖ D√©tailler par mois
                                            </button>
                                            {formData.engineerMonthlyAllocation[eng.id] && (
                                              <button 
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); clearMonthlyAllocation(eng.id, 'engineer'); }}
                                                className="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded"
                                              >
                                                ‚úï
                                              </button>
                                            )}
                                          </div>
                                        )}
                                        {formData.engineerMonthlyAllocation[eng.id] && (
                                          <p className="text-xs text-green-700 font-semibold">‚úì Allocation d√©taill√©e d√©finie</p>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </label>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    {resources.length > 0 && (
                      <div className="mt-4">
                        <p className="font-semibold text-gray-800 mb-2">Ressources assign√©es :</p>
                        <div className="space-y-2 max-h-60 overflow-y-auto border rounded p-2">
                          {resources.map(res => {
                            const conflicts = checkResourceConflict(res.id, 'resource', formData.startDate, formData.endDate, editingProject?.id);
                            const isSelected = (formData.selectedResources || []).includes(res.id);
                            return (
                              <div key={res.id} className={`p-2 rounded ${conflicts.length > 0 && isSelected ? 'bg-yellow-50 border border-yellow-300' : ''}`}>
                                <label className="flex items-start gap-2 cursor-pointer">
                                  <input type="checkbox" checked={isSelected} onChange={() => toggleResource(res.id)} className="rounded mt-1" />
                                  <div className="flex-1">
                                    <span className="text-sm font-semibold">{res.name} {res.type && `(${res.type})`}</span>
                                    {conflicts.length > 0 && isSelected && (
                                      <div className="text-xs text-yellow-700 mt-1">‚ö†Ô∏è D√©j√† assign√©: {conflicts.map(p => p.name).join(', ')}</div>
                                    )}
                                    {isSelected && (
                                      <div className="mt-2 space-y-2">
                                        <div className="flex items-center gap-2">
                                          <label className="text-xs text-gray-600">Jours vendus:</label>
                                          <input type="number" min="0" value={formData.resourceDays[res.id] || 0} onChange={(e) => setFormData(prev => ({...prev, resourceDays: {...prev.resourceDays, [res.id]: parseInt(e.target.value) || 0}}))} className="w-20 border rounded px-2 py-1 text-sm" onClick={(e) => e.stopPropagation()} />
                                          <span className="text-xs text-gray-500">jours</span>
                                        </div>
                                        {formData.startDate && formData.endDate && formData.resourceDays[res.id] > 0 && (
                                          <div className="flex gap-2">
                                            <button 
                                              type="button"
                                              onClick={(e) => { e.stopPropagation(); openMonthlyAllocationModal(res.id, res.name, 'resource'); }}
                                              className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded font-semibold flex items-center gap-1"
                                            >
                                              üìÖ D√©tailler par mois
                                            </button>
                                            {formData.resourceMonthlyAllocation[res.id] && (
                                              <button 
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); clearMonthlyAllocation(res.id, 'resource'); }}
                                                className="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded"
                                              >
                                                ‚úï
                                              </button>
                                            )}
                                          </div>
                                        )}
                                        {formData.resourceMonthlyAllocation[res.id] && (
                                          <p className="text-xs text-green-700 font-semibold">‚úì Allocation d√©taill√©e d√©finie</p>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </label>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    {genericResources.length > 0 && (
                      <div className="mt-4">
                        <p className="font-semibold text-gray-800 mb-2">Ressources G√©n√©riques assign√©es :</p>
                        <div className="space-y-2 max-h-60 overflow-y-auto border rounded p-2">
                          {genericResources.map(res => {
                            const conflicts = checkResourceConflict(res.id, 'generic', formData.startDate, formData.endDate, editingProject?.id);
                            const isSelected = (formData.selectedGenericResources || []).includes(res.id);
                            return (
                              <div key={res.id} className={`p-2 rounded ${conflicts.length > 0 && isSelected ? 'bg-yellow-50 border border-yellow-300' : ''}`}>
                                <label className="flex items-start gap-2 cursor-pointer">
                                  <input type="checkbox" checked={isSelected} onChange={() => toggleGenericResource(res.id)} className="rounded mt-1" />
                                  <div className="flex-1">
                                    <span className="text-sm font-semibold">{res.name} {res.type && `(${res.type})`}</span>
                                    {conflicts.length > 0 && isSelected && (
                                      <div className="text-xs text-yellow-700 mt-1">‚ö†Ô∏è D√©j√† assign√©: {conflicts.map(p => p.name).join(', ')}</div>
                                    )}
                                    {isSelected && (
                                      <div className="mt-2 space-y-2">
                                        <div className="flex items-center gap-2">
                                          <label className="text-xs text-gray-600">Jours vendus:</label>
                                          <input type="number" min="0" value={formData.genericResourceDays[res.id] || 0} onChange={(e) => setFormData(prev => ({...prev, genericResourceDays: {...prev.genericResourceDays, [res.id]: parseInt(e.target.value) || 0}}))} className="w-20 border rounded px-2 py-1 text-sm" onClick={(e) => e.stopPropagation()} />
                                          <span className="text-xs text-gray-500">jours</span>
                                        </div>
                                        {formData.startDate && formData.endDate && formData.genericResourceDays[res.id] > 0 && (
                                          <div className="flex gap-2">
                                            <button 
                                              type="button"
                                              onClick={(e) => { e.stopPropagation(); openMonthlyAllocationModal(res.id, res.name, 'generic'); }}
                                              className="text-xs bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded font-semibold flex items-center gap-1"
                                            >
                                              üìÖ D√©tailler par mois
                                            </button>
                                            {formData.genericResourceMonthlyAllocation[res.id] && (
                                              <button 
                                                type="button"
                                                onClick={(e) => { e.stopPropagation(); clearMonthlyAllocation(res.id, 'generic'); }}
                                                className="text-xs bg-red-100 hover:bg-red-200 text-red-800 px-2 py-1 rounded"
                                              >
                                                ‚úï
                                              </button>
                                            )}
                                          </div>
                                        )}
                                        {formData.genericResourceMonthlyAllocation[res.id] && (
                                          <p className="text-xs text-green-700 font-semibold">‚úì Allocation d√©taill√©e d√©finie</p>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                </label>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    <div className="mt-6 border-t pt-4">
                      <h3 className="font-semibold text-gray-800 mb-3">üè∑Ô∏è Tags</h3>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Client</label>
                          <div className="flex gap-2 mb-2">
                            <input type="text" id="newClientTag" placeholder="Nouveau client" className="flex-1 border rounded px-3 py-2 text-sm" onKeyDown={(e) => { if (e.key === 'Enter') { const val = e.target.value.trim(); if (val) { addClientTag(val); toggleTag('client', val); e.target.value = ''; } } }} />
                            <button onClick={() => { const input = document.getElementById('newClientTag'); const val = input.value.trim(); if (val) { addClientTag(val); toggleTag('client', val); input.value = ''; } }} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-semibold">Ajouter</button>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {availableTags.client.map(tag => (
                              <button key={tag} onClick={() => toggleTag('client', tag)} className={`px-3 py-1 rounded-full text-sm border-2 ${(formData.tags.client || []).includes(tag) ? 'bg-blue-100 text-blue-800 border-blue-400 font-semibold' : 'bg-white text-gray-700 border-gray-300'}`}>
                                {tag}
                              </button>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Type de projet</label>
                          <div className="flex flex-wrap gap-2">
                            {availableTags.type.map(tag => (
                              <button key={tag} onClick={() => toggleTag('type', tag)} className={`px-3 py-1 rounded-full text-sm border-2 ${(formData.tags.type || []).includes(tag) ? 'bg-purple-100 text-purple-800 border-purple-400 font-semibold' : 'bg-white text-gray-700 border-gray-300'}`}>
                                {tag}
                              </button>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Priorit√©</label>
                          <div className="flex flex-wrap gap-2">
                            {availableTags.priority.map(tag => (
                              <button key={tag} onClick={() => toggleTag('priority', tag)} className={`px-3 py-1 rounded-full text-sm border-2 ${(formData.tags.priority || []).includes(tag) ? 'bg-red-100 text-red-800 border-red-400 font-semibold' : 'bg-white text-gray-700 border-gray-300'}`}>
                                {tag}
                              </button>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className="flex gap-2 mt-6">
                      <button onClick={addProject} className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2"><Check size={18} /> {editingProject ? 'Mettre √† jour' : 'Cr√©er'}</button>
                      <button onClick={resetProjectForm} className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2"><X size={18} /> Annuler</button>
                    </div>
                  </div>
                </div>
              )}

              {showDeleteWarning && resourceToDelete && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={cancelDelete}>
                  <div className="bg-white rounded-lg shadow-xl p-6 max-w-md mx-4" onClick={(e) => e.stopPropagation()}>
                    <div className="flex items-start gap-3 mb-4">
                      <div className="bg-red-100 rounded-full p-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#dc2626" strokeWidth="2">
                          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                          <line x1="12" y1="9" x2="12" y2="13"/>
                          <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                      </div>
                      <div className="flex-1">
                        <h3 className="text-lg font-bold text-gray-900 mb-2">‚ö†Ô∏è Attention - Ressource utilis√©e</h3>
                        <p className="text-gray-700 mb-3">
                          Voulez-vous vraiment supprimer <strong>{resourceToDelete.name}</strong> ?
                        </p>
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                          <p className="text-sm font-semibold text-yellow-800 mb-1">
                            Cette ressource est assign√©e √† {resourceToDelete.usedIn.length} projet(s) :
                          </p>
                          <ul className="text-sm text-yellow-700 space-y-1">
                            {resourceToDelete.usedIn.map(p => (
                              <li key={p.id}>‚Ä¢ {p.name}</li>
                            ))}
                          </ul>
                        </div>
                        <p className="text-sm text-gray-600">
                          La ressource sera automatiquement retir√©e de tous ces projets.
                        </p>
                      </div>
                    </div>
                    <div className="flex gap-3">
                      <button onClick={() => confirmDelete(resourceToDelete.id, resourceToDelete.type)} className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">
                        Confirmer la suppression
                      </button>
                      <button onClick={cancelDelete} className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold">
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showAlerts && (
                <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50" onClick={() => setShowAlerts(false)}>
                  <div className="bg-white rounded-lg shadow-xl p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-gray-900">üîî Alertes et notifications</h3>
                      <button onClick={() => setShowAlerts(false)} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                      </button>
                    </div>
                    {allAlerts.length === 0 ? (
                      <div className="text-center py-8">
                        <div className="text-6xl mb-2">‚úÖ</div>
                        <p className="text-gray-600">Aucune alerte ! Tout est en ordre.</p>
                      </div>
                    ) : (
                      <div className="space-y-3">
                        {allAlerts.map((alert, idx) => {
                          if (alert.type === 'overlap') {
                            return (
                              <div key={idx} className="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-red-100 rounded-full p-2">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" strokeWidth="2">
                                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                      <line x1="12" y1="9" x2="12" y2="13"/>
                                      <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                  </div>
                                  <div>
                                    <p className="font-semibold text-red-800">Chevauchement de dates</p>
                                    <p className="text-sm text-red-700">
                                      <strong>{alert.resource}</strong> ({alert.resourceType}) est assign√©(e) simultan√©ment sur :
                                    </p>
                                    <ul className="text-sm text-red-700 mt-1 ml-4">
                                      {alert.projects.map((p, i) => <li key={i}>‚Ä¢ {p}</li>)}
                                    </ul>
                                  </div>
                                </div>
                              </div>
                            );
                          } else if (alert.type === 'no-dates') {
                            return (
                              <div key={idx} className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-yellow-100 rounded-full p-2">
                                    <Calendar size={20} className="text-yellow-600" />
                                  </div>
                                  <div>
                                    <p className="font-semibold text-yellow-800">Dates manquantes</p>
                                    <p className="text-sm text-yellow-700">
                                      Le projet <strong>{alert.project}</strong> n'a pas de dates d√©finies.
                                    </p>
                                  </div>
                                </div>
                              </div>
                            );
                          } else if (alert.type === 'no-resources') {
                            return (
                              <div key={idx} className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                <div className="flex items-start gap-3">
                                  <div className="bg-orange-100 rounded-full p-2">
                                    <Users size={20} className="text-orange-600" />
                                  </div>
                                  <div>
                                    <p className="font-semibold text-orange-800">Ressources manquantes</p>
                                    <p className="text-sm text-orange-700">
                                      Le projet <strong>{alert.project}</strong> est "En cours" mais n'a aucune ressource assign√©e.
                                    </p>
                                  </div>
                                </div>
                              </div>
                            );
                          }
                        })}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {showDayModal && selectedDayProjects && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowDayModal(false)}>
                  <div className="bg-white rounded-lg shadow-xl p-6 max-w-3xl w-full mx-4 max-h-96 overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-gray-900">
                        üìÖ {selectedDayProjects.day} {new Date(selectedDayProjects.year, selectedDayProjects.month).toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                      </h3>
                      <button onClick={() => setShowDayModal(false)} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                      </button>
                    </div>
                    {selectedDayProjects.projects.length === 0 ? (
                      <p className="text-gray-500 text-center py-8">Aucun projet actif ce jour</p>
                    ) : (
                      <div className="space-y-3">
                        <p className="text-sm text-gray-600">{selectedDayProjects.projects.length} projet(s) actif(s) ce jour</p>
                        {selectedDayProjects.projects.map(project => (
                          <div key={project.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <h4 className="font-bold text-gray-800">{project.name}</h4>
                                <p className="text-sm text-gray-600 mt-1">
                                  {project.startDate && `Du ${new Date(project.startDate).toLocaleDateString('fr-FR')}`}
                                  {project.startDate && project.endDate && ' - '}
                                  {project.endDate && `au ${new Date(project.endDate).toLocaleDateString('fr-FR')}`}
                                </p>
                              </div>
                              <span className={`px-2 py-1 rounded-full text-xs font-semibold ${statusConfig[project.status]?.color || 'bg-gray-100 text-gray-800'}`}>
                                {statusConfig[project.status]?.label || project.status}
                              </span>
                            </div>
                            <div className="mt-2 space-y-2">
                              {getProjectManager(project) && (
                                <div className="flex items-center gap-2">
                                  <span className="text-xs font-semibold text-gray-600">PM:</span>
                                  <span className="text-xs bg-orange-100 text-orange-800 px-2 py-0.5 rounded">{getProjectManager(project).name}</span>
                                </div>
                              )}
                              {getAssignedEngineers(project).length > 0 && (
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="text-xs font-semibold text-gray-600">Ing√©nieurs:</span>
                                  {getAssignedEngineers(project).map(eng => (
                                    <span key={eng.id} className="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded">{eng.name}</span>
                                  ))}
                                </div>
                              )}
                              {getAssignedResources(project).length > 0 && (
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="text-xs font-semibold text-gray-600">Ressources:</span>
                                  {getAssignedResources(project).map(res => (
                                    <span key={res.id} className="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded">{res.name}</span>
                                  ))}
                                </div>
                              )}
                              {getAssignedGenericResources(project).length > 0 && (
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="text-xs font-semibold text-gray-600">G√©n√©riques:</span>
                                  {getAssignedGenericResources(project).map(res => (
                                    <span key={res.id} className="text-xs bg-teal-100 text-teal-800 px-2 py-0.5 rounded">{res.name}</span>
                                  ))}
                                </div>
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {showConflictModal && conflictToResolve && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowConflictModal(false)}>
                  <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6 max-h-[85vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <AlertTriangle size={24} className="text-red-600" />
                        R√©soudre le conflit
                      </h3>
                      <button onClick={() => setShowConflictModal(false)} className="text-gray-500 hover:text-gray-700">
                        <X size={24} />
                      </button>
                    </div>

                    <div className="mb-6">
                      <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
                        <p className="text-sm text-red-900 font-semibold mb-2">Chevauchement d√©tect√©:</p>
                        <p className="text-sm text-red-800">
                          <strong>{conflictToResolve.project1.name}</strong> et <strong>{conflictToResolve.project2.name}</strong> 
                          se chevauchent du {conflictToResolve.overlapStart.toLocaleDateString('fr-FR')} au {conflictToResolve.overlapEnd.toLocaleDateString('fr-FR')}
                        </p>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="border-2 border-indigo-200 rounded-lg p-4">
                          <p className="font-bold text-gray-800 mb-2">{conflictToResolve.project1.name}</p>
                          <p className="text-sm text-gray-600 mb-3">
                            Du {new Date(conflictToResolve.project1.startDate).toLocaleDateString('fr-FR')} 
                            au {new Date(conflictToResolve.project1.endDate).toLocaleDateString('fr-FR')}
                          </p>
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project1.status]?.color || 'bg-gray-200'}`}>
                            {statusConfig[conflictToResolve.project1.status]?.label || conflictToResolve.project1.status}
                          </span>
                        </div>

                        <div className="border-2 border-indigo-200 rounded-lg p-4">
                          <p className="font-bold text-gray-800 mb-2">{conflictToResolve.project2.name}</p>
                          <p className="text-sm text-gray-600 mb-3">
                            Du {new Date(conflictToResolve.project2.startDate).toLocaleDateString('fr-FR')} 
                            au {new Date(conflictToResolve.project2.endDate).toLocaleDateString('fr-FR')}
                          </p>
                          <span className={`px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project2.status]?.color || 'bg-gray-200'}`}>
                            {statusConfig[conflictToResolve.project2.status]?.label || conflictToResolve.project2.status}
                          </span>
                        </div>
                      </div>
                    </div>

                    {/* R√©solution Automatique par Priorit√© */}
                    <div className="mb-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-lg p-5 shadow-md">
                      <div className="flex items-center gap-2 mb-4">
                        <span className="text-2xl">üéØ</span>
                        <h4 className="text-lg font-bold text-purple-900">R√©solution Automatique par Priorit√©</h4>
                      </div>
                      
                      <p className="text-sm text-purple-700 mb-4">
                        Choisissez quel projet est prioritaire. Ses allocations resteront <strong>fixes</strong>. 
                        L'autre projet sera automatiquement allou√© dans les jours disponibles restants.
                      </p>
                      
                      {/* Radio buttons selezione progetto prioritario */}
                      <div className="space-y-3 mb-5">
                        <label className={`flex items-start gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                          priorityProject === 'project1' 
                            ? 'bg-purple-100 border-purple-500' 
                            : 'bg-white border-gray-300 hover:border-purple-300'
                        }`}>
                          <input
                            type="radio"
                            name="priorityProject"
                            checked={priorityProject === 'project1'}
                            onChange={() => setPriorityProject('project1')}
                            className="mt-1 w-5 h-5 text-purple-600"
                          />
                          <div className="flex-1">
                            <p className="font-bold text-gray-800">{conflictToResolve.project1.name}</p>
                            <p className="text-sm text-gray-600">
                              {new Date(conflictToResolve.project1.startDate).toLocaleDateString('fr-FR')} ‚Üí 
                              {new Date(conflictToResolve.project1.endDate).toLocaleDateString('fr-FR')}
                            </p>
                            <span className={`inline-block mt-1 px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project1.status]?.color || 'bg-gray-200'}`}>
                              {statusConfig[conflictToResolve.project1.status]?.label || conflictToResolve.project1.status}
                            </span>
                            {priorityProject === 'project1' && (
                              <p className="text-xs text-purple-700 mt-2 font-semibold">
                                ‚úì Prioritaire - Dates gard√©es fixes
                              </p>
                            )}
                          </div>
                        </label>
                        
                        <label className={`flex items-start gap-3 p-4 rounded-lg border-2 cursor-pointer transition-all ${
                          priorityProject === 'project2' 
                            ? 'bg-purple-100 border-purple-500' 
                            : 'bg-white border-gray-300 hover:border-purple-300'
                        }`}>
                          <input
                            type="radio"
                            name="priorityProject"
                            checked={priorityProject === 'project2'}
                            onChange={() => setPriorityProject('project2')}
                            className="mt-1 w-5 h-5 text-purple-600"
                          />
                          <div className="flex-1">
                            <p className="font-bold text-gray-800">{conflictToResolve.project2.name}</p>
                            <p className="text-sm text-gray-600">
                              {new Date(conflictToResolve.project2.startDate).toLocaleDateString('fr-FR')} ‚Üí 
                              {new Date(conflictToResolve.project2.endDate).toLocaleDateString('fr-FR')}
                            </p>
                            <span className={`inline-block mt-1 px-2 py-1 rounded text-xs font-semibold ${statusConfig[conflictToResolve.project2.status]?.color || 'bg-gray-200'}`}>
                              {statusConfig[conflictToResolve.project2.status]?.label || conflictToResolve.project2.status}
                            </span>
                            {priorityProject === 'project2' && (
                              <p className="text-xs text-purple-700 mt-2 font-semibold">
                                ‚úì Prioritaire - Dates gard√©es fixes
                              </p>
                            )}
                          </div>
                        </label>
                      </div>
                      
                      {/* Button applicazione */}
                      <button
                        onClick={() => {
                          if (!priorityProject) {
                            alert('‚ö†Ô∏è Veuillez s√©lectionner un projet prioritaire');
                            return;
                          }
                          
                          const result = resolveByPriority(conflictToResolve, priorityProject);
                          
                          // üîß FIX #3: Se giorni insufficienti ‚Üí BLOCCA e torna a manuale
                          if (result.warning) {
                            alert(`‚ùå ${result.warning}\n\n‚ö†Ô∏è Jours disponibles insuffisants!\n\nVeuillez r√©soudre le conflit manuellement en utilisant les calendriers ci-dessous.`);
                            return; // NON applica niente, modal rimane aperto
                          }
                          
                          // Ottieni info risorsa dal conflitto
                          const resourceId = conflictToResolve.resourceId;
                          const resourceType = conflictToResolve.resourceType;
                          
                          // üîß FIX #1: Applica la risoluzione con aggiornamento campi corretti
                          const updatedProjects = projects.map(p => {
                            if (p.id === result.priorityProject.id) {
                              // Progetto prioritario: mantieni com'√® (date bloccate)
                              return p;
                            } else if (p.id === result.secondaryProject.id) {
                              // Progetto secondario: aggiorna con nuove allocazioni
                              
                              // Prepara update base
                              const updatedProject = {
                                ...p,
                                startDate: result.secondaryProject.newStartDate,
                                endDate: result.secondaryProject.newEndDate,
                                selectedDates: result.secondaryProject.allocations  // ‚úÖ SOSTITUISCI completamente
                              };
                              
                              // üîß FIX #1: Aggiorna campo corretto per tipo risorsa
                              if (resourceId && resourceType) {
                                if (resourceType === 'engineer') {
                                  updatedProject.engineerMonthlyAllocation = {
                                    ...(p.engineerMonthlyAllocation || {}),
                                    [resourceId]: result.secondaryProject.allocations
                                  };
                                } else if (resourceType === 'resource') {
                                  updatedProject.resourceMonthlyAllocation = {
                                    ...(p.resourceMonthlyAllocation || {}),
                                    [resourceId]: result.secondaryProject.allocations
                                  };
                                } else if (resourceType === 'generic') {
                                  updatedProject.genericResourceMonthlyAllocation = {
                                    ...(p.genericResourceMonthlyAllocation || {}),
                                    [resourceId]: result.secondaryProject.allocations
                                  };
                                }
                              }
                              
                              return updatedProject;
                            }
                            return p;
                          });
                          
                          setProjects(updatedProjects);
                          
                          // üîß FIX: Refresh PRIMA di chiudere modal
                          if (resourceId) {
                            setSelectedResourceId(''); // Reset
                            setTimeout(() => {
                              setSelectedResourceId(resourceId); // Restore ‚Üí triggers recalc
                              
                              // Chiudi modal DOPO refresh
                              setShowConflictModal(false);
                              setConflictToResolve(null);
                              setPriorityProject(null);
                              
                              // Alert finale
                              alert(`‚úÖ R√©solution appliqu√©e avec succ√®s!\n\nAllou√© ${result.daysAllocated}j pour ${result.secondaryProject.name}`);
                            }, 300);
                          } else {
                            // Fallback se no resourceId
                            setShowConflictModal(false);
                            setConflictToResolve(null);
                            setPriorityProject(null);
                            alert(`‚úÖ R√©solution appliqu√©e avec succ√®s!\n\nAllou√© ${result.daysAllocated}j pour ${result.secondaryProject.name}`);
                          }
                        }}
                        disabled={!priorityProject}
                        className={`w-full font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg ${
                          priorityProject 
                            ? 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white' 
                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                        }`}
                      >
                        <span className="text-xl">‚ú®</span>
                        <span>Appliquer r√©solution par priorit√©</span>
                      </button>
                      
                      <div className="mt-3 text-xs text-purple-800 bg-purple-100 rounded px-3 py-2">
                        üí° <strong>Info:</strong> Cette r√©solution automatique trouve les jours disponibles en √©vitant les conflits avec le projet prioritaire. Si pas assez de jours, un avertissement sera affich√©.
                      </div>
                    </div>

                    <div className="space-y-3">
                      <p className="font-semibold text-gray-800 mb-3">Options de r√©solution:</p>
                      
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="font-semibold text-blue-900 mb-3 flex items-center justify-between">
                          <span>üìÖ Modifier les dates de {conflictToResolve.project1.name}</span>
                          <span className="text-sm font-normal">
                            Total: {getConflictTotalDays('project1')} jour(s)
                          </span>
                        </p>
                        
                        {/* Toggle Calendario */}
                        <button
                          onClick={() => setConflictCalendarMode(conflictCalendarMode === 'project1' ? null : 'project1')}
                          className="w-full mb-3 bg-blue-100 hover:bg-blue-200 text-blue-900 px-3 py-2 rounded font-semibold text-sm flex items-center justify-center gap-2"
                        >
                          {conflictCalendarMode === 'project1' ? 'üìÖ Masquer' : 'üìÖ Ouvrir'} le calendrier
                        </button>
                        
                        {/* Calendario Interattivo */}
                        {conflictCalendarMode === 'project1' && (
                          <div className="bg-white border-2 border-blue-300 rounded-lg p-4 mb-3">
                            {/* Range Selection */}
                            <div className="mb-4 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-3">
                              <h4 className="text-sm font-bold text-green-900 mb-3">‚ö° S√©lection Rapide par P√©riode</h4>
                              
                              <div className="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date d√©but</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeStart}
                                    onChange={(e) => setConflictRangeStart(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date fin</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeEnd}
                                    onChange={(e) => setConflictRangeEnd(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                              </div>
                              
                              <div className="mb-3">
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="checkbox"
                                    checked={conflictRangeWorkdaysOnly}
                                    onChange={(e) => setConflictRangeWorkdaysOnly(e.target.checked)}
                                    className="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-xs font-semibold text-gray-700 group-hover:text-green-700">
                                    üìÜ Seulement jours ouvrables (Lun-Ven)
                                  </span>
                                </label>
                              </div>
                              
                              <div className="flex gap-2">
                                <button
                                  onClick={() => applyConflictRangeSelection('project1', 0.5)}
                                  className="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 0.5j
                                </button>
                                <button
                                  onClick={() => applyConflictRangeSelection('project1', 1.0)}
                                  className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 1.0j
                                </button>
                              </div>
                            </div>
                            
                            {/* Header: Mois/Anno navigation */}
                            <div className="flex items-center justify-between mb-3 bg-blue-50 p-2 rounded">
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() - 1))}
                                className="text-blue-900 hover:bg-blue-200 px-3 py-1 rounded font-bold"
                              >
                                ‚óÄ
                              </button>
                              <span className="font-bold text-blue-900 text-sm">
                                {conflictCalendarMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                              </span>
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() + 1))}
                                className="text-blue-900 hover:bg-blue-200 px-3 py-1 rounded font-bold"
                              >
                                ‚ñ∂
                              </button>
                            </div>
                            
                            {/* Giorni settimana header */}
                            <div className="grid grid-cols-7 gap-1 mb-2">
                              {['Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa', 'Di'].map(day => (
                                <div key={day} className="text-center text-xs font-bold text-gray-600 py-1">
                                  {day}
                                </div>
                              ))}
                            </div>
                            
                            {/* Giorni calendario */}
                            <div className="grid grid-cols-7 gap-1">
                              {generateConflictCalendarDays(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth()).map((day, index) => {
                                const allocation = getConflictDayAllocation(day, 'project1');
                                
                                // V√©rifier conflit avec autres projets (syst√®me intelligent)
                                const year = conflictCalendarMonth.getFullYear();
                                const month = conflictCalendarMonth.getMonth();
                                const dateKey = day ? `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : null;
                                const isAllocatedElsewhere = dateKey ? isDayAllocatedElsewhere(
                                  dateKey, 
                                  conflictToResolve?.project1?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : false;
                                const allocationDetails = isAllocatedElsewhere ? getAllocationDetails(
                                  dateKey, 
                                  conflictToResolve?.project1?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : null;
                                
                                return (
                                  <button
                                    key={index}
                                    onClick={() => handleConflictDayClick(day, 'project1')}
                                    disabled={!day}
                                    title={allocationDetails ? 
                                      `‚ö†Ô∏è D√©j√† allou√© dans:\n${allocationDetails.map(a => `${a.projectName} (${a.allocation}j)`).join('\n')}` 
                                      : ''
                                    }
                                    className={`
                                      aspect-square text-xs rounded flex flex-col items-center justify-center font-semibold relative
                                      ${!day ? 'invisible' : ''}
                                      ${allocation === 1.0 ? 'bg-blue-600 text-white hover:bg-blue-700' : ''}
                                      ${allocation === 0.5 ? 'bg-orange-400 text-white hover:bg-orange-500' : ''}
                                      ${!allocation ? 'bg-gray-100 hover:bg-blue-100 text-gray-700' : ''}
                                      ${isAllocatedElsewhere ? 'border-2 border-red-500' : ''}
                                    `}
                                  >
                                    {isAllocatedElsewhere && (
                                      <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px] font-bold">
                                        ‚ö†
                                      </div>
                                    )}
                                    <span>{day}</span>
                                    {allocation && <span className="text-[8px]">{allocation}j</span>}
                                  </button>
                                );
                              })}
                            </div>
                            
                            {/* Legenda */}
                            <div className="mt-3 pt-3 border-t border-blue-200 flex gap-3 text-xs">
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                                <span>Vide</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-orange-400 rounded"></div>
                                <span>0.5j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-blue-600 rounded"></div>
                                <span>1.0j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px]">‚ö†</div>
                                <span>D√©j√† allou√©</span>
                              </div>
                            </div>
                            
                            <p className="mt-3 text-xs text-blue-800 bg-blue-50 p-2 rounded">
                              üí° <strong>Conseil:</strong> Click sur un jour pour cycler entre √©tats (Vide ‚Üí 0.5j ‚Üí 1.0j ‚Üí Vide)
                            </p>
                          </div>
                        )}
                        
                        <button 
                          onClick={() => {
                            const dates = calculateConflictProjectDates('project1');
                            if (dates.start && dates.end) {
                              resolveConflict(conflictToResolve, 'modify1', { startDate: dates.start, endDate: dates.end }, conflictSelectedDays.project1);
                              setConflictCalendarMode(null);
                            } else {
                              alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un jour');
                            }
                          }}
                          className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold text-sm"
                        >
                          Appliquer √† {conflictToResolve.project1.name}
                        </button>
                      </div>

                      <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p className="font-semibold text-green-900 mb-3 flex items-center justify-between">
                          <span>üìÖ Modifier les dates de {conflictToResolve.project2.name}</span>
                          <span className="text-sm font-normal">
                            Total: {getConflictTotalDays('project2')} jour(s)
                          </span>
                        </p>
                        
                        {/* Toggle Calendario */}
                        <button
                          onClick={() => setConflictCalendarMode(conflictCalendarMode === 'project2' ? null : 'project2')}
                          className="w-full mb-3 bg-green-100 hover:bg-green-200 text-green-900 px-3 py-2 rounded font-semibold text-sm flex items-center justify-center gap-2"
                        >
                          {conflictCalendarMode === 'project2' ? 'üìÖ Masquer' : 'üìÖ Ouvrir'} le calendrier
                        </button>
                        
                        {/* Calendario Interattivo */}
                        {conflictCalendarMode === 'project2' && (
                          <div className="bg-white border-2 border-green-300 rounded-lg p-4 mb-3">
                            {/* Range Selection */}
                            <div className="mb-4 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-3">
                              <h4 className="text-sm font-bold text-green-900 mb-3">‚ö° S√©lection Rapide par P√©riode</h4>
                              
                              <div className="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date d√©but</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeStart}
                                    onChange={(e) => setConflictRangeStart(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                                <div>
                                  <label className="block text-xs font-semibold text-gray-700 mb-1">üìÖ Date fin</label>
                                  <input 
                                    type="date"
                                    value={conflictRangeEnd}
                                    onChange={(e) => setConflictRangeEnd(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded px-2 py-1 text-sm"
                                  />
                                </div>
                              </div>
                              
                              <div className="mb-3">
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="checkbox"
                                    checked={conflictRangeWorkdaysOnly}
                                    onChange={(e) => setConflictRangeWorkdaysOnly(e.target.checked)}
                                    className="w-4 h-4 text-green-600 rounded focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-xs font-semibold text-gray-700 group-hover:text-green-700">
                                    üìÜ Seulement jours ouvrables (Lun-Ven)
                                  </span>
                                </label>
                              </div>
                              
                              <div className="flex gap-2">
                                <button
                                  onClick={() => applyConflictRangeSelection('project2', 0.5)}
                                  className="flex-1 bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 0.5j
                                </button>
                                <button
                                  onClick={() => applyConflictRangeSelection('project2', 1.0)}
                                  className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-xs font-bold"
                                >
                                  Appliquer 1.0j
                                </button>
                              </div>
                            </div>
                            
                            {/* Header: Mois/Anno navigation */}
                            <div className="flex items-center justify-between mb-3 bg-green-50 p-2 rounded">
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() - 1))}
                                className="text-green-900 hover:bg-green-200 px-3 py-1 rounded font-bold"
                              >
                                ‚óÄ
                              </button>
                              <span className="font-bold text-green-900 text-sm">
                                {conflictCalendarMonth.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}
                              </span>
                              <button
                                onClick={() => setConflictCalendarMonth(new Date(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth() + 1))}
                                className="text-green-900 hover:bg-green-200 px-3 py-1 rounded font-bold"
                              >
                                ‚ñ∂
                              </button>
                            </div>
                            
                            {/* Giorni settimana header */}
                            <div className="grid grid-cols-7 gap-1 mb-2">
                              {['Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa', 'Di'].map(day => (
                                <div key={day} className="text-center text-xs font-bold text-gray-600 py-1">
                                  {day}
                                </div>
                              ))}
                            </div>
                            
                            {/* Giorni calendario */}
                            <div className="grid grid-cols-7 gap-1">
                              {generateConflictCalendarDays(conflictCalendarMonth.getFullYear(), conflictCalendarMonth.getMonth()).map((day, index) => {
                                const allocation = getConflictDayAllocation(day, 'project2');
                                
                                // V√©rifier conflit avec autres projets (syst√®me intelligent)
                                const year = conflictCalendarMonth.getFullYear();
                                const month = conflictCalendarMonth.getMonth();
                                const dateKey = day ? `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : null;
                                const isAllocatedElsewhere = dateKey ? isDayAllocatedElsewhere(
                                  dateKey, 
                                  conflictToResolve?.project2?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : false;
                                const allocationDetails = isAllocatedElsewhere ? getAllocationDetails(
                                  dateKey, 
                                  conflictToResolve?.project2?.id,
                                  conflictToResolve?.resourceName,
                                  conflictToResolve?.resourceType
                                ) : null;
                                
                                return (
                                  <button
                                    key={index}
                                    onClick={() => handleConflictDayClick(day, 'project2')}
                                    disabled={!day}
                                    title={allocationDetails ? 
                                      `‚ö†Ô∏è D√©j√† allou√© dans:\n${allocationDetails.map(a => `${a.projectName} (${a.allocation}j)`).join('\n')}` 
                                      : ''
                                    }
                                    className={`
                                      aspect-square text-xs rounded flex flex-col items-center justify-center font-semibold relative
                                      ${!day ? 'invisible' : ''}
                                      ${allocation === 1.0 ? 'bg-green-600 text-white hover:bg-green-700' : ''}
                                      ${allocation === 0.5 ? 'bg-orange-400 text-white hover:bg-orange-500' : ''}
                                      ${!allocation ? 'bg-gray-100 hover:bg-green-100 text-gray-700' : ''}
                                      ${isAllocatedElsewhere ? 'border-2 border-red-500' : ''}
                                    `}
                                  >
                                    {isAllocatedElsewhere && (
                                      <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px] font-bold">
                                        ‚ö†
                                      </div>
                                    )}
                                    <span>{day}</span>
                                    {allocation && <span className="text-[8px]">{allocation}j</span>}
                                  </button>
                                );
                              })}
                            </div>
                            
                            {/* Legenda */}
                            <div className="mt-3 pt-3 border-t border-green-200 flex gap-3 text-xs">
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-gray-100 border border-gray-300 rounded"></div>
                                <span>Vide</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-orange-400 rounded"></div>
                                <span>0.5j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-4 h-4 bg-green-600 rounded"></div>
                                <span>1.0j</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-3 h-3 bg-red-500 rounded-full flex items-center justify-center text-white text-[8px]">‚ö†</div>
                                <span>D√©j√† allou√©</span>
                              </div>
                            </div>
                            
                            <p className="mt-3 text-xs text-green-800 bg-green-50 p-2 rounded">
                              üí° <strong>Conseil:</strong> Click sur un jour pour cycler entre √©tats (Vide ‚Üí 0.5j ‚Üí 1.0j ‚Üí Vide)
                            </p>
                          </div>
                        )}
                        
                        <button 
                          onClick={() => {
                            const dates = calculateConflictProjectDates('project2');
                            if (dates.start && dates.end) {
                              resolveConflict(conflictToResolve, 'modify2', { startDate: dates.start, endDate: dates.end }, conflictSelectedDays.project2);
                              setConflictCalendarMode(null);
                            } else {
                              alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un jour');
                            }
                          }}
                          className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold text-sm"
                        >
                          Appliquer √† {conflictToResolve.project2.name}
                        </button>
                      </div>

                      <div className="bg-gray-100 border border-gray-300 rounded-lg p-4 text-center">
                        <p className="text-sm text-gray-600 mb-2">üí° Conseil: Cliquez sur les jours individuels ou utilisez la s√©lection rapide par p√©riode</p>
                        <button 
                          onClick={() => setShowConflictModal(false)}
                          className="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded font-semibold text-sm"
                        >
                          Annuler
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal Confirmation Conflits (Syst√®me Intelligent) */}
              {showConflictWarningModal && conflictWarningData && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
                    {/* Header fisso */}
                    <div className="flex items-center gap-3 p-6 border-b border-gray-200">
                      <div className="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                        ‚ö†
                      </div>
                      <div>
                        <h3 className="text-xl font-bold text-gray-900">Conflit d'allocation d√©tect√©</h3>
                        <p className="text-sm text-gray-600">Des jours sont d√©j√† allou√©s dans d'autres projets</p>
                      </div>
                    </div>
                    
                    {/* Contenuto scrollabile */}
                    <div className="flex-1 overflow-y-auto p-6">
                      <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4 mb-4">
                        <h4 className="font-bold text-red-900 mb-3">Jours en conflit:</h4>
                        
                        {Object.entries(conflictWarningData.days).map(([date, info]) => (
                          <div key={date} className="mb-3 bg-white rounded p-3">
                            <p className="font-semibold text-gray-900 mb-1">
                              üìÖ {new Date(date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                            </p>
                            <div className="ml-4 space-y-1">
                              {info.map((alloc, idx) => (
                                <div key={idx} className="text-sm text-gray-700">
                                  <span className="font-semibold">{alloc.projectName}</span>
                                  <span className="text-gray-500"> - </span>
                                  <span className={`px-2 py-0.5 rounded ${
                                    alloc.allocation === 1.0 ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'
                                  }`}>
                                    {alloc.allocation}j allou√©
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                      
                      <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                        <h4 className="font-bold text-yellow-900 mb-2">‚ö° Action propos√©e:</h4>
                        <p className="text-sm text-yellow-800 mb-2">
                          Si vous confirmez, les jours s√©lectionn√©s seront:
                        </p>
                        <ul className="text-sm text-yellow-800 space-y-1 ml-4">
                          <li>‚Ä¢ <strong>Retir√©s ou r√©duits</strong> des projets existants selon la r√®gle de split</li>
                          <li>‚Ä¢ <strong>Allou√©s</strong> au projet <span className="font-semibold">{conflictWarningData.currentProject}</span></li>
                        </ul>
                        <p className="text-xs text-yellow-700 mt-3 italic">
                          üí° R√®gle de split: Si vous allouez 0.5j sur un jour qui a d√©j√† 1.0j, 
                          l'ancien projet sera r√©duit √† 0.5j (partage √©quitable)
                        </p>
                      </div>
                    </div>
                    
                    {/* Footer fisso con bottoni */}
                    <div className="flex gap-3 p-6 border-t border-gray-200 bg-gray-50 rounded-b-lg">
                      <button
                        onClick={() => {
                          setShowConflictWarningModal(false);
                          setConflictWarningData(null);
                          setPendingAllocationAction(null);
                        }}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-3 rounded-lg font-semibold"
                      >
                        ‚ùå Annuler
                      </button>
                      <button
                        onClick={() => {
                          if (pendingAllocationAction) {
                            pendingAllocationAction();
                          }
                          setShowConflictWarningModal(false);
                          setConflictWarningData(null);
                          setPendingAllocationAction(null);
                        }}
                        className="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-lg font-semibold"
                      >
                        ‚úÖ Confirmer et appliquer
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal Allocation Mensuelle D√©taill√©e */}
              {showMonthlyAllocationModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowMonthlyAllocationModal(false)}>
                  <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="sticky top-0 bg-gradient-to-r from-indigo-600 to-blue-600 text-white p-6 rounded-t-lg z-10">
                      <h3 className="text-xl font-bold flex items-center gap-2">
                        üìÖ R√©partition Mensuelle D√©taill√©e
                      </h3>
                      <p className="text-sm mt-1 text-indigo-100">
                        {monthlyAllocationData.resourceName} - Total: {monthlyAllocationData.totalDays} jours
                      </p>
                    </div>
                    
                    <div className="p-6">
                      {!formData.startDate || !formData.endDate ? (
                        <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-center">
                          <p className="text-yellow-800 font-semibold">‚ö†Ô∏è D√©finissez d'abord les dates du projet</p>
                        </div>
                      ) : (
                        <>
                          {/* Sezione Selezione Rapida Range Date */}
                          <div className="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300 rounded-lg p-5 mb-6 shadow-md">
                            <h4 className="text-lg font-bold text-green-900 mb-4 flex items-center gap-2">
                              ‚ö° S√©lection Rapide par P√©riode
                            </h4>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  üìÖ Date d√©but
                                </label>
                                <input 
                                  type="date"
                                  value={rangeStartDate}
                                  onChange={(e) => setRangeStartDate(e.target.value)}
                                  min={formData.startDate}
                                  max={formData.endDate}
                                  className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all"
                                />
                              </div>
                              
                              <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">
                                  üìÖ Date fin
                                </label>
                                <input 
                                  type="date"
                                  value={rangeEndDate}
                                  onChange={(e) => setRangeEndDate(e.target.value)}
                                  min={formData.startDate}
                                  max={formData.endDate}
                                  className="w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all"
                                />
                              </div>
                            </div>
                            
                            <div className="mb-4">
                              <label className="flex items-center gap-2 cursor-pointer group">
                                <input 
                                  type="checkbox"
                                  checked={rangeWorkdaysOnly}
                                  onChange={(e) => setRangeWorkdaysOnly(e.target.checked)}
                                  className="w-5 h-5 text-green-600 rounded focus:ring-2 focus:ring-green-300"
                                />
                                <span className="text-sm font-semibold text-gray-700 group-hover:text-green-700">
                                  üìÜ Seulement jours ouvrables (Lun-Ven)
                                </span>
                              </label>
                            </div>
                            
                            <div className="mb-4">
                              <label className="block text-sm font-semibold text-gray-700 mb-2">
                                Allocation par d√©faut:
                              </label>
                              <div className="flex gap-4">
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="radio"
                                    name="rangeAllocationType"
                                    checked={rangeAllocationType === 0.5}
                                    onChange={() => setRangeAllocationType(0.5)}
                                    className="w-4 h-4 text-green-600 focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-sm font-semibold text-gray-700 group-hover:text-green-700">
                                    üîµ¬Ω Demi-journ√©e (0.5j)
                                  </span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer group">
                                  <input 
                                    type="radio"
                                    name="rangeAllocationType"
                                    checked={rangeAllocationType === 1.0}
                                    onChange={() => setRangeAllocationType(1.0)}
                                    className="w-4 h-4 text-green-600 focus:ring-2 focus:ring-green-300"
                                  />
                                  <span className="text-sm font-semibold text-gray-700 group-hover:text-green-700">
                                    üîµ Journ√©e enti√®re (1j)
                                  </span>
                                </label>
                              </div>
                            </div>
                            
                            <button 
                              onClick={applyDateRange}
                              className="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg"
                            >
                              <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>
                              </svg>
                              üìÖ Appliquer le range sur le calendrier
                            </button>
                            
                            <div className="mt-3 text-xs text-green-800 bg-green-100 rounded px-3 py-2">
                              üí° <strong>Astuce:</strong> Apr√®s avoir appliqu√© le range, vous pouvez encore modifier individuellement chaque jour en cliquant dessus dans le calendrier ci-dessous.
                            </div>
                          </div>
                          
                          {/* Pannello Suggestions Smart - Feature #4 */}
                          <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-lg p-5 mb-6 shadow-md">
                            <div className="flex items-center gap-2 mb-3">
                              <span className="text-2xl">üí°</span>
                              <h4 className="text-lg font-bold text-purple-900">Suggestions d'Allocation Rapide</h4>
                            </div>
                            <p className="text-sm text-purple-700 mb-4">
                              Cliquez sur une suggestion pour s√©lectionner automatiquement les jours ouvrables
                            </p>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                              {(() => {
                                const totalDays = monthlyAllocationData.totalDays;
                                const suggestions = [];
                                
                                // Suggestion: 1 mois complet (22j)
                                if (totalDays >= 20 && totalDays <= 23) {
                                  suggestions.push({
                                    label: 'üìÜ 1 mois complet',
                                    days: 22,
                                    color: 'bg-blue-500 hover:bg-blue-600'
                                  });
                                }
                                
                                // Suggestion: 3 semaines (15j)
                                if (totalDays >= 14 && totalDays <= 16) {
                                  suggestions.push({
                                    label: 'üìä 3 semaines',
                                    days: 15,
                                    color: 'bg-green-500 hover:bg-green-600'
                                  });
                                }
                                
                                // Suggestion: 2 semaines (10j)
                                if (totalDays >= 9 && totalDays <= 11) {
                                  suggestions.push({
                                    label: 'üìã 2 semaines',
                                    days: 10,
                                    color: 'bg-yellow-500 hover:bg-yellow-600'
                                  });
                                }
                                
                                // Suggestion: 1 semaine (5j)
                                if (totalDays >= 4 && totalDays <= 6) {
                                  suggestions.push({
                                    label: 'üìå 1 semaine',
                                    days: 5,
                                    color: 'bg-orange-500 hover:bg-orange-600'
                                  });
                                }
                                
                                // Toujours: 50% disponibilit√©
                                suggestions.push({
                                  label: '‚öñÔ∏è 50% disponibilit√©',
                                  days: Math.round(totalDays / 2),
                                  color: 'bg-indigo-500 hover:bg-indigo-600'
                                });
                                
                                // Toujours: Total disponible
                                suggestions.push({
                                  label: 'üíØ Total disponible',
                                  days: totalDays,
                                  color: 'bg-purple-500 hover:bg-purple-600'
                                });
                                
                                return suggestions.map((suggestion, idx) => (
                                  <button
                                    key={idx}
                                    onClick={() => {
                                      // Applique la suggestion: s√©lection N jours ouvrables
                                      const projectStart = new Date(formData.startDate);
                                      const projectEnd = new Date(formData.endDate);
                                      const newSelectedDates = {};
                                      let currentDate = new Date(projectStart);
                                      let workingDaysCount = 0;
                                      
                                      // Seleziona N giorni lavorativi (Lun-Ven) dall'inizio progetto
                                      while (workingDaysCount < suggestion.days && currentDate <= projectEnd) {
                                        const dayOfWeek = currentDate.getDay();
                                        // Skip weekend (0=Domenica, 6=Sabato)
                                        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                                          const dateStr = currentDate.toISOString().split('T')[0];
                                          newSelectedDates[dateStr] = 1.0; // Journ√©e enti√®re par d√©faut
                                          workingDaysCount++;
                                        }
                                        currentDate.setDate(currentDate.getDate() + 1);
                                      }
                                      
                                      // Aggiorna stato
                                      setMonthlyAllocationData(prev => ({
                                        ...prev,
                                        selectedDates: newSelectedDates
                                      }));
                                    }}
                                    className={`${suggestion.color} text-white px-3 py-3 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg flex flex-col items-center justify-center gap-1`}
                                  >
                                    <span className="text-center">{suggestion.label}</span>
                                    <span className="text-xs opacity-90">{suggestion.days}j</span>
                                  </button>
                                ));
                              })()}
                            </div>
                            <div className="mt-3 text-xs text-purple-800 bg-purple-100 rounded px-3 py-2">
                              üí° <strong>Astuce:</strong> Les suggestions s√©lectionnent automatiquement les jours ouvrables (Lun-Ven) depuis le d√©but du projet. Vous pouvez ensuite ajuster manuellement.
                            </div>
                          </div>
                          
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <p className="text-sm text-blue-800 mb-2">
                              <span className="font-bold">R√®gle:</span> S√©lectionnez exactement <span className="font-bold text-blue-900">{monthlyAllocationData.totalDays} jours</span> en cliquant sur les cases du calendrier
                            </p>
                            <div className="flex items-center gap-4 text-xs text-blue-700 mt-2 flex-wrap">
                              <div className="flex items-center gap-1">
                                <div className="w-6 h-6 bg-gray-50 border-2 border-gray-200 rounded flex items-center justify-center text-xs">1</div>
                                <span>Non s√©lectionn√©</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-6 h-6 bg-blue-300 border-2 border-blue-700 rounded flex items-center justify-center text-xs font-bold">¬Ω</div>
                                <span>Demi-journ√©e (0.5j)</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <div className="w-6 h-6 bg-blue-600 text-white border-2 border-blue-700 rounded flex items-center justify-center text-xs">1</div>
                                <span>Journ√©e enti√®re (1j)</span>
                              </div>
                              <div className="text-blue-900 font-semibold">üëÜ Cliquez plusieurs fois pour changer</div>
                            </div>
                          </div>
                          
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                            {getProjectMonths().map(month => {
                              const daysInMonth = getDaysInMonth(month.month, month.year);
                              const firstDay = getFirstDayOfMonth(month.month, month.year);
                              const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
                              const daysSelected = getDatesInMonth(month.year, month.month);
                              
                              return (
                                <div key={month.key} className="bg-white border-2 border-gray-200 rounded-lg p-3">
                                  <h4 className="font-bold text-gray-800 text-center mb-2 capitalize">{month.label}</h4>
                                  <p className="text-xs text-center text-gray-600 mb-2">{daysSelected} jour{daysSelected !== 1 ? 's' : ''} s√©lectionn√©{daysSelected !== 1 ? 's' : ''}</p>
                                  
                                  {/* Jours de la semaine */}
                                  <div className="grid grid-cols-7 gap-1 mb-1">
                                    {['L', 'M', 'M', 'J', 'V', 'S', 'D'].map((day, idx) => (
                                      <div key={idx} className={`text-xs font-bold text-center py-1 ${idx >= 5 ? 'text-red-600' : 'text-gray-700'}`}>
                                        {day}
                                      </div>
                                    ))}
                                  </div>
                                  
                                  {/* Grille des jours */}
                                  <div className="grid grid-cols-7 gap-1">
                                    {/* Jours vides avant le d√©but du mois */}
                                    {[...Array(adjustedFirstDay)].map((_, idx) => (
                                      <div key={`empty-${idx}`} className="aspect-square"></div>
                                    ))}
                                    
                                    {/* Jours du mois */}
                                    {[...Array(daysInMonth)].map((_, dayIndex) => {
                                      const day = dayIndex + 1;
                                      const dateKey = formatDateKey(month.year, month.month, day);
                                      const dayValue = monthlyAllocationData.selectedDates[dateKey] || 0;
                                      const dayOfWeek = new Date(month.year, month.month, day).getDay();
                                      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                      
                                      // V√©rifier si le jour est d√©j√† allou√© ailleurs pour cette ressource sp√©cifique (syst√®me intelligent)
                                      const isAllocatedElsewhere = isDayAllocatedElsewhere(
                                        dateKey, 
                                        editingProject?.id, 
                                        monthlyAllocationData.resourceName, 
                                        monthlyAllocationData.resourceType
                                      );
                                      const allocationDetails = isAllocatedElsewhere ? getAllocationDetails(
                                        dateKey, 
                                        editingProject?.id,
                                        monthlyAllocationData.resourceName,
                                        monthlyAllocationData.resourceType
                                      ) : null;
                                      
                                      return (
                                        <button
                                          key={day}
                                          type="button"
                                          onClick={() => toggleDateSelection(dateKey)}
                                          title={allocationDetails ? 
                                            `‚ö†Ô∏è D√©j√† allou√© dans:\n${allocationDetails.map(a => `${a.projectName} (${a.allocation}j)`).join('\n')}` 
                                            : ''
                                          }
                                          className={`aspect-square rounded text-sm font-semibold transition-all relative ${
                                            dayValue === 1.0
                                              ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-md scale-105' 
                                              : dayValue === 0.5
                                              ? 'bg-blue-300 text-blue-900 hover:bg-blue-400 shadow-sm'
                                              : isWeekend
                                              ? 'bg-gray-100 text-gray-500 hover:bg-blue-100 hover:text-blue-700'
                                              : 'bg-gray-50 text-gray-700 hover:bg-blue-100 hover:text-blue-700'
                                          } border-2 ${
                                            isAllocatedElsewhere
                                              ? 'border-red-500 border-solid' 
                                              : dayValue > 0 ? 'border-blue-700' : 'border-gray-200 hover:border-blue-300'
                                          }`}
                                        >
                                          {isAllocatedElsewhere && (
                                            <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold">
                                              ‚ö†
                                            </div>
                                          )}
                                          {day}
                                          {dayValue === 0.5 && (
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                              <div className="text-xs font-bold bg-white bg-opacity-70 px-1 rounded">¬Ω</div>
                                            </div>
                                          )}
                                        </button>
                                      );
                                    })}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                          
                          <div className={`p-4 rounded-lg mb-4 ${getSelectedDatesCount() === monthlyAllocationData.totalDays ? 'bg-green-50 border-2 border-green-300' : 'bg-red-50 border-2 border-red-300'}`}>
                            <div className="flex justify-between items-center">
                              <span className="font-bold text-gray-800">Jours s√©lectionn√©s:</span>
                              <span className={`text-2xl font-bold ${getSelectedDatesCount() === monthlyAllocationData.totalDays ? 'text-green-700' : 'text-red-700'}`}>
                                {getSelectedDatesCount()} / {monthlyAllocationData.totalDays} jours
                              </span>
                            </div>
                            {getSelectedDatesCount() === monthlyAllocationData.totalDays ? (
                              <p className="text-sm text-green-700 font-semibold mt-2">‚úì R√©partition valide</p>
                            ) : (
                              <p className="text-sm text-red-700 font-semibold mt-2">
                                ‚úó {getSelectedDatesCount() > monthlyAllocationData.totalDays ? 'Trop de jours' : 'Pas assez de jours'} 
                                ({Math.abs(getSelectedDatesCount() - monthlyAllocationData.totalDays)} jour{Math.abs(getSelectedDatesCount() - monthlyAllocationData.totalDays) !== 1 ? 's' : ''} {getSelectedDatesCount() > monthlyAllocationData.totalDays ? 'en trop' : 'manquant' + (Math.abs(getSelectedDatesCount() - monthlyAllocationData.totalDays) !== 1 ? 's' : '')})
                              </p>
                            )}
                          </div>
                          
                          <div className="flex gap-3">
                            <button 
                              onClick={saveMonthlyAllocation}
                              disabled={getSelectedDatesCount() !== monthlyAllocationData.totalDays}
                              className={`flex-1 px-6 py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 ${
                                getSelectedDatesCount() === monthlyAllocationData.totalDays 
                                  ? 'bg-green-600 hover:bg-green-700' 
                                  : 'bg-gray-400 cursor-not-allowed'
                              }`}
                            >
                              <Check size={20} /> Valider la r√©partition
                            </button>
                            <button 
                              onClick={() => setShowMonthlyAllocationModal(false)}
                              className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-bold flex items-center justify-center gap-2"
                            >
                              <X size={20} /> Annuler
                            </button>
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              )}
              
              {/* Sync Status Indicator */}
              {isOneDriveConnected && (
                <div className="fixed bottom-6 right-6 z-50">
                  {syncStatus === 'saving' && (
                    <div className="bg-blue-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-pulse">
                      <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                      </svg>
                      <span className="font-semibold">Synchronisation...</span>
                    </div>
                  )}
                  {syncStatus === 'saved' && (
                    <div className="bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/>
                      </svg>
                      <span className="font-semibold">Synchronis√© {lastSyncTime}</span>
                    </div>
                  )}
                  {syncStatus === 'error' && (
                    <div className="bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2">
                      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                      <span className="font-semibold">Erreur de synchronisation</span>
                    </div>
                  )}
                </div>
              )}
              
              {/* Banner OneDrive non connect√© */}
              {isOneDriveReady && !isOneDriveConnected && (
                <div className="fixed bottom-6 left-6 right-6 md:left-auto md:right-6 md:max-w-md z-40">
                  <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-4 shadow-xl">
                    <div className="flex items-start gap-3">
                      <svg className="w-8 h-8 text-blue-600 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                      </svg>
                      <div className="flex-1">
                        <div className="font-bold text-blue-900 mb-1">üí° Synchronisation Cloud</div>
                        <div className="text-sm text-blue-800 mb-3">
                          Connectez OneDrive pour synchroniser automatiquement vos donn√©es entre tous vos appareils
                        </div>
                        <div className="flex gap-2">
                          <button 
                            onClick={signInOneDrive}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all"
                          >
                            <svg className="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                              <rect x="2" y="2" width="9" height="9" fill="#F25022"/><rect x="13" y="2" width="9" height="9" fill="#7FBA00"/><rect x="2" y="13" width="9" height="9" fill="#00A4EF"/><rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                            </svg>
                            Connecter maintenant
                          </button>
                          <button 
                            onClick={() => setIsOneDriveReady(false)}
                            className="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold text-sm transition-all"
                          >
                            Plus tard
                          </button>
                        </div>
                      </div>
                      <button 
                        onClick={() => setIsOneDriveReady(false)}
                        className="text-gray-400 hover:text-gray-600"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* ========================================== */}
              {/* MODAL CONFIGURAZIONE RISORSA */}
              {/* ========================================== */}
              {showResourceConfigModal && selectedResourceForConfig && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowResourceConfigModal(false)}>
                  <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <Settings size={24} className="text-blue-600" />
                        Configuration: {selectedResourceForConfig.name}
                      </h2>
                      <button onClick={() => setShowResourceConfigModal(false)} className="text-gray-400 hover:text-gray-600">
                        <X size={20} />
                      </button>
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Heures maximales par mois
                        </label>
                        <input
                          type="number"
                          value={selectedResourceForConfig.maxMonthlyHours}
                          onChange={(e) => setSelectedResourceForConfig({
                            ...selectedResourceForConfig,
                            maxMonthlyHours: parseInt(e.target.value) || 160
                          })}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="160"
                          min="1"
                        />
                        <p className="text-xs text-gray-500 mt-1">Capacit√© mensuelle maximale (d√©faut: 160h)</p>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Heures par jour
                        </label>
                        <input
                          type="number"
                          value={selectedResourceForConfig.defaultDailyHours}
                          onChange={(e) => setSelectedResourceForConfig({
                            ...selectedResourceForConfig,
                            defaultDailyHours: parseInt(e.target.value) || 8
                          })}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="8"
                          min="1"
                          max="24"
                        />
                        <p className="text-xs text-gray-500 mt-1">Heures de travail par jour (d√©faut: 8h)</p>
                      </div>
                      
                      <div className="bg-blue-50 p-3 rounded">
                        <p className="text-sm text-blue-800">
                          <strong>Allocation maximale:</strong> {selectedResourceForConfig.maxMonthlyHours}h / mois<br />
                          <strong>Jours √©quivalents:</strong> {Math.round(selectedResourceForConfig.maxMonthlyHours / selectedResourceForConfig.defaultDailyHours)} jours/mois
                        </p>
                      </div>
                    </div>
                    
                    <div className="flex gap-2 mt-6">
                      <button
                        onClick={() => {
                          updateResourceConfig(
                            selectedResourceForConfig.id,
                            selectedResourceForConfig.type,
                            selectedResourceForConfig.maxMonthlyHours,
                            selectedResourceForConfig.defaultDailyHours
                          );
                          setShowResourceConfigModal(false);
                          setSelectedResourceForConfig(null);
                        }}
                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold"
                      >
                        <Check size={16} className="inline mr-2" />
                        Enregistrer
                      </button>
                      <button
                        onClick={() => {
                          setShowResourceConfigModal(false);
                          setSelectedResourceForConfig(null);
                        }}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold"
                      >
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              )}
              
              {/* ========================================== */}
              {/* MODAL INDISPONIBILIT√â */}
              {/* ========================================== */}
              {showUnavailabilityModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowUnavailabilityModal(false)}>
                  <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <Calendar size={24} className="text-orange-600" />
                        Ajouter indisponibilit√©
                      </h2>
                      <button onClick={() => setShowUnavailabilityModal(false)} className="text-gray-400 hover:text-gray-600">
                        <X size={20} />
                      </button>
                    </div>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Type
                        </label>
                        <select
                          value={unavailabilityForm.type}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, type: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                        >
                          <option value="vacation">üèñÔ∏è Cong√© / Vacances</option>
                          <option value="sick">ü§í Maladie</option>
                          <option value="training">üìö Formation</option>
                          <option value="other">‚ö†Ô∏è Autre</option>
                        </select>
                      </div>
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Date d√©but
                        </label>
                        <input
                          type="date"
                          value={unavailabilityForm.startDate}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, startDate: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Date fin
                        </label>
                        <input
                          type="date"
                          value={unavailabilityForm.endDate}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, endDate: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                          Raison (optionnelle)
                        </label>
                        <input
                          type="text"
                          value={unavailabilityForm.reason}
                          onChange={(e) => setUnavailabilityForm({ ...unavailabilityForm, reason: e.target.value })}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="Ex: Vacances d'√©t√©, Formation React..."
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-2 mt-6">
                      <button
                        onClick={addUnavailability}
                        className="flex-1 bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-semibold"
                        disabled={!unavailabilityForm.startDate || !unavailabilityForm.endDate}
                      >
                        <Check size={16} className="inline mr-2" />
                        Ajouter
                      </button>
                      <button
                        onClick={() => {
                          setShowUnavailabilityModal(false);
                          setUnavailabilityForm({
                            resourceId: null, resourceType: '',
                            startDate: '', endDate: '', type: 'vacation', reason: ''
                          });
                        }}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold"
                      >
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProjectManager />);
    </script>
</body>
</html>
